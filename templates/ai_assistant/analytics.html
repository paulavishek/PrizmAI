{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics of Spectra - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .stat-icon {
        font-size: 32px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f5f5;
        border-radius: 8px;
    }
    
    .stat-info h3 {
        color: #999;
        font-size: 13px;
        margin: 0;
        text-transform: uppercase;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }
    
    .chart-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="mb-3">
        <a href="{% url 'ai_assistant:chat' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Back to Chat
        </a>
    </div>
    
    <div class="analytics-header">
        <h2><i class="fas fa-chart-bar me-2"></i> Analytics of Spectra</h2>
        <p class="text-muted mb-0">Track your AI-assisted project management activity</p>
    </div>
    
    <!-- Info Banner -->
    <div class="alert alert-info d-flex align-items-start mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-left: 4px solid #2196f3; border-radius: 8px;">
        <i class="fas fa-info-circle me-3 mt-1" style="color: #2196f3; font-size: 1.2rem;"></i>
        <div style="font-size: 0.95rem; line-height: 1.6;">
            <strong>About this data:</strong> Analytics include demo sessions (visible in your sidebar) plus your own conversations with Spectra. 
            Charts show daily aggregated activity over the past 30 days, tracking when AI interactions occurred, not just current session dates.
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="analytics-grid">
        <div class="stat-card">
            <div class="stat-icon">💬</div>
            <div class="stat-info">
                <h3>Total Messages</h3>
                <div class="stat-value">{{ total_messages }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">🧠</div>
            <div class="stat-info">
                <h3>RAG Usage Rate</h3>
                <div class="stat-value">{{ rag_usage_rate }}%</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">📚</div>
            <div class="stat-info">
                <h3>Knowledge Base Queries</h3>
                <div class="stat-value">{{ kb_queries }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">�</div>
            <div class="stat-info">
                <h3>Context-Aware Responses</h3>
                <div class="stat-value">{{ context_aware_rate }}%</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">�</div>
            <div class="stat-info">
                <h3>Multi-Turn Conversations</h3>
                <div class="stat-value">{{ multi_turn_sessions }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">⚡</div>
            <div class="stat-info">
                <h3>Avg Response Time</h3>
                <div class="stat-value">{{ avg_response_time }}s</div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">Messages Over Time</div>
            <canvas id="messagesChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">AI Feature Usage (RAG vs Web Search)</div>
            <canvas id="featureChart"></canvas>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">Token Efficiency Trend</div>
            <canvas id="tokenChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Load analytics data
    fetch('{% url "ai_assistant:analytics_data" %}')
        .then(r => r.json())
        .then(data => {
            // Messages chart - Line chart showing messages over time
            const messagesCtx = document.getElementById('messagesChart').getContext('2d');
            new Chart(messagesCtx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Messages',
                        data: data.messages,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Feature usage chart - Bar chart showing Web Search vs KB Queries
            const totalWebSearches = data.web_searches.reduce((a, b) => a + b, 0);
            const totalKbQueries = data.kb_queries.reduce((a, b) => a + b, 0);
            
            const featureCtx = document.getElementById('featureChart').getContext('2d');
            new Chart(featureCtx, {
                type: 'bar',
                data: {
                    labels: ['Knowledge Base (RAG)', 'Web Search'],
                    datasets: [{
                        label: 'Usage Count',
                        data: [totalKbQueries, totalWebSearches],
                        backgroundColor: ['#34a853', '#4285f4'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Token efficiency chart - Line showing tokens over time
            const tokenCtx = document.getElementById('tokenChart').getContext('2d');
            new Chart(tokenCtx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Tokens Used',
                        data: data.tokens,
                        borderColor: '#fbbc04',
                        backgroundColor: 'rgba(251, 188, 4, 0.1)',
                        tension: 0.3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
</script>
{% endblock %}
