{% extends 'base.html' %}
{% load static %}

{% block title %}AI Usage - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --bg-light: #f9fafb;
        --border-color: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
    }
    
    .ai-usage-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .back-to-dashboard {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10;
    }
    
    .page-header {
        margin-bottom: 32px;
        position: relative;
    }
    
    .page-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }
    
    .page-header p {
        font-size: 16px;
        color: var(--text-secondary);
    }
    
    .usage-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .card-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    
    .usage-percentage {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .progress-container {
        position: relative;
        background: var(--bg-light);
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
        margin: 20px 0;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 6px;
        transition: width 0.4s ease;
        position: relative;
    }
    
    .progress-bar.low {
        background: linear-gradient(90deg, var(--success-color) 0%, #34d399 100%);
    }
    
    .progress-bar.medium {
        background: linear-gradient(90deg, var(--warning-color) 0%, #fbbf24 100%);
    }
    
    .progress-bar.high {
        background: linear-gradient(90deg, var(--danger-color) 0%, #f87171 100%);
    }
    
    .usage-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 15px;
        color: var(--text-primary);
        margin-top: 12px;
    }
    
    .usage-stats strong {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .reset-info {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 13px;
        margin-top: 12px;
    }
    
    .usage-note {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 14px 16px;
        margin-top: 16px;
        font-size: 13px;
        color: #1e40af;
        line-height: 1.6;
    }
    
    .usage-note i {
        margin-right: 8px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-box {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .stat-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .stat-value.highlight {
        color: var(--primary-color);
    }
    
    .feature-list {
        margin-top: 20px;
    }
    
    .feature-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .feature-item:last-child {
        border-bottom: none;
    }
    
    .feature-name {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .feature-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: white;
    }
    
    .feature-icon.coach {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .feature-icon.assistant {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .feature-stats {
        text-align: right;
    }
    
    .feature-count {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .feature-time {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .chart-container {
        margin-top: 24px;
        height: 300px;
        position: relative;
    }
    
    .empty-state {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        position: relative;
        z-index: 1;
        background: white;
    }
    
    .empty-state i {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
        display: block;
    }
    
    .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: block;
    }
    
    .empty-state p {
        margin-bottom: 4px;
        display: block;
    }
    
    .empty-state .text-muted {
        font-size: 12px;
        color: #9ca3af;
        display: block !important;
    }
    
    .empty-state ul {
        display: block !important;
        list-style-position: inside;
    }
    
    .empty-state ul li {
        display: list-item !important;
    }
    
    .quota-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        background: #eff6ff;
        color: #1e40af;
    }
    
    .quota-badge.warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .quota-badge.danger {
        background: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-usage-container">
    <!-- Back Button -->
    <button onclick="goBack()" class="btn btn-outline-secondary back-to-dashboard">
        <i class="fas fa-arrow-left me-1"></i> Back
    </button>
    
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-robot me-2" style="color: var(--primary-color);"></i>AI Usage</h1>
        <p>Monitor your AI feature consumption and manage your monthly quota</p>
    </div>
    
    <!-- Main Usage Card -->
    <div class="usage-card">
        <div class="card-header">
            <div>
                <h2 class="card-title">AI Requests</h2>
                <p class="card-subtitle">Track your monthly AI usage across all features</p>
            </div>
            <div class="usage-percentage" id="usage-percentage">
                {{ quota.get_usage_percent }}%
            </div>
        </div>
        
        <div class="progress-container">
            {% if quota.get_usage_percent < 50 %}
                <div class="progress-bar low" style="width: {{ quota.get_usage_percent }}%" id="progress-bar"></div>
            {% elif quota.get_usage_percent < 80 %}
                <div class="progress-bar medium" style="width: {{ quota.get_usage_percent }}%" id="progress-bar"></div>
            {% else %}
                <div class="progress-bar high" style="width: {{ quota.get_usage_percent }}%" id="progress-bar"></div>
            {% endif %}
        </div>
        
        <div class="usage-stats">
            <span>
                <strong id="requests-used">{{ quota.requests_used }}</strong> of 
                <strong>{{ quota.monthly_quota }}</strong> requests used
            </span>
            <span class="reset-info">
                <i class="fas fa-clock"></i>
                <span id="days-until-reset">Resets in {{ quota.get_days_until_reset }} days</span>
            </span>
        </div>
        
        {% if quota.get_usage_percent >= 80 %}
        <div class="usage-note">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>High usage alert:</strong> You've used {{ quota.get_usage_percent }}% of your monthly quota. 
            {% if quota.get_remaining_requests == 0 %}
                You've reached your limit. Your quota will reset in {{ quota.get_days_until_reset }} days.
            {% else %}
                You have {{ quota.get_remaining_requests }} requests remaining.
            {% endif %}
        </div>
        {% else %}
        <div class="usage-note">
            <i class="fas fa-info-circle"></i>
            Please note that each time you use AI Coach or AI Assistant, it counts as one request. 
            Your monthly request quota will reset at the end of your billing period.
        </div>
        {% endif %}
    </div>
    
    <!-- Daily Limit Card -->
    <div class="usage-card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-header">
            <div>
                <h2 class="card-title" style="color: white;"><i class="fas fa-clock me-2"></i>Daily Limit</h2>
                <p class="card-subtitle" style="color: rgba(255,255,255,0.8);">To ensure fair usage, there's a daily limit of {{ quota.daily_limit }} AI requests</p>
            </div>
            <div class="usage-percentage" id="daily-usage-percentage" style="background: rgba(255,255,255,0.2);">
                {% widthratio quota.daily_requests_used quota.daily_limit 100 as daily_percent %}
                {{ daily_percent|default:0 }}%
            </div>
        </div>
        
        <div class="progress-container" style="background: rgba(255,255,255,0.2);">
            {% if daily_percent < 50 %}
                <div class="progress-bar" style="width: {{ daily_percent }}%; background: #4CAF50;"></div>
            {% elif daily_percent < 80 %}
                <div class="progress-bar" style="width: {{ daily_percent }}%; background: #ff9800;"></div>
            {% else %}
                <div class="progress-bar" style="width: {{ daily_percent }}%; background: #f44336;"></div>
            {% endif %}
        </div>
        
        <div class="usage-stats" style="color: white;">
            <span>
                <strong>{{ quota.daily_requests_used }}</strong> of 
                <strong>{{ quota.daily_limit }}</strong> daily requests used
            </span>
            <span>
                <i class="fas fa-sync-alt"></i>
                Resets at midnight
            </span>
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">Monthly Remaining</div>
            <div class="stat-value highlight" id="requests-remaining">{{ quota.get_remaining_requests }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Daily Remaining</div>
            <div class="stat-value highlight" style="color: #667eea;">{{ quota.get_remaining_daily_requests }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Lifetime</div>
            <div class="stat-value">{{ quota.total_requests_all_time }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Days Until Reset</div>
            <div class="stat-value">{{ quota.get_days_until_reset }}</div>
        </div>
    </div>
    
    <!-- Feature Breakdown -->
    <div class="usage-card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Feature Usage</h2>
                <p class="card-subtitle">Breakdown by AI feature (last 30 days)</p>
            </div>
        </div>
        
        {% if by_feature %}
        <div class="feature-list">
            {% for feature in by_feature %}
            <div class="feature-item">
                <div class="feature-name">
                    <div class="feature-icon {% if feature.feature == 'ai_coach' %}coach{% else %}assistant{% endif %}">
                        {% if feature.feature == 'ai_coach' %}
                            <i class="fas fa-graduation-cap"></i>
                        {% else %}
                            <i class="fas fa-comment-dots"></i>
                        {% endif %}
                    </div>
                    <div>
                        <div>
                            {% if feature.feature == 'ai_coach' %}
                                AI Coach
                            {% elif feature.feature == 'ai_assistant' %}
                                AI Assistant
                            {% else %}
                                {{ feature.feature|title }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="feature-stats">
                    <div class="feature-count">{{ feature.count }}</div>
                    <div class="feature-time">
                        {% if feature.avg_response_time %}
                            Avg {{ feature.avg_response_time|floatformat:0 }}ms
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-bar"></i>
            <h3>ðŸ“Š No AI Usage Yet</h3>
            <p style="font-size: 15px; margin-bottom: 16px;">You haven't used any AI features in the last 30 days.</p>
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin: 0 auto; max-width: 500px; text-align: left;">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <i class="fas fa-lightbulb" style="color: #15803d; font-size: 20px; margin-top: 2px;"></i>
                    <div>
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #14532d;">Get Started with AI Features:</p>
                        <ul style="margin: 0; padding-left: 20px; color: #14532d;">
                            <li><strong>AI Coach:</strong> Get project insights and recommendations</li>
                            <li><strong>AI Assistant:</strong> Ask questions about your tasks and boards</li>
                            <li><strong>Analytics:</strong> Generate AI-powered board summaries</li>
                        </ul>
                    </div>
                </div>
            </div>
            <small class="text-muted mt-3" style="display: block; font-size: 13px;">
                Navigate to any board and look for AI-powered features to get started! ðŸš€
            </small>
        </div>
        {% endif %}
    </div>
    
    <!-- Daily Usage Chart -->
    <div class="usage-card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Usage Trend</h2>
                <p class="card-subtitle">Daily AI requests over the last 30 days</p>
            </div>
        </div>
        
        {% if daily_usage and daily_usage|length >= 2 %}
        <div class="chart-container">
            <canvas id="usageChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <h3>ðŸ“Š Not Enough Data for Trend Chart</h3>
            <p style="font-size: 15px; margin-bottom: 16px; display: block;">
                {% if daily_usage and daily_usage|length > 0 %}
                You have used AI features on <strong>{{ daily_usage|length }} day{{ daily_usage|length|pluralize }}</strong> so far.
                {% else %}
                You haven't used any AI features yet.
                {% endif %}
            </p>
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin: 0 auto; max-width: 550px; text-align: left; display: block !important; visibility: visible !important;">
                <div style="display: flex !important; align-items: flex-start; gap: 12px;">
                    <i class="fas fa-info-circle" style="color: #0284c7; font-size: 22px; margin-top: 2px; flex-shrink: 0;"></i>
                    <div style="flex: 1;">
                        <p style="margin: 0 0 12px 0; font-weight: 600; color: #0c4a6e; font-size: 15px; display: block;">To see your usage trend chart:</p>
                        <ul style="margin: 0; padding-left: 20px; color: #0c4a6e; line-height: 1.8; display: block !important;">
                            <li style="display: list-item !important; margin-bottom: 6px;">Use AI Coach or AI Assistant features</li>
                            <li style="display: list-item !important; margin-bottom: 6px;">Come back on different days to use AI features</li>
                            <li style="display: list-item !important;">The chart will appear once you have activity on <strong>at least 2 different days</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% if daily_usage and daily_usage|length > 0 %}
            <small class="text-muted mt-3" style="display: block !important; font-size: 14px; margin-top: 20px; padding: 12px; background: #fef3c7; border: 1px solid #fde047; border-radius: 6px; color: #78350f; max-width: 550px; margin-left: auto; margin-right: auto;">
                <i class="fas fa-rocket" style="margin-right: 6px;"></i>
                <strong>Great start!</strong> Keep using AI features on another day, and your trend chart will appear here! ðŸ“ˆ
            </small>
            {% else %}
            <small class="text-muted mt-3" style="display: block !important; font-size: 14px; margin-top: 20px; padding: 12px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 6px; color: #1e40af; max-width: 550px; margin-left: auto; margin-right: auto;">
                <i class="fas fa-lightbulb" style="margin-right: 6px;"></i>
                <strong>Get started:</strong> Try asking the AI Coach for project insights or use the AI Assistant! ðŸš€
            </small>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Auto-refresh usage stats every 30 seconds
let refreshInterval = null;

function refreshUsageStats() {
    fetch('/api/ai-usage/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update main stats
                document.getElementById('usage-percentage').textContent = data.quota.percentage + '%';
                document.getElementById('requests-used').textContent = data.quota.used;
                document.getElementById('requests-remaining').textContent = data.quota.remaining;
                document.getElementById('days-until-reset').textContent = 'Resets in ' + data.quota.days_until_reset + ' days';
                
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = data.quota.percentage + '%';
                
                // Update progress bar color based on usage
                progressBar.classList.remove('low', 'medium', 'high');
                if (data.quota.percentage < 50) {
                    progressBar.classList.add('low');
                } else if (data.quota.percentage < 80) {
                    progressBar.classList.add('medium');
                } else {
                    progressBar.classList.add('high');
                }
            }
        })
        .catch(error => console.error('Error refreshing stats:', error));
}

// Start auto-refresh
document.addEventListener('DOMContentLoaded', function() {
    refreshInterval = setInterval(refreshUsageStats, 30000);
    
    {% if daily_usage and daily_usage|length >= 2 %}
    // Create chart
    const ctx = document.getElementById('usageChart').getContext('2d');
    const dailyData = JSON.parse('{{ daily_usage_json|escapejs }}');
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dailyData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'AI Requests',
                data: dailyData.map(d => d.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    {% endif %}
});

// Clear interval on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
