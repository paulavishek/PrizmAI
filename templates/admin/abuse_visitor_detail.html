{% extends 'base.html' %}
{% load static %}

{% block title %}Visitor Detail - Abuse Monitoring{% endblock %}

{% block extra_css %}
<style>
    .visitor-detail-page {
        padding: 20px;
    }
    
    .nav-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 25px;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0;
    }
    
    .nav-tabs a {
        padding: 12px 24px;
        text-decoration: none;
        color: #666;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        font-weight: 500;
        border: 1px solid transparent;
        border-bottom: none;
        margin-bottom: -2px;
    }
    
    .nav-tabs a:hover { 
        background: #f9fafb;
        color: #1f2937;
    }
    
    .nav-tabs a.active { 
        background: white;
        color: #667eea;
        border-color: #e5e7eb;
        border-bottom-color: white;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #667eea;
        text-decoration: none;
        margin-bottom: 15px;
    }
    
    .back-link:hover { text-decoration: underline; }
    
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .info-card-header {
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
    }
    
    .info-card-body {
        padding: 20px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child { border-bottom: none; }
    
    .info-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .info-value {
        font-weight: 600;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .badge-success { background: #d1fae5; color: #059669; }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .action-btn:hover { transform: translateY(-2px); }
    .action-btn.block { background: #dc2626; color: white; }
    .action-btn.flag { background: #f59e0b; color: white; }
    .action-btn.unblock { background: #059669; color: white; }
    .action-btn.reset { background: #6b7280; color: white; }
    
    .vpn-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .vpn-info h3 { margin: 0 0 15px 0; }
    
    .vpn-factors {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .vpn-factor {
        background: rgba(255,255,255,0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    
    .session-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .session-table th,
    .session-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }
    
    .session-table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #666;
    }
    
    .risk-meter {
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        width: 100px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 10px;
    }
    
    .risk-meter-fill {
        height: 100%;
        transition: width 0.3s;
    }
    
    .session-ids {
        max-height: 150px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="visitor-detail-page">
    <a href="{% url 'analytics:abuse_visitor_list' %}" class="back-link">
        ‚Üê Back to Visitor List
    </a>
    
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h1 style="margin: 0 0 5px 0;">
                <code style="font-size: 1.5rem;">{{ visitor.ip_address }}</code>
            </h1>
            <div style="color: #666;">
                Visitor ID: {{ visitor.id }} ‚Ä¢ First seen: {{ visitor.first_seen|date:"M d, Y H:i" }}
            </div>
        </div>
        <div>
            {% if visitor.is_blocked %}
                <span class="badge badge-danger" style="font-size: 1rem; padding: 8px 16px;">üö´ BLOCKED</span>
            {% elif visitor.is_flagged %}
                <span class="badge badge-warning" style="font-size: 1rem; padding: 8px 16px;">‚ö†Ô∏è FLAGGED</span>
            {% else %}
                <span class="badge badge-success" style="font-size: 1rem; padding: 8px 16px;">‚úì Active</span>
            {% endif %}
        </div>
    </div>
    
    <!-- VPN Detection Info -->
    {% if vpn_info %}
    <div class="vpn-info">
        <h3>üîç IP Analysis</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
            <div>
                <div style="opacity: 0.8; font-size: 0.85rem;">Risk Score</div>
                <div style="font-size: 1.5rem; font-weight: 700;">
                    {{ vpn_info.risk_score }}/100
                    <div class="risk-meter">
                        <div class="risk-meter-fill" style="width: {{ vpn_info.risk_score }}%; background: {% if vpn_info.risk_score >= 60 %}#dc2626{% elif vpn_info.risk_score >= 30 %}#f59e0b{% else %}#059669{% endif %};"></div>
                    </div>
                </div>
            </div>
            <div>
                <div style="opacity: 0.8; font-size: 0.85rem;">VPN Detected</div>
                <div style="font-size: 1.5rem; font-weight: 700;">
                    {% if vpn_info.is_vpn %}Yes ‚ö†Ô∏è{% else %}No ‚úì{% endif %}
                </div>
            </div>
            <div>
                <div style="opacity: 0.8; font-size: 0.85rem;">Datacenter IP</div>
                <div style="font-size: 1.5rem; font-weight: 700;">
                    {% if vpn_info.is_datacenter %}Yes ‚ö†Ô∏è{% else %}No ‚úì{% endif %}
                </div>
            </div>
            <div>
                <div style="opacity: 0.8; font-size: 0.85rem;">Country / ISP</div>
                <div style="font-size: 1rem; font-weight: 600;">
                    {{ vpn_info.country|default:"Unknown" }}<br>
                    <span style="font-weight: 400; font-size: 0.85rem;">{{ vpn_info.isp|default:"Unknown" }}</span>
                </div>
            </div>
        </div>
        {% if vpn_info.factors %}
        <div class="vpn-factors">
            {% for factor in vpn_info.factors %}
            <span class="vpn-factor">{{ factor }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Detail Grid -->
    <div class="detail-grid">
        <!-- Usage Stats -->
        <div class="info-card">
            <div class="info-card-header">üìä Usage Statistics</div>
            <div class="info-card-body">
                <div class="info-row">
                    <span class="info-label">Total Sessions Created</span>
                    <span class="info-value {% if visitor.total_sessions_created >= 10 %}text-danger{% elif visitor.total_sessions_created >= 5 %}text-warning{% endif %}">
                        {{ visitor.total_sessions_created }}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total AI Generations</span>
                    <span class="info-value {% if visitor.total_ai_generations >= 40 %}text-danger{% elif visitor.total_ai_generations >= 20 %}text-warning{% endif %}">
                        {{ visitor.total_ai_generations }}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total Projects Created</span>
                    <span class="info-value">{{ visitor.total_projects_created }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Export Attempts</span>
                    <span class="info-value">{{ visitor.total_export_attempts }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sessions (Last Hour)</span>
                    <span class="info-value">{{ visitor.sessions_last_hour }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sessions (Last 24h)</span>
                    <span class="info-value">{{ visitor.sessions_last_24h }}</span>
                </div>
            </div>
        </div>
        
        <!-- Identification -->
        <div class="info-card">
            <div class="info-card-header">üîê Identification</div>
            <div class="info-card-body">
                <div class="info-row">
                    <span class="info-label">IP Address</span>
                    <span class="info-value"><code>{{ visitor.ip_address }}</code></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Browser Fingerprint</span>
                    <span class="info-value">
                        {% if visitor.browser_fingerprint %}
                            <code style="font-size: 0.8rem;">{{ visitor.browser_fingerprint|truncatechars:32 }}</code>
                        {% else %}
                            <span style="color: #999;">Not captured</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">First Seen</span>
                    <span class="info-value">{{ visitor.first_seen|date:"M d, Y H:i" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Seen</span>
                    <span class="info-value">{{ visitor.last_seen|date:"M d, Y H:i" }} ({{ visitor.last_seen|timesince }} ago)</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Session Created</span>
                    <span class="info-value">
                        {% if visitor.last_session_created %}
                            {{ visitor.last_session_created|date:"M d, Y H:i" }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flag Reason -->
    {% if visitor.flag_reason %}
    <div class="info-card" style="margin-bottom: 20px;">
        <div class="info-card-header" style="background: #fef3c7;">‚ö†Ô∏è Flag Reason</div>
        <div class="info-card-body">
            {{ visitor.flag_reason }}
        </div>
    </div>
    {% endif %}
    
    <!-- Session IDs -->
    {% if visitor.session_ids %}
    <div class="info-card" style="margin-bottom: 20px;">
        <div class="info-card-header">üîó Associated Session IDs ({{ visitor.session_ids|length }})</div>
        <div class="info-card-body">
            <div class="session-ids">
                {% for sid in visitor.session_ids %}
                {{ sid }}<br>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        {% if visitor.is_blocked %}
            <button onclick="performAction('unblock')" class="action-btn unblock">‚úì Unblock Visitor</button>
        {% else %}
            <button onclick="performAction('block')" class="action-btn block">üö´ Block Visitor</button>
        {% endif %}
        
        {% if visitor.is_flagged %}
            <button onclick="performAction('unflag')" class="action-btn" style="background: #059669; color: white;">‚úì Remove Flag</button>
        {% else %}
            <button onclick="performAction('flag')" class="action-btn flag">‚ö†Ô∏è Flag as Suspicious</button>
        {% endif %}
        
        <button onclick="performAction('reset_counters')" class="action-btn reset">üîÑ Reset Counters</button>
    </div>
    
    <!-- Sessions from this IP -->
    {% if sessions %}
    <div class="info-card" style="margin-top: 30px;">
        <div class="info-card-header">üìã Recent Sessions from this IP ({{ sessions|length }})</div>
        <div class="info-card-body" style="padding: 0;">
            <table class="session-table">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Mode</th>
                        <th>Device</th>
                        <th>AI Used</th>
                        <th>Projects</th>
                        <th>Converted</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td><code>{{ session.session_id|truncatechars:16 }}</code></td>
                        <td>
                            <span class="badge {% if session.demo_mode == 'solo' %}badge-info{% else %}badge-success{% endif %}">
                                {{ session.demo_mode }}
                            </span>
                        </td>
                        <td>{{ session.device_type }}</td>
                        <td>{{ session.ai_generations_used }}</td>
                        <td>{{ session.projects_created_in_demo }}</td>
                        <td>
                            {% if session.converted_to_signup %}
                                <span class="badge badge-success">Yes ‚úì</span>
                            {% else %}
                                <span style="color: #999;">No</span>
                            {% endif %}
                        </td>
                        <td>{{ session.created_at|date:"M d, H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function performAction(action) {
    const actionText = {
        'block': 'block this visitor',
        'unblock': 'unblock this visitor',
        'flag': 'flag this visitor as suspicious',
        'unflag': 'remove the flag from this visitor',
        'reset_counters': 'reset all counters for this visitor'
    }[action];
    
    if (!confirm(`Are you sure you want to ${actionText}?`)) return;
    
    const reason = action === 'flag' ? prompt('Enter reason for flagging (optional):') : '';
    
    fetch('{% url "analytics:abuse_action" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `action=${action}&visitor_id={{ visitor.id }}&reason=${encodeURIComponent(reason || '')}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>
{% endblock %}
