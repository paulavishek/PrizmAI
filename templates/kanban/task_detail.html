{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ task.title }} - Task Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- AI Task Summary Card -->
        <div class="card shadow mb-4 border-left-info">
            <div class="card-header py-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%); border-bottom: 3px solid #0a58ca;">
                <h6 class="m-0 font-weight-bold text-white d-flex align-items-center">
                    <i class="fas fa-brain me-2" style="font-size: 1.2rem;"></i><span style="font-size: 1.1rem;">AI Task Analysis & Summary</span>
                </h6>
                <button id="generate-task-summary" class="btn btn-sm btn-light" data-task-id="{{ task.id }}">
                    <span id="task-summary-spinner" class="spinner-border spinner-border-sm d-none me-1" role="status"></span>
                    <i class="fas fa-brain me-1"></i> Generate Comprehensive Summary
                </button>
            </div>
            <div class="card-body">
                <div id="task-summary-container" class="d-none">
                    <div class="task-summary-content">
                        <div id="task-summary-text"></div>
                    </div>
                </div>
                <div id="task-summary-placeholder" class="text-center py-4">
                    <i class="fas fa-brain fa-3x text-info mb-3"></i>
                    <p class="text-muted mb-0"><strong>Get AI-Powered Task Insights</strong></p>
                    <small class="text-muted">Comprehensive analysis covering risk, stakeholders, resources, dependencies, and more</small>
                </div>
            </div>
        </div>

        <!-- Task Detail Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Task Details</h6>
                <div>
                    <button onclick="goBack()" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </button>
                    {% if is_demo_mode %}
                    <a href="{% url 'demo_board_detail' task.column.board.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-columns me-1"></i> View Board
                    </a>
                    {% else %}
                    <a href="{% url 'board_detail' task.column.board.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-columns me-1"></i> View Board
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <form method="post" class="task-form">
                    {% csrf_token %}
                    
                    <!-- Render most fields with crispy -->
                    {% for field in form %}
                        {% if field.name != 'complexity_score' %}
                            {{ field|as_crispy_field }}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Custom rendering for complexity score -->
                    <div class="mb-3">
                        <label for="{{ form.complexity_score.id_for_label }}" class="form-label d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-chart-line text-warning me-1"></i> Complexity Score
                            </span>
                            <output id="complexity-output-detail" class="badge bg-secondary">{{ task.complexity_score|default:5 }}</output>
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <small class="text-muted">Simple (1)</small>
                            <input type="range" name="complexity_score" id="id_complexity_score" 
                                   class="form-range" min="1" max="10" step="1" 
                                   value="{{ task.complexity_score|default:5 }}"
                                   title="Task complexity from 1 (simple) to 10 (very complex)">
                            <small class="text-muted">Complex (10)</small>
                        </div>
                        <small class="form-text text-muted">Rate the task complexity from 1 (simple) to 10 (very complex). You can adjust this value anytime.</small>
                        {% if form.complexity_score.errors %}
                            <div class="invalid-feedback d-block">{{ form.complexity_score.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-outline-danger me-2" onclick="deleteTask()">Delete</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
                
                <!-- Hidden form for task deletion -->
                <form id="deleteTaskForm" method="post" action="{% url 'delete_task' task.id %}" style="display: none;">
                    {% csrf_token %}
                </form>
            </div>
        </div>

        <!-- Comments Section -->        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Comments</h6>
                {% if comments.count > 2 %}
                <button id="summarize-comments" class="btn btn-sm btn-outline-primary" data-task-id="{{ task.id }}">
                    <i class="fas fa-robot me-1"></i> Summarize with AI
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- AI Summary Section -->
                <div id="comment-summary-container" class="alert alert-info mb-4 d-none">
                    <button type="button" class="btn-close" id="close-summary" aria-label="Close" style="position: absolute; right: 15px; top: 15px;"></button>
                    <div class="d-flex align-items-start">
                        <i class="fas fa-robot mt-1 me-2"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Comment Summary:</strong>
                                <button id="export-summary-pdf" class="btn btn-sm btn-outline-primary d-none" title="Export summary as PDF">
                                    <i class="fas fa-file-pdf me-1"></i> Export PDF
                                    <span id="pdf-export-spinner" class="spinner-border spinner-border-sm ms-1 d-none" role="status"></span>
                                </button>
                            </div>
                            <p id="comment-summary-text" class="mb-1"></p>
                            <div id="summary-spinner" class="d-none">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2 text-muted">Generating summary...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if comments %}
                    {% for comment in comments %}
                    <div class="d-flex mb-4">
                        {% if comment.user.profile.profile_picture %}
                            <img class="rounded-circle me-3" src="{{ comment.user.profile.profile_picture.url }}" width="50" height="50" alt="{{ comment.user.username }}">
                        {% else %}
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                {{ comment.user.username|slice:":1" }}
                            </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">{{ comment.user.username }}</h6>
                                <small class="text-muted">{{ comment.created_at|date:"M d, Y" }} at {{ comment.created_at|time:"H:i" }}</small>
                            </div>
                            <p class="mb-0">{{ comment.content }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No comments yet.</p>
                {% endif %}

                <hr>
                
                <!-- Add Comment Form -->
                <form method="post">
                    {% csrf_token %}
                    {{ comment_form|crispy }}
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">Add Comment</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Files Section -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-file me-2"></i> Attachments</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleFileUpload()" title="Upload file">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
            <div class="card-body">
                <!-- File Upload Form -->
                <form id="taskFileForm" method="post" action="{% url 'upload_task_file' task_id=task.id %}" enctype="multipart/form-data" style="display: none;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select File</label>
                        <input type="file" id="fileInput" name="file" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" required>
                        <small class="text-muted">Supported: PDF, Word, Excel, PowerPoint, JPG, PNG (Max: 10MB)</small>
                    </div>
                    <div class="mb-3">
                        <label for="fileDescription" class="form-label">Description (Optional)</label>
                        <textarea id="fileDescription" name="description" class="form-control" rows="2" placeholder="Add a description for this file..." maxlength="500"></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Upload
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleFileUpload()">
                            Cancel
                        </button>
                    </div>
                </form>

                <!-- Files List -->
                <div id="filesList">
                    {% if task.file_attachments.all %}
                        {% for file in task.file_attachments.all %}
                            {% if not file.is_deleted %}
                                <div class="d-flex align-items-start justify-content-between p-3 mb-2 bg-light rounded">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas {{ file.get_file_icon }} text-primary me-2"></i>
                                            <a href="{% url 'download_task_file' file_id=file.id %}" class="text-decoration-none" target="_blank">
                                                <strong>{{ file.filename }}</strong>
                                            </a>
                                        </div>
                                        <small class="text-muted">
                                            By {{ file.uploaded_by.username }} • {{ file.file_size|filesizeformat }} • {{ file.uploaded_at|date:"M d, Y" }}
                                        </small>
                                        {% if file.description %}
                                            <p class="mb-0 mt-1 text-muted small">{{ file.description }}</p>
                                        {% endif %}
                                    </div>
                                    {% if user == file.uploaded_by or user.is_staff %}
                                        <button type="button" class="btn btn-sm btn-link text-danger ms-2" onclick="deleteTaskFile({{ file.id }}, '{{ file.filename }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">No files attached yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Wiki Links Section -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-book me-2"></i> Linked Wiki Pages</h6>
                <a href="{% url 'wiki:quick_link' content_type='task' object_id=task.id %}" class="btn btn-sm btn-outline-primary" title="Link wiki pages to this task">
                    <i class="fas fa-link"></i> Link Wiki
                </a>
            </div>
            <div class="card-body">
                {% if wiki_links %}
                    <div class="list-group list-group-flush">
                        {% for link in wiki_links %}
                            <a href="{% url 'wiki:page_detail' link.wiki_page.slug %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <i class="fas fa-book"></i> {{ link.wiki_page.title }}
                                    </h6>
                                    {% if link.description %}
                                        <p class="mb-1 text-muted small">{{ link.description }}</p>
                                    {% endif %}
                                    <small class="text-muted">
                                        Category: <strong>{{ link.wiki_page.category.name }}</strong> • 
                                        Last updated: {{ link.wiki_page.updated_at|date:"M d, Y" }}
                                    </small>
                                </div>
                                <span class="badge bg-info">View Page</span>
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-book-open fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No wiki pages linked to this task</p>
                        <small class="text-muted">Click "Link Wiki" above to add relevant documentation</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Task Info Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Task Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted">Status</label>
                    <div class="p-2 bg-light rounded">{{ task.column.name }}</div>
                </div>

                <div class="mb-3">
                    <label class="text-muted">Created By</label>
                    <div class="d-flex align-items-center p-2 bg-light rounded">
                        {% if task.created_by.profile.profile_picture %}
                            <img class="rounded-circle me-2" src="{{ task.created_by.profile.profile_picture.url }}" width="25" height="25" alt="{{ task.created_by.username }}">
                        {% else %}
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 0.8rem;">
                                {{ task.created_by.username|slice:":1" }}
                            </div>
                        {% endif %}
                        {{ task.created_by.username }}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="text-muted">Created On</label>
                    <div class="p-2 bg-light rounded">{{ task.created_at|date:"M d, Y" }}</div>
                </div>

                {% if task.assigned_to %}
                <div class="mb-3">
                    <label class="text-muted">Assigned To</label>
                    <div class="d-flex align-items-center p-2 bg-light rounded">
                        {% if task.assigned_to.profile.profile_picture %}
                            <img class="rounded-circle me-2" src="{{ task.assigned_to.profile.profile_picture.url }}" width="25" height="25" alt="{{ task.assigned_to.username }}">
                        {% else %}
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 0.8rem;">
                                {{ task.assigned_to.username|slice:":1" }}
                            </div>
                        {% endif %}
                        {{ task.assigned_to.username }}
                    </div>
                </div>
                {% endif %}

                {% if task.due_date %}
                <div class="mb-3">
                    <label class="text-muted">Due Date</label>
                    <div class="p-2 rounded {% if task.due_date < now and task.progress < 100 %}bg-danger text-white{% else %}bg-light{% endif %}">
                        {{ task.due_date|date:"M d, Y" }}
                        {% if task.due_date < now and task.progress < 100 %}<span class="badge bg-light text-danger ms-2">Overdue</span>{% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- 🔮 AI Predicted Completion Date -->
                {% if task.progress < 100 %}
                <div class="mb-3">
                    <label class="text-muted d-flex align-items-center">
                        <i class="fas fa-brain text-primary me-2"></i> Predicted Completion
                        <button type="button" class="btn btn-sm btn-link p-0 ms-2" id="refresh-prediction" data-task-id="{{ task.id }}" title="Refresh prediction">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </label>
                    <div id="prediction-container" class="p-2 bg-light rounded">
                        {% if prediction %}
                            <div class="prediction-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong class="d-block {% if prediction.is_likely_late %}text-danger{% else %}text-success{% endif %}">
                                            {{ prediction.predicted_date|date:"M d, Y" }}
                                        </strong>
                                        <small class="text-muted">
                                            Range: {{ prediction.early_date|date:"M d" }} - {{ prediction.late_date|date:"M d" }}
                                        </small>
                                    </div>
                                    <span class="badge {% if prediction.confidence >= 0.7 %}bg-success{% elif prediction.confidence >= 0.5 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ prediction.confidence_percentage }}% confidence
                                    </span>
                                </div>
                                {% if prediction.is_likely_late %}
                                    <div class="alert alert-warning alert-sm mb-2 py-1 px-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <small>Likely to miss due date</small>
                                    </div>
                                {% endif %}
                                <div class="mt-2">
                                    <small class="text-muted d-block">
                                        <i class="fas fa-chart-line me-1"></i>Based on {{ prediction.based_on_tasks }} similar task{{ prediction.based_on_tasks|pluralize }}
                                    </small>
                                    
                                    <!-- Similar Tasks List -->
                                    {% if prediction.similar_tasks %}
                                        <button type="button" class="btn btn-outline-info btn-sm mt-1 w-100" data-bs-toggle="collapse" data-bs-target="#similar-tasks-list">
                                            <i class="fas fa-tasks me-1"></i>View {{ prediction.similar_tasks|length }} Similar Task{{ prediction.similar_tasks|length|pluralize }} 
                                            <i class="fas fa-chevron-down ms-1"></i>
                                        </button>
                                        <div class="collapse mt-2" id="similar-tasks-list">
                                            <div class="card card-body py-2 px-2 bg-white border-info">
                                                <small class="text-primary mb-2"><strong><i class="fas fa-info-circle me-1"></i>Tasks used for prediction:</strong></small>
                                                <div class="list-group list-group-flush">
                                                    {% for similar_task in prediction.similar_tasks %}
                                                    <a href="{% url 'task_detail' similar_task.id %}" class="list-group-item list-group-item-action py-2 px-2 small border-start border-info border-3" target="_blank">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <i class="fas fa-check-circle text-success me-1"></i>
                                                                <strong>{{ similar_task.title|truncatewords:8 }}</strong>
                                                            </div>
                                                            <span class="badge bg-primary ms-2">{{ similar_task.actual_duration_days|floatformat:1 }} days</span>
                                                        </div>
                                                        <div class="text-muted mt-1" style="font-size: 0.85em;">
                                                            <span class="me-2">
                                                                <i class="fas fa-layer-group"></i> Complexity: {{ similar_task.complexity_score }}/10
                                                            </span>
                                                            <span class="me-2">
                                                                <i class="fas fa-flag"></i> {{ similar_task.priority|title }}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-calendar-check"></i> {{ similar_task.completed_at|date:"M d, Y" }}
                                                            </span>
                                                        </div>
                                                    </a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info py-2 px-2 mt-2 mb-0">
                                            <small class="mb-0">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>Refresh prediction to see similar tasks</strong>
                                                <br>Click the <i class="fas fa-sync-alt"></i> button above to reload prediction data.
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <button type="button" class="btn btn-link btn-sm p-0 mt-1" data-bs-toggle="collapse" data-bs-target="#prediction-details">
                                    <small>View details <i class="fas fa-chevron-down"></i></small>
                                </button>
                                <div class="collapse mt-2" id="prediction-details">
                                    <div class="card card-body py-2 px-2 bg-white">
                                        <small class="text-muted">
                                            <strong>Factors considered:</strong><br>
                                            {% if prediction.factors.complexity_score %}
                                            • Complexity: {{ prediction.factors.complexity_score }}/10<br>
                                            {% endif %}
                                            {% if prediction.factors.priority %}
                                            • Priority: {{ prediction.factors.priority|title }}<br>
                                            {% endif %}
                                            {% if prediction.factors.team_member_velocity %}
                                            • Team velocity: {{ prediction.factors.team_member_velocity }}x<br>
                                            {% endif %}
                                            • Historical avg: {{ prediction.factors.historical_avg_days|floatformat:1 }} days<br>
                                            • Method: {{ prediction.prediction_method|title|cut:"_" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-muted text-center py-2 prediction-placeholder">
                                <i class="fas fa-brain mb-2"></i>
                                <small class="d-block">No prediction available yet</small>
                                <small class="d-block text-muted">Set a start date to enable predictions</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="mb-3">
                    <label class="text-muted">Priority</label>
                    <div class="p-2 bg-light rounded">
                        <span class="task-priority priority-{{ task.priority }}">{{ task.priority|title }}</span>
                    </div>
                </div>

                <!-- Task Progress Section -->
                <div class="mb-3">
                    <label class="text-muted">Progress</label>
                    <div class="p-2 bg-light rounded">
                        <div class="task-progress-container">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-sm btn-outline-secondary progress-btn decrease-progress" 
                                        data-task-id="{{ task.id }}" title="Decrease progress by 10%">
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <div class="progress flex-grow-1 mx-1" style="height: 15px;">
                                    <div class="progress-bar {% if task.progress < 30 %}bg-danger{% elif task.progress < 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                         role="progressbar" 
                                         style="--progress-width: {{ task.progress }}%; width: var(--progress-width);" 
                                         aria-valuenow="{{ task.progress }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-sm btn-outline-secondary progress-btn increase-progress" 
                                        data-task-id="{{ task.id }}" title="Increase progress by 10%">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="text-center mt-1">
                                <span id="progress-value">{{ task.progress }}% complete</span>
                            </div>
                        </div>
                    </div>
                </div>                <!-- 🛡️ Risk Management Section -->
                {% if task.risk_level %}
                <div class="mb-3 p-2 rounded border-2 {% if task.risk_level == 'critical' %}border-danger bg-danger{% elif task.risk_level == 'high' %}border-warning bg-warning{% elif task.risk_level == 'medium' %}border-info bg-info{% else %}border-success bg-success{% endif %} text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <label class="text-white-50 mb-1">Risk Assessment</label>
                            <h6 class="mb-1">🛡️ Risk Level: <strong>{{ task.risk_level|title }}</strong></h6>
                            <small>Score: {{ task.risk_score }}/9 | Likelihood: {{ task.risk_likelihood }}/3 | Impact: {{ task.risk_impact }}/3</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-light" 
                                    onclick="showRiskExplanation({{ task.id }})" 
                                    title="Why did AI give this risk score?">
                                <i class="bi bi-lightbulb me-1"></i> Why?
                            </button>
                        </div>
                    </div>
                    {% if task.risk_indicators %}
                    <div class="mt-2">
                        <small class="text-white-50">Indicators to Monitor:</small>
                        <ul class="small mb-0 mt-1">
                            {% for indicator in task.risk_indicators %}
                            <li>
                                {% if indicator.indicator %}
                                    <strong>{{ indicator.indicator }}</strong>
                                    {% if indicator.frequency %}<span class="text-white-75"> (Monitor: {{ indicator.frequency }})</span>{% endif %}
                                    {% if indicator.threshold %}<span class="badge bg-light text-dark ms-1">Alert: {{ indicator.threshold }}</span>{% endif %}
                                {% else %}
                                    {{ indicator }}
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if task.mitigation_suggestions %}
                    <div class="mt-2">
                        <small class="text-white-50">Mitigation Strategies:</small>
                        <div class="small mt-1">
                            {% for suggestion in task.mitigation_suggestions %}
                            <div class="mb-1">
                                {% if suggestion.action %}
                                    <strong>{{ suggestion.action }}</strong>
                                    {% if suggestion.expected_impact %} - <em>{{ suggestion.expected_impact }}</em>{% endif %}
                                    {% if suggestion.timeline %} <span class="text-white-75">({{ suggestion.timeline }})</span>{% endif %}
                                    {% if suggestion.priority %}<span class="badge bg-light text-dark ms-1">{{ suggestion.priority|upper }}</span>{% endif %}
                                {% elif suggestion.strategy %}
                                    <strong>{{ suggestion.strategy }}</strong>: {{ suggestion.description }} ({{ suggestion.timeline }})
                                {% else %}
                                    {{ suggestion }}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <!-- No Risk Assessment Yet - Show AI Assessment Button -->
                <div class="mb-3 p-3 bg-light rounded border border-2 border-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-shield-check text-info"></i> AI Risk Assessment</h6>
                            <small class="text-muted">Let AI analyze potential risks for this task</small>
                        </div>
                        <button type="button" class="btn btn-info btn-sm" 
                                onclick="assessTaskRisk({{ task.id }})" 
                                id="assess-risk-btn-{{ task.id }}">
                            <i class="bi bi-robot me-1"></i> Assess Risk with AI
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- 👥 Stakeholder Involvement Section -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="text-muted mb-0">👥 Stakeholders</label>
                        <div>
                            {% if stakeholders %}
                            <button type="button" class="btn btn-sm btn-outline-info me-2" 
                                    onclick="explainStakeholderRecommendations({{ task.id }})" 
                                    title="Why were these stakeholders identified?">
                                <i class="bi bi-lightbulb me-1"></i> AI Insights
                            </button>
                            {% endif %}
                            <a href="{% url 'stakeholder:task_stakeholder_involvement' board_id=task.column.board.id task_id=task.id %}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-user-plus me-1"></i> Manage Stakeholders
                            </a>
                        </div>
                    </div>
                    {% if stakeholders %}
                    <div class="p-2 bg-light rounded">
                        {% for involvement in stakeholders %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded border-start border-3 border-info">
                            <div>
                                <strong>{{ involvement.stakeholder.name }}</strong>
                                <small class="d-block text-muted">{{ involvement.get_involvement_type_display }}</small>
                                {% if involvement.feedback %}
                                <small class="d-block text-muted mt-1"><i class="fas fa-comment"></i> {{ involvement.feedback|truncatewords:15 }}</small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info">{{ involvement.get_engagement_status_display }}</span>
                                {% if involvement.satisfaction_rating %}
                                <small class="d-block text-warning mt-1">★ {{ involvement.satisfaction_rating }}/5</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-3 bg-light rounded text-center text-muted">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p class="mb-0">No stakeholders assigned to this task yet.</p>
                        <small>Click "Manage Stakeholders" above to add stakeholders.</small>
                    </div>
                    {% endif %}
                </div>

                <!-- 📋 Dependencies & Requirements Section -->
                {% if task.parent_task or task.subtasks.all or task.related_tasks.all or task.dependencies.all or task.required_skills %}
                <div class="mb-3">
                    <label class="text-muted mb-2"><strong>📋 Dependencies & Requirements</strong></label>
                    
                    <!-- 📊 Timeline Dependencies (Gantt Chart) -->
                    {% if task.dependencies.all or task.dependent_tasks.all %}
                    <div class="p-2 bg-light rounded mb-2">
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1"><strong><i class="fas fa-project-diagram me-1"></i>Timeline Dependencies (Gantt Chart)</strong></small>
                            <small class="text-muted fst-italic">Tasks linked for timeline scheduling and blocking relationships</small>
                        </div>
                        
                        {% if task.dependencies.all %}
                        <div class="mb-2">
                            <small class="text-muted"><i class="fas fa-arrow-right me-1"></i>Dependencies ({{ task.dependencies.count }}):</small>
                            <small class="text-muted d-block mb-1">This task cannot start until these tasks are completed:</small>
                            {% for dep in task.dependencies.all %}
                            <div class="p-2 bg-white rounded border-start border-4 border-warning mb-1">
                                <a href="{% url 'task_detail' dep.id %}" class="text-decoration-none">
                                    <strong>{{ dep.title }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ dep.start_date }} → {{ dep.due_date|date:"Y-m-d" }}
                                    <span class="badge bg-{% if dep.progress == 100 %}success{% elif dep.progress > 0 %}primary{% else %}secondary{% endif %} ms-1">{{ dep.progress }}%</span>
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% with blocking_tasks=task.dependent_tasks.all %}
                        {% if blocking_tasks %}
                        <div class="mb-2">
                            <small class="text-muted"><i class="fas fa-lock me-1"></i>Blocking ({{ blocking_tasks.count }}):</small>
                            <small class="text-muted d-block mb-1">These tasks cannot start until this task is completed:</small>
                            {% for blocked in blocking_tasks %}
                            <div class="p-2 bg-white rounded border-start border-4 border-danger mb-1">
                                <a href="{% url 'task_detail' blocked.id %}" class="text-decoration-none">
                                    <strong>{{ blocked.title }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ blocked.start_date }} → {{ blocked.due_date|date:"Y-m-d" }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                    {% endif %}
                    
                    <!-- 🔗 Task Hierarchy -->
                    {% if task.parent_task or task.subtasks.all %}
                    <div class="p-2 bg-light rounded mb-2">
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1"><strong><i class="fas fa-sitemap me-1"></i>Task Hierarchy</strong></small>
                            <small class="text-muted fst-italic">Parent-child relationships for task organization</small>
                        </div>
                        
                        {% if task.parent_task %}
                        <div class="mb-2">
                            <small class="text-muted">Parent Task:</small>
                            <div class="p-2 bg-white rounded border-start border-3 border-primary">
                                <a href="{% url 'task_detail' task.parent_task.id %}" class="text-decoration-none"><strong>{{ task.parent_task.title }}</strong></a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.subtasks.all %}
                        <div class="mb-2">
                            <small class="text-muted">Subtasks ({{ task.subtasks.count }}):</small>
                            {% for subtask in task.subtasks.all %}
                            <div class="p-2 bg-white rounded border-start border-3 border-success ms-2 mb-1">
                                <a href="{% url 'task_detail' subtask.id %}" class="text-decoration-none"><small>{{ subtask.title }}</small></a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- 📎 Additional Information -->
                    {% if task.related_tasks.all or task.required_skills or task.complexity_score %}
                    <div class="p-2 bg-light rounded">
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1"><strong><i class="fas fa-info-circle me-1"></i>Additional Information</strong></small>
                        </div>
                        
                        {% if task.related_tasks.all %}
                        <div class="mb-2">
                            <small class="text-muted">Related Tasks ({{ task.related_tasks.count }}):</small>
                            <div class="mt-1">
                                {% for related in task.related_tasks.all %}
                                <a href="{% url 'task_detail' related.id %}" class="badge bg-secondary me-1 text-decoration-none">{{ related.title|truncatewords:3 }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.required_skills %}
                        <div class="mb-2">
                            <small class="text-muted">Required Skills:</small>
                            <div>
                                {% for skill in task.required_skills %}
                                <span class="badge bg-warning me-1 mt-1">{{ skill.name }} ({{ skill.level }})</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if task.complexity_score %}
                        <div class="mt-2">
                            <small class="text-muted d-block mb-1">Complexity Score:</small>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar {% if task.complexity_score >= 8 %}bg-danger{% elif task.complexity_score >= 5 %}bg-warning{% else %}bg-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ task.complexity_score }}0%;"></div>
                            </div>
                            <small class="text-muted">{{ task.complexity_score }}/10 
                                {% if task.complexity_score >= 8 %}(Very Complex){% elif task.complexity_score >= 5 %}(Moderate){% else %}(Simple){% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- 📦 Resource Information -->
                {% if task.skill_match_score or task.workload_impact or task.collaboration_required %}
                <div class="mb-3">
                    <label class="text-muted">📦 Resource Information</label>
                    <div class="p-2 bg-light rounded">
                        {% if task.skill_match_score %}
                        <div class="mb-2">
                            <small class="text-muted">Skill Match Score:</small>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 85%;"></div>
                            </div>
                            <small class="text-muted">{{ task.skill_match_score }}%</small>
                        </div>
                        {% endif %}
                        
                        {% if task.workload_impact %}
                        <div class="mb-2">
                            <small class="text-muted">Workload Impact: </small>
                            <span class="badge {% if task.workload_impact == 'critical' %}bg-danger{% elif task.workload_impact == 'high' %}bg-warning{% else %}bg-success{% endif %}">{{ task.get_workload_impact_display }}</span>
                        </div>
                        {% endif %}
                        
                        {% if task.collaboration_required %}
                        <div>
                            <small class="text-muted"><i class="fas fa-users me-1"></i>Collaboration Required</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if task.labels.all %}                <div>
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="text-muted mb-0">Labels
                            <button type="button" class="btn btn-sm p-0" data-bs-toggle="modal" data-bs-target="#leanLabelsInfoModal">
                                <i class="fas fa-info-circle text-primary" title="Learn about Lean Six Sigma labels"></i>
                            </button>
                        </label>
                        <button type="button" id="suggest-lss-classification" class="btn btn-sm btn-outline-primary" data-task-id="{{ task.id }}">
                            <i class="fas fa-robot me-1"></i> Suggest LSS
                        </button>
                    </div>
                    
                    <!-- AI LSS Classification Suggestion -->
                    <div id="lss-suggestion-container" class="alert alert-info my-2 d-none">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-robot mt-1 me-2"></i>
                            <div>
                                <strong>AI Suggestion:</strong>
                                <p id="lss-suggestion-text" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                    <div id="classify-spinner" class="d-none text-center my-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2 text-muted">Analyzing with AI...</span>
                    </div>
                    
                    <div class="p-2 bg-light rounded">{% for label in task.labels.all %}
                            {% if label.category == 'lean' %}
                            <span class="task-label lean-label" style="--label-color: {{ label.color }}" 
                                  title="Lean Six Sigma: {{ label.name }}">
                                <i class="fas fa-chart-line"></i> {{ label.name }}
                            </span>
                            {% else %}
                            <span class="task-label" style="--label-color: {{ label.color }}">{{ label.name }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Time Tracking Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-clock"></i> Time Tracking
                </h6>
                <a href="{% url 'my_timesheet' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-calendar-week"></i> Timesheet
                </a>
            </div>
            <div class="card-body">
                <!-- Total Time Logged -->
                <div class="mb-3 p-3 bg-light rounded text-center">
                    <div class="text-muted mb-1">Total Time Logged</div>
                    <h3 class="mb-0 text-primary" id="total-time-display">
                        {{ total_time_logged|floatformat:2 }}h
                    </h3>
                </div>

                <!-- Quick Time Entry Form -->
                <form id="quick-time-log-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label small">Hours <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="time-hours" 
                                   step="0.25" min="0.25" max="24" placeholder="0.00" required>
                            <span class="input-group-text">hours</span>
                        </div>
                        <small class="text-muted">Increments of 0.25 (15 min)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small">Date</label>
                        <input type="date" class="form-control form-control-sm" id="time-date" 
                               value="{{ "now"|date:"Y-m-d" }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small">Description</label>
                        <textarea class="form-control form-control-sm" id="time-description" 
                                  rows="2" placeholder="What did you work on?"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-plus"></i> Log Time
                    </button>
                </form>

                <!-- Recent Entries -->
                <div class="mt-3" id="recent-time-entries">
                    <h6 class="text-muted small mb-2">Recent Entries</h6>
                    {% if task.time_entries.all %}
                    <div class="list-group list-group-flush">
                        {% for entry in task.time_entries.all|slice:":5" %}
                        <div class="list-group-item px-0 py-2" data-entry-id="{{ entry.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="text-primary">{{ entry.hours_spent }}h</strong>
                                    <small class="text-muted d-block">{{ entry.work_date|date:"M d, Y" }}</small>
                                    {% if entry.description %}
                                    <small class="text-muted">{{ entry.description|truncatechars:40 }}</small>
                                    {% endif %}
                                </div>
                                {% if entry.user == user %}
                                <button class="btn btn-sm btn-link text-danger delete-time-entry" 
                                        data-entry-id="{{ entry.id }}" title="Delete">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small text-center py-2 mb-0">No time logged yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activity Log Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Activity Log</h6>
            </div>
            <div class="card-body">
                {% if activities %}
                <div class="timeline">
                    {% for activity in activities %}
                    <div class="timeline-item">
                        <div class="timeline-item-marker">
                            {% if activity.activity_type == 'created' %}
                                <i class="fas fa-plus text-success"></i>
                            {% elif activity.activity_type == 'moved' %}
                                <i class="fas fa-arrows-alt text-info"></i>
                            {% elif activity.activity_type == 'updated' %}
                                <i class="fas fa-edit text-primary"></i>
                            {% elif activity.activity_type == 'commented' %}
                                <i class="fas fa-comment text-secondary"></i>
                            {% elif activity.activity_type == 'assigned' %}
                                <i class="fas fa-user-plus text-warning"></i>
                            {% elif activity.activity_type == 'label_added' or activity.activity_type == 'label_removed' %}
                                <i class="fas fa-tag text-danger"></i>
                            {% endif %}
                        </div>
                        <div class="timeline-item-content">
                            <p>{{ activity.description }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ activity.user.username }}</small>
                                <small class="text-muted">{{ activity.created_at|date:"M d, Y" }} at {{ activity.created_at|time:"H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No activity recorded yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lean Six Sigma Labels Info Modal -->
<div class="modal fade" id="leanLabelsInfoModal" tabindex="-1" aria-labelledby="leanLabelsInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leanLabelsInfoModalLabel">Understanding Lean Six Sigma Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Pri<span class="stylish-z">z</span>mAI includes Lean Six Sigma labels to help categorize your tasks based on their value contribution:</p>
                
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        Value-Added (VA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that transform inputs into outputs that customers value and are willing to pay for.</p>
                        <p class="card-text small">Example: Developing a feature that customers requested</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        Necessary Non-Value-Added (NNVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities required by current regulations, processes, or constraints, but don't directly add value for the customer.</p>
                        <p class="card-text small">Example: Compliance documentation, quality checks</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        Waste/Eliminate (NVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that consume resources without adding any value. These should be minimized or eliminated.</p>
                        <p class="card-text small">Example: Fixing defects, unnecessary meetings, waiting for approvals</p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i> 
                    <strong>Tip:</strong> Tagging your tasks this way helps identify process improvement opportunities and focus on value-adding activities.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    .task-label {
        background-color: var(--label-color);
        padding: 2px 8px;
        border-radius: 4px;
        color: white;
        display: inline-block;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }
    .timeline-item:not(:last-child):before {
        content: "";
        position: absolute;
        left: -20px;
        top: 0;
        width: 2px;
        height: 100%;
        background-color: #e0e0e0;
    }
    .timeline-item-marker {
        position: absolute;
        left: -30px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 0 2px #e0e0e0;
    }
    .timeline-item-content {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up increase progress buttons
        document.querySelectorAll('.increase-progress').forEach(btn => {
            btn.addEventListener('click', function() {
                const taskId = this.dataset.taskId;
                updateTaskProgress(taskId, 'increase');
            });
        });
        
        // Set up decrease progress buttons
        document.querySelectorAll('.decrease-progress').forEach(btn => {
            btn.addEventListener('click', function() {
                const taskId = this.dataset.taskId;
                updateTaskProgress(taskId, 'decrease');
            });
        });
        
        // Initialize labels with their colors
        document.querySelectorAll('.task-label').forEach(label => {
            const color = label.style.getPropertyValue('--label-color');
            if (color) {
                label.style.backgroundColor = color;
            }
        });
    });
    
    function updateTaskProgress(taskId, direction) {
        // Get the CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Send AJAX request to update progress
        fetch(`/tasks/${taskId}/update-progress/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                direction: direction
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the progress bar
                const progressBar = document.querySelector('.progress-bar');
                const progressText = document.getElementById('progress-value');
                
                if (progressBar && progressText) {
                    // Remove existing color classes
                    progressBar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
                    // Add new color class
                    progressBar.classList.add(data.colorClass);
                    // Update width
                    progressBar.style.width = `${data.progress}%`;
                    // Update text
                    progressText.textContent = `${data.progress}% complete`;
                }
                
                // Add a new timeline item for the progress update
                const timeline = document.querySelector('.timeline');
                if (timeline) {
                    const now = new Date();
                    const formattedDate = `${now.toLocaleDateString()} at ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    timelineItem.innerHTML = `
                        <div class="timeline-item-marker">
                            <i class="fas fa-edit text-primary"></i>
                        </div>
                        <div class="timeline-item-content">
                            <p>Updated progress to ${data.progress}%</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">You</small>
                                <small class="text-muted">${formattedDate}</small>
                            </div>
                        </div>
                    `;
                    
                    // Insert at the top of the timeline
                    if (timeline.firstChild) {
                        timeline.insertBefore(timelineItem, timeline.firstChild);
                    } else {
                        timeline.appendChild(timelineItem);
                    }
                    
                    // Remove "No activity" message if it exists
                    const noActivityMessage = document.querySelector('.card-body > .text-muted');
                    if (noActivityMessage && noActivityMessage.textContent === 'No activity recorded yet.') {
                        noActivityMessage.remove();
                    }
                }
            } else {
                console.error('Error updating task progress:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating task progress:', error);
        });
    }

    // File Management Functions
    function toggleFileUpload() {
        const form = document.getElementById('taskFileForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('taskFileForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const fileInput = document.getElementById('fileInput');
        
        if (!fileInput.files.length) {
            alert('Please select a file');
            return;
        }
        
        fetch('{% url "upload_task_file" task_id=task.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('File uploaded successfully!');
                location.reload();
            } else {
                alert('Upload failed: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload error: ' + error);
        });
    });

    function deleteTaskFile(fileId, filename) {
        if (confirm(`Delete "${filename}"?`)) {
            fetch(`{% url 'delete_task_file' file_id=0 %}`.replace('0', fileId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting file');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
    
    // Handle complexity score slider in task detail page
    document.addEventListener('DOMContentLoaded', function() {
        const complexitySlider = document.querySelector('#id_complexity_score');
        const complexityOutput = document.getElementById('complexity-output-detail');
        
        if (complexitySlider && complexityOutput) {
            // Set initial value from the slider
            const initialValue = complexitySlider.value || 5;
            complexityOutput.value = initialValue;
            complexityOutput.textContent = initialValue;
            
            // Update display color based on initial value
            updateComplexityBadge(initialValue, complexityOutput);
            
            // Update on slider change
            complexitySlider.addEventListener('input', function() {
                const value = this.value;
                complexityOutput.value = value;
                complexityOutput.textContent = value;
                updateComplexityBadge(value, complexityOutput);
            });
        }
        
        function updateComplexityBadge(value, badge) {
            badge.className = 'badge ';
            if (value >= 8) {
                badge.className += 'bg-danger';
            } else if (value >= 5) {
                badge.className += 'bg-warning';
            } else {
                badge.className += 'bg-success';
            }
        }
    });
    
    // Handle task deletion with confirmation
    function deleteTask() {
        if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
            document.getElementById('deleteTaskForm').submit();
        }
    }
    
    // Handle comprehensive task summary generation
    document.getElementById('generate-task-summary')?.addEventListener('click', function() {
        const taskId = this.getAttribute('data-task-id');
        const btn = this;
        const spinner = document.getElementById('task-summary-spinner');
        const container = document.getElementById('task-summary-container');
        const placeholder = document.getElementById('task-summary-placeholder');
        const textElement = document.getElementById('task-summary-text');
        
        // Show loading state
        btn.disabled = true;
        spinner.classList.remove('d-none');
        
        fetch(`/api/summarize-task-details/${taskId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Hide placeholder and show content
            placeholder.classList.add('d-none');
            container.classList.remove('d-none');
            
            // Format the summary with proper markdown-style rendering
            const formattedSummary = formatTaskSummary(data.summary);
            textElement.innerHTML = formattedSummary;
        })
        .catch(error => {
            console.error('Error generating task summary:', error);
            textElement.innerHTML = '<div class="alert alert-danger">Failed to generate AI summary. Please try again.</div>';
            placeholder.classList.add('d-none');
            container.classList.remove('d-none');
        })
        .finally(() => {
            // Hide loading state
            btn.disabled = false;
            spinner.classList.add('d-none');
        });
    });
    
    // Format task summary with proper styling
    function formatTaskSummary(text) {
        if (!text) return '';
        
        // Convert markdown-style headings to HTML
        let formatted = text
            .replace(/## (.*?)$/gm, '<h5 class="text-primary mt-3 mb-2"><strong>$1</strong></h5>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')
            .replace(/^- (.*?)$/gm, '<li class="mb-1">$1</li>')
            .replace(/^(\d+)\. (.*?)$/gm, '<li class="mb-1">$2</li>')
            .replace(/⚠️/g, '<span class="text-danger">⚠️</span>');
        
        // Wrap consecutive list items in ul/ol tags
        formatted = formatted.replace(/(<li class="mb-1">.*?<\/li>\n?)+/gs, function(match) {
            return '<ul class="ps-3 mb-2">' + match + '</ul>';
        });
        
        // Add line breaks for paragraphs
        formatted = formatted.replace(/\n\n/g, '<br><br>');
        
        return '<div class="ai-summary-formatted">' + formatted + '</div>';
    }
    
    // Handle back navigation to previous page
    function goBack() {
        // Check if there's a previous page in history
        if (document.referrer && document.referrer !== window.location.href) {
            window.history.back();
        } else {
            // Fallback to board detail if no history (demo-aware)
            {% if is_demo_mode %}
            window.location.href = '{% url "demo_board_detail" task.column.board.id %}';
            {% else %}
            window.location.href = '{% url "board_detail" task.column.board.id %}';
            {% endif %}
        }
    }

    // Handle prediction refresh
    document.getElementById('refresh-prediction')?.addEventListener('click', function() {
        const taskId = this.getAttribute('data-task-id');
        const btn = this;
        const container = document.getElementById('prediction-container');
        const icon = btn.querySelector('i');
        
        // Show loading state
        btn.disabled = true;
        icon.classList.add('fa-spin');
        
        fetch(`/api/task/${taskId}/prediction/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.has_prediction) {
                const pred = data.prediction;
                
                // Update the prediction display
                container.innerHTML = `
                    <div class="prediction-content">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="d-block ${pred.is_likely_late ? 'text-danger' : 'text-success'}">
                                    ${pred.predicted_date_formatted}
                                </strong>
                                <small class="text-muted">
                                    Range: ${pred.early_date_formatted} - ${pred.late_date_formatted}
                                </small>
                            </div>
                            <span class="badge ${pred.confidence_percentage >= 70 ? 'bg-success' : pred.confidence_percentage >= 50 ? 'bg-warning' : 'bg-secondary'}">
                                ${pred.confidence_percentage}% confidence
                            </span>
                        </div>
                        ${pred.is_likely_late ? `
                            <div class="alert alert-warning alert-sm mb-2 py-1 px-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <small>Likely to miss due date</small>
                            </div>
                        ` : ''}
                        <div class="mt-2">
                            <small class="text-muted d-block">
                                <i class="fas fa-chart-line me-1"></i>Based on ${pred.based_on_tasks} similar task${pred.based_on_tasks !== 1 ? 's' : ''}
                            </small>
                            
                            ${pred.similar_tasks && pred.similar_tasks.length > 0 ? `
                                <button type="button" class="btn btn-outline-info btn-sm mt-1 w-100" data-bs-toggle="collapse" data-bs-target="#similar-tasks-list">
                                    <i class="fas fa-tasks me-1"></i>View ${pred.similar_tasks.length} Similar Task${pred.similar_tasks.length !== 1 ? 's' : ''}
                                    <i class="fas fa-chevron-down ms-1"></i>
                                </button>
                                <div class="collapse mt-2" id="similar-tasks-list">
                                    <div class="card card-body py-2 px-2 bg-white border-info">
                                        <small class="text-primary mb-2"><strong><i class="fas fa-info-circle me-1"></i>Tasks used for prediction:</strong></small>
                                        <div class="list-group list-group-flush">
                                            ${pred.similar_tasks.map(task => `
                                                <a href="/tasks/${task.id}/" class="list-group-item list-group-item-action py-2 px-2 small border-start border-info border-3" target="_blank">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <i class="fas fa-check-circle text-success me-1"></i>
                                                            <strong>${task.title.split(' ').slice(0, 8).join(' ')}${task.title.split(' ').length > 8 ? '...' : ''}</strong>
                                                        </div>
                                                        <span class="badge bg-primary ms-2">${task.actual_duration_days.toFixed(1)} days</span>
                                                    </div>
                                                    <div class="text-muted mt-1" style="font-size: 0.85em;">
                                                        <span class="me-2">
                                                            <i class="fas fa-layer-group"></i> Complexity: ${task.complexity_score}/10
                                                        </span>
                                                        <span class="me-2">
                                                            <i class="fas fa-flag"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                                        </span>
                                                        <span>
                                                            <i class="fas fa-calendar-check"></i> ${task.completed_at ? new Date(task.completed_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'N/A'}
                                                        </span>
                                                    </div>
                                                </a>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="alert alert-info py-2 px-2 mt-2 mb-0">
                                    <small class="mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>No similar tasks found</strong>
                                        <br>Prediction based on rule-based estimation.
                                    </small>
                                </div>
                            `}
                        </div>
                        
                        <button type="button" class="btn btn-link btn-sm p-0 mt-1" data-bs-toggle="collapse" data-bs-target="#prediction-details">
                            <small>View factors <i class="fas fa-chevron-down"></i></small>
                        </button>
                        <div class="collapse mt-2" id="prediction-details">
                            <div class="card card-body py-2 px-2 bg-white">
                                <small class="text-muted">
                                    <strong>Factors considered:</strong><br>
                                    ${pred.factors.complexity_score ? `• Complexity: ${pred.factors.complexity_score}/10<br>` : ''}
                                    ${pred.factors.priority ? `• Priority: ${pred.factors.priority.charAt(0).toUpperCase() + pred.factors.priority.slice(1)}<br>` : ''}
                                    ${pred.factors.team_member_velocity ? `• Team velocity: ${pred.factors.team_member_velocity}x<br>` : ''}
                                    • Historical avg: ${pred.factors.historical_avg_days ? pred.factors.historical_avg_days.toFixed(1) : 'N/A'} days<br>
                                    • Method: ${pred.prediction_method.replace(/_/g, ' ')}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Show success message
                showToast('Prediction updated successfully!', 'success');
            } else {
                container.innerHTML = `
                    <div class="text-muted text-center py-2">
                        <i class="fas fa-info-circle mb-2"></i>
                        <small class="d-block">${data.message || 'Unable to generate prediction'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error refreshing prediction:', error);
            showToast('Failed to refresh prediction', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            icon.classList.remove('fa-spin');
        });
    });

    // Simple toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // ========== AI EXPLAINABILITY FUNCTIONS ==========
    
    // Cached risk analysis data from server
    const cachedRiskAnalysis = {{ task.risk_analysis|safe|default:"null" }};
    
    // Function to show risk explanation modal
    window.showRiskExplanation = function(taskId) {
        const btn = event.target.closest('button');
        
        // Check if we have valid cached data with actual risk assessment content
        const hasValidData = cachedRiskAnalysis && 
                            Object.keys(cachedRiskAnalysis).length > 0 &&
                            (cachedRiskAnalysis.risk_assessment || cachedRiskAnalysis.likelihood || cachedRiskAnalysis.impact);
        
        // If we have cached data, use it immediately for instant loading
        if (hasValidData) {
            showRiskAnalysisModal('{{ task.title|escapejs }}', cachedRiskAnalysis);
            return;
        }
        
        // Otherwise, fetch fresh data from API
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
        
        fetch(`/api/kanban/calculate-task-risk/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                task_id: taskId,
                title: '{{ task.title|escapejs }}',
                description: '{{ task.description|escapejs }}',
                priority: '{{ task.priority }}',
                board_id: {{ task.column.board.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.risk_analysis) {
                showRiskAnalysisModal('{{ task.title|escapejs }}', data.risk_analysis);
            } else {
                showToast('Failed to load risk explanation: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to load risk explanation. Please try again.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    };

    // Function to assess task risk (for tasks without risk assessment)
    window.assessTaskRisk = function(taskId) {
        const btn = document.getElementById(`assess-risk-btn-${taskId}`);
        if (!btn) return;
        
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';
        
        fetch(`/api/kanban/calculate-task-risk/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                task_id: taskId,
                title: '{{ task.title|escapejs }}',
                description: '{{ task.description|escapejs }}',
                priority: '{{ task.priority }}',
                board_id: {{ task.column.board.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.risk_analysis) {
                showRiskAnalysisModal('{{ task.title|escapejs }}', data.risk_analysis);
                showToast('Risk assessment completed!', 'success');
                // Reload page after 2 seconds to show updated risk
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Failed to assess risk: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to assess risk. Please try again.', 'error');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    };

    // Function to show risk analysis modal
    function showRiskAnalysisModal(taskTitle, riskAnalysis) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.setAttribute('tabindex', '-1');
        modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h5 class="modal-title">
                            <i class="bi bi-lightbulb-fill me-2"></i>
                            AI Risk Analysis: ${escapeHtml(taskTitle)}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        ${renderRiskAnalysisContent(riskAnalysis)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    // Render risk analysis content with explainability
    function renderRiskAnalysisContent(riskAnalysis) {
        // Check if we have any meaningful data
        if (!riskAnalysis || Object.keys(riskAnalysis).length === 0) {
            return `
                <div class="alert alert-warning">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>No Analysis Data Available</h6>
                    <p class="mb-0">Risk analysis data is not available for this task. The AI may still be processing the analysis.</p>
                </div>
            `;
        }
        
        // Check if we have the essential data structures
        const hasEssentialData = riskAnalysis.risk_assessment || riskAnalysis.likelihood || riskAnalysis.impact;
        if (!hasEssentialData) {
            return `
                <div class="alert alert-warning">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Incomplete Analysis Data</h6>
                    <p class="mb-0">The risk analysis is incomplete. Please try refreshing or contact support if the issue persists.</p>
                </div>
            `;
        }
        
        // Try to use AIExplainability module if available
        if (typeof AIExplainability !== 'undefined' && AIExplainability.renderExplainabilityPanel) {
            return AIExplainability.renderExplainabilityPanel(riskAnalysis);
        }
        
        // Fallback rendering with basic explainability
        const likelihood = riskAnalysis.likelihood || {};
        const impact = riskAnalysis.impact || {};
        const assessment = riskAnalysis.risk_assessment || {};
        const indicators = riskAnalysis.risk_indicators || [];
        
        let html = `
            <div class="container-fluid">
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Understanding This Analysis</h6>
                    <p class="mb-0">This AI assessment considers task complexity, dependencies, assignee skills, timeline, and historical data to predict potential risks.</p>
                </div>
        `;
        
        // Confidence Score
        if (riskAnalysis.confidence_score) {
            const confidence = Math.round(riskAnalysis.confidence_score * 100);
            html += `
                <div class="mb-4">
                    <h6 class="fw-bold">AI Confidence Level</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${confidence > 75 ? 'bg-success' : confidence > 50 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${confidence}%">
                            ${confidence}%
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Risk Scores
        html += `
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-warning text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Likelihood</h6>
                            <div class="display-4 text-warning">${likelihood.score || '?'}</div>
                            <small>${likelihood.percentage_range || ''}</small>
                            ${likelihood.confidence ? `<div class="mt-2"><small>Confidence: ${Math.round(likelihood.confidence * 100)}%</small></div>` : ''}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Impact</h6>
                            <div class="display-4 text-danger">${impact.score || '?'}</div>
                            <small>${impact.severity_level || ''}</small>
                            ${impact.confidence ? `<div class="mt-2"><small>Confidence: ${Math.round(impact.confidence * 100)}%</small></div>` : ''}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-primary text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Risk Score</h6>
                            <div class="display-4 text-primary">${assessment.risk_score || '?'}/9</div>
                            <small class="text-uppercase">${assessment.risk_level || ''}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Calculation Explanation
        html += `
            <div class="card mb-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calculator me-2"></i>How We Calculated This</h6>
                    <div class="text-center my-3">
                        <code class="fs-5">Likelihood (${likelihood.score}) × Impact (${impact.score}) = Risk Score (${assessment.risk_score})</code>
                    </div>
                    <p class="mb-0">${assessment.summary || ''}</p>
                </div>
            </div>
        `;
        
        // Contributing Factors
        if (assessment.contributing_factors && assessment.contributing_factors.length > 0) {
            html += `
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="bi bi-pie-chart me-2"></i>Contributing Factors</h6>
                    ${assessment.contributing_factors.map((factor, idx) => `
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-semibold">
                                    <span class="badge bg-secondary me-2">${idx + 1}</span>
                                    ${escapeHtml(factor.factor)}
                                </div>
                                <div class="fw-bold text-danger">${factor.contribution_percentage}%</div>
                            </div>
                            <p class="small text-muted mb-2">${escapeHtml(factor.description || '')}</p>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: ${factor.contribution_percentage}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Detailed Analysis
        html += `
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Likelihood Factors</h6>
                        </div>
                        <div class="card-body">
                            <p>${likelihood.reasoning || 'N/A'}</p>
                            ${likelihood.key_factors && likelihood.key_factors.length > 0 ? `
                                <ul class="mb-0">
                                    ${likelihood.key_factors.map(f => `<li>${escapeHtml(f)}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Impact Analysis</h6>
                        </div>
                        <div class="card-body">
                            <p>${impact.reasoning || 'N/A'}</p>
                            ${impact.affected_areas && impact.affected_areas.length > 0 ? `
                                <ul class="mb-0">
                                    ${impact.affected_areas.map(a => `<li>${escapeHtml(a)}</li>`).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Risk Indicators
        if (indicators.length > 0) {
            html += `
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Risk Indicators to Monitor</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Indicator</th>
                                        <th>Frequency</th>
                                        <th>Alert Threshold</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${indicators.map(ind => `
                                        <tr>
                                            <td>${escapeHtml(ind.indicator || '-')}</td>
                                            <td><span class="badge bg-info">${escapeHtml(ind.frequency || '-')}</span></td>
                                            <td><span class="badge bg-warning">${escapeHtml(ind.threshold || '-')}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Model Assumptions
        if (riskAnalysis.explainability) {
            const exp = riskAnalysis.explainability;
            html += `
                <div class="accordion" id="explainabilityAccordion">
                    ${exp.model_assumptions && exp.model_assumptions.length > 0 ? `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#assumptions">
                                    <i class="bi bi-lightbulb me-2"></i> Model Assumptions
                                </button>
                            </h2>
                            <div id="assumptions" class="accordion-collapse collapse" data-bs-parent="#explainabilityAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        ${exp.model_assumptions.map(a => `<li>${escapeHtml(a)}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${exp.data_limitations && exp.data_limitations.length > 0 ? `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#limitations">
                                    <i class="bi bi-exclamation-triangle me-2"></i> Data Limitations
                                </button>
                            </h2>
                            <div id="limitations" class="accordion-collapse collapse" data-bs-parent="#explainabilityAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        ${exp.data_limitations.map(l => `<li>${escapeHtml(l)}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    // Function to explain stakeholder recommendations
    window.explainStakeholderRecommendations = function(taskId) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title"><i class="bi bi-lightbulb me-2"></i>AI Stakeholder Insights</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>These stakeholders were identified based on:</strong></p>
                        <ul>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Task requirements and scope analysis</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Historical involvement in similar tasks</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Organizational roles and responsibilities</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Potential impact on their work streams</li>
                            <li><i class="bi bi-check-circle text-success me-2"></i>Communication patterns in the project</li>
                        </ul>
                        <div class="alert alert-light">
                            <p class="mb-0"><i class="bi bi-info-circle me-2"></i><strong>Note:</strong> AI recommendations improve over time as more project data becomes available.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    };

    // Utility: Escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Get CSRF token
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
    }

    // ============================================================================
    // TIME TRACKING FUNCTIONALITY
    // ============================================================================
    
    // Quick time log form submission
    const quickTimeLogForm = document.getElementById('quick-time-log-form');
    if (quickTimeLogForm) {
        quickTimeLogForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const hours = document.getElementById('time-hours').value;
            const date = document.getElementById('time-date').value;
            const description = document.getElementById('time-description').value;
            const taskId = {{ task.id }};
            
            if (!hours || parseFloat(hours) <= 0) {
                alert('Please enter valid hours');
                return;
            }
            
            const formData = new FormData();
            formData.append('hours', hours);
            formData.append('description', description);
            formData.append('work_date', date);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Disable button during submission
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Logging...';
            
            fetch(`/task/${taskId}/time/quick-log/`, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update total time display
                    document.getElementById('total-time-display').textContent = data.total_time + 'h';
                    
                    // Clear form
                    document.getElementById('time-hours').value = '';
                    document.getElementById('time-description').value = '';
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-1"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    quickTimeLogForm.insertBefore(alertDiv, quickTimeLogForm.firstChild);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => alertDiv.remove(), 3000);
                    
                    // Reload to show new entry
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to log time'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to log time. Please try again.');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Delete time entry
    document.querySelectorAll('.delete-time-entry').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!confirm('Delete this time entry?')) return;
            
            const entryId = this.dataset.entryId;
            const entryElement = this.closest('.list-group-item');
            
            fetch(`/time-entry/${entryId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update total time
                    document.getElementById('total-time-display').textContent = data.total_time + 'h';
                    
                    // Remove entry element
                    entryElement.remove();
                    
                    // If no entries left, show message
                    const entriesList = document.querySelector('#recent-time-entries .list-group');
                    if (entriesList && entriesList.children.length === 0) {
                        entriesList.innerHTML = '<p class="text-muted small text-center py-2 mb-0">No time logged yet</p>';
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete entry'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete entry. Please try again.');
            });
        });
    });
</script>

{% load static %}
<script src="{% static 'js/ai_features.js' %}?v={{ STATIC_VERSION|default:'2' }}"></script>
{% endblock %}