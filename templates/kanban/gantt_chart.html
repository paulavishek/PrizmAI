{% extends 'base.html' %}
{% load static %}

{% block title %}{{ board.name }} - Gantt Chart{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
<style>
    .gantt-container {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow-x: auto;
    }

    .gantt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .gantt-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    /* Ensure dependency arrows are visible */
    .gantt .arrow {
        fill: none;
        stroke: #666;
        stroke-width: 1.4px;
        opacity: 0.7;
    }

    .gantt .arrow:hover {
        stroke: #333;
        stroke-width: 2px;
        opacity: 1;
    }

    .gantt .arrow-head {
        fill: #666;
        stroke: #666;
    }

    .view-buttons {
        display: flex;
        gap: 8px;
    }

    .view-buttons button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .view-buttons button:hover {
        background: #f5f5f5;
    }

    .view-buttons button.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    /* Custom task colors based on priority */
    .gantt .bar-wrapper .bar[data-priority="low"] {
        fill: #6c757d !important;
    }

    .gantt .bar-wrapper .bar[data-priority="medium"] {
        fill: #4c9aff !important;
    }

    .gantt .bar-wrapper .bar[data-priority="high"] {
        fill: #ff9500 !important;
    }

    .gantt .bar-wrapper .bar[data-priority="urgent"] {
        fill: #ff5252 !important;
    }

    /* Hide progress overlay to prevent mixed colors */
    .gantt .bar-wrapper .bar-progress {
        display: none !important;
    }

    /* Ensure bars have uniform color */
    .gantt .bar-wrapper .bar {
        opacity: 1 !important;
    }

    /* Make bars clearly clickable */
    .gantt .bar-wrapper {
        cursor: pointer !important;
    }

    .gantt .bar-wrapper:hover .bar {
        opacity: 0.85;
        filter: brightness(1.1);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .board-tabs {
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
    }

    .board-tabs .nav-link {
        color: #495057;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 0.75rem 1.25rem;
    }

    .board-tabs .nav-link:hover {
        border-bottom-color: #dee2e6;
    }

    .board-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
        background: none;
    }

    .gantt-legend {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .legend-item {
        display: inline-block;
        margin-right: 20px;
        margin-bottom: 10px;
    }

    .legend-color {
        display: inline-block;
        width: 30px;
        height: 15px;
        margin-right: 5px;
        border-radius: 2px;
        vertical-align: middle;
    }

    /* Adaptive task labels - ALWAYS inside bars */
    .gantt .bar-label {
        font-size: 11px;
        font-weight: 500;
        fill: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        pointer-events: none;
        text-anchor: middle !important;  /* Center text horizontally */
        dominant-baseline: middle !important;  /* Center text vertically */
    }

    /* Override any outside positioning */
    .gantt .bar-label.outside-left,
    .gantt .bar-label.outside-right {
        fill: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
        font-weight: 500;
    }

    /* Task bar info overlay */
    .bar-info-overlay {
        pointer-events: none;
        font-size: 11px;
        fill: rgba(255, 255, 255, 0.95);
        font-weight: 500;
    }

    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        color: #374151;
        border: 2px solid rgba(255,255,255,0.3);
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
    }

    /* Custom tooltip for task bars */
    .gantt-tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
    }

    .gantt-tooltip.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>
                <i class="fas fa-project-diagram me-2"></i>{{ board.name }}
            </h1>
        </div>
        <div class="col-auto">
            <button onclick="goBack()" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i> Back
            </button>
        </div>
    </div>

    <!-- Board Navigation Tabs -->
    <ul class="nav nav-tabs board-tabs">
        <li class="nav-item">
            <a class="nav-link" href="{% url 'board_detail' board.id %}">
                <i class="fas fa-columns me-1"></i> Kanban View
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'board_analytics' board.id %}">
                <i class="fas fa-chart-bar me-1"></i> Analytics
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{% url 'gantt_chart' board.id %}">
                <i class="fas fa-chart-gantt me-1"></i> Gantt Chart
            </a>
        </li>
    </ul>

    <div class="gantt-container" style="position: relative;">
        <div class="gantt-header">
            <h2>ðŸ“Š Project Timeline</h2>
            <div class="view-buttons">
                <button class="view-btn" data-mode="Day">Day</button>
                <button class="view-btn active" data-mode="Week">Week</button>
                <button class="view-btn" data-mode="Month">Month</button>
            </div>
        </div>

        {% if tasks %}
            <svg id="gantt"></svg>
            
            <!-- Custom Tooltip -->
            <div class="gantt-tooltip" id="gantt-tooltip"></div>
            
            <!-- Legend -->
            <div class="gantt-legend">
                <strong>Legend:</strong>
                <div class="legend-item">
                    <span class="legend-color" style="background: #6c757d;"></span>
                    <span>Low Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #4c9aff;"></span>
                    <span>Medium Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff9500;"></span>
                    <span>High Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff5252;"></span>
                    <span>Urgent Priority</span>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No Tasks with Dates</h3>
                <p>Add start dates and due dates to your tasks to see them on the Gantt chart.</p>
                <a href="{% url 'board_detail' board.id %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i> Go to Board
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
    {% if tasks %}
    // Collect all task IDs for validation
    const allTaskIds = new Set([{% for task in tasks %}'{{ task.id }}'{% if not forloop.last %},{% endif %}{% endfor %}]);
    
    console.log('===== GANTT CHART DEBUG =====');
    console.log('Board: {{ board.name }}');
    console.log('Total tasks:', {{ tasks.count }});
    console.log('All task IDs:', Array.from(allTaskIds));
    
    // Prepare task data for Gantt chart with validated dependencies
    const tasks = [
        {% for task in tasks %}
        {
            id: '{{ task.id }}',
            name: '{{ task.title|escapejs }}',
            fullName: '{{ task.title|escapejs }}',
            start: '{{ task.start_date|date:"Y-m-d" }}',
            end: '{{ task.due_date|date:"Y-m-d" }}',
            progress: {{ task.progress|default:0 }},
            dependencies: '{% with deps=task.dependencies.all %}{% if deps %}{% for dep in deps %}{% if dep.start_date and dep.due_date %}{{ dep.id }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}{% endif %}{% endwith %}',
            custom_class: 'status-{{ task.column.name|lower|cut:" " }}',
            status: '{% if "done" in task.column.name|lower %}done{% elif "progress" in task.column.name|lower %}in_progress{% else %}todo{% endif %}',
            priority: '{{ task.priority }}',
            assigned_to: '{% if task.assigned_to %}{{ task.assigned_to.username }}{% else %}Unassigned{% endif %}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    console.log('Raw tasks data:', tasks);
    
    // Validate and clean up dependencies
    tasks.forEach(task => {
        if (task.dependencies) {
            const depIds = task.dependencies.split(',').filter(id => {
                const trimmedId = id.trim();
                // Only include dependencies that exist in our task list
                // and are not self-referencing
                return trimmedId && allTaskIds.has(trimmedId) && trimmedId !== task.id;
            });
            task.dependencies = depIds.join(',');
            
            // Debug logging
            if (depIds.length > 0) {
                console.log(`Task ${task.id} (${task.name}) depends on: ${task.dependencies}`);
            }
        }
    });

    let ganttChart = null;
    let currentViewMode = 'Week';

    // Initialize Gantt chart
    function initGantt(viewMode = 'Week') {
        const ganttElement = document.getElementById('gantt');
        currentViewMode = viewMode;
        
        if (ganttChart) {
            ganttChart.change_view_mode(viewMode);
            // After changing view mode, reapply custom attributes and enhancements
            setTimeout(() => {
                applyCustomStyling();
            }, 300);
        } else {
            // Debug: Log tasks with dependencies
            console.log('Tasks with dependencies:', tasks.filter(t => t.dependencies).map(t => ({
                id: t.id,
                name: t.name,
                dependencies: t.dependencies
            })));
            
            ganttChart = new Gantt('#gantt', tasks, {
                view_mode: viewMode,
                bar_height: 30,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                date_format: 'YYYY-MM-DD',
                language: 'en',
                popup_trigger: 'none', // Disable popup entirely for cleaner navigation
                on_click: function(task) {
                    // Redirect to task detail page immediately without showing popup
                    window.location.href = `/tasks/${task.id}/`;
                    return false; // Prevent default behavior
                },
                on_date_change: function(task, start, end) {
                    // Update task dates via API
                    updateTaskDates(task.id, start, end);
                    return false; // Prevent promise error
                },
                on_progress_change: function(task, progress) {
                    // Update task progress via API
                    updateTaskProgress(task.id, progress);
                    return false; // Prevent promise error
                }
            });

            // Apply custom styling for the first time
            setTimeout(() => {
                applyCustomStyling();
            }, 300);
        }
    }

    // Apply all custom styling, attributes, and enhancements
    function applyCustomStyling() {
        // Add custom attributes for styling
        tasks.forEach(task => {
            const barElement = document.querySelector(`.bar-wrapper[data-id="${task.id}"] .bar`);
            if (barElement) {
                // Set priority attribute for color styling
                barElement.setAttribute('data-priority', task.priority);
            }
        });

        // Add manual click handlers to all bars for better compatibility
        document.querySelectorAll('.bar-wrapper').forEach(barWrapper => {
            barWrapper.style.cursor = 'pointer';
            // Remove old listeners by cloning the node
            const newBarWrapper = barWrapper.cloneNode(true);
            barWrapper.parentNode.replaceChild(newBarWrapper, barWrapper);
            
            newBarWrapper.addEventListener('click', function(e) {
                const taskId = this.getAttribute('data-id');
                if (taskId) {
                    window.location.href = `/tasks/${taskId}/`;
                }
            });
        });

        // Enhance bars with additional info
        enhanceBarsWithInfo();

        // Add tooltip functionality
        addTooltipHandlers();
    }

    // Add tooltip functionality for task bars
    function addTooltipHandlers() {
        const tooltip = document.getElementById('gantt-tooltip');
        if (!tooltip) return;

        tasks.forEach(task => {
            const barWrapper = document.querySelector(`.bar-wrapper[data-id="${task.id}"]`);
            if (!barWrapper) return;

            // Store full task name as data attribute
            barWrapper.setAttribute('data-full-name', task.fullName);
            barWrapper.setAttribute('data-priority', task.priority);
            barWrapper.setAttribute('data-assigned-to', task.assigned_to);
            barWrapper.setAttribute('data-progress', task.progress);

            // Add mouseenter event
            barWrapper.addEventListener('mouseenter', function(e) {
                const fullName = this.getAttribute('data-full-name');
                const priority = this.getAttribute('data-priority');
                const assignedTo = this.getAttribute('data-assigned-to');
                const progress = this.getAttribute('data-progress');

                // Build tooltip content
                let tooltipContent = `<strong>${fullName}</strong><br>`;
                tooltipContent += `Priority: ${priority.charAt(0).toUpperCase() + priority.slice(1)}<br>`;
                tooltipContent += `Assigned: ${assignedTo}<br>`;
                tooltipContent += `Progress: ${progress}%`;

                tooltip.innerHTML = tooltipContent;
                tooltip.classList.add('show');
                
                // Position tooltip on first appearance
                positionTooltip(e);
            });

            // Add mousemove event to follow cursor with smart positioning
            barWrapper.addEventListener('mousemove', function(e) {
                positionTooltip(e);
            });

            // Add mouseleave event
            barWrapper.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
        });

        // Hide tooltip when clicking anywhere
        document.addEventListener('click', function(e) {
            tooltip.classList.remove('show');
        });

        // Hide tooltip when scrolling
        const ganttContainer = document.querySelector('.gantt-container');
        if (ganttContainer) {
            ganttContainer.addEventListener('scroll', function() {
                tooltip.classList.remove('show');
            });
        }

        // Hide tooltip when mouse moves outside the Gantt chart area
        const ganttElement = document.getElementById('gantt');
        if (ganttElement) {
            ganttElement.addEventListener('mouseleave', function() {
                // Small delay to allow moving between bars
                setTimeout(function() {
                    const stillHovering = document.querySelector('.bar-wrapper:hover');
                    if (!stillHovering) {
                        tooltip.classList.remove('show');
                    }
                }, 50);
            });
        }

        // Smart tooltip positioning function - ensures tooltip is always visible
        function positionTooltip(e) {
            const tooltip = document.getElementById('gantt-tooltip');
            if (!tooltip || !tooltip.classList.contains('show')) return;

            // Get tooltip dimensions (need to make it visible first to measure)
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;

            // Get viewport dimensions
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Offset from cursor
            const offsetX = 15;
            const offsetY = 15;

            // Determine best position: prioritize visibility
            let left, top;
            
            // Calculate space available in each direction
            const spaceRight = viewportWidth - e.clientX;
            const spaceLeft = e.clientX;
            const spaceBelow = viewportHeight - e.clientY;
            const spaceAbove = e.clientY;

            // Horizontal positioning: choose side with more space
            if (spaceRight >= tooltipWidth + offsetX) {
                // Enough space on the right
                left = e.pageX + offsetX;
            } else if (spaceLeft >= tooltipWidth + offsetX) {
                // Not enough on right, try left
                left = e.pageX - tooltipWidth - offsetX;
            } else {
                // Not enough on either side, center horizontally with margin
                left = Math.max(10, Math.min(e.pageX - tooltipWidth / 2, viewportWidth - tooltipWidth - 10));
            }

            // Vertical positioning: choose top or bottom based on available space
            if (spaceBelow >= tooltipHeight + offsetY) {
                // Enough space below cursor
                top = e.pageY + offsetY;
            } else if (spaceAbove >= tooltipHeight + offsetY) {
                // Not enough below, position above cursor
                top = e.pageY - tooltipHeight - offsetY;
            } else {
                // Not enough space above or below, position near cursor
                // Choose the side with more space
                if (spaceBelow > spaceAbove) {
                    // More space below, position at top of viewport
                    top = Math.max(10, e.pageY - tooltipHeight / 2);
                } else {
                    // More space above, position accordingly
                    top = Math.max(10, e.pageY - tooltipHeight + offsetY);
                }
            }

            // Final boundary checks to ensure tooltip stays within viewport
            left = Math.max(10, Math.min(left, viewportWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, viewportHeight - tooltipHeight - 10));

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // Enhance bars with task names only (no progress, no assignments)
    function enhanceBarsWithInfo() {
        tasks.forEach(task => {
            const barWrapper = document.querySelector(`.bar-wrapper[data-id="${task.id}"]`);
            if (!barWrapper) return;

            const bar = barWrapper.querySelector('.bar');
            if (!bar) return;

            const barRect = bar.getBBox();
            const barWidth = barRect.width;
            const barHeight = barRect.height;

            // Find and modify the existing label to show truncated name ONLY - INSIDE the bar
            const existingLabel = barWrapper.querySelector('.bar-label');
            if (existingLabel) {
                // Adjust minimum width threshold based on view mode
                let minWidth = 30;
                if (currentViewMode === 'Month') {
                    minWidth = 15; // More aggressive showing in month view
                } else if (currentViewMode === 'Day') {
                    minWidth = 50; // Day view has larger bars
                }

                // Show labels for bars wider than minimum width
                if (barWidth > minWidth) {
                    // Calculate how many characters can fit
                    let charWidth = 6.5; // Approximate width per character at font-size 11px
                    let fontSize = 11;
                    
                    // Adjust font size and char width based on view mode
                    if (currentViewMode === 'Month') {
                        fontSize = 10; // Slightly smaller font for month view
                        charWidth = 6;
                        existingLabel.style.fontSize = fontSize + 'px';
                    } else if (currentViewMode === 'Day') {
                        fontSize = 11;
                        charWidth = 6.5;
                        existingLabel.style.fontSize = fontSize + 'px';
                    } else {
                        // Week view
                        fontSize = 11;
                        charWidth = 6.5;
                        existingLabel.style.fontSize = fontSize + 'px';
                    }
                    
                    const availableWidth = barWidth - 8; // Minimal padding
                    const maxChars = Math.floor(availableWidth / charWidth);

                    let displayName = task.fullName;
                    
                    // For very small bars, show at least initial
                    if (maxChars < 2) {
                        displayName = task.fullName.substring(0, 1);
                    } else if (maxChars < 4) {
                        displayName = task.fullName.substring(0, maxChars);
                    } else if (displayName.length > maxChars) {
                        displayName = displayName.substring(0, maxChars - 3) + '...';
                    }

                    // Update the label text and FORCE position inside bar (centered)
                    existingLabel.textContent = displayName;
                    existingLabel.setAttribute('x', barRect.x + barWidth / 2);
                    existingLabel.setAttribute('y', barRect.y + barHeight / 2);
                    existingLabel.setAttribute('text-anchor', 'middle');
                    existingLabel.setAttribute('dominant-baseline', 'middle');
                    existingLabel.style.display = 'block';
                    
                    // Remove any outside positioning classes
                    existingLabel.classList.remove('outside-left', 'outside-right');
                } else {
                    // Only hide label if bar is extremely small
                    existingLabel.textContent = '';
                    existingLabel.style.display = 'none';
                }
            }
        });
    }

    // Initialize Gantt chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        initGantt('Week');
    });

    // Update task dates
    function updateTaskDates(taskId, start, end) {
        fetch(`/api/tasks/update-dates/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                task_id: taskId,
                start_date: formatDate(start),
                due_date: formatDate(end)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task dates updated successfully');
            } else {
                console.error('Failed to update task dates:', data.error);
                // Reload the page to revert changes
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error updating task dates:', error);
            location.reload();
        });
    }

    // Update task progress
    function updateTaskProgress(taskId, progress) {
        fetch(`/tasks/${taskId}/update-progress/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                progress: progress
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task progress updated successfully');
            } else {
                console.error('Failed to update task progress:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating task progress:', error);
        });
    }

    // Helper function to format date
    function formatDate(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // View mode buttons
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            // Change Gantt view mode
            const mode = this.getAttribute('data-mode');
            initGantt(mode);
        });
    });
    {% endif %}
    
    // Handle back navigation to previous page
    function goBack() {
        // Check if there's a previous page in history
        if (document.referrer && document.referrer !== window.location.href) {
            window.history.back();
        } else {
            // Fallback to board detail if no history
            window.location.href = '{% url "board_detail" board.id %}';
        }
    }
</script>
{% endblock %}
