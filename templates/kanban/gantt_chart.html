{% extends 'base.html' %}
{% load static %}

{% block title %}{{ board.name }} - Gantt Chart{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
<style>
    /* ============================================
       PROFESSIONAL GANTT CHART STYLES
       ============================================ */
    
    .gantt-container {
        padding: 24px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin: 20px 0;
        overflow-x: auto;
        border: 1px solid #e2e8f0;
    }

    .gantt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e2e8f0;
    }

    .gantt-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* ============================================
       PROFESSIONAL DEPENDENCY ARROWS
       ============================================ */

    /* Hide ALL default frappe-gantt arrow polygons */
    .gantt polygon {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    /* Main arrow path styling */
    .gantt .arrow,
    .gantt path.arrow {
        fill: none !important;
        stroke: #64748b !important;
        stroke-width: 2px !important;
        stroke-linecap: round !important;
        stroke-linejoin: round !important;
        opacity: 0.85 !important;
    }

    .gantt .arrow:hover,
    .gantt path.arrow:hover {
        stroke: #475569 !important;
        stroke-width: 2.5px !important;
        opacity: 1 !important;
    }

    /* ============================================
       VIEW MODE BUTTONS
       ============================================ */

    .view-buttons {
        display: flex;
        gap: 4px;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 8px;
    }

    .view-buttons button {
        padding: 10px 20px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        color: #64748b;
        font-size: 0.875rem;
    }

    .view-buttons button:hover {
        background: #e2e8f0;
        color: #334155;
    }

    .view-buttons button.active {
        background: #3b82f6;
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* ============================================
       TASK BAR PRIORITY COLORS
       ============================================ */

    .gantt .bar-wrapper .bar[data-priority="low"] {
        fill: #94a3b8 !important;
        rx: 6;
        ry: 6;
    }

    .gantt .bar-wrapper .bar[data-priority="medium"] {
        fill: #3b82f6 !important;
        rx: 6;
        ry: 6;
    }

    .gantt .bar-wrapper .bar[data-priority="high"] {
        fill: #f59e0b !important;
        rx: 6;
        ry: 6;
    }

    .gantt .bar-wrapper .bar[data-priority="urgent"] {
        fill: #ef4444 !important;
        rx: 6;
        ry: 6;
    }

    /* Hide progress overlay for cleaner look */
    .gantt .bar-wrapper .bar-progress {
        display: none !important;
    }

    /* Ensure bars have uniform color and rounded corners */
    .gantt .bar-wrapper .bar {
        opacity: 1 !important;
        rx: 6;
        ry: 6;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        transition: all 0.2s ease;
    }

    /* Make bars clearly clickable with hover effects */
    .gantt .bar-wrapper {
        cursor: pointer !important;
    }

    .gantt .bar-wrapper:hover .bar {
        filter: brightness(1.15) drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        transform: translateY(-1px);
    }

    /* Hide resize handles - they're misleading since drag is disabled */
    .gantt .handle,
    .gantt .bar-handle,
    .gantt .handle.left,
    .gantt .handle.right,
    .gantt .bar-wrapper .handle,
    rect.handle {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* Remove resize cursor on bar edges */
    .gantt .bar-wrapper:hover {
        cursor: pointer !important;
    }
    
    .gantt .bar:hover {
        cursor: pointer !important;
    }

    /* Empty state styling */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #64748b;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 24px;
        opacity: 0.4;
        color: #94a3b8;
    }

    .empty-state h3 {
        color: #475569;
        margin-bottom: 12px;
    }

    /* Board navigation tabs */
    .board-tabs {
        margin-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }

    .board-tabs .nav-link {
        color: #64748b;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .board-tabs .nav-link:hover {
        color: #3b82f6;
        border-bottom-color: #bfdbfe;
    }

    .board-tabs .nav-link.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
        background: none;
    }

    /* ============================================
       PROFESSIONAL LEGEND
       ============================================ */

    .gantt-legend {
        margin-top: 24px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 24px;
    }

    .gantt-legend strong {
        color: #475569;
        font-size: 0.875rem;
        margin-right: 8px;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        color: #64748b;
    }

    .legend-color {
        display: inline-block;
        width: 24px;
        height: 12px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* ============================================
       TASK BAR LABELS
       ============================================ */

    .gantt .bar-label {
        font-size: 11px;
        font-weight: 600;
        fill: white !important;
        text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        pointer-events: none;
        text-anchor: middle !important;
        dominant-baseline: middle !important;
        letter-spacing: 0.02em;
    }

    .gantt .bar-label.outside-left,
    .gantt .bar-label.outside-right {
        fill: white !important;
        text-shadow: 0 1px 3px rgba(0,0,0,0.4) !important;
        font-weight: 600;
    }

    /* Task bar info overlay */
    .bar-info-overlay {
        pointer-events: none;
        font-size: 11px;
        fill: rgba(255, 255, 255, 0.95);
        font-weight: 600;
    }

    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        color: #374151;
        border: 2px solid rgba(255,255,255,0.3);
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
    }

    /* ============================================
       PROFESSIONAL TOOLTIP
       ============================================ */

    .gantt-tooltip {
        position: fixed;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 13px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        display: none;
        border: 1px solid rgba(255,255,255,0.1);
        max-width: 320px;
    }

    .gantt-tooltip.show {
        display: block;
        animation: tooltipFadeIn 0.15s ease-out;
    }

    @keyframes tooltipFadeIn {
        from {
            opacity: 0;
            transform: translateY(4px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .gantt-tooltip strong {
        color: #f8fafc;
        display: block;
        margin-bottom: 6px;
        font-size: 14px;
    }

    .gantt-tooltip .tooltip-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 4px 0;
        color: #cbd5e1;
        font-size: 12px;
    }

    .gantt-tooltip .tooltip-row i {
        width: 14px;
        color: #94a3b8;
    }

    /* ============================================
       GANTT GRID AND TIMELINE STYLING
       ============================================ */

    .gantt .grid-header {
        fill: #f8fafc;
        stroke: #e2e8f0;
    }

    .gantt .grid-row {
        fill: transparent;
    }

    .gantt .grid-row:nth-child(even) {
        fill: rgba(241, 245, 249, 0.5);
    }

    .gantt .row-line {
        stroke: #e2e8f0;
    }

    .gantt .tick {
        stroke: #e2e8f0;
        stroke-width: 1;
    }

    .gantt .today-highlight {
        fill: rgba(59, 130, 246, 0.08);
        stroke: #3b82f6;
        stroke-width: 2;
        stroke-dasharray: 4, 4;
    }

    .gantt .lower-text, .gantt .upper-text {
        fill: #64748b;
        font-weight: 500;
        font-size: 12px;
    }

    .gantt .upper-text {
        fill: #475569;
        font-weight: 600;
    }

    /* ============================================
       DEPENDENCY ARROW ENHANCEMENTS
       ============================================ */

    /* Ensure all arrow heads (markers) are hidden except our custom one */
    .gantt marker polygon {
        display: block !important;
    }



    /* ============================================
       ASSIGNEE INITIALS ON TASK BARS
       ============================================ */

    .assignee-initials {
        font-size: 10px;
        font-weight: 700;
        fill: white;
        text-anchor: middle;
        dominant-baseline: middle;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .assignee-circle {
        fill: rgba(255, 255, 255, 0.25);
        stroke: rgba(255, 255, 255, 0.4);
        stroke-width: 1;
    }

    /* ============================================
       PHASE-BASED VIEW STYLES
       ============================================ */

    .phase-view-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .phase-view-controls .btn {
        transition: all 0.2s ease;
    }

    .phase-view-controls .btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* Phase bar styling */
    .gantt .bar-wrapper .bar[data-is-phase="true"] {
        fill: #6366f1 !important;
        rx: 8;
        ry: 8;
        cursor: pointer;
        filter: drop-shadow(0 3px 6px rgba(99, 102, 241, 0.3));
    }

    .gantt .bar-wrapper .bar[data-is-phase="true"]:hover {
        filter: brightness(1.1) drop-shadow(0 4px 8px rgba(99, 102, 241, 0.4));
    }

    /* Phase expanded state */
    .gantt .bar-wrapper .bar[data-is-phase="true"][data-expanded="true"] {
        fill: #4f46e5 !important;
    }

    /* Milestone diamond marker styles */
    .milestone-diamond {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .milestone-diamond:hover {
        transform: scale(1.2);
        filter: brightness(1.2);
    }

    .gantt .bar-wrapper .bar[data-is-milestone="true"] {
        fill: #f59e0b !important;
        rx: 0;
        ry: 0;
    }

    /* Hide the regular bar for milestones - we'll draw a diamond instead */
    .gantt .bar-wrapper[data-is-milestone="true"] .bar {
        opacity: 0 !important;
    }

    /* Milestone diamond SVG element */
    .milestone-diamond-shape {
        fill: #f59e0b;
        stroke: #d97706;
        stroke-width: 1.5;
        cursor: pointer;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        transition: all 0.2s ease;
    }

    .milestone-diamond-shape:hover {
        fill: #fbbf24;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.25));
        transform-origin: center;
    }

    .milestone-label {
        font-size: 11px;
        font-weight: 600;
        fill: #92400e !important;
        pointer-events: none;
    }

    /* Phase collapse indicator */
    .phase-indicator {
        font-size: 0.75rem;
        padding: 2px 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin-left: 8px;
    }

    /* Phase info panel */
    .phase-info-panel {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .phase-info-panel .phase-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 4px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .phase-info-panel .phase-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .phase-info-panel .phase-item.expanded {
        background: #eff6ff;
        border-color: #3b82f6;
    }

    .phase-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .phase-badge.tasks {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .phase-badge.milestones {
        background: #fef3c7;
        color: #b45309;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>
                <i class="fas fa-project-diagram me-2"></i>{{ board.name }}
            </h1>
        </div>
        <div class="col-auto">
            <button onclick="goBack()" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i> Back
            </button>
        </div>
    </div>

    <!-- Board Navigation Tabs -->
    <ul class="nav nav-tabs board-tabs">
        <li class="nav-item">
            <a class="nav-link" href="{% if is_demo_mode %}{% url 'demo_board_detail' board.id %}{% else %}{% url 'board_detail' board.id %}{% endif %}">
                <i class="fas fa-columns me-1"></i> Kanban View
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'board_analytics' board.id %}">
                <i class="fas fa-chart-bar me-1"></i> Analytics
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{% url 'gantt_chart' board.id %}">
                <i class="fas fa-chart-gantt me-1"></i> Gantt Chart
            </a>
        </li>
    </ul>

    <div class="gantt-container" style="position: relative;">
        <div class="gantt-header">
            <h2>ðŸ“Š Project Timeline</h2>
            <div class="d-flex align-items-center gap-3">
                {% if has_phases %}
                <!-- Phase/Task View Toggle -->
                <div class="phase-view-controls btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" id="phase-view-btn" onclick="setPhaseView()">
                        <i class="fas fa-layer-group me-1"></i> Phase View
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="all-tasks-btn" onclick="setAllTasksView()">
                        <i class="fas fa-tasks me-1"></i> All Tasks
                    </button>
                </div>
                {% endif %}
                <div class="view-buttons">
                    <button class="view-btn" data-mode="Day">Day</button>
                    <button class="view-btn active" data-mode="Week">Week</button>
                    <button class="view-btn" data-mode="Month">Month</button>
                </div>
            </div>
        </div>

        {% if has_phases %}
        <!-- Phase Information Panel -->
        <div class="phase-info-panel" id="phase-info-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><i class="fas fa-layer-group me-1"></i> Phases</strong>
                <small class="text-muted">Click a phase to expand/collapse</small>
            </div>
            <div id="phase-items-container">
                <!-- Phase items will be populated by JavaScript -->
            </div>
        </div>
        {% endif %}

        {% if tasks %}
            <svg id="gantt"></svg>
            
            <!-- Custom Tooltip -->
            <div class="gantt-tooltip" id="gantt-tooltip"></div>
            
            <!-- Legend -->
            <div class="gantt-legend">
                <strong>Legend:</strong>
                <div class="legend-item">
                    <span class="legend-color" style="background: #94a3b8;"></span>
                    <span>Low Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #3b82f6;"></span>
                    <span>Medium Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #f59e0b;"></span>
                    <span>High Priority</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ef4444;"></span>
                    <span>Urgent Priority</span>
                </div>
                <div class="legend-item">
                    <svg width="22" height="16" style="vertical-align: middle;">
                        <circle cx="11" cy="8" r="7" fill="rgba(59,130,246,0.3)" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                        <text x="11" y="8" text-anchor="middle" dominant-baseline="middle" font-size="8" font-weight="700" fill="white">AB</text>
                    </svg>
                    <span>Assignee</span>
                </div>
                {% if has_phases %}
                <div class="legend-item">
                    <span class="legend-color" style="background: #6366f1;"></span>
                    <span>Phase</span>
                </div>
                {% endif %}
                <div class="legend-item">
                    <svg width="20" height="20" style="vertical-align: middle;">
                        <polygon points="10,2 18,10 10,18 2,10" fill="#f59e0b" stroke="#d97706" stroke-width="1"/>
                    </svg>
                    <span>Milestone</span>
                </div>
                <div class="legend-item" style="margin-left: auto;">
                    <svg width="40" height="12" style="vertical-align: middle;">
                        <defs>
                            <marker id="arrowhead-legend" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                                <polygon points="0 0, 6 3, 0 6" fill="#64748b"/>
                            </marker>
                        </defs>
                        <path d="M 2 6 L 30 6" stroke="#64748b" stroke-width="2" fill="none" marker-end="url(#arrowhead-legend)"/>
                    </svg>
                    <span>Dependency</span>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No Tasks with Dates</h3>
                <p>Add start dates and due dates to your tasks to see them on the Gantt chart.</p>
                <a href="{% if is_demo_mode %}{% url 'demo_board_detail' board.id %}{% else %}{% url 'board_detail' board.id %}{% endif %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-1"></i> Go to Board
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
    // Suppress known Frappe Gantt library errors related to $bar
    // These occur during mouse interactions when bars are not yet rendered
    window.addEventListener('error', function(event) {
        if (event.message && (
            event.message.includes("Cannot read properties of undefined (reading '$bar')") ||
            event.message.includes("Cannot read properties of undefined (reading 'group')")
        )) {
            event.preventDefault();
            event.stopPropagation();
            return true; // Suppress the error
        }
    }, true);
    
    {% if tasks %}
    // Collect all task IDs for validation
    const allTaskIds = new Set([{% for task in tasks %}'{{ task.id }}'{% if not forloop.last %},{% endif %}{% endfor %}]);
    
    console.log('===== GANTT CHART DEBUG =====');
    console.log('Board: {{ board.name }}');
    console.log('Total tasks:', {{ tasks.count }});
    console.log('All task IDs:', Array.from(allTaskIds));
    
    // Phase data from Django (for phase-based view)
    const phasesData = {{ phases_data_json|safe }};
    const hasPhases = {{ has_phases|yesno:"true,false" }};
    const numPhases = {{ num_phases|default:0 }};

    // View state
    let currentView = hasPhases ? 'phases' : 'all';
    let expandedPhases = new Set();

    // Prepare task data for Gantt chart with validated dependencies
    const tasks = [
        {% for task in tasks %}
        {
            id: '{{ task.id }}',
            name: '{{ task.title|escapejs }}',
            fullName: '{{ task.title|escapejs }}',
            start: '{{ task.start_date|date:"Y-m-d" }}',
            end: '{{ task.due_date|date:"Y-m-d" }}',
            progress: {{ task.progress|default:0 }},
            dependencies: '{% with deps=task.dependencies.all %}{% if deps %}{% for dep in deps %}{% if dep.start_date and dep.due_date %}{{ dep.id }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}{% endif %}{% endwith %}',
            custom_class: 'status-{{ task.column.name|lower|cut:" " }}',
            status: '{% if "done" in task.column.name|lower %}done{% elif "progress" in task.column.name|lower %}in_progress{% else %}todo{% endif %}',
            priority: '{{ task.priority }}',
            assigned_to: '{% if task.assigned_to %}{{ task.assigned_to.username }}{% else %}Unassigned{% endif %}',
            assignee_first_name: '{% if task.assigned_to %}{{ task.assigned_to.first_name|escapejs }}{% endif %}',
            assignee_last_name: '{% if task.assigned_to %}{{ task.assigned_to.last_name|escapejs }}{% endif %}',
            item_type: '{{ task.item_type|default:"task" }}',
            phase: '{{ task.phase|default:""|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    console.log('Raw tasks data:', tasks);
    
    // Validate and fix task dates to prevent negative width errors
    // frappe-gantt requires end date >= start date
    tasks.forEach(task => {
        const startDate = new Date(task.start);
        const endDate = new Date(task.end);
        
        // Check for invalid dates
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            console.warn(`Task ${task.id} has invalid dates, using today as fallback`);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            task.start = today.toISOString().split('T')[0];
            task.end = tomorrow.toISOString().split('T')[0];
        } else if (endDate < startDate) {
            // If end date is before start date, swap them
            console.warn(`Task ${task.id} has end date before start date, swapping`);
            const temp = task.start;
            task.start = task.end;
            task.end = temp;
        } else if (endDate.getTime() === startDate.getTime()) {
            // If dates are the same, add 1 day to end date to ensure visible bar width
            console.warn(`Task ${task.id} has same start and end date, extending by 1 day`);
            const newEnd = new Date(endDate);
            newEnd.setDate(newEnd.getDate() + 1);
            task.end = newEnd.toISOString().split('T')[0];
        }
    });
    
    // Validate and clean up dependencies
    tasks.forEach(task => {
        if (task.dependencies) {
            const depIds = task.dependencies.split(',').filter(id => {
                const trimmedId = id.trim();
                // Only include dependencies that exist in our task list
                // and are not self-referencing
                return trimmedId && allTaskIds.has(trimmedId) && trimmedId !== task.id;
            });
            task.dependencies = depIds.join(',');
            
            // Debug logging
            if (depIds.length > 0) {
                console.log(`Task ${task.id} (${task.name}) depends on: ${task.dependencies}`);
            }
        }
    });

    let ganttChart = null;
    let currentViewMode = 'Week';

    // Initialize Gantt chart
    function initGantt(viewMode = 'Week') {
        const ganttElement = document.getElementById('gantt');
        currentViewMode = viewMode;
        
        if (ganttChart) {
            ganttChart.change_view_mode(viewMode);
            // After changing view mode, reapply custom attributes and enhancements
            setTimeout(() => {
                applyCustomStyling();
            }, 300);
        } else {
            // Debug: Log tasks with dependencies
            console.log('Tasks with dependencies:', tasks.filter(t => t.dependencies).map(t => ({
                id: t.id,
                name: t.name,
                dependencies: t.dependencies
            })));
            
            ganttChart = new Gantt('#gantt', tasks, {
                view_mode: viewMode,
                bar_height: 32,
                bar_corner_radius: 6,
                arrow_curve: 10, // Smooth curves for clean routing
                padding: 20,
                date_format: 'YYYY-MM-DD',
                language: 'en',
                custom_popup_html: null, // Disable default popup
                popup_trigger: 'none', // Disable popup entirely for cleaner navigation
                on_click: function(task) {
                    // Redirect to task detail page immediately without showing popup
                    window.location.href = `/tasks/${task.id}/`;
                    return false; // Prevent default behavior
                },
                on_date_change: function(task, start, end) {
                    // Update task dates via API
                    updateTaskDates(task.id, start, end);
                    return false; // Prevent promise error
                },
                on_progress_change: function(task, progress) {
                    // Update task progress via API
                    updateTaskProgress(task.id, progress);
                    return false; // Prevent promise error
                }
            });

            // Apply custom styling for the first time
            setTimeout(() => {
                applyCustomStyling();
            }, 300);
            
            // Apply arrow styling again after a longer delay to ensure all SVG elements are rendered
            setTimeout(() => {
                enhanceDependencyArrows();
            }, 600);
            
            // Final cleanup pass for any remaining arrow issues
            setTimeout(() => {
                enhanceDependencyArrows();
            }, 1000);
        }
    }

    // Apply all custom styling, attributes, and enhancements
    function applyCustomStyling() {
        // Add custom attributes for styling
        tasks.forEach(task => {
            const barElement = document.querySelector(`.bar-wrapper[data-id="${task.id}"] .bar`);
            if (barElement) {
                // Set priority attribute for color styling
                barElement.setAttribute('data-priority', task.priority);
            }
        });

        // Enhance dependency arrows with better styling
        enhanceDependencyArrows();

        // Add manual click handlers to all bars for better compatibility
        document.querySelectorAll('.bar-wrapper').forEach(barWrapper => {
            barWrapper.style.cursor = 'pointer';
            // Remove old listeners by cloning the node
            const newBarWrapper = barWrapper.cloneNode(true);
            barWrapper.parentNode.replaceChild(newBarWrapper, barWrapper);
            
            newBarWrapper.addEventListener('click', function(e) {
                const taskId = this.getAttribute('data-id');
                if (taskId) {
                    // Check if this is a phase bar (id starts with 'phase-')
                    if (taskId.startsWith('phase-')) {
                        // Extract phase name and toggle
                        const phaseNum = taskId.replace('phase-', '');
                        const phaseName = `Phase ${phaseNum}`;
                        togglePhase(phaseName);
                    } else if (taskId.startsWith('milestone-')) {
                        // Navigate to milestone task detail
                        const milestoneId = taskId.replace('milestone-', '');
                        window.location.href = `/tasks/${milestoneId}/`;
                    } else {
                        // Navigate to regular task detail
                        window.location.href = `/tasks/${taskId}/`;
                    }
                }
            });
        });

        // Enhance bars with additional info
        enhanceBarsWithInfo();

        // Add assignee initials to task bars
        addAssigneeInitials();

        // Add tooltip functionality
        addTooltipHandlers();
    }

    // Fix frappe-gantt's arrow rendering
    function enhanceDependencyArrows() {
        const ganttSvg = document.querySelector('#gantt');
        if (!ganttSvg) return;

        // Find or create defs
        let defs = ganttSvg.querySelector('defs');
        if (!defs) {
            defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            ganttSvg.insertBefore(defs, ganttSvg.firstChild);
        }

        // Check if our custom arrowhead already exists
        let existingMarker = defs.querySelector('#arrowhead-custom');
        if (!existingMarker) {
            // Create ONE clean arrowhead marker with unique ID
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead-custom');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '10');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '5');
            marker.setAttribute('orient', 'auto');
            marker.setAttribute('markerUnits', 'strokeWidth');

            // Clean filled triangle arrowhead
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0,0 10,5 0,10 2,5');
            polygon.setAttribute('fill', '#64748b');

            marker.appendChild(polygon);
            defs.appendChild(marker);
        }

        // Remove ALL standalone polygons outside of defs (the distorted default arrows)
        ganttSvg.querySelectorAll('polygon').forEach(polygon => {
            // Keep polygons in defs (markers) and milestone diamonds
            if (!polygon.closest('defs') && !polygon.classList.contains('milestone-diamond-shape')) {
                polygon.remove();
            }
        });

        // Style all arrow paths with proper attributes
        ganttSvg.querySelectorAll('path').forEach(path => {
            const className = path.getAttribute('class') || '';

            // Only target arrow paths (frappe-gantt uses 'arrow' class)
            if (className.includes('arrow')) {
                // Apply clean styling
                path.setAttribute('stroke', '#64748b');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('stroke-linecap', 'round');
                path.setAttribute('stroke-linejoin', 'round');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead-custom)');
                path.style.opacity = '0.85';
                
                // Remove any inline polygon styling that might interfere
                path.querySelectorAll('polygon').forEach(p => p.remove());
            }
        });

        // Also look for paths inside .arrow groups
        ganttSvg.querySelectorAll('.arrow path, g.arrow path').forEach(path => {
            path.setAttribute('stroke', '#64748b');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#arrowhead-custom)');
            path.style.opacity = '0.85';
        });
    }

    // Add tooltip functionality for task bars
    function addTooltipHandlers() {
        const tooltip = document.getElementById('gantt-tooltip');
        if (!tooltip) return;

        tasks.forEach(task => {
            const barWrapper = document.querySelector(`.bar-wrapper[data-id="${task.id}"]`);
            if (!barWrapper) return;

            // Store full task name as data attribute
            barWrapper.setAttribute('data-full-name', task.fullName);
            barWrapper.setAttribute('data-priority', task.priority);
            barWrapper.setAttribute('data-assigned-to', task.assigned_to);
            barWrapper.setAttribute('data-progress', task.progress);
            barWrapper.setAttribute('data-start', task.start);
            barWrapper.setAttribute('data-end', task.end);

            // Add mouseenter event
            barWrapper.addEventListener('mouseenter', function(e) {
                const fullName = this.getAttribute('data-full-name');
                const priority = this.getAttribute('data-priority');
                const assignedTo = this.getAttribute('data-assigned-to');
                const progress = this.getAttribute('data-progress');
                const startDate = this.getAttribute('data-start');
                const endDate = this.getAttribute('data-end');

                // Build enhanced tooltip content
                let tooltipContent = `<strong>${fullName}</strong>`;
                tooltipContent += `<div class="tooltip-row"><i class="fas fa-flag"></i> Priority: ${priority.charAt(0).toUpperCase() + priority.slice(1)}</div>`;
                tooltipContent += `<div class="tooltip-row"><i class="fas fa-user"></i> ${assignedTo}</div>`;
                tooltipContent += `<div class="tooltip-row"><i class="fas fa-calendar"></i> ${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}</div>`;
                tooltipContent += `<div class="tooltip-row"><i class="fas fa-tasks"></i> Progress: ${progress}%</div>`;

                tooltip.innerHTML = tooltipContent;
                tooltip.classList.add('show');
                
                // Position tooltip on first appearance
                positionTooltip(e);
            });

            // Add mousemove event to follow cursor with smart positioning
            barWrapper.addEventListener('mousemove', function(e) {
                positionTooltip(e);
            });

            // Add mouseleave event
            barWrapper.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });
        });

        // Hide tooltip when clicking anywhere
        document.addEventListener('click', function(e) {
            tooltip.classList.remove('show');
        });

        // Hide tooltip when scrolling
        const ganttContainer = document.querySelector('.gantt-container');
        if (ganttContainer) {
            ganttContainer.addEventListener('scroll', function() {
                tooltip.classList.remove('show');
            });
        }

        // Hide tooltip when mouse moves outside the Gantt chart area
        const ganttElement = document.getElementById('gantt');
        if (ganttElement) {
            ganttElement.addEventListener('mouseleave', function() {
                // Small delay to allow moving between bars
                setTimeout(function() {
                    const stillHovering = document.querySelector('.bar-wrapper:hover');
                    if (!stillHovering) {
                        tooltip.classList.remove('show');
                    }
                }, 50);
            });
        }

        // Smart tooltip positioning function - ensures tooltip is always visible
        function positionTooltip(e) {
            const tooltip = document.getElementById('gantt-tooltip');
            if (!tooltip || !tooltip.classList.contains('show')) return;

            // Get tooltip dimensions (need to make it visible first to measure)
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;

            // Get viewport dimensions
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Offset from cursor
            const offsetX = 15;
            const offsetY = 15;

            // Determine best position: prioritize visibility
            let left, top;
            
            // Calculate space available in each direction
            const spaceRight = viewportWidth - e.clientX;
            const spaceLeft = e.clientX;
            const spaceBelow = viewportHeight - e.clientY;
            const spaceAbove = e.clientY;

            // Horizontal positioning: choose side with more space
            if (spaceRight >= tooltipWidth + offsetX) {
                // Enough space on the right
                left = e.pageX + offsetX;
            } else if (spaceLeft >= tooltipWidth + offsetX) {
                // Not enough on right, try left
                left = e.pageX - tooltipWidth - offsetX;
            } else {
                // Not enough on either side, center horizontally with margin
                left = Math.max(10, Math.min(e.pageX - tooltipWidth / 2, viewportWidth - tooltipWidth - 10));
            }

            // Vertical positioning: choose top or bottom based on available space
            if (spaceBelow >= tooltipHeight + offsetY) {
                // Enough space below cursor
                top = e.pageY + offsetY;
            } else if (spaceAbove >= tooltipHeight + offsetY) {
                // Not enough below, position above cursor
                top = e.pageY - tooltipHeight - offsetY;
            } else {
                // Not enough space above or below, position near cursor
                // Choose the side with more space
                if (spaceBelow > spaceAbove) {
                    // More space below, position at top of viewport
                    top = Math.max(10, e.pageY - tooltipHeight / 2);
                } else {
                    // More space above, position accordingly
                    top = Math.max(10, e.pageY - tooltipHeight + offsetY);
                }
            }

            // Final boundary checks to ensure tooltip stays within viewport
            left = Math.max(10, Math.min(left, viewportWidth - tooltipWidth - 10));
            top = Math.max(10, Math.min(top, viewportHeight - tooltipHeight - 10));

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // Enhance bars with task names only (no progress, no assignments)
    function enhanceBarsWithInfo() {
        tasks.forEach(task => {
            const barWrapper = document.querySelector(`.bar-wrapper[data-id="${task.id}"]`);
            if (!barWrapper) return;

            const bar = barWrapper.querySelector('.bar');
            if (!bar) return;

            // Safely get bounding box - getBBox() can throw or return invalid values
            let barRect;
            try {
                barRect = bar.getBBox();
            } catch (e) {
                console.warn(`Could not get bounding box for task ${task.id}:`, e);
                return;
            }
            
            // Validate dimensions - skip if invalid (negative or zero)
            const barWidth = barRect.width;
            const barHeight = barRect.height;
            
            if (barWidth <= 0 || barHeight <= 0 || !isFinite(barWidth) || !isFinite(barHeight)) {
                console.warn(`Invalid bar dimensions for task ${task.id}: width=${barWidth}, height=${barHeight}`);
                return;
            }

            // Calculate space reserved for assignee initials (if task has assignee and bar is wide enough)
            const hasAssignee = task.assigned_to !== 'Unassigned';
            const initialsSpace = (hasAssignee && barWidth >= 40) ? 28 : 0; // 20px circle + 8px padding

            // Find and modify the existing label to show truncated name ONLY - INSIDE the bar
            const existingLabel = barWrapper.querySelector('.bar-label');
            if (existingLabel) {
                // Adjust minimum width threshold based on view mode - more aggressive showing
                let minWidth = 20;  // Show text for bars as small as 20px
                if (currentViewMode === 'Month') {
                    minWidth = 12; // More aggressive showing in month view
                } else if (currentViewMode === 'Day') {
                    minWidth = 40; // Day view has larger bars
                }

                // Show labels for bars wider than minimum width
                if (barWidth > minWidth) {
                    // Calculate how many characters can fit - use smaller font for narrow bars
                    let charWidth = 5.5; // Tighter character width estimate
                    let fontSize = 10;
                    
                    // Adjust font size based on bar width for better readability
                    if (barWidth < 40) {
                        fontSize = 8;
                        charWidth = 4.5;
                    } else if (barWidth < 80) {
                        fontSize = 9;
                        charWidth = 5;
                    } else if (currentViewMode === 'Month') {
                        fontSize = 9;
                        charWidth = 5;
                    } else if (currentViewMode === 'Day') {
                        fontSize = 11;
                        charWidth = 6;
                    } else {
                        // Week view
                        fontSize = 10;
                        charWidth = 5.5;
                    }
                    
                    existingLabel.style.fontSize = fontSize + 'px';
                    
                    // Account for assignee initials space on the right
                    const availableWidth = barWidth - 6 - initialsSpace; // Padding + initials space
                    const maxChars = Math.floor(availableWidth / charWidth);

                    let displayName = task.fullName;
                    
                    // For very small bars, show at least initial
                    if (maxChars < 2) {
                        displayName = task.fullName.substring(0, 1);
                    } else if (maxChars < 4) {
                        displayName = task.fullName.substring(0, maxChars);
                    } else if (displayName.length > maxChars) {
                        displayName = displayName.substring(0, maxChars - 3) + '...';
                    }

                    // Update the label text and position - shift left if there's an assignee
                    existingLabel.textContent = displayName;
                    const labelX = barRect.x + (barWidth - initialsSpace) / 2;
                    existingLabel.setAttribute('x', labelX);
                    existingLabel.setAttribute('y', barRect.y + barHeight / 2);
                    existingLabel.setAttribute('text-anchor', 'middle');
                    existingLabel.setAttribute('dominant-baseline', 'middle');
                    existingLabel.style.display = 'block';
                    
                    // Remove any outside positioning classes
                    existingLabel.classList.remove('outside-left', 'outside-right');
                } else {
                    // Only hide label if bar is extremely small
                    existingLabel.textContent = '';
                    existingLabel.style.display = 'none';
                }
            }
        });
    }

    // Add assignee initials to task bars (like ClickUp)
    function addAssigneeInitials() {
        const ganttSvg = document.querySelector('#gantt');
        if (!ganttSvg) return;

        // Remove existing assignee elements to prevent duplicates
        ganttSvg.querySelectorAll('.assignee-group').forEach(el => el.remove());

        tasks.forEach(task => {
            // Skip if no assignee
            if (task.assigned_to === 'Unassigned') return;

            const barWrapper = document.querySelector(`.bar-wrapper[data-id="${task.id}"]`);
            if (!barWrapper) return;

            const bar = barWrapper.querySelector('.bar');
            if (!bar) return;

            let barRect;
            try {
                barRect = bar.getBBox();
            } catch (e) {
                return;
            }

            // Only show initials if bar is wide enough (at least 40px for circle)
            if (barRect.width < 40) return;

            // Get initials from first and last name, fallback to username
            let initials = '';
            if (task.assignee_first_name && task.assignee_last_name) {
                initials = (task.assignee_first_name.charAt(0) + task.assignee_last_name.charAt(0)).toUpperCase();
            } else if (task.assignee_first_name) {
                initials = task.assignee_first_name.substring(0, 2).toUpperCase();
            } else {
                // Use first 2 chars of username
                initials = task.assigned_to.substring(0, 2).toUpperCase();
            }

            // Create SVG group for assignee avatar
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('class', 'assignee-group');

            // Position at the right side of the bar
            const circleRadius = 10;
            const circleX = barRect.x + barRect.width - circleRadius - 4;
            const circleY = barRect.y + barRect.height / 2;

            // Create circle background
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', circleX);
            circle.setAttribute('cy', circleY);
            circle.setAttribute('r', circleRadius);
            circle.setAttribute('class', 'assignee-circle');
            group.appendChild(circle);

            // Create initials text
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', circleX);
            text.setAttribute('y', circleY);
            text.setAttribute('class', 'assignee-initials');
            text.textContent = initials;
            group.appendChild(text);

            // Insert into the bar wrapper
            barWrapper.appendChild(group);
        });
    }

    // Initialize Gantt chart on page load
    document.addEventListener('DOMContentLoaded', function() {
        initGantt('Week');
    });

    // Update task dates
    function updateTaskDates(taskId, start, end) {
        fetch(`/api/tasks/update-dates/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                task_id: taskId,
                start_date: formatDate(start),
                due_date: formatDate(end)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task dates updated successfully');
            } else {
                console.error('Failed to update task dates:', data.error);
                // Reload the page to revert changes
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error updating task dates:', error);
            location.reload();
        });
    }

    // Update task progress
    function updateTaskProgress(taskId, progress) {
        fetch(`/tasks/${taskId}/update-progress/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                progress: progress
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task progress updated successfully');
            } else {
                console.error('Failed to update task progress:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating task progress:', error);
        });
    }

    // Helper function to format date
    function formatDate(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Helper function to format date for display in tooltips
    function formatDateDisplay(dateStr) {
        if (!dateStr) return 'N/A';
        const d = new Date(dateStr);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // View mode buttons
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            // Change Gantt view mode
            const mode = this.getAttribute('data-mode');
            initGantt(mode);
        });
    });
    {% endif %}

    // =====================================================
    // PHASE-BASED VIEW FUNCTIONS
    // =====================================================

    // Set view to show only phases (collapsed)
    function setPhaseView() {
        currentView = 'phases';
        expandedPhases.clear();
        updateViewButtons();
        updatePhaseInfoPanel();
        // Re-render Gantt with phase view
        if (hasPhases) {
            renderGanttWithPhases();
        }
    }

    // Set view to show all tasks
    function setAllTasksView() {
        currentView = 'all';
        updateViewButtons();
        // Re-render Gantt with all tasks
        initGantt(currentViewMode);
    }

    // Toggle a phase expansion
    function togglePhase(phaseName) {
        if (expandedPhases.has(phaseName)) {
            expandedPhases.delete(phaseName);
        } else {
            expandedPhases.add(phaseName);
        }
        updatePhaseInfoPanel();
        renderGanttWithPhases();
    }

    // Update view toggle button states
    function updateViewButtons() {
        const phaseBtn = document.getElementById('phase-view-btn');
        const allTasksBtn = document.getElementById('all-tasks-btn');
        const phaseInfoPanel = document.getElementById('phase-info-panel');

        if (phaseBtn && allTasksBtn) {
            if (currentView === 'phases') {
                phaseBtn.classList.add('active');
                allTasksBtn.classList.remove('active');
                if (phaseInfoPanel) phaseInfoPanel.style.display = '';
            } else {
                phaseBtn.classList.remove('active');
                allTasksBtn.classList.add('active');
                if (phaseInfoPanel) phaseInfoPanel.style.display = 'none';
            }
        }
    }

    // Update phase info panel with current state
    function updatePhaseInfoPanel() {
        const container = document.getElementById('phase-items-container');
        if (!container || !hasPhases) return;

        let html = '';
        for (const [phaseName, data] of Object.entries(phasesData)) {
            const isExpanded = expandedPhases.has(phaseName);
            const expandIcon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';

            html += `
                <div class="phase-item ${isExpanded ? 'expanded' : ''}" onclick="togglePhase('${phaseName}')">
                    <div>
                        <i class="fas ${expandIcon} me-2"></i>
                        <strong>${phaseName}</strong>
                        ${data.start && data.end ? `<small class="text-muted ms-2">${data.start} - ${data.end}</small>` : ''}
                    </div>
                    <div class="d-flex gap-2">
                        <span class="phase-badge tasks">
                            <i class="fas fa-tasks"></i> ${data.task_count || 0} tasks
                        </span>
                        <span class="phase-badge milestones">
                            <i class="fas fa-flag"></i> ${data.milestone_count || 0} milestones
                        </span>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }

    // Render Gantt chart with phase-based view
    function renderGanttWithPhases() {
        if (!hasPhases) {
            initGantt(currentViewMode);
            return;
        }

        console.log('=== renderGanttWithPhases called ===');
        console.log('phasesData:', phasesData);
        console.log('numPhases:', numPhases);

        let ganttData = [];

        // Build data based on current view state
        // Iterate phases in numerical order (Phase 1, Phase 2, Phase 3...)
        for (let i = 1; i <= numPhases; i++) {
            const phaseName = `Phase ${i}`;
            const data = phasesData[phaseName];
            console.log(`Processing ${phaseName}:`, data);
            if (!data || !data.start || !data.end) {
                console.warn(`Skipping ${phaseName} - missing data or dates`);
                continue;
            }

            const phaseId = phaseName.replace(' ', '-').toLowerCase();
            const isExpanded = expandedPhases.has(phaseName);

            // Add phase bar with all required fields to match task structure
            const phaseBar = {
                id: phaseId,
                name: `${phaseName} ${isExpanded ? 'â–¼' : 'â–¶'} (${data.task_count} tasks, ${data.milestone_count} milestones)`,
                fullName: phaseName,
                start: data.start,
                end: data.end,
                progress: 0,
                dependencies: '',
                custom_class: 'phase-bar',
                priority: 'phase',
                status: 'phase',
                assigned_to: '',
                assignee_first_name: '',
                assignee_last_name: '',
                item_type: 'phase',
                phase: phaseName,
                isPhase: true,
                phaseName: phaseName
            };
            console.log(`Adding phase bar for ${phaseName}:`, phaseBar);
            ganttData.push(phaseBar);

            // If expanded, add tasks and milestones for this phase
            if (isExpanded) {
                const phaseTasks = tasks.filter(t => t.phase === phaseName);
                phaseTasks.forEach(task => {
                    // Only include tasks/milestones with valid dates
                    if (!task.start || !task.end || task.start === 'None' || task.end === 'None') return;

                    if (task.item_type === 'milestone') {
                        // Milestones: use due_date as both start and end
                        ganttData.push({
                            ...task,
                            id: `milestone-${task.id}`,
                            name: `â—† ${task.name}`,
                            start: task.end,  // Milestones only have due_date
                            isMilestone: true
                        });
                    } else {
                        ganttData.push(task);
                    }
                });
            }
        }

        // If no valid phase data, fall back to all tasks view
        if (ganttData.length === 0) {
            console.warn('No valid phase data, falling back to all tasks view');
            initGantt(currentViewMode);
            return;
        }

        // Log final gantt data to debug ordering
        console.log('Final ganttData order:', ganttData.map(d => ({ id: d.id, name: d.name, start: d.start, end: d.end, isPhase: d.isPhase })));

        // WORKAROUND: Frappe Gantt sorts by start date internally
        // To maintain phase order (1, 2, 3), we need to ensure Phase 1 starts earliest
        // Add a small visual hack: prepend phase number to ensure correct display order
        const phaseItems = ganttData.filter(d => d.isPhase);
        if (phaseItems.length > 1) {
            // Check if phases are out of order by start date
            let needsReordering = false;
            for (let i = 1; i < phaseItems.length; i++) {
                if (new Date(phaseItems[i].start) < new Date(phaseItems[i-1].start)) {
                    needsReordering = true;
                    break;
                }
            }
            
            if (needsReordering) {
                console.warn('Phases are out of chronological order - Gantt library will reorder them by start date');
                // Add phase number prefix to names for visual clarity
                phaseItems.forEach((phase, idx) => {
                    phase.name = `[${idx + 1}] ` + phase.name;
                });
            }
        }

        // Re-initialize Gantt with phase data
        initGanttWithData(ganttData);
    }

    // Initialize Gantt with custom data
    function initGanttWithData(data) {
        const ganttElement = document.getElementById('gantt');

        if (ganttChart) {
            // Destroy existing chart
            ganttElement.innerHTML = '';
        }

        if (data.length === 0) {
            ganttElement.innerHTML = '<text x="50%" y="50" text-anchor="middle" fill="#64748b">No items to display</text>';
            return;
        }

        ganttChart = new Gantt('#gantt', data, {
            view_mode: currentViewMode,
            bar_height: 32,
            bar_corner_radius: 6,
            arrow_curve: 10,
            padding: 20,
            date_format: 'YYYY-MM-DD',
            language: 'en',
            auto_move_label: false,
            custom_popup_html: null,
            popup_trigger: 'none',
            on_click: function(task) {
                if (task.isPhase) {
                    togglePhase(task.phaseName);
                    return false; // Prevent navigation for phase bars
                } else if (task.isMilestone) {
                    const milestoneId = task.id.replace('milestone-', '');
                    window.location.href = `/tasks/${milestoneId}/`;
                } else {
                    window.location.href = `/tasks/${task.id}/`;
                }
            },
            on_date_change: function(task, start, end) {
                if (!task.isPhase && !task.isMilestone) {
                    updateTaskDates(task.id, start, end);
                }
            },
            on_progress_change: function(task, progress) {
                if (!task.isPhase && !task.isMilestone) {
                    updateTaskProgress(task.id, progress);
                }
            }
        });

        // Apply custom styling after render with multiple passes for reliability
        setTimeout(() => {
            applyPhaseAndMilestoneStyling();
        }, 150);
        
        // Additional pass for dependency arrows (they render later)
        setTimeout(() => {
            enhanceDependencyArrows();
        }, 400);
        
        // Final cleanup pass
        setTimeout(() => {
            enhanceDependencyArrows();
        }, 800);
    }

    // Apply custom styling for phases and milestones
    function applyPhaseAndMilestoneStyling() {
        const ganttSvg = document.querySelector('#gantt');
        if (!ganttSvg) return;

        // Remove existing milestone diamonds to prevent duplicates
        ganttSvg.querySelectorAll('.milestone-diamond-group').forEach(el => el.remove());

        // Style phase bars and create milestone diamonds
        document.querySelectorAll('.gantt .bar-wrapper').forEach(wrapper => {
            const bar = wrapper.querySelector('.bar');
            const label = wrapper.querySelector('.bar-label');
            const taskId = wrapper.getAttribute('data-id');

            if (bar && label) {
                const taskName = label.textContent || '';

                // Check if this is a phase bar
                if (taskName.includes('Phase') && (taskName.includes('tasks') || taskName.includes('milestones'))) {
                    bar.setAttribute('data-is-phase', 'true');
                    bar.style.cursor = 'pointer';
                }

                // Check if this is a milestone (starts with diamond symbol or has milestone id)
                if (taskName.startsWith('â—†') || (taskId && taskId.startsWith('milestone-'))) {
                    wrapper.setAttribute('data-is-milestone', 'true');
                    bar.setAttribute('data-is-milestone', 'true');
                    
                    // Create actual diamond shape
                    createMilestoneDiamond(wrapper, bar, label, taskName);
                }
            }
        });

        // Also apply standard styling
        applyCustomStyling();
    }

    // Create a diamond shape for milestones
    function createMilestoneDiamond(wrapper, bar, label, taskName) {
        const ganttSvg = document.querySelector('#gantt');
        if (!ganttSvg) return;

        let barRect;
        try {
            barRect = bar.getBBox();
        } catch (e) {
            return;
        }

        if (barRect.width <= 0 || barRect.height <= 0) return;

        // Create SVG group for the diamond
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        group.setAttribute('class', 'milestone-diamond-group');

        // Diamond size and position (centered on the bar position)
        const diamondSize = 16;
        const centerX = barRect.x + barRect.width / 2;
        const centerY = barRect.y + barRect.height / 2;

        // Create diamond polygon (rotated square)
        const diamond = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const points = [
            `${centerX},${centerY - diamondSize}`,      // top
            `${centerX + diamondSize},${centerY}`,      // right
            `${centerX},${centerY + diamondSize}`,      // bottom
            `${centerX - diamondSize},${centerY}`       // left
        ].join(' ');
        diamond.setAttribute('points', points);
        diamond.setAttribute('class', 'milestone-diamond-shape');
        group.appendChild(diamond);

        // Create label text (positioned to the right of diamond)
        const milestoneLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        const displayName = taskName.replace('â—† ', '').substring(0, 20) + (taskName.length > 22 ? '...' : '');
        milestoneLabel.textContent = displayName;
        milestoneLabel.setAttribute('x', centerX + diamondSize + 8);
        milestoneLabel.setAttribute('y', centerY);
        milestoneLabel.setAttribute('class', 'milestone-label');
        milestoneLabel.setAttribute('dominant-baseline', 'middle');
        group.appendChild(milestoneLabel);

        // Hide the original bar and label
        bar.style.opacity = '0';
        label.style.display = 'none';

        // Add click handler to diamond
        const taskId = wrapper.getAttribute('data-id');
        diamond.style.cursor = 'pointer';
        diamond.addEventListener('click', function() {
            if (taskId && taskId.startsWith('milestone-')) {
                const milestoneId = taskId.replace('milestone-', '');
                window.location.href = `/tasks/${milestoneId}/`;
            }
        });

        // Insert diamond group into the wrapper
        wrapper.appendChild(group);
    }

    // Initialize phase view on load if phases exist
    if (hasPhases) {
        document.addEventListener('DOMContentLoaded', function() {
            updatePhaseInfoPanel();
            // Start with phase view
            if (currentView === 'phases') {
                renderGanttWithPhases();
            }
        });
    }

    // Handle back navigation to previous page
    function goBack() {
        // Check if there's a previous page in history
        if (document.referrer && document.referrer !== window.location.href) {
            window.history.back();
        } else {
            // Fallback to board detail if no history (demo-aware)
            {% if is_demo_mode %}
            window.location.href = '{% url "demo_board_detail" board.id %}';
            {% else %}
            window.location.href = '{% url "board_detail" board.id %}';
            {% endif %}
        }
    }
</script>
{% endblock %}
