{% extends 'base.html' %}
{% load static %}

{% block title %}Burndown Prediction - {{ board.name }}{% endblock %}

{% block extra_css %}
<style>
    .burndown-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .burndown-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .burndown-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .prediction-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .prediction-card h4 {
        color: #0f172a;
        font-weight: 700;
    }

    .prediction-card p,
    .prediction-card .text-muted {
        color: #64748b !important;
    }

    .prediction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .metric-row {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .metric-card {
        flex: 1;
        min-width: 200px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .metric-label {
        font-size: 13px;
        color: #64748b !important;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: block;
    }

    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: #0f172a !important;
        display: block;
        line-height: 1.2;
    }

    .metric-value * {
        color: #0f172a !important;
    }

    .metric-subtext {
        font-size: 12px;
        color: #64748b !important;
        margin-top: 5px;
        display: block;
    }

    .risk-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.5;
    }

    .risk-low {
        background: #d4edda !important;
        color: #155724 !important;
    }

    .risk-medium {
        background: #fff3cd !important;
        color: #856404 !important;
    }

    .risk-high {
        background: #f8d7da !important;
        color: #721c24 !important;
    }

    .risk-critical {
        background: #d32f2f !important;
        color: white !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .alert-box {
        border-left: 4px solid;
        padding: 15px 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        background: white;
    }

    .alert-box.critical {
        border-color: #d32f2f;
        background: #fff5f5;
    }

    .alert-box.critical strong,
    .alert-box.critical p {
        color: #7f1d1d !important;
    }

    .alert-box.warning {
        border-color: #f57c00;
        background: #fff8e1;
    }

    .alert-box.warning strong,
    .alert-box.warning p {
        color: #78350f !important;
    }

    .alert-box.info {
        border-color: #0288d1;
        background: #e3f2fd;
    }

    .alert-box.info strong,
    .alert-box.info p {
        color: #1e3a8a !important;
    }

    .suggestion-card {
        background: white;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 12px;
        border-left: 4px solid #667eea;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .suggestion-card:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }

    .suggestion-card strong {
        color: #0f172a;
    }

    .suggestion-card p {
        color: #475569 !important;
    }

    .suggestion-priority {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        text-align: center;
        line-height: 30px;
        font-weight: 700;
        margin-right: 12px;
    }

    .suggestion-impact {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 10px;
    }

    .impact-high {
        background: #fee;
        color: #c00;
    }

    .impact-medium {
        background: #ffeaa7;
        color: #856404;
    }

    .impact-low {
        background: #dfe6e9;
        color: #2d3436;
    }

    .impact-critical {
        background: #d32f2f;
        color: white;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }

    .confidence-band-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        font-size: 13px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-color {
        width: 30px;
        height: 3px;
        border-radius: 2px;
    }

    .btn-generate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .no-prediction {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .no-prediction i {
        font-size: 64px;
        color: #cbd5e0;
        margin-bottom: 20px;
    }

    .no-prediction h3 {
        color: #0f172a;
        font-weight: 700;
    }

    .no-prediction p {
        color: #64748b;
    }

    .confidence-band-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        font-size: 13px;
        color: #475569;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="burndown-container">
    <!-- Header -->
    <div class="burndown-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="burndown-title">
                    <i class="fas fa-chart-line"></i> Burndown Prediction
                </div>
                <p class="mb-0" style="opacity: 0.9;">{{ board.name }}</p>
            </div>
            <div>
                <a href="{% if is_demo_mode %}{% url 'demo_board_detail' board.id %}{% else %}{% url 'board_detail' board.id %}{% endif %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left me-2"></i>Back to Board
                </a>
                <button class="btn btn-generate" onclick="generatePrediction()">
                    <i class="fas fa-sync-alt"></i> Generate New Prediction
                </button>
            </div>
        </div>
    </div>

    {% if prediction %}
    <!-- Key Metrics -->
    <div class="prediction-card">
        <h4 class="mb-4"><i class="fas fa-tachometer-alt text-primary"></i> Completion Forecast</h4>
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-label">Predicted Completion</div>
                <div class="metric-value">{{ prediction.predicted_completion_date|date:"M d, Y" }}</div>
                <div class="metric-subtext">
                    Â±{{ prediction.days_margin_of_error }} days ({{ prediction.confidence_percentage }}% confidence)
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Completion Range</div>
                <div class="metric-value" style="font-size: 18px;">
                    {{ prediction.completion_date_lower_bound|date:"M d" }} - {{ prediction.completion_date_upper_bound|date:"M d, Y" }}
                </div>
                <div class="metric-subtext">{{ prediction.confidence_percentage }}% confidence interval</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Days Until Completion</div>
                <div class="metric-value">{{ prediction.days_until_completion_estimate }}</div>
                <div class="metric-subtext">Based on current velocity</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Risk Level</div>
                <div class="metric-value" style="font-size: 20px;">
                    <span class="risk-badge risk-{{ prediction.risk_level }}">
                        {{ prediction.get_risk_level_display }}
                    </span>
                </div>
                <div class="metric-subtext">{{ prediction.delay_probability }}% miss probability</div>
            </div>
        </div>
    </div>

    <!-- Progress Metrics -->
    <div class="prediction-card">
        <h4 class="mb-4"><i class="fas fa-tasks text-success"></i> Current Progress</h4>
        <div class="metric-row">
            <div class="metric-card">
                <div class="metric-label">Tasks Completed</div>
                <div class="metric-value">{{ prediction.completed_tasks }} / {{ prediction.total_tasks }}</div>
                <div class="metric-subtext">{{ prediction.completion_percentage|floatformat:1 }}% complete</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Tasks Remaining</div>
                <div class="metric-value">{{ prediction.remaining_tasks }}</div>
                <div class="metric-subtext">Work still to do</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Current Velocity</div>
                <div class="metric-value">{{ prediction.current_velocity }}</div>
                <div class="metric-subtext">tasks/week</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Velocity Trend</div>
                <div class="metric-value" style="font-size: 20px;">
                    {% if prediction.velocity_trend == 'increasing' %}
                    <i class="fas fa-arrow-up text-success"></i> Up
                    {% elif prediction.velocity_trend == 'decreasing' %}
                    <i class="fas fa-arrow-down text-danger"></i> Down
                    {% else %}
                    <i class="fas fa-minus text-info"></i> Stable
                    {% endif %}
                </div>
                <div class="metric-subtext">{{ prediction.velocity_trend|title }}</div>
            </div>
        </div>
    </div>

    <!-- Burndown Chart -->
    <div class="prediction-card">
        <h4 class="mb-3"><i class="fas fa-chart-area text-info"></i> Burndown Chart with Confidence Bands</h4>
        <div class="chart-container">
            <canvas id="burndownChart"></canvas>
        </div>
        <div class="confidence-band-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(102, 126, 234, 0.3);"></div>
                <span>Confidence Band ({{ prediction.confidence_percentage }}%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #667eea;"></div>
                <span>Predicted Path</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #48bb78;"></div>
                <span>Actual Progress</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #cbd5e0; border-style: dashed;"></div>
                <span>Ideal Burndown</span>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    {% if alerts %}
    <div class="prediction-card">
        <h4 class="mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Active Alerts ({{ alerts.count }})
        </h4>
        {% for alert in alerts %}
        <div class="alert-box {{ alert.severity }}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong>
                        {% if alert.severity == 'critical' %}
                        <i class="fas fa-times-circle text-danger"></i>
                        {% elif alert.severity == 'warning' %}
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        {% else %}
                        <i class="fas fa-info-circle text-info"></i>
                        {% endif %}
                        {{ alert.title }}
                    </strong>
                    <p class="mb-2 mt-2">{{ alert.message }}</p>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> {{ alert.created_at|timesince }} ago
                    </small>
                </div>
                <div>
                    {% if alert.status == 'active' %}
                    <button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert({{ alert.id }})">
                        <i class="fas fa-check"></i> Acknowledge
                    </button>
                    {% elif alert.status == 'acknowledged' %}
                    <span class="badge bg-info">Acknowledged</span>
                    <button class="btn btn-sm btn-outline-success" onclick="resolveAlert({{ alert.id }})">
                        <i class="fas fa-check-double"></i> Resolve
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Actionable Suggestions -->
    {% if prediction.actionable_suggestions %}
    <div class="prediction-card">
        <h4 class="mb-3"><i class="fas fa-lightbulb text-warning"></i> Actionable Suggestions</h4>
        <p class="text-muted mb-4">AI-generated recommendations to improve completion probability:</p>

        {% for suggestion in prediction.actionable_suggestions %}
        <div class="suggestion-card">
            <div class="d-flex align-items-start">
                <span class="suggestion-priority">{{ suggestion.priority }}</span>
                <div class="flex-grow-1">
                    <strong>{{ suggestion.title }}</strong>
                    <span class="suggestion-impact impact-{{ suggestion.impact }}">
                        {{ suggestion.impact }} impact
                    </span>
                    <p class="mb-0 mt-2 text-muted">{{ suggestion.description }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Velocity History -->
    <div class="prediction-card">
        <h4 class="mb-3"><i class="fas fa-history text-secondary"></i> Velocity History</h4>
        <div class="chart-container" style="height: 300px;">
            <canvas id="velocityChart"></canvas>
        </div>
    </div>

    {% else %}
    <!-- No Prediction State -->
    <div class="no-prediction">
        <i class="fas fa-chart-line"></i>
        <h3 class="mt-3 mb-3">No Prediction Available</h3>
        <p class="text-muted mb-4">Generate a burndown prediction to see completion forecasts with confidence intervals.
        </p>
        <button class="btn btn-generate btn-lg" onclick="generatePrediction()">
            <i class="fas fa-magic"></i> Generate Prediction
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    function generatePrediction() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        btn.disabled = true;

        fetch("{% url 'generate_burndown_prediction' board.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                alert('Error generating prediction: ' + error);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
    }

    function acknowledgeAlert(alertId) {
        fetch(`/board/{{ board.id }}/burndown/alerts/${alertId}/acknowledge/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    function resolveAlert(alertId) {
        fetch(`/board/{{ board.id }}/burndown/alerts/${alertId}/resolve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    {% if prediction %}
    // Load chart data
    fetch("{% url 'burndown_chart_data' board.id %}")
        .then(response => response.json())
        .then(data => {
            console.log('Burndown data:', data);
            if (data.success === false) {
                console.error('Error loading chart data:', data.error);
                document.getElementById('burndownChart').closest('.prediction-card').innerHTML =
                    '<div class="alert alert-warning">Could not load chart data: ' + data.error + '</div>';
                return;
            }
            renderBurndownChart(data);
        })
        .catch(error => {
            console.error('Error fetching burndown data:', error);
            document.getElementById('burndownChart').closest('.prediction-card').innerHTML =
                '<div class="alert alert-danger">Error loading chart: ' + error.message + '</div>';
        });

    fetch("{% url 'velocity_chart_data' board.id %}")
        .then(response => response.json())
        .then(data => {
            console.log('Velocity data:', data);
            if (data.success === false) {
                console.error('Error loading velocity data:', data.error);
                return;
            }
            renderVelocityChart(data);
        })
        .catch(error => {
            console.error('Error fetching velocity data:', error);
        });

    function renderBurndownChart(data) {
        const ctx = document.getElementById('burndownChart').getContext('2d');

        // Check if we have data
        if (!data.historical || data.historical.length === 0) {
            document.getElementById('burndownChart').closest('.chart-container').innerHTML =
                '<div class="alert alert-info">No historical data available yet. Complete some tasks to see the burndown chart.</div>';
            return;
        }

        // Combine historical and projected for actual line
        const historicalData = data.historical.map(p => ({ x: new Date(p.date), y: p.remaining }));
        const projectedData = data.projected.map(p => ({ x: new Date(p.date), y: p.remaining }));
        const upperBand = data.confidence_bands.upper_band.map(p => ({ x: new Date(p.date), y: p.remaining }));
        const lowerBand = data.confidence_bands.lower_band.map(p => ({ x: new Date(p.date), y: p.remaining }));
        const idealLine = data.ideal_line.map(p => ({ x: new Date(p.date), y: p.remaining }));

        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Actual Progress',
                        data: historicalData,
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    },
                    {
                        label: 'Predicted Path',
                        data: projectedData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 4,
                    },
                    {
                        label: 'Upper Bound',
                        data: upperBand,
                        borderColor: 'rgba(102, 126, 234, 0.3)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 1,
                        fill: '+1',
                        tension: 0.3,
                        pointRadius: 0,
                    },
                    {
                        label: 'Lower Bound',
                        data: lowerBand,
                        borderColor: 'rgba(102, 126, 234, 0.3)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 1,
                        tension: 0.3,
                        pointRadius: 0,
                    },
                    {
                        label: 'Ideal Burndown',
                        data: idealLine,
                        borderColor: '#cbd5e0',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        tension: 0,
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#4a5568',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            color: '#4a5568'
                        },
                        grid: {
                            color: '#e2e8f0'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Tasks Remaining',
                            color: '#4a5568',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            color: '#4a5568',
                            precision: 0
                        },
                        grid: {
                            color: '#e2e8f0'
                        }
                    }
                }
            }
        });
    }

    function renderVelocityChart(data) {
        const ctx = document.getElementById('velocityChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels.map(d => new Date(d).toLocaleDateString()),
                datasets: [{
                    label: 'Tasks Completed',
                    data: data.velocities,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    annotation: data.average ? {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: data.average,
                                yMax: data.average,
                                borderColor: '#f56565',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: `Average: ${data.average.toFixed(1)}`,
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    } : {}
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Tasks Completed'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Period'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    // Handle back navigation
    function goBack() {
        // Check if there's a previous page in history
        if (document.referrer && document.referrer !== window.location.href) {
            window.history.back();
        } else {
            // Fallback to board detail if no history (demo-aware)
            {% if is_demo_mode %}
            window.location.href = '{% url "demo_board_detail" board.id %}';
            {% else %}
            window.location.href = '{% url "board_detail" board.id %}';
            {% endif %}
        }
    }</script>
{% endblock %}