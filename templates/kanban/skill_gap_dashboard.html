{% extends 'base.html' %}
{% load static %}

{% block title %}Skill Gap Analysis - {{ board.name }} - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gap-card, .plan-card {
        border-left: 4px solid #6c757d;
        transition: all 0.2s ease;
    }
    
    .gap-card:hover, .plan-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .gap-card.critical {
        border-left-color: #dc3545;
    }
    
    .gap-card.high {
        border-left-color: #ffc107;
    }
    
    .gap-card.medium {
        border-left-color: #17a2b8;
    }
    
    .gap-card.low {
        border-left-color: #6c757d;
    }
    
    .skill-matrix-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .skill-matrix-table td {
        vertical-align: middle;
    }
    
    .action-buttons .btn {
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-brain me-2 text-primary"></i>
                Skill Gap Analysis
            </h1>
            <p class="text-muted mb-0">{{ board.name }}</p>
        </div>
        <div class="btn-group">
            <button onclick="goBack()" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back
            </button>
            <button class="btn btn-primary" onclick="runSkillAnalysis()">
                <i class="fas fa-sync-alt me-1"></i> Run Analysis
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card warning">
                <h3>{{ skill_gaps.count }}</h3>
                <p class="mb-0"><i class="fas fa-exclamation-triangle me-1"></i> Active Skill Gaps</p>
                <small>{{ critical_gaps }} Critical • {{ high_gaps }} High</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card info">
                <h3>{{ development_plans.count }}</h3>
                <p class="mb-0"><i class="fas fa-graduation-cap me-1"></i> Development Plans</p>
                <small>{{ active_plans }} Active • {{ proposed_plans }} Proposed</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card success">
                <h3>{% if team_profile %}{{ team_profile.skill_inventory|length }}{% else %}0{% endif %}</h3>
                <p class="mb-0"><i class="fas fa-tools me-1"></i> Unique Skills</p>
                <small>Team skill inventory</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card {% if team_profile.utilization_percentage > 90 %}warning{% elif team_profile.utilization_percentage > 75 %}info{% else %}success{% endif %}">
                <h3>{% if team_profile %}{{ team_profile.utilization_percentage|floatformat:0 }}%{% else %}0%{% endif %}</h3>
                <p class="mb-0"><i class="fas fa-chart-line me-1"></i> Team Utilization</p>
                <small>Current capacity usage</small>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Skill Gaps Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Skill Gaps ({{ skill_gaps.count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if skill_gaps %}
                        {% for gap in skill_gaps %}
                        <div class="gap-card {{ gap.severity }} p-3 mb-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        <strong>{{ gap.skill_name }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ gap.proficiency_level }}</span>
                                    </h6>
                                    <small class="text-muted">
                                        Need {{ gap.gap_count }} more • {{ gap.affected_tasks.count }} tasks affected
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge 
                                        {% if gap.severity == 'critical' %}bg-danger
                                        {% elif gap.severity == 'high' %}bg-warning text-dark
                                        {% elif gap.severity == 'medium' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {{ gap.get_severity_display }}
                                    </span>
                                    <span class="badge bg-light text-dark ms-1">{{ gap.get_status_display }}</span>
                                </div>
                            </div>
                            
                            {% if gap.ai_recommendations %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    {{ gap.ai_recommendations|length }} AI recommendation(s)
                                </small>
                            </div>
                            {% endif %}
                            
                            <div class="action-buttons mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewGapDetails({{ gap.id }})">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="createPlanForGap({{ gap.id }})">
                                    <i class="fas fa-plus me-1"></i> Create Plan
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-check-circle text-success"></i>
                            <h5>No Skill Gaps Identified</h5>
                            <p class="text-muted">Run analysis to check for skill gaps in your team.</p>
                            <button class="btn btn-primary" onclick="runSkillAnalysis()">
                                <i class="fas fa-sync-alt me-1"></i> Run Analysis
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Development Plans Section -->
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Development Plans ({{ development_plans.count }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if development_plans %}
                        {% for plan in development_plans %}
                        <div class="plan-card p-3 mb-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        <strong>{{ plan.title }}</strong>
                                    </h6>
                                    <small class="text-muted">
                                        {{ plan.target_skill }} ({{ plan.target_proficiency }})
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge 
                                        {% if plan.plan_type == 'training' %}bg-primary
                                        {% elif plan.plan_type == 'hiring' %}bg-success
                                        {% elif plan.plan_type == 'contractor' %}bg-info
                                        {% elif plan.plan_type == 'redistribute' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        <i class="fas 
                                            {% if plan.plan_type == 'training' %}fa-book
                                            {% elif plan.plan_type == 'hiring' %}fa-user-plus
                                            {% elif plan.plan_type == 'contractor' %}fa-handshake
                                            {% elif plan.plan_type == 'redistribute' %}fa-exchange-alt
                                            {% else %}fa-users{% endif %} me-1"></i>
                                        {{ plan.get_plan_type_display }}
                                    </span>
                                    <span class="badge bg-light text-dark ms-1">{{ plan.get_status_display }}</span>
                                </div>
                            </div>
                            
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar 
                                    {% if plan.progress_percentage >= 75 %}bg-success
                                    {% elif plan.progress_percentage >= 50 %}bg-primary
                                    {% else %}bg-warning{% endif %}" 
                                    role="progressbar" 
                                    style="width: {{ plan.progress_percentage }}%" 
                                    aria-valuenow="{{ plan.progress_percentage }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    {{ plan.target_users.count }} team member(s)
                                    {% if plan.estimated_hours %} • {{ plan.estimated_hours }}h{% endif %}
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPlanDetails({{ plan.id }})">
                                        <i class="fas fa-eye me-1"></i> Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h5>No Development Plans</h5>
                            <p class="text-muted">Create plans to address skill gaps.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Team Skill Matrix -->
    {% if team_profile and team_profile.skill_inventory %}
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-th me-2"></i>
                        Team Skill Matrix
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover skill-matrix-table">
                            <thead>
                                <tr>
                                    <th>Skill</th>
                                    <th class="text-center">Expert</th>
                                    <th class="text-center">Advanced</th>
                                    <th class="text-center">Intermediate</th>
                                    <th class="text-center">Beginner</th>
                                    <th class="text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for skill_name, skill_data in team_profile.skill_inventory.items %}
                                <tr>
                                    <td><strong>{{ skill_name }}</strong></td>
                                    <td class="text-center">
                                        {% if skill_data.expert > 0 %}
                                            <span class="badge bg-success">{{ skill_data.expert }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if skill_data.advanced > 0 %}
                                            <span class="badge bg-primary">{{ skill_data.advanced }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if skill_data.intermediate > 0 %}
                                            <span class="badge bg-info">{{ skill_data.intermediate }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if skill_data.beginner > 0 %}
                                            <span class="badge bg-secondary">{{ skill_data.beginner }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <strong>{{ skill_data.expert|add:skill_data.advanced|add:skill_data.intermediate|add:skill_data.beginner }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hidden element for board ID -->
    <div id="skill-gap-dashboard" data-board-id="{{ board.id }}" style="display: none;"></div>
</div>

<!-- Gap Details Modal -->
<div class="modal fade" id="gapDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Skill Gap Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="gapDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plan Details Modal -->
<div class="modal fade" id="planDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Development Plan Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="planDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="planDetailsFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editPlanBtn" style="display:none;">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button type="button" class="btn btn-danger" id="deletePlanBtn" style="display:none;">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/skill_gap_analysis.js' %}"></script>
<script>
    // Initialize the skill gap analyzer
    const boardId = {{ board.id }};
    // Note: skillGapAnalyzer is already declared in skill_gap_analysis.js as a global variable

    document.addEventListener('DOMContentLoaded', function() {
        if (!window.skillGapAnalyzer) {
            window.skillGapAnalyzer = new SkillGapAnalyzer(boardId);
        }
    });

    // Make function globally accessible
    window.runSkillAnalysis = function() {
        if (window.skillGapAnalyzer) {
            showLoadingOverlay('Running skill gap analysis...');
            window.skillGapAnalyzer.analyzeGaps(14).then((data) => {
                hideLoadingOverlay();
                
                // Check if recommendations are pending
                const pendingCount = data.gaps.filter(g => g.recommendations_pending).length;
                if (pendingCount > 0) {
                    showToast(`Analysis complete! AI generating ${pendingCount} recommendation(s)...`, 'info');
                    // Poll for completion instead of fixed wait
                    pollForRecommendations(data.gaps.filter(g => g.recommendations_pending).map(g => g.id));
                } else {
                    showToast('Analysis complete!', 'success');
                    // Update UI immediately without reload
                    updateGapsDisplay(data.gaps);
                }
            }).catch(error => {
                hideLoadingOverlay();
                showToast('Failed to run analysis: ' + error.message, 'error');
            });
        }
    }

    // Poll for recommendation completion (max 5 attempts, 2 seconds apart)
    async function pollForRecommendations(gapIds, attempt = 1, maxAttempts = 5) {
        if (attempt > maxAttempts) {
            showToast('Recommendations still generating. Refresh page later to see them.', 'info');
            updateGapsDisplay(window.skillGapAnalyzer.gaps);
            return;
        }
        
        await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
        
        try {
            // Check if recommendations are ready
            const response = await fetch(`/api/skill-gaps/list/${boardId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const stillPending = data.gaps.filter(g => 
                    gapIds.includes(g.id) && (!g.ai_recommendations || g.ai_recommendations.length === 0)
                );
                
                if (stillPending.length === 0) {
                    showToast('All recommendations ready!', 'success');
                    updateGapsDisplay(data.gaps);
                } else {
                    showToast(`Waiting for ${stillPending.length} recommendation(s)... (${attempt}/${maxAttempts})`, 'info');
                    pollForRecommendations(gapIds, attempt + 1, maxAttempts);
                }
            }
        } catch (error) {
            console.error('Error polling for recommendations:', error);
            updateGapsDisplay(window.skillGapAnalyzer.gaps);
        }
    }

    // Update gaps display without page reload
    function updateGapsDisplay(gaps) {
        window.skillGapAnalyzer.gaps = gaps;
        window.skillGapAnalyzer.renderGapsSection();
        // Also reload the page content for server-rendered sections
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    window.viewGapDetails = async function(gapId) {
        try {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('gapDetailsModal'));
            modal.show();
            
            // Show loading state
            document.getElementById('gapDetailsContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading gap details...</p>
                </div>
            `;
            
            // Fetch gap details
            const response = await fetch(`/api/skill-gaps/${gapId}/detail/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load gap details');
            }
            
            const data = await response.json();
            const gap = data.gap;
            
            // Build modal content
            let content = `
                <div class="gap-details">
                    <div class="mb-4">
                        <h5>${gap.skill_name} <span class="badge bg-secondary">${gap.proficiency_level}</span></h5>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Gap Size:</strong> Need ${gap.gap_count} more team member(s)</p>
                                <p><strong>Currently Available:</strong> ${gap.available_count}</p>
                                <p><strong>Required:</strong> ${gap.required_count}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Severity:</strong> <span class="badge ${getSeverityClass(gap.severity)}">${gap.severity.toUpperCase()}</span></p>
                                <p><strong>Status:</strong> <span class="badge ${getStatusClass(gap.status)}">${gap.status.replace('_', ' ').toUpperCase()}</span></p>
                            </div>
                        </div>
                    </div>
                    
                    ${gap.affected_tasks && gap.affected_tasks.length > 0 ? `
                        <div class="mb-4">
                            <h6><i class="fas fa-tasks me-2"></i>Affected Tasks (${gap.affected_tasks.length})</h6>
                            <div class="list-group">
                                ${gap.affected_tasks.map(task => `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${task.title}</strong><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-columns me-1"></i>${task.column}
                                                    ${task.assigned_to ? `<i class="fas fa-user ms-2 me-1"></i>${task.assigned_to}` : ''}
                                                    ${task.due_date ? `<i class="fas fa-calendar ms-2 me-1"></i>${new Date(task.due_date).toLocaleDateString()}` : ''}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p class="text-muted">No tasks affected</p>'}
                    
                    ${gap.ai_recommendations && gap.ai_recommendations.length > 0 ? `
                        <div class="mb-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h6>
                            ${gap.ai_recommendations.map(rec => `
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h6 class="card-title">${rec.action || rec.title || 'Recommendation'}</h6>
                                        <p class="card-text">${rec.description || rec.rationale || ''}</p>
                                        ${rec.estimated_time ? `<small class="text-muted"><i class="fas fa-clock me-1"></i>Estimated time: ${rec.estimated_time}</small>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No AI recommendations available</div>'}
                    
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="window.createPlanForGap(${gap.id})">
                            <i class="fas fa-plus me-1"></i> Create Development Plan
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gapDetailsContent').innerHTML = content;
            
        } catch (error) {
            console.error('Error loading gap details:', error);
            document.getElementById('gapDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load gap details: ${error.message}
                </div>
            `;
        }
    };
    
    function getSeverityClass(severity) {
        const classes = {
            'critical': 'bg-danger',
            'high': 'bg-warning text-dark',
            'medium': 'bg-info',
            'low': 'bg-secondary'
        };
        return classes[severity] || 'bg-secondary';
    }
    
    function getStatusClass(status) {
        const classes = {
            'identified': 'bg-warning',
            'acknowledged': 'bg-info',
            'in_progress': 'bg-primary',
            'resolved': 'bg-success'
        };
        return classes[status] || 'bg-secondary';
    }
    
    function getCsrfToken() {
        // Try to get from hidden input first
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) return token;
        
        // Try to get from meta tag
        token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if (token) return token;
        
        // Try to get from cookie (Django's default)
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue || '';
    }

    window.viewPlanDetails = async function(planId) {
        try {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('planDetailsModal'));
            modal.show();
            
            // Show loading state
            document.getElementById('planDetailsContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading plan details...</p>
                </div>
            `;
            
            // Fetch plan details from the plans array loaded on page
            const response = await fetch(`/api/development-plans/${boardId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load plan details');
            }
            
            const data = await response.json();
            const plan = data.plans.find(p => p.id === planId);
            
            if (!plan) {
                throw new Error('Plan not found');
            }
            
            // Build modal content
            let content = `
                <div class="plan-details">
                    <div class="mb-4">
                        <h5>${plan.title}</h5>
                        <p class="text-muted">${plan.description || 'No description provided'}</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Target Skill:</strong> ${plan.target_skill}</p>
                            <p><strong>Target Proficiency:</strong> <span class="badge bg-info">${plan.target_proficiency}</span></p>
                            <p><strong>Plan Type:</strong> ${getPlanTypeBadgeHTML(plan.plan_type)}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> <span class="badge ${getStatusClass(plan.status)}">${plan.status.replace('_', ' ').toUpperCase()}</span></p>
                            <p><strong>Progress:</strong> ${plan.progress_percentage}%</p>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${plan.progress_percentage >= 75 ? 'bg-success' : plan.progress_percentage >= 50 ? 'bg-primary' : 'bg-warning'}" 
                                     role="progressbar" 
                                     style="width: ${plan.progress_percentage}%" 
                                     aria-valuenow="${plan.progress_percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${plan.progress_percentage}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Estimated Hours:</strong> ${plan.estimated_hours ? plan.estimated_hours + 'h' : 'Not specified'}</p>
                            <p><strong>Estimated Cost:</strong> ${plan.estimated_cost ? '$' + plan.estimated_cost : 'Not specified'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Start Date:</strong> ${plan.start_date ? new Date(plan.start_date).toLocaleDateString() : 'Not set'}</p>
                            <p><strong>Target Completion:</strong> ${plan.target_completion_date ? new Date(plan.target_completion_date).toLocaleDateString() : 'Not set'}</p>
                            ${plan.is_overdue ? '<p class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Overdue</p>' : ''}
                        </div>
                    </div>
                    
                    ${plan.target_users && plan.target_users.length > 0 ? `
                        <div class="mb-4">
                            <h6><i class="fas fa-users me-2"></i>Target Team Members (${plan.target_users.length})</h6>
                            <div class="list-group">
                                ${plan.target_users.map(user => `
                                    <div class="list-group-item">
                                        <i class="fas fa-user me-2"></i>${user.username}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p class="text-muted">No specific team members assigned</p>'}
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>Created by: ${plan.created_by} • 
                            <i class="fas fa-calendar ms-2 me-1"></i>${new Date(plan.created_at).toLocaleDateString()}
                            ${plan.ai_suggested ? ' • <i class="fas fa-robot ms-2 me-1"></i>AI Suggested' : ''}
                        </small>
                    </div>
                </div>
            `;
            
            document.getElementById('planDetailsContent').innerHTML = content;
            
            // Show action buttons and wire them up
            document.getElementById('editPlanBtn').style.display = 'inline-block';
            document.getElementById('deletePlanBtn').style.display = 'inline-block';
            
            document.getElementById('editPlanBtn').onclick = function() {
                modal.hide();
                editPlanDetails(plan);
            };
            
            document.getElementById('deletePlanBtn').onclick = function() {
                if (confirm('Are you sure you want to delete this development plan? This action cannot be undone.')) {
                    deletePlan(planId, modal);
                }
            };
            
        } catch (error) {
            console.error('Error loading plan details:', error);
            document.getElementById('planDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Failed to load plan details: ${error.message}
                </div>
            `;
        }
    };
    
    async function deletePlan(planId, modal) {
        try {
            const response = await fetch(`/api/development-plans/${planId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete plan');
            }
            
            const data = await response.json();
            
            // Close modal
            modal.hide();
            
            // Show success message
            showNotification('Development plan deleted successfully', 'success');
            
            // Remove the plan card from the DOM
            // Look for plan cards in both server-rendered and JS-rendered sections
            let cardRemoved = false;
            
            // First try to find and remove from server-rendered section
            const serverRenderedSection = document.querySelector('.col-md-6.mb-4 .card-body');
            if (serverRenderedSection) {
                const serverCards = serverRenderedSection.querySelectorAll('.plan-card');
                console.log('Server-rendered plan cards found:', serverCards.length);
                serverCards.forEach(card => {
                    const detailsButton = card.querySelector(`button[onclick*="viewPlanDetails(${planId})"]`);
                    if (detailsButton) {
                        console.log('Removing server-rendered card for plan ID:', planId);
                        card.remove();
                        cardRemoved = true;
                    }
                });
            }
            
            // Also check JS-rendered sections
            const jsRenderedSection = document.getElementById('development-plans-section');
            if (jsRenderedSection) {
                const jsCards = jsRenderedSection.querySelectorAll('.plan-card');
                console.log('JS-rendered plan cards found:', jsCards.length);
            }
            
            // Reload the development plans via JavaScript to sync the state
            if (window.skillGapAnalyzer) {
                await window.skillGapAnalyzer.loadDevelopmentPlans();
                window.skillGapAnalyzer.renderPlansSection();
            }
            
            // Count ALL remaining plans on the page
            const allPlanCards = document.querySelectorAll('.plan-card');
            const remainingPlans = allPlanCards.length;
            
            console.log('Total remaining plans after deletion:', remainingPlans);
            
            // Update the count in the summary card at the top
            const summaryCard = document.querySelector('.stat-card.info h3');
            if (summaryCard) {
                summaryCard.textContent = remainingPlans;
                console.log('Updated summary card count');
            }
            
            // Update the count in the Development Plans section header
            // Target the specific blue header section with bg-primary
            const blueHeader = document.querySelector('.col-md-6 .card-header.bg-primary.text-white h5.mb-0');
            if (blueHeader) {
                blueHeader.innerHTML = `<i class="fas fa-graduation-cap me-2"></i>Development Plans (${remainingPlans})`;
                console.log('Updated blue header count to:', remainingPlans);
            } else {
                console.log('Blue header not found');
            }
            
            // Also update any other headers with graduation cap icon (for dynamic sections)
            document.querySelectorAll('.card-header h5').forEach(header => {
                const iconElement = header.querySelector('.fa-graduation-cap');
                if (iconElement && !header.classList.contains('mb-0')) {
                    // This is a dynamic development plans header - update it
                    header.innerHTML = `<i class="fas fa-graduation-cap me-2"></i>Development Plans (${remainingPlans})`;
                    console.log('Updated dynamic header count');
                }
            });
            
            // If no plans left, show empty state
            if (remainingPlans === 0) {
                // Update summary card subtitle
                const summarySubtitle = document.querySelector('.stat-card.info small');
                if (summarySubtitle) {
                    summarySubtitle.textContent = '0 Active • 0 Proposed';
                }
                
                // Show empty state in the plans section
                const plansSections = document.querySelectorAll('.col-md-6 .card-body');
                plansSections.forEach(cardBody => {
                    // Check if this card body had plan cards and now is empty
                    if (cardRemoved && cardBody.querySelector('.plan-card') === null && !cardBody.querySelector('.empty-state')) {
                        cardBody.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <h5>No Development Plans</h5>
                                <p class="text-muted">Create plans to address skill gaps.</p>
                            </div>
                        `;
                    }
                });
            }
            
            // Also update the skill gap analyzer if available
            if (window.skillGapAnalyzer) {
                await window.skillGapAnalyzer.loadDevelopmentPlans();
                window.skillGapAnalyzer.renderPlansSection();
            }
            
        } catch (error) {
            console.error('Error deleting plan:', error);
            showNotification('Failed to delete development plan: ' + error.message, 'error');
        }
    }
    
    function editPlanDetails(plan) {
        // Create/show edit modal
        let editModal = document.getElementById('editPlanModal');
        if (!editModal) {
            editModal = document.createElement('div');
            editModal.className = 'modal fade';
            editModal.id = 'editPlanModal';
            editModal.setAttribute('tabindex', '-1');
            editModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Development Plan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editPlanForm">
                                <input type="hidden" id="editPlanId" name="plan_id">
                                
                                <div class="mb-3">
                                    <label for="editPlanTitle" class="form-label">Plan Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editPlanTitle" name="title" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="editPlanType" class="form-label">Plan Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editPlanType" name="plan_type" required>
                                        <option value="training">Training</option>
                                        <option value="hiring">Hiring</option>
                                        <option value="contractor">Contractor</option>
                                        <option value="redistribute">Redistribute Work</option>
                                        <option value="mentorship">Mentorship</option>
                                        <option value="cross_training">Cross-Training</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="editPlanStatus" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editPlanStatus" name="status" required>
                                        <option value="proposed">Proposed</option>
                                        <option value="approved">Approved</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="editPlanDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editPlanDescription" name="description" rows="3"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanProgress" class="form-label">Progress (%)</label>
                                        <input type="number" class="form-control" id="editPlanProgress" name="progress_percentage" min="0" max="100">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanProficiency" class="form-label">Target Proficiency</label>
                                        <select class="form-select" id="editPlanProficiency" name="target_proficiency">
                                            <option value="beginner">Beginner</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                            <option value="expert">Expert</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanHours" class="form-label">Estimated Hours</label>
                                        <input type="number" class="form-control" id="editPlanHours" name="estimated_hours" min="0" step="0.5">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanCost" class="form-label">Estimated Cost</label>
                                        <input type="number" class="form-control" id="editPlanCost" name="estimated_cost" min="0" step="0.01">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanStartDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="editPlanStartDate" name="start_date">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editPlanTargetDate" class="form-label">Target Completion Date</label>
                                        <input type="date" class="form-control" id="editPlanTargetDate" name="target_completion_date">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitEditPlanForm()">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }
        
        // Populate form with plan data
        document.getElementById('editPlanId').value = plan.id;
        document.getElementById('editPlanTitle').value = plan.title;
        document.getElementById('editPlanType').value = plan.plan_type;
        document.getElementById('editPlanStatus').value = plan.status;
        document.getElementById('editPlanDescription').value = plan.description || '';
        document.getElementById('editPlanProgress').value = plan.progress_percentage;
        document.getElementById('editPlanProficiency').value = plan.target_proficiency;
        document.getElementById('editPlanHours').value = plan.estimated_hours || '';
        document.getElementById('editPlanCost').value = plan.estimated_cost || '';
        document.getElementById('editPlanStartDate').value = plan.start_date || '';
        document.getElementById('editPlanTargetDate').value = plan.target_completion_date || '';
        
        // Show modal
        const modal = new bootstrap.Modal(editModal);
        modal.show();
    }
    
    window.submitEditPlanForm = async function() {
        const form = document.getElementById('editPlanForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const planId = document.getElementById('editPlanId').value;
        const formData = {
            title: document.getElementById('editPlanTitle').value,
            plan_type: document.getElementById('editPlanType').value,
            status: document.getElementById('editPlanStatus').value,
            description: document.getElementById('editPlanDescription').value,
            progress_percentage: parseInt(document.getElementById('editPlanProgress').value) || 0,
            target_proficiency: document.getElementById('editPlanProficiency').value,
            estimated_hours: parseFloat(document.getElementById('editPlanHours').value) || null,
            estimated_cost: parseFloat(document.getElementById('editPlanCost').value) || null,
            start_date: document.getElementById('editPlanStartDate').value || null,
            target_completion_date: document.getElementById('editPlanTargetDate').value || null
        };
        
        try {
            const response = await fetch(`/api/development-plans/${planId}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update plan');
            }
            
            const data = await response.json();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPlanModal'));
            modal.hide();
            
            // Show success message
            showNotification('Development plan updated successfully', 'success');
            
            // Reload the skill gap analyzer
            if (window.skillGapAnalyzer) {
                await window.skillGapAnalyzer.loadDevelopmentPlans();
                window.skillGapAnalyzer.renderPlansSection();
            } else {
                // Fallback: reload page
                location.reload();
            }
            
        } catch (error) {
            console.error('Error updating plan:', error);
            showNotification('Failed to update development plan: ' + error.message, 'error');
        }
    };
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    function getPlanTypeBadgeHTML(type) {
        const badges = {
            'training': '<span class="badge bg-primary"><i class="fas fa-book me-1"></i>Training</span>',
            'hiring': '<span class="badge bg-success"><i class="fas fa-user-plus me-1"></i>Hiring</span>',
            'contractor': '<span class="badge bg-info"><i class="fas fa-handshake me-1"></i>Contractor</span>',
            'redistribute': '<span class="badge bg-warning text-dark"><i class="fas fa-exchange-alt me-1"></i>Redistribute</span>',
            'mentorship': '<span class="badge bg-purple"><i class="fas fa-user-graduate me-1"></i>Mentorship</span>',
            'cross_training': '<span class="badge bg-secondary"><i class="fas fa-users me-1"></i>Cross-training</span>'
        };
        return badges[type] || '<span class="badge bg-secondary">' + type + '</span>';
    };

    window.createPlanForGap = async function(gapId) {
        try {
            // Close gap details modal if open
            const gapModal = bootstrap.Modal.getInstance(document.getElementById('gapDetailsModal'));
            if (gapModal) {
                gapModal.hide();
            }
            
            // Fetch gap details to pre-fill form
            const response = await fetch(`/api/skill-gaps/${gapId}/detail/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load gap details');
            }
            
            const data = await response.json();
            const gap = data.gap;
            
            // Create plan modal if it doesn't exist
            let planModal = document.getElementById('createPlanModal');
            if (!planModal) {
                planModal = document.createElement('div');
                planModal.className = 'modal fade';
                planModal.id = 'createPlanModal';
                planModal.setAttribute('tabindex', '-1');
                planModal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create Development Plan</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createPlanForm">
                                    <input type="hidden" id="planGapId" name="skill_gap_id">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Skill Gap</label>
                                        <input type="text" class="form-control" id="planSkillName" readonly>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="planTitle" class="form-label">Plan Title <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="planTitle" name="title" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="planType" class="form-label">Plan Type <span class="text-danger">*</span></label>
                                        <select class="form-select" id="planType" name="plan_type" required>
                                            <option value="">Select plan type...</option>
                                            <option value="training">Training</option>
                                            <option value="hiring">Hiring</option>
                                            <option value="contractor">Contractor</option>
                                            <option value="redistribute">Redistribute Work</option>
                                            <option value="mentorship">Mentorship</option>
                                            <option value="cross_training">Cross-Training</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="planDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="planDescription" name="description" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="planHours" class="form-label">Estimated Hours</label>
                                            <input type="number" class="form-control" id="planHours" name="estimated_hours" min="0" step="0.5">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="planCost" class="form-label">Estimated Cost</label>
                                            <input type="number" class="form-control" id="planCost" name="estimated_cost" min="0" step="0.01">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="planTargetDate" class="form-label">Target Completion Date</label>
                                        <input type="date" class="form-control" id="planTargetDate" name="target_completion_date">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitPlanForm()">Create Plan</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(planModal);
            }
            
            // Pre-fill form
            document.getElementById('planGapId').value = gap.id;
            document.getElementById('planSkillName').value = `${gap.skill_name} (${gap.proficiency_level})`;
            document.getElementById('planTitle').value = `Develop ${gap.skill_name} Skills`;
            document.getElementById('planDescription').value = `Address skill gap: Need ${gap.gap_count} more team member(s) with ${gap.proficiency_level} level ${gap.skill_name} skills.`;
            
            // Show modal
            const modal = new bootstrap.Modal(planModal);
            modal.show();
            
        } catch (error) {
            console.error('Error creating plan:', error);
            showToast('Failed to open plan creation form: ' + error.message, 'error');
        }
    };
    
    window.submitPlanForm = async function() {
        try {
            const form = document.getElementById('createPlanForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                skill_gap_id: document.getElementById('planGapId').value,
                title: document.getElementById('planTitle').value,
                plan_type: document.getElementById('planType').value,
                description: document.getElementById('planDescription').value,
                estimated_hours: document.getElementById('planHours').value || null,
                estimated_cost: document.getElementById('planCost').value || null,
                target_completion_date: document.getElementById('planTargetDate').value || null
            };
            
            const response = await fetch('/api/development-plans/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to create plan');
            }
            
            const data = await response.json();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createPlanModal'));
            if (modal) {
                modal.hide();
            }
            
            // Show success message and reload
            showToast('Development plan created successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('Error submitting plan:', error);
            showToast('Failed to create plan: ' + error.message, 'error');
        }
    };

    // Utility functions
    window.showLoadingOverlay = function(message) {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = `
            <div class="text-center text-white">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>${message}</p>
            </div>
        `;
        document.body.appendChild(overlay);
    };

    window.hideLoadingOverlay = function() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    };

    window.showToast = function(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
        toast.style.zIndex = '10000';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    // Handle back navigation
    function goBack() {
        // Check if there's a previous page in history
        if (document.referrer && document.referrer !== window.location.href) {
            window.history.back();
        } else {
            // Fallback to board detail if no history (demo-aware)
            {% if is_demo_mode %}
            window.location.href = '{% url "demo_board_detail" board.id %}';
            {% else %}
            window.location.href = '{% url "board_detail" board.id %}';
            {% endif %}
        }
    }
    
    // Track skill gap analysis page view as a feature (for demo nudges)
    {% if is_demo_mode %}
    setTimeout(function() {
        fetch('/demo/track-event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                event_type: 'feature_explored',
                event_data: {
                    feature: 'skill_gap_analysis',
                    page: window.location.pathname,
                    timestamp: new Date().toISOString()
                }
            })
        })
        .then(response => response.json())
        .then(data => console.log('📊 Feature tracked: skill_gap_analysis'))
        .catch(error => console.error('Error tracking feature:', error));
    }, 3000); // Track after 3 seconds of viewing
    {% endif %}
</script>
{% endblock %}
