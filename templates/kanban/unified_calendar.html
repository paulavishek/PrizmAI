{% extends 'base.html' %}
{% load static %}

{% block title %}My Calendar â€” PrizmAI{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet' />
<style>
    .calendar-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 24px;
    }
    .fc-event {
        cursor: pointer;
        border-radius: 4px !important;
        font-size: 0.8rem;
        padding: 2px 4px;
    }
    .fc-event:hover { opacity: 0.85; transform: translateY(-1px); transition: 0.15s; }
    /* Pointer cursor on clickable day cells */
    .fc .fc-daygrid-day,
    .fc .fc-timegrid-slot,
    .fc .fc-daygrid-bg-harness,
    .fc .fc-daygrid-day-frame { cursor: pointer; }
    .stat-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    .stat-card .stat-number { font-size: 2rem; font-weight: 700; }
    /* Tooltip */
    #cal-tooltip {
        position: fixed;
        z-index: 9999;
        background: #212529;
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.82rem;
        pointer-events: none;
        display: none;
        max-width: 260px;
        line-height: 1.6;
    }
    /* Board filter chips */
    .board-chip {
        cursor: pointer;
        transition: opacity 0.15s;
        user-select: none;
    }
    .board-chip.inactive { opacity: 0.4; }
    /* Teammate chips */
    .teammate-chip {
        cursor: pointer;
        transition: opacity 0.15s;
        user-select: none;
        font-size: 0.78rem !important;
        padding: 5px 10px !important;
    }
    .teammate-chip.inactive { opacity: 0.35; text-decoration: line-through; }
    /* Modal adjustments */
    .nav-tabs .nav-link { font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-calendar-alt me-2 text-primary"></i>My Calendar
            </h1>
            <p class="text-muted mb-0">All tasks &amp; events across your boards â€” {{ current_month }}</p>
        </div>
        <button class="btn btn-primary btn-sm" id="btn-new">
            <i class="fas fa-plus me-1"></i> New
        </button>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number text-primary">{{ total_tasks }}</div>
                <div class="text-muted small">Scheduled Tasks</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number text-purple" style="color:#6f42c1">{{ events_this_month }}</div>
                <div class="text-muted small">Events This Month</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="stat-card">
                <div class="stat-number text-danger">{{ overdue_count }}</div>
                <div class="text-muted small">Overdue Tasks</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-1" style="font-size:0.8rem;">
        <strong class="small text-muted me-1">Your tasks (priority):</strong>
        <span class="small"><span class="badge" style="background:#dc3545;">â—</span> Urgent</span>
        <span class="small"><span class="badge" style="background:#fd7e14;">â—</span> High</span>
        <span class="small"><span class="badge" style="background:#0d6efd;">â—</span> Medium</span>
        <span class="small"><span class="badge" style="background:#198754;">â—</span> Low</span>
        <span class="ms-3 small text-muted me-1">Events:</span>
        <span class="small"><span class="badge" style="background:#6f42c1;">â—</span> Meeting</span>
        <span class="small"><span class="badge" style="background:#f59e0b;">â—</span> Out of Office</span>
        <span class="small"><span class="badge" style="background:#64748b;">â—</span> Busy Block</span>
        <span class="small"><span class="badge" style="background:#0284c7;">â—</span> Team Event</span>
    </div>
    <!-- Teammate colour legend (built by JS) -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3" id="teammate-legend" style="font-size:0.8rem;">
        <strong class="small text-muted me-1">Teammates:</strong>
    </div>

    <!-- Board filter chips -->
    {% if boards %}
    <div class="d-flex flex-wrap gap-2 mb-3" id="board-chips">
        <span class="badge board-chip bg-secondary" data-board-id="all" style="font-size:0.8rem; padding:6px 10px;">All Boards</span>
        {% for b in boards %}
        <span class="badge board-chip bg-primary" data-board-id="{{ b.id }}" style="font-size:0.8rem; padding:6px 10px;">{{ b.name }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Team view mode toggle -->
    <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
        <span class="small text-muted fw-semibold">Team view:</span>
        <div class="btn-group btn-group-sm" role="group" aria-label="Team view mode">
            <button type="button" class="btn btn-outline-secondary" id="btn-mode-detail">
                <i class="fas fa-list-ul me-1"></i> Detail
            </button>
            <button type="button" class="btn btn-outline-secondary" id="btn-mode-avail">
                <i class="fas fa-calendar-check me-1"></i> Availability
            </button>
        </div>
        <span class="text-muted small" id="team-mode-badge"></span>
    </div>
    <!-- Teammate filter chips (built by JS) -->
    <div class="d-flex flex-wrap gap-2 mb-3" id="teammate-chips" style="display:none!important;"></div>

    <!-- Calendar -->
    <div class="calendar-container">
        <div class="d-flex align-items-center gap-2 mb-3 text-muted" style="font-size:0.82rem;">
            <i class="fas fa-hand-pointer" style="color:#0d6efd;"></i>
            <span>Click any date to quickly <strong>create a task</strong> or <strong>schedule an event</strong> on that day.</span>
        </div>
        <div id='calendar'></div>
    </div>

</div>

<!-- Hover Tooltip -->
<div id="cal-tooltip"></div>

<!-- ============================
     Create / New popup (tiny)
============================= -->
<div id="create-popup" class="card shadow" style="
    display:none; position:fixed; z-index:1055; min-width:180px;
    border-radius:10px; overflow:hidden;">
    <div class="list-group list-group-flush">
        <button class="list-group-item list-group-item-action py-2 px-3" id="popup-create-task">
            <i class="fas fa-tasks me-2 text-primary"></i> Create Task
        </button>
        <button class="list-group-item list-group-item-action py-2 px-3" id="popup-create-event">
            <i class="fas fa-calendar-plus me-2 text-purple" style="color:#6f42c1"></i> Schedule Event
        </button>
    </div>
</div>

<!-- ============================
     CREATE TASK MODAL
     (select board â†’ redirect to full Kanban task form)
============================= -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-tasks me-2 text-primary"></i>Create Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">Select a board to open the full task creation form with AI features.</p>
        <div class="mb-3">
          <label class="form-label fw-semibold">Board <span class="text-danger">*</span></label>
          <select class="form-select" id="task-board">
            <option value="">â€” select board â€”</option>
            {% for b in boards %}
            <option value="{{ b.id }}">{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="task-form-error" class="alert alert-danger d-none small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="btn-go-create-task">
          <i class="fas fa-arrow-right me-1"></i> Continue to Form
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================
     CREATE EVENT MODAL
============================= -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createEventModalLabel">
          <i class="fas fa-calendar-plus me-2" style="color:#6f42c1"></i>Schedule Event
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="event-form-error" class="alert alert-danger d-none"></div>

        <!-- Type row (determines which fields are shown below) -->
        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Event Type</label>
            <select class="form-select" id="event-type">
              <option value="meeting">ğŸ¤ Meeting</option>
              <option value="out_of_office">ğŸ– Out of Office</option>
              <option value="busy_block">ğŸ”´ Busy Block</option>
              <option value="team_event">ğŸŸ Team Event</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Visibility</label>
            <select class="form-select" id="event-visibility">
              <option value="team">Team can see Iâ€™m busy</option>
              <option value="private">ğŸ”’ Private (only me)</option>
            </select>
            <small class="text-muted" id="event-visibility-hint" style="font-size:0.78rem;">Teammates see youâ€™re blocked but not the reason.</small>
          </div>
        </div>

        <!-- Title -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="event-title" placeholder="Event titleâ€¦">
        </div>

        <!-- All-day toggle + Date/Time -->
        <div class="mb-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="event-all-day">
            <label class="form-check-label" for="event-all-day">All Day</label>
          </div>
        </div>
        <div class="row g-2 mb-3" id="event-datetime-row">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Start <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="event-start">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">End <span class="text-danger">*</span></label>
            <input type="datetime-local" class="form-control" id="event-end">
          </div>
        </div>
        <div class="row g-2 mb-3" id="event-allday-row" style="display:none!important">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Start Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="event-start-date">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">End Date</label>
            <input type="date" class="form-control" id="event-end-date">
          </div>
        </div>

        <!-- Linked Task (Busy Block only) -->
        <div class="mb-3" id="event-linked-task-row" style="display:none;">
          <label class="form-label fw-semibold">Linked Task <span class="text-muted fw-normal small">(optional)</span></label>
          <select class="form-select" id="event-linked-task">
            <option value="">â€” None (show generic busy) â€”</option>
          </select>
          <small class="text-muted">Teammates will see â€œbusy (Task Name)â€ instead of just â€œbusyâ€.</small>
        </div>

        <!-- Location (Meeting / Team Event) -->
        <div class="mb-3" id="event-location-row">
          <label class="form-label fw-semibold">Location</label>
          <input type="text" class="form-control" id="event-location" placeholder="Room, Zoom link, etc.">
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Description</label>
          <textarea class="form-control" id="event-description" rows="2" placeholder="Agenda or notesâ€¦"></textarea>
        </div>

        <!-- Participants (Meeting / Team Event) -->
        <div class="mb-3" id="event-participants-row">
          <label class="form-label fw-semibold">Participants</label>
          <select class="form-select" id="event-participants" multiple style="height:100px;"></select>
          <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
        </div>

        <!-- Board (optional, shown for non-OOO/non-busy) -->
        <div class="mb-3" id="event-board-row">
          <label class="form-label fw-semibold">Board <span class="text-muted fw-normal small">(optional)</span></label>
          <select class="form-select" id="event-board">
            <option value="">â€” none â€”</option>
            {% for b in boards %}
            <option value="{{ b.id }}">{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="btn-save-event">
          <i class="fas fa-save me-1"></i> Schedule
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============================
     EVENT / TASK DETAIL POPOVER
============================= -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="detail-title">Details</h6>
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detail-body" style="font-size:0.9rem;"></div>
      <div class="modal-footer py-2">
        <a href="#" id="detail-open-link" class="btn btn-primary btn-sm">Open</a>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ---- Data from Django ----
    const boardsData      = {{ boards_json|safe }};
    const allParticipants = {{ participants_json|safe }};
    const teammatesData   = {{ teammates_json|safe }};
    const allTasksData    = {{ all_tasks_json|safe }};
    const CSRF            = '{{ csrf_token }}';
    const EVENTS_URL      = '{% url "unified_calendar_events_api" %}';
    const CREATE_EVENT_URL = '{% url "calendar_create_event" %}';

    // ---- Board filter state ----
    let activeBoardIds = [];  // empty = all

    // ---- Team layer / view mode state ----
    let teamViewMode      = localStorage.getItem('prizmTeamViewMode') || 'detail';
    let hiddenTeammateIds = new Set();

    // ---- Layer/mode event processing ----
    function processEvents(data) {
        let filtered = data;
        // Apply teammate visibility filter (hides tasks AND status events from that teammate)
        if (hiddenTeammateIds.size > 0) {
            filtered = data.filter(function(e) {
                const p = e.extendedProps;
                if (!p) return true;
                if (p.layer === 'teammate')        return !hiddenTeammateIds.has(p.assignee_id);
                if (p.layer === 'teammate_status') return !hiddenTeammateIds.has(p.creator_id);
                return true;
            });
        }

        if (teamViewMode === 'detail') return filtered;

        // Availability mode: aggregate teammate *tasks* into compact "busy" blocks;
        // teammate_status CalendarEvents (OOO/Busy Block/Team Event) pass through with
        // their already-sanitized titles from the server.
        const pass = [];
        const busyMap = {};
        filtered.forEach(function(e) {
            const p = e.extendedProps;
            if (p && p.layer === 'teammate') {
                // Aggregate task-due-date busy signals
                const key = `${p.assignee_id}_${e.start}`;
                if (!busyMap[key]) {
                    busyMap[key] = {
                        assignee_id: p.assignee_id,
                        name: p.assignee_name || p.assignee || 'Teammate',
                        color: e.color,
                        date: e.start,
                        count: 0,
                    };
                }
                busyMap[key].count++;
            } else {
                // 'mine', 'event', 'teammate_status' â€” always pass through
                pass.push(e);
            }
        });
        Object.values(busyMap).forEach(function(b) {
            const n = b.count;
            pass.push({
                id: `busy-${b.assignee_id}-${b.date}`,
                title: `${b.name} â€” busy (${n} task${n !== 1 ? 's' : ''})`,
                start: b.date,
                color: b.color,
                extendedProps: { source: 'busy', layer: 'busy',
                                 assignee_name: b.name, count: n },
            });
        });
        return pass;
    }

    // ---- Create popup & last clicked date ----
    const createPopup = document.getElementById('create-popup');
    let clickedDateStr = null;
    let clickedDatetime = null;

    // Smart popup positioning â€” position:fixed uses viewport coords, never scrollY
    function showPopup(clientX, clientY) {
        const POPUP_H = 88, POPUP_W = 200;
        let top  = clientY + 10;
        let left = clientX;
        if (top  + POPUP_H > window.innerHeight - 8) top  = clientY - POPUP_H - 10;
        if (left + POPUP_W > window.innerWidth  - 8) left = window.innerWidth - POPUP_W - 8;
        if (left < 8) left = 8;
        if (top  < 8) top  = 8;
        createPopup.style.top  = top  + 'px';
        createPopup.style.left = left + 'px';
        createPopup.style.display = 'block';
    }

    // ---- Tooltip ----
    const tooltip = document.getElementById('cal-tooltip');
    document.addEventListener('mousemove', e => {
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top  = (e.clientY - 10) + 'px';
    });

    // ---- FullCalendar ----
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        firstDay: 1,
        headerToolbar: {
            left:   'prev,next today',
            center: 'title',
            right:  'dayGridMonth,timeGridWeek,listMonth',
        },
        height: 'auto',
        events: function (fetchInfo, successCallback, failureCallback) {
            let url = `${EVENTS_URL}?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;
            if (activeBoardIds.length > 0) {
                url += `&boards=${activeBoardIds.join(',')}`;
            }
            fetch(url)
                .then(r => r.json())
                .then(data => successCallback(processEvents(data)))
                .catch(() => failureCallback());
        },
        // Click on empty date cell â†’ show create popup
        dateClick: function (info) {
            clickedDateStr = info.dateStr;
            clickedDatetime = info.date;
            showPopup(info.jsEvent.clientX, info.jsEvent.clientY);
        },
        // Click on existing event â†’ show detail popover
        eventClick: function (info) {
            info.jsEvent.preventDefault();
            createPopup.style.display = 'none';
            const p = info.event.extendedProps;
            if (!p || p.source === 'busy') return;  // aggregated busy block â€” no detail
            const title = info.event.title;

            document.getElementById('detail-title').textContent = title;

            let body = '';
            if (p.source === 'task') {
                body = `
                    <div><strong>Board:</strong> ${p.board}</div>
                    <div><strong>Column:</strong> ${p.column}</div>
                    <div><strong>Priority:</strong> ${p.priority}</div>
                    ${p.assignee ? `<div><strong>Assignee:</strong> ${p.assignee}</div>` : ''}
                    <div><strong>Progress:</strong> ${p.progress}%</div>
                `;
                document.getElementById('detail-open-link').href = info.event.url;
                document.getElementById('detail-open-link').style.display = '';
            } else if (p.layer === 'teammate_status') {
                // Teammateâ€™s status event â€” show limited info
                body = `
                    <div><strong>Type:</strong> ${p.event_type}</div>
                    ${p.linked_task_title ? `<div><strong>Working on:</strong> ${p.linked_task_title}</div>` : ''}
                `;
                document.getElementById('detail-open-link').href = `/calendar/events/${p.event_id}/`;
                document.getElementById('detail-open-link').style.display = '';
            } else {
                // My own events â€” full detail
                const participants = p.participants && p.participants.length
                    ? p.participants.join(', ')
                    : '(none beyond you)';
                const privBadge = p.visibility === 'private'
                    ? '<div class="mt-2"><span class="badge bg-secondary">ğŸ”’ Private</span></div>' : '';
                body = `
                    <div><strong>Type:</strong> ${p.event_type}</div>
                    ${p.board ? `<div><strong>Board:</strong> ${p.board}</div>` : ''}
                    ${p.location ? `<div><strong>Location:</strong> ${p.location}</div>` : ''}
                    ${p.description ? `<div><strong>Notes:</strong> ${p.description}</div>` : ''}
                    ${p.linked_task_title ? `<div><strong>Linked task:</strong> ${p.linked_task_title}</div>` : ''}
                    ${p.event_type_key === 'meeting' || p.event_type_key === 'team_event'
                        ? `<div><strong>Participants:</strong> ${participants}</div>` : ''}
                    ${privBadge}
                `;
                document.getElementById('detail-open-link').href = `/calendar/events/${p.event_id}/`;
                document.getElementById('detail-open-link').style.display = '';
            }
            document.getElementById('detail-body').innerHTML = body;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        },
        eventMouseEnter: function (info) {
            const p = info.event.extendedProps;
            if (p.source === 'busy') {
                tooltip.innerHTML = `<strong>${info.event.title}</strong><br><span style="color:#aaa;">Switch to Detail view to see individual tasks.</span>`;
            } else if (p.source === 'task') {
                const layerBit = p.layer === 'teammate'
                    ? `<br><span style="color:${info.event.backgroundColor}; font-weight:600;">â— ${p.assignee_name || p.assignee}â€™s task</span>`
                    : '';
                tooltip.innerHTML = `
                    <strong>${info.event.title}</strong><br>
                    ğŸ“‹ ${p.board} â€º ${p.column}<br>
                    ğŸš© ${p.priority}${layerBit}
                    ${p.assignee ? `<br>ğŸ‘¤ ${p.assignee}` : ''}
                    <br>â¬œ ${p.progress}% complete
                `;
            } else if (p.layer === 'teammate_status') {
                // Sanitized title already contains name + status
                const icons = {
                    'out_of_office': 'ğŸ–',
                    'busy_block': 'ğŸ”´',
                    'team_event': 'ğŸŸ',
                    'meeting': 'ğŸ¤',
                };
                const icon = icons[p.event_type_key] || 'ğŸ—“';
                tooltip.innerHTML = `${icon} <strong>${info.event.title}</strong>
                    ${p.linked_task_title ? `<br>ğŸ“‹ Task: ${p.linked_task_title}` : ''}`;  
            } else {
                // My own event
                const privBadge = p.visibility === 'private'
                    ? '<br><span style="color:#9ca3af;">ğŸ”’ Private â€” only you see this</span>' : '';
                tooltip.innerHTML = `
                    <strong>${info.event.title}</strong><br>
                    ğŸ—“ ${p.event_type}
                    ${p.board ? `<br>ğŸ“‹ ${p.board}` : ''}
                    ${p.location ? `<br>ğŸ“ ${p.location}` : ''}
                    ${p.linked_task_title ? `<br>ğŸ“‹ Task: ${p.linked_task_title}` : ''}
                    ${privBadge}
                `;
            }
            tooltip.style.display = 'block';
        },
        eventMouseLeave: function () { tooltip.style.display = 'none'; },
        eventDidMount: function (info) {
            const p = info.event.extendedProps;
            // Teammate tasks: slightly muted so yours stand out
            if (p.layer === 'teammate') {
                info.el.style.opacity = '0.72';
            }
            if (p.source === 'task' && p.layer === 'mine') {
                const d = new Date(info.event.start);
                const today = new Date(); today.setHours(0,0,0,0);
                if (d < today && p.progress < 100) {
                    info.el.style.opacity = '0.7';
                    info.el.style.textDecoration = 'line-through';
                }
            }
        },
    });
    calendar.render();

    // ---- Apply stored team view mode ----
    (function applyMode() {
        const detailBtn = document.getElementById('btn-mode-detail');
        const availBtn  = document.getElementById('btn-mode-avail');
        const badge     = document.getElementById('team-mode-badge');
        if (!detailBtn) return;
        if (teamViewMode === 'detail') {
            detailBtn.classList.add('active');
            availBtn.classList.remove('active');
            if (badge) badge.textContent = 'Showing teammate task details';
        } else {
            availBtn.classList.add('active');
            detailBtn.classList.remove('active');
            if (badge) badge.textContent = 'Showing busy / free blocks';
        }
    })();

    document.getElementById('btn-mode-detail').addEventListener('click', function() {
        teamViewMode = 'detail';
        localStorage.setItem('prizmTeamViewMode', 'detail');
        document.getElementById('btn-mode-detail').classList.add('active');
        document.getElementById('btn-mode-avail').classList.remove('active');
        const b = document.getElementById('team-mode-badge');
        if (b) b.textContent = 'Showing teammate task details';
        calendar.refetchEvents();
    });
    document.getElementById('btn-mode-avail').addEventListener('click', function() {
        teamViewMode = 'availability';
        localStorage.setItem('prizmTeamViewMode', 'availability');
        document.getElementById('btn-mode-avail').classList.add('active');
        document.getElementById('btn-mode-detail').classList.remove('active');
        const b = document.getElementById('team-mode-badge');
        if (b) b.textContent = 'Showing busy / free blocks';
        calendar.refetchEvents();
    });

    // ---- Build teammate legend + filter chips ----
    const tmLegendEl = document.getElementById('teammate-legend');
    const tmChipsEl  = document.getElementById('teammate-chips');

    if (teammatesData.length > 0) {
        if (tmChipsEl) tmChipsEl.style.removeProperty('display');
        teammatesData.forEach(function(t) {
            // Legend entry
            if (tmLegendEl) {
                const ls = document.createElement('span');
                ls.className = 'small';
                ls.innerHTML = `<span class="badge" style="background:${t.color};">â—</span> ${t.display}`;
                tmLegendEl.appendChild(ls);
            }
            // Filter chip
            if (tmChipsEl) {
                const chip = document.createElement('span');
                chip.className = 'badge teammate-chip';
                chip.dataset.teammateId = t.id;
                chip.style.background = t.color;
                chip.textContent = t.display;
                tmChipsEl.appendChild(chip);
            }
        });

        if (tmChipsEl) {
            tmChipsEl.addEventListener('click', function(e) {
                const chip = e.target.closest('.teammate-chip');
                if (!chip) return;
                const tid = parseInt(chip.dataset.teammateId, 10);
                if (hiddenTeammateIds.has(tid)) {
                    hiddenTeammateIds.delete(tid);
                    chip.classList.remove('inactive');
                } else {
                    hiddenTeammateIds.add(tid);
                    chip.classList.add('inactive');
                }
                calendar.refetchEvents();
            });
        }
    }

    // Close popup on outside click
    document.addEventListener('click', function (e) {
        if (!createPopup.contains(e.target) && e.target.id !== 'btn-new') {
            createPopup.style.display = 'none';
        }
    });

    // "New" button in header â†’ anchor popup near button
    document.getElementById('btn-new').addEventListener('click', function (e) {
        e.stopPropagation();
        const rect = this.getBoundingClientRect();
        showPopup(rect.left, rect.bottom + 4);
        // Default to today if no date clicked
        if (!clickedDateStr) {
            const d = new Date();
            clickedDateStr = d.toISOString().split('T')[0];
            clickedDatetime = d;
        }
    });

    // ---- Board filter chips ----
    document.querySelectorAll('.board-chip').forEach(chip => {
        chip.addEventListener('click', function () {
            const boardId = this.dataset.boardId;
            if (boardId === 'all') {
                activeBoardIds = [];
                document.querySelectorAll('.board-chip').forEach(c => c.classList.remove('inactive'));
            } else {
                const idx = activeBoardIds.indexOf(boardId);
                if (idx === -1) {
                    activeBoardIds.push(boardId);
                    this.classList.remove('inactive');
                    // Deactivate "All" chip
                    document.querySelector('.board-chip[data-board-id="all"]').classList.add('inactive');
                } else {
                    activeBoardIds.splice(idx, 1);
                    this.classList.add('inactive');
                    if (activeBoardIds.length === 0) {
                        document.querySelector('.board-chip[data-board-id="all"]').classList.remove('inactive');
                    }
                }
            }
            calendar.refetchEvents();
        });
    });

    // ================================================================
    //  CREATE TASK FLOW (redirects to full Kanban task creation form)
    // ================================================================
    document.getElementById('popup-create-task').addEventListener('click', function () {
        createPopup.style.display = 'none';
        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    });

    document.getElementById('btn-go-create-task').addEventListener('click', function () {
        const errDiv = document.getElementById('task-form-error');
        errDiv.classList.add('d-none');
        const boardId = document.getElementById('task-board').value;
        if (!boardId) {
            errDiv.textContent = 'Please select a board.';
            errDiv.classList.remove('d-none');
            return;
        }
        let url = '/boards/' + boardId + '/create-task/';
        if (clickedDateStr) url += '?due_date=' + clickedDateStr;
        window.location.href = url;
    });

        // ================================================================
    //  CREATE EVENT FLOW
    // ================================================================

    // Populate participants list
    const partSelect = document.getElementById('event-participants');
    allParticipants.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.display} (${p.username})`;
        partSelect.appendChild(opt);
    });

    // Populate linked task dropdown (grouped by board)
    const linkedTaskSel = document.getElementById('event-linked-task');
    const tasksByBoard = {};
    allTasksData.forEach(function(t) {
        if (!tasksByBoard[t.board_name]) tasksByBoard[t.board_name] = [];
        tasksByBoard[t.board_name].push(t);
    });
    Object.entries(tasksByBoard).forEach(function([boardName, tasks]) {
        const grp = document.createElement('optgroup');
        grp.label = boardName;
        tasks.forEach(function(t) {
            const o = document.createElement('option');
            o.value = t.id;
            o.textContent = t.title;
            grp.appendChild(o);
        });
        linkedTaskSel.appendChild(grp);
    });

    // ---- Event Type change handler: show/hide contextual fields ----
    const TYPE_FIELDS = {
        meeting:       { participants: true,  location: true,  linked_task: false, board: true  },
        out_of_office: { participants: false, location: false, linked_task: false, board: false },
        busy_block:    { participants: false, location: false, linked_task: true,  board: false },
        team_event:    { participants: true,  location: true,  linked_task: false, board: true  },
    };
    function applyEventTypeFields(type) {
        const cfg = TYPE_FIELDS[type] || TYPE_FIELDS.meeting;
        document.getElementById('event-participants-row').style.display = cfg.participants ? '' : 'none';
        document.getElementById('event-location-row').style.display    = cfg.location    ? '' : 'none';
        document.getElementById('event-linked-task-row').style.display = cfg.linked_task ? '' : 'none';
        document.getElementById('event-board-row').style.display       = cfg.board       ? '' : 'none';
        // Out of Office defaults to All Day
        if (type === 'out_of_office') {
            document.getElementById('event-all-day').checked = true;
            document.getElementById('event-datetime-row').style.display = 'none';
            document.getElementById('event-allday-row').style.removeProperty('display');
        }
    }
    document.getElementById('event-type').addEventListener('change', function() {
        applyEventTypeFields(this.value);
    });
    // Apply on load (default = meeting)
    applyEventTypeFields('meeting');

    document.getElementById('popup-create-event').addEventListener('click', function () {
        createPopup.style.display = 'none';
        // Pre-fill date/time
        if (clickedDateStr) {
            document.getElementById('event-start-date').value = clickedDateStr;
            document.getElementById('event-end-date').value   = clickedDateStr;
            const startDT = clickedDateStr + 'T09:00';
            const endDT   = clickedDateStr + 'T10:00';
            document.getElementById('event-start').value = startDT;
            document.getElementById('event-end').value   = endDT;
        }
        new bootstrap.Modal(document.getElementById('createEventModal')).show();
    });

    // All-day toggle
    document.getElementById('event-all-day').addEventListener('change', function () {
        const isAllDay = this.checked;
        document.getElementById('event-datetime-row').style.display = isAllDay ? 'none' : '';
        document.getElementById('event-allday-row').style.display   = isAllDay ? '' : 'none';
    });

    document.getElementById('btn-save-event').addEventListener('click', function () {
        const errDiv = document.getElementById('event-form-error');
        errDiv.classList.add('d-none');

        const title = document.getElementById('event-title').value.trim();
        if (!title) { errDiv.textContent = 'Title is required.'; errDiv.classList.remove('d-none'); return; }

        const isAllDay = document.getElementById('event-all-day').checked;
        let startDT, endDT;
        if (isAllDay) {
            startDT = document.getElementById('event-start-date').value + 'T00:00:00';
            endDT   = (document.getElementById('event-end-date').value ||
                       document.getElementById('event-start-date').value) + 'T23:59:59';
        } else {
            startDT = document.getElementById('event-start').value;
            endDT   = document.getElementById('event-end').value;
        }

        if (!startDT || !endDT) {
            errDiv.textContent = 'Start and end are required.';
            errDiv.classList.remove('d-none');
            return;
        }

        // Gather selected participants
        const selectedOpts = Array.from(partSelect.selectedOptions);
        const participantIds = selectedOpts.map(o => parseInt(o.value));

        const payload = {
            title,
            event_type:     document.getElementById('event-type').value,
            visibility:     document.getElementById('event-visibility').value,
            is_all_day:     isAllDay,
            start_datetime: startDT,
            end_datetime:   endDT,
            location:       document.getElementById('event-location').value.trim(),
            description:    document.getElementById('event-description').value.trim(),
            participant_ids: participantIds,
            board_id:       document.getElementById('event-board').value || null,
            linked_task_id: document.getElementById('event-linked-task').value || null,
        };

        this.disabled = true;
        fetch(CREATE_EVENT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF,
            },
            body: JSON.stringify(payload),
        })
        .then(r => r.json())
        .then(data => {
            this.disabled = false;
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('createEventModal')).hide();
                // Clear form
                document.getElementById('event-title').value           = '';
                document.getElementById('event-location').value        = '';
                document.getElementById('event-description').value     = '';
                document.getElementById('event-linked-task').value     = '';
                document.getElementById('event-visibility').value      = 'team';
                document.getElementById('event-type').value            = 'meeting';
                applyEventTypeFields('meeting');
                Array.from(partSelect.options).forEach(o => o.selected = false);
                // Add to calendar immediately
                calendar.addEvent(data.event);
            } else {
                errDiv.textContent = data.error || 'Failed to create event.';
                errDiv.classList.remove('d-none');
            }
        })
        .catch(() => {
            this.disabled = false;
            errDiv.textContent = 'Network error. Please try again.';
            errDiv.classList.remove('d-none');
        });
    });
});
</script>
{% endblock %}
