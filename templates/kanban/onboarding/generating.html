{% extends "kanban/onboarding/base_onboarding.html" %}

{% block title %}Building Your Workspace — PrizmAI{% endblock %}

{% block progress %}
<div class="onboarding-progress text-center">
    <span class="step done"><i class="bi bi-check-circle-fill"></i> Welcome</span>
    <span class="step-divider">›</span>
    <span class="step done"><i class="bi bi-check-circle-fill"></i> Goal</span>
    <span class="step-divider">›</span>
    <span class="step active"><i class="bi bi-gear-wide-connected fa-spin"></i> Generating</span>
    <span class="step-divider">›</span>
    <span class="step">Review</span>
    <span class="step-divider">›</span>
    <span class="step">Done</span>
</div>
{% endblock %}

{% block body %}
<div class="text-center" style="max-width: 480px;">
    <!-- Live status area -->
    <div id="statusArea">
        <div class="mb-4">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Generating…</span>
            </div>
        </div>
        <h3 id="statusText" class="mb-2" style="font-weight: 700;">Understanding your goal…</h3>
        <p class="text-muted mb-4" style="font-size: 0.9rem;">
            This usually takes 15-30 seconds. Sit tight!
        </p>
        <div class="progress mb-3" style="height: 6px; max-width: 320px; margin: 0 auto;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 10%; background: linear-gradient(135deg, #667eea, #764ba2);" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Error area (hidden by default) -->
    <div id="errorArea" class="d-none">
        <div class="mb-3">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2.5rem;"></i>
        </div>
        <h3 class="mb-2" style="font-weight: 700;">Something went wrong</h3>
        <p class="text-muted mb-4" style="font-size: 0.9rem;" id="errorMsg">
            But we've got you covered — you can try again or use a template workspace.
        </p>
        <div class="d-flex flex-column gap-2 align-items-center">
            <form method="post" action="{% url 'onboarding_goal' %}">
                {% csrf_token %}
                <input type="hidden" name="goal_text" value="{{ goal_text }}">
                <button type="submit" class="btn btn-prizm">
                    <i class="bi bi-arrow-clockwise me-1"></i>Try again
                </button>
            </form>
            <form method="post" action="{% url 'onboarding_skip' %}">
                {% csrf_token %}
                <button type="submit" class="link-subtle" style="background:none; border:none; cursor:pointer;">
                    Skip setup
                </button>
            </form>
        </div>
    </div>

    <!-- Timeout area (hidden by default) -->
    <div id="timeoutArea" class="d-none">
        <div class="mb-3">
            <i class="bi bi-hourglass-split text-warning" style="font-size: 2.5rem;"></i>
        </div>
        <h3 class="mb-2" style="font-weight: 700;">Taking longer than expected…</h3>
        <p class="text-muted mb-4" style="font-size: 0.9rem;">
            AI generation is still running. You can keep waiting, try again, or skip.
        </p>
        <div class="d-flex flex-column gap-2 align-items-center">
            <button class="btn btn-outline-primary" onclick="keepWaiting()">
                <i class="bi bi-clock-history me-1"></i>Keep waiting
            </button>
            <form method="post" action="{% url 'onboarding_goal' %}">
                {% csrf_token %}
                <input type="hidden" name="goal_text" value="{{ goal_text }}">
                <button type="submit" class="link-subtle" style="background:none; border:none; cursor:pointer;">
                    Try again with a different goal
                </button>
            </form>
            <form method="post" action="{% url 'onboarding_skip' %}">
                {% csrf_token %}
                <button type="submit" class="link-subtle" style="background:none; border:none; cursor:pointer;">
                    Skip setup
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const STATUS_URL = "{% url 'onboarding_status' %}";
    const REVIEW_URL = "{% url 'onboarding_review' %}";
    const POLL_INTERVAL = 2000;       // 2 seconds
    const TIMEOUT_MS = 45000;         // 45 seconds

    const messages = [
        'Understanding your goal…',
        'Creating missions…',
        'Building strategies…',
        'Setting up boards…',
        'Adding starter tasks…',
        'Almost there…',
    ];

    let msgIndex = 0;
    let startTime = Date.now();
    let timedOut = false;

    // Cycle through status messages
    const msgInterval = setInterval(() => {
        msgIndex = Math.min(msgIndex + 1, messages.length - 1);
        document.getElementById('statusText').textContent = messages[msgIndex];
        // Advance progress bar
        const pct = Math.min(10 + (msgIndex + 1) * 15, 90);
        const bar = document.getElementById('progressBar');
        bar.style.width = pct + '%';
        bar.setAttribute('aria-valuenow', pct);
    }, 4000);

    // Poll for status
    const pollInterval = setInterval(async () => {
        // Check timeout
        if (!timedOut && Date.now() - startTime > TIMEOUT_MS) {
            timedOut = true;
            document.getElementById('statusArea').classList.add('d-none');
            document.getElementById('timeoutArea').classList.remove('d-none');
            clearInterval(msgInterval);
            // Don't stop polling — keep checking in case it completes
        }

        try {
            const resp = await fetch(STATUS_URL);
            if (!resp.ok) return;
            const data = await resp.json();

            if (data.status === 'ready') {
                clearInterval(pollInterval);
                clearInterval(msgInterval);
                window.location.href = REVIEW_URL;
            } else if (data.status === 'failed') {
                clearInterval(pollInterval);
                clearInterval(msgInterval);
                document.getElementById('statusArea').classList.add('d-none');
                document.getElementById('timeoutArea').classList.add('d-none');
                document.getElementById('errorArea').classList.remove('d-none');
                if (data.error) {
                    document.getElementById('errorMsg').textContent = data.error;
                }
            }
        } catch (e) {
            // Network error — keep polling silently
        }
    }, POLL_INTERVAL);

    function keepWaiting() {
        timedOut = false;
        startTime = Date.now();
        document.getElementById('timeoutArea').classList.add('d-none');
        document.getElementById('statusArea').classList.remove('d-none');
    }
</script>
{% endblock %}
