{% extends 'base.html' %}

{% block title %}Dashboard - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    /* Styles for clickable metric cards */
    .metrics-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metrics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    /* Badge styles for priorities */
    .badge.priority-low {
        background-color: #6c757d;
        color: white;
    }

    .badge.priority-medium {
        background-color: #ffc107;
        color: black;
    }

    .badge.priority-high {
        background-color: #fd7e14;
        color: white;
    }

    .badge.priority-urgent {
        background-color: #dc3545;
        color: white;
    }

    /* Collapsible Demo Credentials Banner */
    .demo-credentials-banner {
        background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
        border: 2px solid #0288d1;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.15);
        transition: all 0.3s ease;
    }

    .demo-credentials-banner.expanded {
        box-shadow: 0 6px 20px rgba(2, 136, 209, 0.25);
    }

    .demo-banner-header {
        padding: 1rem 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
        transition: background-color 0.2s ease;
    }

    .demo-banner-header:hover {
        background: rgba(2, 136, 209, 0.08);
    }

    .demo-banner-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #01579b;
    }

    .demo-banner-icon {
        font-size: 1.3rem;
        color: #0288d1;
    }

    .demo-toggle-icon {
        font-size: 1.2rem;
        color: #0288d1;
        transition: transform 0.3s ease;
    }

    .demo-credentials-banner.expanded .demo-toggle-icon {
        transform: rotate(180deg);
    }

    .demo-banner-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease, padding 0.4s ease;
        padding: 0 1.5rem;
    }

    .demo-credentials-banner.expanded .demo-banner-content {
        max-height: 500px;
        padding: 0 1.5rem 1.5rem 1.5rem;
    }

    .demo-users-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    @media (max-width: 992px) {
        .demo-users-row {
            grid-template-columns: 1fr;
        }
    }

    .demo-user-box {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid #b3e5fc;
        transition: all 0.3s ease;
    }

    .demo-user-box:hover {
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.2);
        transform: translateY(-3px);
    }

    .demo-user-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .demo-user-init {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        flex-shrink: 0;
    }

    .demo-user-box.admin .demo-user-init {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .demo-user-box.developer .demo-user-init {
        background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    }

    .demo-user-box.strategist .demo-user-init {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .demo-user-info h6 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: #01579b;
    }

    .demo-user-role {
        font-size: 0.75rem;
        color: #0288d1;
        margin: 0;
    }

    .demo-cred-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }

    .demo-cred-label {
        color: #6c757d;
        font-weight: 600;
    }

    .demo-cred-value {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: #01579b;
        background: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        border: 1px solid #b3e5fc;
    }

    /* Demo Skills List */
    .demo-skills-list {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e3f2fd;
    }

    .demo-skill-tag {
        display: inline-block;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #01579b;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.3rem;
        margin-bottom: 0.3rem;
        border: 1px solid #90caf9;
    }

    /* Demo Login Button */
    .demo-login-btn {
        display: block;
        width: 100%;
        padding: 0.6rem;
        margin-top: 0.75rem;
        background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
        color: white;
        text-align: center;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        border: none;
    }

    .demo-login-btn:hover {
        background: linear-gradient(135deg, #0277bd 0%, #01579b 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
    }

    /* Demo Boards Section */
    .demo-boards-section {
        padding-top: 1rem;
        border-top: 2px solid #b3e5fc;
    }

    .demo-boards-title {
        font-size: 1rem;
        font-weight: 700;
        color: #01579b;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
    }

    .demo-boards-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 992px) {
        .demo-boards-grid {
            grid-template-columns: 1fr;
        }
    }

    .demo-board-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e3f2fd;
        text-align: center;
        transition: all 0.3s ease;
    }

    .demo-board-item:hover {
        border-color: #0288d1;
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.15);
        transform: translateY(-2px);
    }

    .demo-board-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 0.75rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .demo-board-item.software .demo-board-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .demo-board-item.marketing .demo-board-icon {
        background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
    }

    .demo-board-item.bug .demo-board-icon {
        background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    }

    .demo-board-name {
        font-weight: 700;
        font-size: 0.9rem;
        color: #01579b;
        margin-bottom: 0.4rem;
    }

    .demo-board-desc {
        font-size: 0.75rem;
        color: #6c757d;
        line-height: 1.3;
    }

    /* Adjust max-height for expanded content with new sections */
    .demo-credentials-banner.expanded .demo-banner-content {
        max-height: 800px;
        padding: 0 1.5rem 1.5rem 1.5rem;
    }
    
    /* Welcome Modal Styles */
    .welcome-modal .modal-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border-bottom: none;
    }
    .welcome-modal .modal-title {
        font-weight: 700;
    }
    .welcome-modal .modal-body {
        padding: 1.5rem;
    }
    .welcome-modal .modal-body .lead {
        margin-left: 0;
        padding-left: 0;
    }
    .welcome-modal .feature-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        margin-left: 0;
        padding-left: 0;
        width: 100%;
    }
    .welcome-modal .feature-item > div:last-child {
        flex: 1;
        min-width: 0;
    }
    .welcome-modal .feature-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    .welcome-modal .feature-icon.users { background: #dbeafe; color: #2563eb; }
    .welcome-modal .feature-icon.boards { background: #dcfce7; color: #16a34a; }
    .welcome-modal .feature-icon.reset { background: #fef3c7; color: #d97706; }
    .welcome-modal .demo-user-badges-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-left: 0;
        padding-left: 0;
        justify-content: flex-start;
    }
    .welcome-modal .demo-user-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    .welcome-modal .demo-user-badge i { margin-right: 5px; color: #6366f1; }
    .welcome-modal h6 {
        margin-left: 0;
        padding-left: 0;
        text-align: left;
    }
    .welcome-modal p {
        margin-left: 0;
        padding-left: 0;
        text-align: left;
    }

    /* ================================================================
       MISSION TREE STYLES
       ================================================================ */
    .mission-tree { position: relative; }

    /* Mission Card */
    .mission-card {
        border-left: 4px solid #4e73df !important;
        background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        transition: box-shadow 0.2s ease;
    }
    .mission-card:hover { box-shadow: 0 4px 16px rgba(78,115,223,0.18) !important; }

    /* Status badges */
    .ms-status-badge { font-size: 0.68rem; padding: 0.25em 0.6em; }
    .ms-status-badge.status-active    { background-color: #1cc88a; color: #fff; }
    .ms-status-badge.status-completed { background-color: #36b9cc; color: #fff; }
    .ms-status-badge.status-on_hold   { background-color: #f6c23e; color: #333; }

    /* Strategy rows */
    .strategy-container { border-left: 2px solid #e3e6f0; padding-left: 1.25rem; }
    .strategy-row {
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-left: 3px solid #6c757d;
        border-radius: 6px !important;
        transition: background 0.15s ease;
        user-select: none;
    }
    .strategy-row:hover { background: #eef0f5; }
    .strategy-node { position: relative; }
    .tree-branch-icon { font-size: 0.85rem; }

    /* Strategy chevron rotation */
    .strategy-chevron { transition: transform 0.25s ease; display: inline-block; }
    .strategy-chevron.expanded { transform: rotate(90deg); }

    /* Board tiles */
    .boards-container { border-left: 2px dashed #e3e6f0; padding-left: 1rem; }
    .board-tile-row {
        border: 1px solid #e3e6f0 !important;
        border-left: 3px solid #4e73df !important;
        transition: box-shadow 0.15s ease;
    }
    .board-tile-row:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

    /* AI summary block */
    .ai-summary-block { font-size: 0.82rem; }
    .ai-summary-text.summary-truncated .summary-content {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .ai-summary-text.summary-expanded .summary-content {
        display: block;
        -webkit-line-clamp: unset;
    }
    .ai-summary-text.summary-expanded .summary-read-more::text { content: "show less"; }
    .summary-ts { font-size: 0.7rem; display: block; margin-top: 2px; }

    /* Extra-small button variant */
    .btn-xs {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        line-height: 1.4;
        border-radius: 4px;
    }
    .btn-outline-info.btn-xs { border-color: #17a2b8; color: #17a2b8; }
    .btn-outline-info.btn-xs:hover { background: #17a2b8; color: #fff; }

    /* Spinner inside button */
    .btn-spinner { display: none; }
    .btn-loading .btn-spinner { display: inline-block; }
    .btn-loading .btn-label  { display: none; }

    /* Summary flash highlight when a new result arrives */
    @keyframes summaryfade {
        0%   { background: #d1ecf1; }
        100% { background: transparent; }
    }
    .summary-flash {
        animation: summaryfade 2s ease-out forwards;
        border-radius: 4px;
        padding: 2px 4px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Modal for First-time Users -->
{% if show_welcome_modal %}
<div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">
                    <i class="fas fa-rocket me-2"></i>Welcome to PrizmAI!
                </h5>
            </div>
            <div class="modal-body">
                <p class="lead mb-4">
                    Your intelligent project management platform is ready. Here's what you need to know:
                </p>
                
                <div class="feature-item">
                    <div class="feature-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Demo Team Members</h6>
                        <p class="text-muted mb-2">
                            Explore collaboration features with these pre-configured demo users:
                        </p>
                        <div class="demo-user-badges-container">
                            <span class="demo-user-badge"><i class="fas fa-user-tie"></i> Alex Chen (Admin)</span>
                            <span class="demo-user-badge"><i class="fas fa-code"></i> Sam Rivera (Developer)</span>
                            <span class="demo-user-badge"><i class="fas fa-chart-line"></i> Jordan Taylor (Analyst)</span>
                        </div>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon boards">
                        <i class="fas fa-columns"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Sample Project Board</h6>
                        <p class="text-muted mb-0">
                            One demo board is pre-loaded with 30 high-quality tasks:
                            <strong>Software Development</strong>.
                            Feel free to explore, edit, or create your own!
                        </p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon reset">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Reset Anytime</h6>
                        <p class="text-muted mb-0">
                            Made changes you want to undo? Use the <strong>Reset Demo Data</strong> button
                            to restore demo boards to their original state. Note: This will delete all your custom boards and tasks.
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Pro Tip:</strong> In your real workspace, you'll invite actual team members.
                    The demo users help you explore features without needing a team right away!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-lg px-5" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-right me-2"></i>Get Started
                </button>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
    welcomeModal.show();
});
</script>
{% endif %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
            <div>
                <a href="{% url 'board_list' %}" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
                    <i class="fas fa-plus fa-sm text-white-50 me-2"></i> View All Boards
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Collapsible Demo Credentials Banner -->
<div class="demo-credentials-banner" id="demoCredentialsBanner">
    <div class="demo-banner-header" onclick="toggleDemoBanner()">
        <div class="demo-banner-title">
            <i class="fas fa-user-shield demo-banner-icon"></i>
            <span>Demo Credentials</span>
            <small class="text-muted" style="font-weight: normal; font-size: 0.85rem;">(Click to expand)</small>
        </div>
        <i class="fas fa-chevron-down demo-toggle-icon"></i>
    </div>
    <div class="demo-banner-content">
        <div class="demo-users-row">
            <!-- Alex Chen - Admin -->
            <div class="demo-user-box admin">
                <div class="demo-user-header">
                    <div class="demo-user-init">AC</div>
                    <div class="demo-user-info">
                        <h6>Alex Chen</h6>
                        <p class="demo-user-role">Admin</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">alex_chen_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Project Management</span>
                    <span class="demo-skill-tag">Agile/Scrum</span>
                    <span class="demo-skill-tag">Leadership</span>
                </div>
                <a href="{% url 'quick_demo_login' 'alex_chen_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Alex
                </a>
            </div>

            <!-- Sam Rivera - Developer -->
            <div class="demo-user-box developer">
                <div class="demo-user-header">
                    <div class="demo-user-init">SR</div>
                    <div class="demo-user-info">
                        <h6>Sam Rivera</h6>
                        <p class="demo-user-role">Developer</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">sam_rivera_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Python</span>
                    <span class="demo-skill-tag">JavaScript</span>
                    <span class="demo-skill-tag">Django</span>
                    <span class="demo-skill-tag">React</span>
                </div>
                <a href="{% url 'quick_demo_login' 'sam_rivera_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Sam
                </a>
            </div>

            <!-- Jordan Taylor - Strategist -->
            <div class="demo-user-box strategist">
                <div class="demo-user-header">
                    <div class="demo-user-init">JT</div>
                    <div class="demo-user-info">
                        <h6>Jordan Taylor</h6>
                        <p class="demo-user-role">Strategist</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">jordan_taylor_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Strategic Planning</span>
                    <span class="demo-skill-tag">Business Analysis</span>
                </div>
                <a href="{% url 'quick_demo_login' 'jordan_taylor_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Jordan
                </a>
            </div>
        </div>

        <!-- Demo Boards Section -->
        <div class="demo-boards-section mt-4">
            <h5 class="demo-boards-title">
                <i class="fas fa-folder-open me-2"></i>Pre-Populated Demo Board
            </h5>
            <div class="demo-boards-grid">
                <!-- Software Development Board -->
                <div class="demo-board-item software">
                    <div class="demo-board-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="demo-board-name">Software Development</div>
                    <div class="demo-board-desc">30 tasks with sprints, dependencies, and Gantt charts</div>
                </div>
            </div>
        </div>

        <!-- AI Feature Notice -->
        <div class="alert alert-info mt-4" style="border-left: 4px solid #17a2b8; background-color: #e7f6f8; border-radius: 8px;">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3" style="font-size: 1.2rem; color: #17a2b8; margin-top: 2px;"></i>
                <div style="flex: 1;">
                    <strong style="color: #0c5460;">Note about AI Features:</strong>
                    <p style="margin-bottom: 0; margin-top: 0.5rem; color: #0c5460; font-size: 0.9rem;">
                        AI-powered features are not available for these demo users. Logging in with any of these demo accounts will not allow you to access AI features.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Main Layout: Mission+Tasks (left) + Metrics sidebar (right) -->
<div class="row g-4 mb-4">

    <!-- ======================================================== -->
    <!-- LEFT COLUMN: Mission Overview (top) + My Tasks (below)   -->
    <!-- ======================================================== -->
    <div class="col-lg-9">

        <!-- Mission Overview Tree -->
        <div class="card shadow mb-4" id="mission-overview-card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bullseye me-2 text-primary"></i>Mission Overview
                    </h6>
                    {% if mission_count %}
                    <span class="badge bg-primary rounded-pill ms-2">{{ mission_count }}</span>
                    {% endif %}
                    <small class="text-muted ms-2">Goal &rarr; Mission &rarr; Strategy &rarr; Board &rarr; Tasks</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% regroup boards by is_official_demo_board as board_groups %}
                    {% for group in board_groups %}
                        {% if group.grouper %}
                            <button onclick="resetDemoData()" class="btn btn-sm btn-warning me-1" title="Reset demo data">
                                <i class="fas fa-redo fa-sm"></i> Reset Demo Data
                            </button>
                        {% endif %}
                    {% endfor %}
                    <a href="{% url 'goal_list' %}" class="btn btn-sm btn-outline-warning text-dark">
                        <i class="fas fa-trophy fa-sm"></i> All Goals
                    </a>
                    <a href="{% url 'mission_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-bullseye fa-sm"></i> All Missions
                    </a>
                    <a href="{% url 'create_mission' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus fa-sm"></i> New Mission
                    </a>
                </div>
            </div>
            <div class="card-body p-3">
                {% if goal_tree %}
                <div class="mission-tree">
                    {% for goal_entry in goal_tree %}

                    {% if goal_entry.goal %}
                    {# ---- ORGANIZATION GOAL node ---- #}
                    <div class="goal-node mb-4" id="goal-node-{{ goal_entry.goal.id }}">
                        <div class="card border-0 shadow-sm mb-0" style="border-left: 4px solid #ffc107 !important;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-trophy text-warning mt-1"></i>
                                        <div>
                                            <span class="badge text-uppercase fw-semibold me-1 mb-1"
                                                  style="background:#fff8e1; color:#b8860b; border:1px solid #ffe082; font-size:0.6rem; letter-spacing:0.07em; padding:3px 7px;">
                                                Organization Goal
                                            </span>
                                            <h6 class="mb-0 fw-bold">
                                                <a href="{% url 'goal_detail' goal_entry.goal.id %}" class="text-decoration-none text-dark">{{ goal_entry.goal.name }}</a>
                                            </h6>
                                            {% if goal_entry.goal.target_metric %}
                                            <small class="text-warning fw-semibold">
                                                <i class="fas fa-bullseye me-1"></i>{{ goal_entry.goal.target_metric }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        {% if goal_entry.goal.status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% elif goal_entry.goal.status == 'completed' %}
                                            <span class="badge bg-primary">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">On Hold</span>
                                        {% endif %}
                                        <span class="badge bg-light text-dark border">
                                            <i class="fas fa-bullseye text-primary me-1"></i>{{ goal_entry.missions|length }} mission{{ goal_entry.missions|length|pluralize }}
                                        </span>
                                        <a href="{% url 'goal_detail' goal_entry.goal.id %}" class="btn btn-sm btn-outline-warning text-dark" title="Open Goal">
                                            <i class="fas fa-external-link-alt fa-xs"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# missions indented under this goal #}
                        <div class="ps-4 mt-1">
                    {% else %}
                    {# ---- Ungrouped missions (no Organization Goal) ---- #}
                    <div class="ungrouped-missions-section mb-4">
                        <div class="text-muted small mb-2 ps-1">
                            <i class="fas fa-minus-circle me-1"></i><em>Missions not linked to an Organization Goal</em>
                        </div>
                        <div>
                    {% endif %}

                        {# ---- MISSION nodes (inside either Goal or Ungrouped wrapper) ---- #}
                        {% for mission_item in goal_entry.missions %}
                        {% with mission=mission_item.mission %}
                        <div class="mission-node mb-4" id="mission-node-{{ mission.id }}">
                        <!-- Mission Card -->
                        <div class="mission-card card border-0 shadow-sm mb-0" style="border-left: 4px solid #4e73df !important;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <i class="fas fa-bullseye text-primary mt-1"></i>
                                        <div>
                                            <!-- MISSION label -->
                                            <span class="badge text-uppercase fw-semibold me-1 mb-1"
                                                  style="background:#e8f0fe; color:#3a5bd9; border:1px solid #c0d0f8; font-size:0.6rem; letter-spacing:0.07em; padding:3px 7px;">
                                                Mission
                                            </span>
                                            <h6 class="mb-0 fw-bold">
                                                <a href="{{ mission.get_absolute_url }}" class="text-decoration-none text-dark stretched-link-override">{{ mission.name }}</a>
                                            </h6>
                                            {% if mission.description %}
                                            <small class="text-muted">{{ mission.description|truncatechars:120 }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        <span class="badge ms-status-badge status-{{ mission.status }}">{{ mission.get_status_display }}</span>
                                        <span class="badge bg-light text-dark border">
                                            <i class="fas fa-sitemap text-primary me-1"></i>{{ mission_item.strategy_count }} strateg{{ mission_item.strategy_count|pluralize:"y,ies" }}
                                        </span>
                                        <a href="{{ mission.get_absolute_url }}" class="btn btn-sm btn-outline-primary" title="Open Mission">
                                            <i class="fas fa-external-link-alt fa-xs"></i>
                                        </a>
                                    </div>
                                </div>
                                <!-- Mission AI Summary -->
                                <div class="ai-summary-block mt-2" id="mission-summary-block-{{ mission.id }}">
                                    {% if mission.ai_summary %}
                                    <div class="ai-summary-text summary-truncated" id="mission-summary-text-{{ mission.id }}">
                                        <i class="fas fa-robot text-info me-1" style="font-size:0.75rem;"></i>
                                        <span class="summary-content">{{ mission.ai_summary }}</span>
                                        <a href="#" class="summary-read-more ms-1 small text-info" onclick="toggleSummary(this,'mission-summary-text-{{ mission.id }}'); return false;">read more</a>
                                    </div>
                                    <small class="text-muted summary-ts" id="mission-ts-{{ mission.id }}"
                                          {% if mission.ai_summary_generated_at %}data-ts="{{ mission.ai_summary_generated_at|date:'c' }}"{% endif %}>
                                        <i class="far fa-clock me-1"></i>Updated {{ mission.ai_summary_generated_at|date:"M d, Y H:i" }}
                                    </small>
                                    {% else %}
                                    <div class="ai-summary-text text-muted fst-italic small" id="mission-summary-text-{{ mission.id }}">
                                        <i class="fas fa-robot me-1"></i>No AI summary yet — click Generate to create one.
                                    </div>
                                    <small class="text-muted summary-ts d-none" id="mission-ts-{{ mission.id }}"></small>
                                    {% endif %}
                                    <button class="btn btn-xs btn-outline-info mt-1 generate-summary-btn"
                                            data-level="mission" data-id="{{ mission.id }}"
                                            data-url="{% url 'generate_mission_summary_api' mission.id %}"
                                            title="{% if mission.organization_goal %}Goal-Aware: evaluates whether this mission is moving the needle on '{{ mission.organization_goal.name }}'{% else %}Generate AI executive summary from strategy summaries{% endif %}">
                                        <i class="fas fa-robot me-1"></i>
                                        <span class="btn-label">
                                            {% if mission.organization_goal %}<i class="fas fa-trophy text-warning me-1" style="font-size:0.65rem;"></i>Goal-Aware Summary{% else %}✨ Generate Summary{% endif %}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Strategies under this mission -->
                        {% if mission_item.strategies %}
                        <div class="strategy-container ps-4 mt-1">
                            {% for strategy_item in mission_item.strategies %}
                            {% with strategy=strategy_item.strategy %}
                            <div class="strategy-node mt-2" id="strategy-node-{{ strategy.id }}">
                                <!-- Strategy Row (always visible) -->
                                <div class="strategy-row d-flex align-items-start gap-2 p-2 rounded"
                                     data-strategy-id="{{ strategy.id }}"
                                     style="cursor:pointer; background:#f8f9fa; border-left: 3px solid #858796;">
                                    <span class="tree-branch-icon mt-1 text-muted">&#9492;&#9472;</span>
                                    <i class="fas fa-chess-knight text-secondary mt-1 flex-shrink-0"></i>
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                            <div>
                                                <!-- STRATEGY label -->
                                                <span class="badge text-uppercase fw-semibold me-1"
                                                      style="background:#f1f1f3; color:#555; border:1px solid #d0d0d8; font-size:0.58rem; letter-spacing:0.07em; padding:3px 7px;">
                                                    Strategy
                                                </span>
                                                <span class="fw-semibold strategy-name">
                                                    <a href="{{ strategy.get_absolute_url }}" class="text-decoration-none text-dark" onclick="event.stopPropagation()">{{ strategy.name }}</a>
                                                </span>
                                                {% if strategy.description %}
                                                <small class="text-muted ms-2">{{ strategy.description|truncatechars:80 }}</small>
                                                {% endif %}
                                            </div>
                                            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                                <span class="badge ms-status-badge status-{{ strategy.status }}">{{ strategy.get_status_display }}</span>
                                                <span class="badge bg-light text-dark border small">
                                                    <i class="fas fa-clipboard-list text-primary me-1"></i>{{ strategy_item.board_count }} board{{ strategy_item.board_count|pluralize }}
                                                </span>
                                                <span class="strategy-chevron text-muted ms-1" id="chevron-{{ strategy.id }}">
                                                    <i class="fas fa-chevron-right"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <!-- Strategy AI Summary -->
                                        <div class="ai-summary-block mt-1" id="strategy-summary-block-{{ strategy.id }}" onclick="event.stopPropagation()">
                                            {% if strategy.ai_summary %}
                                            <div class="ai-summary-text summary-truncated small" id="strategy-summary-text-{{ strategy.id }}">
                                                <i class="fas fa-robot text-info me-1" style="font-size:0.7rem;"></i>
                                                <span class="summary-content">{{ strategy.ai_summary }}</span>
                                                <a href="#" class="summary-read-more ms-1 text-info" onclick="toggleSummary(this,'strategy-summary-text-{{ strategy.id }}'); return false;">read more</a>
                                            </div>
                                            <small class="text-muted summary-ts" id="strategy-ts-{{ strategy.id }}"
                                                  {% if strategy.ai_summary_generated_at %}data-ts="{{ strategy.ai_summary_generated_at|date:'c' }}"{% endif %}>Updated {{ strategy.ai_summary_generated_at|date:"M d, Y H:i" }}</small>
                                            {% else %}
                                            <div class="ai-summary-text text-muted fst-italic small d-none" id="strategy-summary-text-{{ strategy.id }}">
                                                No AI summary yet.
                                            </div>
                                            <small class="text-muted summary-ts d-none" id="strategy-ts-{{ strategy.id }}"></small>
                                            {% endif %}
                                            <button class="btn btn-xs btn-outline-info mt-1 generate-summary-btn"
                                                    data-level="strategy" data-id="{{ strategy.id }}"
                                                    data-url="{% url 'generate_strategy_summary_api' strategy.id %}"
                                                    title="Generate/refresh AI summary">
                                                <i class="fas fa-robot me-1"></i><span class="btn-label">✨ Summarise</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Boards under this strategy (collapsed by default) -->
                                {% if strategy_item.boards %}
                                <div class="boards-container ps-4 mt-1 d-none" id="boards-{{ strategy.id }}">
                                    {% for board_item in strategy_item.boards %}
                                    {% with board=board_item.board %}
                                    <div class="board-tile-row d-flex align-items-center gap-2 p-2 mb-1 rounded border bg-white">
                                        <span class="tree-branch-icon text-muted small">&#9492;&#9472;</span>
                                        <i class="fas fa-clipboard-list text-primary flex-shrink-0" style="font-size:0.8rem;"></i>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-1">
                                                <div>
                                                    <span class="fw-semibold small">
                                                        <a href="{% url 'board_detail' board.id %}" class="text-decoration-none text-dark">{{ board.name }}</a>
                                                    </span>
                                                    {% if board.is_official_demo_board %}
                                                    <span class="badge bg-warning text-dark ms-1" style="font-size:0.6rem;">DEMO</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center gap-1 flex-shrink-0">
                                                    <small class="text-muted">{{ board_item.done_tasks }}/{{ board_item.total_tasks }} tasks</small>
                                                    <a href="{% url 'board_detail' board.id %}" class="btn btn-xs btn-primary ms-1">Open</a>
                                                    <a href="{% url 'board_analytics' board.id %}" class="btn btn-xs btn-outline-secondary" title="Analytics"><i class="fas fa-chart-pie fa-xs"></i></a>
                                                </div>
                                            </div>
                                            <!-- Board progress bar -->
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <div class="progress flex-grow-1" style="height:6px;">
                                                    <div class="progress-bar {% if board_item.completion_pct < 30 %}bg-danger{% elif board_item.completion_pct < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                                         role="progressbar" style="width:{{ board_item.completion_pct }}%;"></div>
                                                </div>
                                                <small class="text-muted flex-shrink-0" style="font-size:0.7rem;">{{ board_item.completion_pct }}%</small>
                                            </div>
                                            <!-- Board AI summary -->
                                            {% if board.ai_summary %}
                                            <div class="ai-summary-text small text-muted fst-italic mt-1 summary-truncated board-summary" id="board-summary-text-{{ board.id }}">
                                                <i class="fas fa-robot me-1" style="font-size:0.65rem;"></i>
                                                <span class="summary-content">{{ board.ai_summary }}</span>
                                            </div>
                                            <small class="text-muted summary-ts" id="board-ts-{{ board.id }}"
                                                  {% if board.ai_summary_generated_at %}data-ts="{{ board.ai_summary_generated_at|date:'c' }}"{% endif %}
                                                  style="font-size:0.68rem;">
                                                {% if board.ai_summary_generated_at %}<i class="far fa-clock me-1"></i>Updated {{ board.ai_summary_generated_at|date:"M d, Y H:i" }}{% endif %}
                                            </small>
                                            {% else %}
                                            <div class="ai-summary-text small text-muted fst-italic mt-1 d-none" id="board-summary-text-{{ board.id }}"></div>
                                            <small class="text-muted summary-ts d-none" id="board-ts-{{ board.id }}"></small>
                                            {% endif %}
                                            <div class="mt-1" onclick="event.stopPropagation()">
                                                <button class="btn btn-xs btn-outline-info generate-summary-btn"
                                                        data-level="board" data-id="{{ board.id }}"
                                                        data-url="{% url 'generate_board_summary_api' board.id %}"
                                                        title="Generate/refresh AI board summary">
                                                    <i class="fas fa-robot me-1"></i><span class="btn-label">✨ Board AI</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="ps-4 mt-2">
                            <small class="text-muted fst-italic">
                                <i class="fas fa-info-circle me-1"></i>No strategies yet.
                                <a href="{% url 'mission_detail' mission.id %}">Add a strategy</a> to this mission.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endfor %}
                    {# close the indentation div inside the goal/ungrouped wrapper #}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty state: no goals or missions yet -->
                <div class="text-center py-5">
                    <i class="fas fa-trophy fa-4x text-warning mb-3" style="opacity:0.3;"></i>
                    <p class="mb-2 fw-semibold">No Organization Goals or Missions yet</p>
                    <p class="text-muted small mb-4">
                        Start at the top — define an <strong>Organization Goal</strong> (your North Star),
                        then add Missions, Strategies and Boards underneath it.
                    </p>
                    <a href="{% url 'create_goal' %}" class="btn btn-warning text-dark">
                        <i class="fas fa-trophy fa-sm me-1"></i> Create Organization Goal
                    </a>
                    <a href="{% url 'create_mission' %}" class="btn btn-primary ms-2">
                        <i class="fas fa-bullseye fa-sm me-1"></i> New Mission
                    </a>
                    <a href="{% url 'create_board' %}" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-plus fa-sm me-1"></i> New Board
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /Mission Overview -->

        <!-- My Tasks Section -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary me-3">
                        <i class="fas fa-user-check me-2"></i>My Tasks
                    </h6>
                    <small class="text-muted">
                        ({{ my_tasks_count }} total{% if my_tasks_count != my_tasks|length %}, showing top 8{% endif %})
                    </small>
                </div>
                <div class="d-flex align-items-center">
                    <label for="taskSortSelect" class="form-label me-2 mb-0 small text-muted">Sort by:</label>
                    <select id="taskSortSelect" class="form-select form-select-sm" style="width: auto;"
                        onchange="changeSortOrder(this.value)">
                        <option value="urgency" {% if my_tasks_sort_by == 'urgency' %}selected{% endif %}>
                            🚨 Urgency (Overdue First)
                        </option>
                        <option value="due_date" {% if my_tasks_sort_by == 'due_date' %}selected{% endif %}>
                            📅 Due Date (Chronological)
                        </option>
                        <option value="priority" {% if my_tasks_sort_by == 'priority' %}selected{% endif %}>
                            🔥 Priority (High to Low)
                        </option>
                        <option value="recent" {% if my_tasks_sort_by == 'recent' %}selected{% endif %}>
                            🕒 Recent (Latest First)
                        </option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if my_tasks %}
                <div class="row">
                    {% for task in my_tasks %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div
                            class="card h-100 border-left-{% if task.priority == 'urgent' %}danger{% elif task.priority == 'high' %}warning{% elif task.priority == 'medium' %}info{% else %}success{% endif %} shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">{{ task.title|truncatechars:40 }}</h6>
                                    <span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span>
                                </div>

                                {% if task.description %}
                                <p class="card-text text-muted small mb-2">{{ task.description|truncatechars:80 }}</p>
                                {% endif %}

                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-project-diagram me-1"></i>{{ task.column.board.name }} - {{ task.column.name }}
                                    </small>
                                </div>

                                {% if task.due_date %}
                                <div class="mb-2">
                                    <small
                                        class="{% if task.due_date < now and task.progress < 100 %}text-danger{% else %}text-muted{% endif %}">
                                        <i class="far fa-calendar-alt me-1"></i>{{ task.due_date|date:"M d, Y" }}
                                        {% if task.due_date < now and task.progress < 100 %}<span
                                            class="badge bg-danger ms-1">Overdue</span>{% endif %}
                                    </small>
                                </div>
                                {% endif %}

                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar {% if task.progress < 30 %}bg-danger{% elif task.progress < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                        role="progressbar" style="width: {{ task.progress }}%"></div>
                                </div>
                                <small class="text-muted">{{ task.progress }}% complete</small>

                                <div class="text-end mt-2">
                                    <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                    <a href="{% url 'board_detail' task.column.board.id %}"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-project-diagram"></i> Board
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-check fa-4x text-gray-300 mb-3"></i>
                    <p class="mb-4">No tasks are currently assigned to you.</p>
                    <p class="text-muted">Tasks assigned to you will appear here for quick access.</p>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /My Tasks -->

    </div>
    <!-- /col-lg-9 -->

    <!-- ======================================================== -->
    <!-- RIGHT SIDEBAR: Metric Cards (stacked)                    -->
    <!-- ======================================================== -->
    <div class="col-lg-3">
        <div class="card shadow" style="position:sticky; top:76px;">
            <div class="card-header py-2 border-bottom" style="background:#f8f9fc;">
                <h6 class="m-0 font-weight-bold text-secondary small text-uppercase" style="letter-spacing:0.05em;">
                    <i class="fas fa-chart-bar me-2"></i>At a Glance
                </h6>
            </div>
            <div class="card-body p-2">

                <!-- Total Tasks -->
                <div class="card stats-card primary shadow-sm mb-2 metrics-card"
                     data-bs-toggle="modal" data-bs-target="#totalTasksModal"
                     style="border-left: 4px solid #4e73df; cursor:pointer;">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Tasks</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ task_count }}</div>
                            </div>
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Completed Tasks -->
                <div class="card stats-card success shadow-sm mb-2 metrics-card"
                     data-bs-toggle="modal" data-bs-target="#completedTasksModal"
                     style="border-left: 4px solid #1cc88a; cursor:pointer;">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Completed Tasks</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completed_count }}</div>
                            </div>
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Completion Rate -->
                <div class="card stats-card warning shadow-sm mb-2 metrics-card"
                     data-bs-toggle="modal" data-bs-target="#completionRateModal"
                     style="border-left: 4px solid #f6c23e; cursor:pointer;">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Completion Rate</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completion_rate }}%</div>
                            </div>
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Overdue Tasks -->
                <div class="card stats-card danger shadow-sm mb-2 metrics-card"
                     data-bs-toggle="modal" data-bs-target="#overdueTasksModal"
                     style="border-left: 4px solid #e74a3b; cursor:pointer;">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Overdue Tasks</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ overdue_count }}</div>
                            </div>
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Tasks Due Soon -->
                <div class="card stats-card info shadow-sm mb-0 metrics-card"
                     data-bs-toggle="modal" data-bs-target="#dueSoonTasksModal"
                     style="border-left: 4px solid #36b9cc; cursor:pointer;">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tasks Due Soon</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ due_soon }}</div>
                                <small class="text-muted">Next 3 days</small>
                            </div>
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- /col-lg-3 -->

</div>
<!-- /Dashboard Main Layout row -->

<!-- Standalone Boards (not linked to any strategy) -->
{% if standalone_boards %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-secondary">
                    <i class="fas fa-clipboard-list me-2"></i>Standalone Boards
                    <span class="badge bg-secondary rounded-pill ms-1">{{ standalone_boards|length }}</span>
                </h6>
                <div class="d-flex gap-2">
                    <a href="{% url 'create_board' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus fa-sm"></i> New Board
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    These boards are not linked to any Mission strategy. 
                    Consider <a href="{% url 'mission_list' %}">assigning them to a strategy</a> to keep everything organised.
                </p>
                <div class="row">
                    {% for board in standalone_boards %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-left-{% if board.is_official_demo_board %}warning{% else %}secondary{% endif %} shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">{{ board.name }}</h6>
                                    {% if board.is_official_demo_board %}
                                        <span class="badge bg-warning text-dark" title="Demo board">
                                            <i class="fas fa-graduation-cap"></i> DEMO
                                        </span>
                                    {% endif %}
                                </div>
                                <p class="card-text text-muted small">
                                    {{ board.description|default:"No description."|truncatechars:90 }}
                                </p>
                                <div class="text-end mt-2">
                                    <a href="{% url 'board_detail' board.id %}" class="btn btn-sm btn-outline-secondary">Open</a>
                                    <a href="{% url 'board_analytics' board.id %}" class="btn btn-sm btn-outline-secondary" title="Analytics">
                                        <i class="fas fa-chart-pie fa-sm"></i>
                                    </a>
                                    <a href="{% url 'budget_dashboard' board.id %}" class="btn btn-sm btn-outline-success" title="Budget">
                                        <i class="fas fa-dollar-sign fa-sm"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-top-0">
                                <small class="text-muted">Created {{ board.created_at|date:"M d, Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Metric Detail Modals -->
<!-- Total Tasks Modal -->
<div class="modal fade" id="totalTasksModal" tabindex="-1" aria-labelledby="totalTasksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="totalTasksModalLabel">All Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if all_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Column</th>
                            <th>Priority</th>
                            <th>Progress</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in all_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td>{{ task.column.name }}</td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-info" role="progressbar"
                                        style="width: {{ task.progress }}%">
                                        <small>{{ task.progress }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="lead">No tasks found!</p>
                </div>
                {% endif %}
                
                {% if all_tasks.has_other_pages %}
                <nav aria-label="All tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if all_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ all_tasks.number }} of {{ all_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if all_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ all_tasks.start_index }} to {{ all_tasks.end_index }} of {{ all_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Completed Tasks Modal -->
<div class="modal fade" id="completedTasksModal" tabindex="-1" aria-labelledby="completedTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completedTasksModalLabel">Completed Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if completed_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Priority</th>
                            <th>Completed On</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in completed_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>{{ task.updated_at|date:"M d, Y" }}</td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                    <p class="lead">No completed tasks yet!</p>
                </div>
                {% endif %}
                
                {% if completed_tasks.has_other_pages %}
                <nav aria-label="Completed tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if completed_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ completed_tasks.number }} of {{ completed_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if completed_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ completed_tasks.start_index }} to {{ completed_tasks.end_index }} of {{ completed_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Rate Modal -->
<div class="modal fade" id="completionRateModal" tabindex="-1" aria-labelledby="completionRateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="completionRateModalLabel">Task Completion Overview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body text-center">
                                <h3 class="text-success">{{ completed_count }}</h3>
                                <p>Completed Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-body text-center">
                                <h3 class="text-primary">{{ remaining_tasks }}</h3>
                                <p>Remaining Tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ completion_rate }}%">
                        {{ completion_rate }}% Complete
                    </div>
                </div>

                <div class="text-center">
                    <h4>Overall Completion Rate: {{ completion_rate }}%</h4>
                    {% if completion_rate >= 80 %}
                    <p class="text-success"><i class="fas fa-check-circle"></i> Excellent progress! Keep up the great
                        work!</p>
                    {% elif completion_rate >= 60 %}
                    <p class="text-warning"><i class="fas fa-clock"></i> Good progress, but there's room for
                        improvement.</p>
                    {% else %}
                    <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Consider focusing on completing
                        more tasks.</p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Overdue Tasks Modal -->
<div class="modal fade" id="overdueTasksModal" tabindex="-1" aria-labelledby="overdueTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="overdueTasksModalLabel">Overdue Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if overdue_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in overdue_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td class="text-danger">{{ task.due_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge bg-danger">{{ task.due_date|timesince }} ago</span>
                            </td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="lead">No overdue tasks!</p>
                    <p class="text-muted">Great job staying on top of deadlines!</p>
                </div>
                {% endif %}
                
                {% if overdue_tasks.has_other_pages %}
                <nav aria-label="Overdue tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if overdue_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ overdue_tasks.number }} of {{ overdue_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if overdue_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ overdue_tasks.start_index }} to {{ overdue_tasks.end_index }} of {{ overdue_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Due Soon Tasks Modal -->
<div class="modal fade" id="dueSoonTasksModal" tabindex="-1" aria-labelledby="dueSoonTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="dueSoonTasksModalLabel">Tasks Due Soon</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if due_soon_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Due Date</th>
                            <th>Days Remaining</th>
                            <th>Priority</th>
                            <th>Progress</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in due_soon_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td>{{ task.due_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge bg-warning">{{ task.due_date|timeuntil }}</span>
                            </td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-info" role="progressbar"
                                        style="width: {{ task.progress }}%">
                                        <small>{{ task.progress }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <p class="lead">No tasks due soon!</p>
                    <p class="text-muted">You're ahead of schedule!</p>
                </div>
                {% endif %}
                
                {% if due_soon_tasks.has_other_pages %}
                <nav aria-label="Due soon tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if due_soon_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ due_soon_tasks.number }} of {{ due_soon_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if due_soon_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ due_soon_tasks.start_index }} to {{ due_soon_tasks.end_index }} of {{ due_soon_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Lean Six Sigma Info Modal -->
<div class="modal fade" id="leanSixSigmaInfoModal" tabindex="-1" aria-labelledby="leanSixSigmaInfoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="leanSixSigmaInfoModalLabel">
                    <i class="fas fa-chart-line me-2"></i> Lean Six Sigma Features in Pri<span
                        class="stylish-z">z</span>mAI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>What is Lean Six Sigma?</h5>
                        <p>Lean Six Sigma is a methodology that combines Lean (eliminating waste) and Six Sigma
                            (reducing variation) to improve business processes. Pri<span class="stylish-z">z</span>mAI
                            now integrates key Lean Six Sigma principles to help you visualize, categorize, and optimize
                            your work.</p>
                    </div>
                </div>

                <h5 class="mb-3">Key Features:</h5>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-tags me-1"></i> Value-Added Task Categorization
                            </div>
                            <div class="card-body">
                                <p>Categorize tasks using Lean Six Sigma labels:</p>
                                <ul>
                                    <li><strong class="text-success">Value-Added (VA):</strong> Activities customers
                                        value and would pay for</li>
                                    <li><strong class="text-warning">Necessary Non-Value-Added (NNVA):</strong> Required
                                        but non-value adding activities</li>
                                    <li><strong class="text-danger">Waste/Eliminate (NVA):</strong> Activities that
                                        should be eliminated</li>
                                </ul>
                                <p class="small text-muted">Access from: Task creation/editing forms and the label
                                    management page</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-chart-pie me-1"></i> Process Efficiency Analytics
                            </div>
                            <div class="card-body">
                                <p>Gain insights with specialized Lean Six Sigma metrics:</p>
                                <ul>
                                    <li>Value-Added percentage calculation</li>
                                    <li>Distribution of VA/NNVA/Waste tasks</li>
                                    <li>Process improvement recommendations</li>
                                </ul>
                                <p class="small text-muted">Access from: Board Analytics page</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-filter me-1"></i> Lean Six Sigma Filtering
                            </div>
                            <div class="card-body">
                                <p>Filter tasks by value category to focus efforts:</p>
                                <ul>
                                    <li>Focus on value-adding tasks first</li>
                                    <li>Identify waste for elimination</li>
                                    <li>Balance necessary non-value activities</li>
                                </ul>
                                <p class="small text-muted">Access from: Board task search panel</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-lightbulb me-1"></i> Process Improvement Tips
                            </div>
                            <div class="card-body">
                                <p>Get actionable recommendations based on your task distribution:</p>
                                <ul>
                                    <li>Ways to eliminate identified waste</li>
                                    <li>How to increase value-added percentage</li>
                                    <li>Strategies for continuous improvement</li>
                                </ul>
                                <p class="small text-muted">Access from: Board Analytics page</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Getting Started:</strong> Begin by adding Lean Six Sigma labels to your tasks. Visit the
                    "Manage Labels" section within any board and click "Add Default Lean Six Sigma Labels".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<!-- Analytics CSS for clickable metric cards -->
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize metric cards to open modals when clicked
        const metricCards = document.querySelectorAll('.metrics-card');
        metricCards.forEach(card => {
            card.addEventListener('click', function () {
                const targetModal = this.getAttribute('data-bs-target');
                const modalElement = document.querySelector(targetModal);
                if (modalElement) {
                    const modalInstance = new bootstrap.Modal(modalElement);
                    modalInstance.show();
                }
            });
        });

        // Enhanced modal cleanup for proper scrolling restoration
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            // Handle modal hide events
            modal.addEventListener('hidden.bs.modal', function () {
                // Ensure body can scroll again
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // Remove any orphaned backdrops
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });

                // Remove aria-hidden and restore focus
                this.setAttribute('aria-hidden', 'true');
                document.body.focus();
            });

            // Handle modal shown events
            modal.addEventListener('shown.bs.modal', function () {
                // Ensure modal is properly visible
                this.removeAttribute('aria-hidden');
            });
        });

        // Additional cleanup for close buttons
        document.querySelectorAll('.modal button[data-bs-dismiss="modal"]').forEach(btn => {
            btn.addEventListener('click', function () {
                const modal = this.closest('.modal');
                if (modal) {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });
        });

        // Global escape key handler for better modal management
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    const modalInstance = bootstrap.Modal.getInstance(openModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            }
        });

        // Fix any existing modal state issues on page load
        setTimeout(function () {
            // Ensure no modal backdrops are left over
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });

            // Ensure body can scroll
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 100);
    });

    // Function to handle task sorting preference change
    function changeSortOrder(sortBy) {
        // Get current URL and update the sort parameter
        const url = new URL(window.location);
        url.searchParams.set('sort_tasks', sortBy);

        // Add a subtle loading indication
        const selectElement = document.getElementById('taskSortSelect');
        const originalHtml = selectElement.innerHTML;
        selectElement.disabled = true;

        // Show loading state briefly
        const loadingText = document.createElement('option');
        loadingText.value = '';
        loadingText.textContent = '🔄 Updating...';
        loadingText.selected = true;
        selectElement.innerHTML = '';
        selectElement.appendChild(loadingText);

        // Redirect to update the page with new sort order
        setTimeout(() => {
            window.location.href = url.toString();
        }, 300);
    }

    // Toggle Demo Credentials Banner
    function toggleDemoBanner() {
        const banner = document.getElementById('demoCredentialsBanner');
        banner.classList.toggle('expanded');

        // Save state to localStorage
        const isExpanded = banner.classList.contains('expanded');
        localStorage.setItem('demoBannerExpanded', isExpanded);
    }

    // Reset Demo Data Function
    function resetDemoData() {
        if (confirm('Reset Demo Environment?\n\nThis will:\n• Delete all boards, tasks, and data you created\n• Restore all original demo data to its initial state\n• Fix any demo data you modified\n\nThis cannot be undone.')) {
            // Show loading indicator
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
            btn.disabled = true;
            
            // Make AJAX request to reset
            fetch('/demo/reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Demo reset successfully!\n\nAll demo data has been restored to its original state.');
                    location.reload();
                } else {
                    alert('Failed to reset demo: ' + (data.message || 'Unknown error'));
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error resetting demo:', error);
                alert('Failed to reset demo. Please try again.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        }
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Restore demo banner state on page load
    document.addEventListener('DOMContentLoaded', function () {
        const banner = document.getElementById('demoCredentialsBanner');
        if (banner) {
            const wasExpanded = localStorage.getItem('demoBannerExpanded') === 'true';
            if (wasExpanded) {
                banner.classList.add('expanded');
            }
        }
        
        // Handle pagination clicks within modals
        handleModalPagination();
    });
    
    // Function to handle pagination within modals via AJAX
    function handleModalPagination() {
        // Get all pagination links in modals
        const paginationLinks = document.querySelectorAll('.modal .pagination a.page-link');
        
        paginationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const url = this.getAttribute('href');
                const modalId = this.getAttribute('data-modal');
                const modal = document.getElementById(modalId);
                
                if (!modal) return;
                
                // Show loading state
                const modalBody = modal.querySelector('.modal-body');
                const originalContent = modalBody.innerHTML;
                modalBody.innerHTML = '<div class=\"text-center py-5\"><i class=\"fas fa-spinner fa-spin fa-3x text-primary\"></i><p class=\"mt-3\">Loading...</p></div>';
                
                // Fetch the new page content
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // Parse the HTML response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract the modal content from the response
                    const newModal = doc.getElementById(modalId);
                    if (newModal) {
                        const newModalBody = newModal.querySelector('.modal-body');
                        const newModalFooter = newModal.querySelector('.modal-footer');
                        
                        if (newModalBody) {
                            modal.querySelector('.modal-body').innerHTML = newModalBody.innerHTML;
                        }
                        if (newModalFooter) {
                            modal.querySelector('.modal-footer').innerHTML = newModalFooter.innerHTML;
                        }
                        
                        // Re-attach pagination handlers
                        handleModalPagination();
                    } else {
                        modalBody.innerHTML = originalContent;
                    }
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    modalBody.innerHTML = '<div class=\"text-center py-5\"><i class=\"fas fa-exclamation-triangle fa-3x text-danger\"></i><p class=\"mt-3\">Error loading content. Please try again.</p></div>';
                });
            });
        });
    }

    /* ==========================================================
       MISSION TREE — Strategy expand/collapse & AI summary AJAX
       ========================================================== */

    // Restore expand/collapse state from localStorage on load
    function storageKey(strategyId) { return 'prizmAI_strategy_expanded_' + strategyId; }

    document.querySelectorAll('.strategy-row').forEach(function(row) {
        const stratId = row.dataset.strategyId;
        const boardsDiv  = document.getElementById('boards-' + stratId);
        const chevron    = document.getElementById('chevron-' + stratId);
        if (!boardsDiv) return;

        // Restore persisted state
        if (localStorage.getItem(storageKey(stratId)) === 'true') {
            boardsDiv.classList.remove('d-none');
            if (chevron) chevron.classList.add('expanded');
        }

        row.addEventListener('click', function(e) {
            // Don't toggle if clicking a link or button inside the row
            if (e.target.closest('a, button')) return;
            const expanded = !boardsDiv.classList.contains('d-none');
            boardsDiv.classList.toggle('d-none', expanded);
            if (chevron) chevron.classList.toggle('expanded', !expanded);
            localStorage.setItem(storageKey(stratId), (!expanded).toString());
        });
    });

    // Toggle "read more / show less" for summary text
    window.toggleSummary = function(link, blockId) {
        const block = document.getElementById(blockId);
        if (!block) return;
        const isExpanded = block.classList.contains('summary-expanded');
        block.classList.toggle('summary-truncated', isExpanded);
        block.classList.toggle('summary-expanded', !isExpanded);
        link.textContent = isExpanded ? 'read more' : 'show less';
    };

    // AI Generate Summary — async Celery-backed with polling
    // Active pollers: Map<"level-id", intervalId>
    var summaryPollers = new Map();

    /**
     * Convert an ISO timestamp string to a human-readable relative string.
     * E.g. "Updated 4 minutes ago", "Updated just now", "Updated 2 hours ago".
     */
    function timeAgo(isoStr) {
        if (!isoStr) return '';
        var d = new Date(isoStr);
        var diffMs  = Date.now() - d.getTime();
        var diffSec = Math.round(diffMs / 1000);
        if (diffSec < 5)   return 'Updated just now';
        if (diffSec < 60)  return 'Updated ' + diffSec + ' seconds ago';
        var diffMin = Math.round(diffSec / 60);
        if (diffMin < 60)  return 'Updated ' + diffMin + ' minute' + (diffMin === 1 ? '' : 's') + ' ago';
        var diffHr  = Math.round(diffMin / 60);
        if (diffHr  < 24)  return 'Updated ' + diffHr  + ' hour'   + (diffHr  === 1 ? '' : 's') + ' ago';
        var diffDay = Math.round(diffHr  / 24);
        return 'Updated ' + diffDay + ' day' + (diffDay === 1 ? '' : 's') + ' ago';
    }

    /** Refresh all summary-ts elements that have a data-ts attribute. */
    function refreshAllTimestamps() {
        document.querySelectorAll('.summary-ts[data-ts]').forEach(function(el) {
            el.innerHTML = '<i class="far fa-clock me-1"></i>' + timeAgo(el.dataset.ts);
        });
    }
    // Run once on load and then every 60 s
    refreshAllTimestamps();
    setInterval(refreshAllTimestamps, 60000);

    /** Flash-highlight an element to signal a new summary arrived. */
    function flashElement(el) {
        el.classList.remove('summary-flash');
        void el.offsetWidth; // reflow to restart animation
        el.classList.add('summary-flash');
    }

    /** Update the DOM for a given level/id with new summary data. */
    function applySummaryToDOM(level, objId, data) {
        var textEl = document.getElementById(level + '-summary-text-' + objId);
        var tsEl   = document.getElementById(level + '-ts-' + objId);

        if (data.summary && textEl) {
            if (level === 'board') {
                textEl.innerHTML = '<i class="fas fa-robot me-1" style="font-size:0.65rem;"></i>'
                    + '<span class="summary-content">' + escapeHtml(data.summary) + '</span>';
            } else {
                textEl.innerHTML = '<i class="fas fa-robot text-info me-1" style="font-size:0.75rem;"></i>'
                    + '<span class="summary-content">' + escapeHtml(data.summary) + '</span> '
                    + '<a href="#" class="summary-read-more ms-1 small text-info" '
                    + 'onclick="toggleSummary(this,\'' + level + '-summary-text-' + objId + '\'); return false;">read more</a>';
            }
            textEl.classList.remove('text-muted', 'fst-italic', 'd-none');
            textEl.classList.add('summary-truncated');
            flashElement(textEl);
        }

        if (tsEl && data.generated_at) {
            tsEl.dataset.ts = data.generated_at;
            tsEl.innerHTML  = '<i class="far fa-clock me-1"></i>' + timeAgo(data.generated_at);
            tsEl.classList.remove('d-none');
        }
    }

    /** Default label for a summary button based on level. */
    function defaultBtnLabel(level) {
        if (level === 'board') return '\u2728 Board AI';
        return '\u2728 ' + level.charAt(0).toUpperCase() + level.slice(1) + ' AI';
    }

    /** Stop spinner and restore button to its normal enabled state. */
    function resetBtn(btn, labelEl, level) {
        if (!btn) return;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        var spinnerEl = btn.querySelector('.btn-spinner');
        if (spinnerEl) spinnerEl.remove();
        if (labelEl) labelEl.textContent = defaultBtnLabel(level);
    }

    /** Put the button into a ⚠ Retry state when polling times out. */
    function setRetryState(btn, labelEl) {
        if (!btn) return;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        var spinnerEl = btn.querySelector('.btn-spinner');
        if (spinnerEl) spinnerEl.remove();
        if (labelEl) labelEl.textContent = '\u26A0 Timed out \u2014 Retry';
        btn.title = 'AI generation is taking longer than expected. Click to try again.';
    }

    /** Start polling /api/summary-status/{level}/{id}/ until the summary updates. */
    function startPolling(level, objId, previousGeneratedAt) {
        var pollerKey = level + '-' + objId;
        // Cancel any already-running poller for the same object
        if (summaryPollers.has(pollerKey)) {
            clearInterval(summaryPollers.get(pollerKey));
        }

        var pollCount = 0;
        var MAX_POLLS = 72; // 72 × 5 s = 6 min max (covers slow Celery startup)
        var btn = document.querySelector('.generate-summary-btn[data-level="' + level + '"][data-id="' + objId + '"]');
        var labelEl = btn ? btn.querySelector('.btn-label') : null;
        var timedOut = false;
        var onVisibilityChange = null; // declared up-front so doPoll can reference it

        function stopPoller(success) {
            clearInterval(intervalId);
            summaryPollers.delete(pollerKey);
            if (onVisibilityChange) {
                document.removeEventListener('visibilitychange', onVisibilityChange);
                onVisibilityChange = null;
            }
            if (success) {
                resetBtn(btn, labelEl, level);
            } else {
                timedOut = true;
                setRetryState(btn, labelEl);
            }
        }

        function doPoll() {
            fetch('/api/summary-status/' + level + '/' + objId + '/', {
                method: 'GET',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var generatedAtChanged = (
                    data.generated_at
                    && data.generated_at !== previousGeneratedAt
                );
                // isNew: task finished AND lock released, OR task finished AND we've
                // hit MAX_POLLS (safety net for edge-case where lock-release was missed).
                var isNew = generatedAtChanged && (!data.queued || pollCount >= MAX_POLLS);
                if (isNew) {
                    stopPoller(true);
                    applySummaryToDOM(level, objId, data);
                } else if (pollCount >= MAX_POLLS) {
                    stopPoller(false);
                }
            })
            .catch(function() {
                if (pollCount >= MAX_POLLS) {
                    stopPoller(false);
                }
            });
        }

        var intervalId = setInterval(function() {
            pollCount++;
            doPoll();
        }, 5000);

        summaryPollers.set(pollerKey, intervalId);

        // When the user switches back to this tab, immediately do one extra check.
        // This catches the common case where the task finished while the tab was
        // in the background and the poller hasn't had its next 5-second tick yet.
        onVisibilityChange = function() {
            if (document.visibilityState !== 'visible') return;
            if (summaryPollers.has(pollerKey)) {
                pollCount++;
                doPoll();
            } else {
                document.removeEventListener('visibilitychange', onVisibilityChange);
            }
        };
        document.addEventListener('visibilitychange', onVisibilityChange);
    }

    document.querySelectorAll('.generate-summary-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            var level  = btn.dataset.level;
            var objId  = btn.dataset.id;
            var url    = btn.dataset.url;

            // Spinner state
            btn.classList.add('btn-loading');
            btn.disabled = true;
            if (!btn.querySelector('.btn-spinner')) {
                var spinner = document.createElement('span');
                spinner.className = 'btn-spinner spinner-border spinner-border-sm me-1';
                spinner.setAttribute('role', 'status');
                btn.prepend(spinner);
            }
            var labelEl = btn.querySelector('.btn-label');
            if (labelEl) labelEl.textContent = '\uD83D\uDD04 Refreshing…';

            // Read the current generated_at so we can detect a new result during polling
            var tsEl = document.getElementById(level + '-ts-' + objId);
            var previousGeneratedAt = tsEl ? (tsEl.dataset.ts || null) : null;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.error) {
                    resetBtn(btn, labelEl, level);
                    alert('Error: ' + data.error);
                    return;
                }

                // Show the cached summary immediately if available
                if (data.summary) {
                    applySummaryToDOM(level, objId, data);
                }

                // Begin polling for the fresh result
                startPolling(level, objId, previousGeneratedAt);
            })
            .catch(function(err) {
                resetBtn(btn, labelEl, level);
                console.error('Summary generation error:', err);
                alert('Failed to queue summary. Please try again.');
            });
        });
    });

    function escapeHtml(text) {
        var map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
        return String(text).replace(/[&<>"']/g, function(m){ return map[m]; });
    }
</script>
{% endblock %}