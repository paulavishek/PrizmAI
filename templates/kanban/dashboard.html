{% extends 'base.html' %}
{% load summary_filters %}

{% block title %}Dashboard - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    /* Styles for clickable metric cards */
    .metrics-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metrics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    /* Badge styles for priorities */
    .badge.priority-low {
        background-color: #6c757d;
        color: white;
    }

    .badge.priority-medium {
        background-color: #ffc107;
        color: black;
    }

    .badge.priority-high {
        background-color: #fd7e14;
        color: white;
    }

    .badge.priority-urgent {
        background-color: #dc3545;
        color: white;
    }

    /* Demo Credentials — compact pill style */
    .demo-credentials-banner {
        background: transparent;
        border: none;
        border-radius: 0;
        margin-bottom: 0.75rem;
        overflow: visible;
        box-shadow: none;
        transition: none;
        text-align: right;
    }

    .demo-credentials-banner.expanded {
        box-shadow: none;
    }

    .demo-banner-header {
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        user-select: none;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        font-size: 0.78rem;
        color: #0369a1;
        transition: background-color 0.2s ease;
    }

    .demo-banner-header:hover {
        background: #e0f2fe;
    }

    .demo-banner-title {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0;
        font-size: 0.78rem;
        font-weight: 600;
        color: #0369a1;
    }

    .demo-banner-icon {
        font-size: 0.75rem;
        color: #0369a1;
    }

    .demo-toggle-icon {
        font-size: 0.7rem;
        color: #0369a1;
        transition: transform 0.3s ease;
    }

    .demo-credentials-banner.expanded .demo-toggle-icon {
        transform: rotate(180deg);
    }

    .demo-banner-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease, padding 0.4s ease;
        padding: 0;
        text-align: left;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid #bae6fd;
        border-radius: 10px;
    }

    .demo-credentials-banner.expanded .demo-banner-content {
        max-height: 500px;
        padding: 1rem 1.25rem 1.25rem 1.25rem;
    }

    .demo-users-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    @media (max-width: 992px) {
        .demo-users-row {
            grid-template-columns: 1fr;
        }
    }

    .demo-user-box {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid #b3e5fc;
        transition: all 0.3s ease;
    }

    .demo-user-box:hover {
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.2);
        transform: translateY(-3px);
    }

    .demo-user-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .demo-user-init {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        flex-shrink: 0;
    }

    .demo-user-box.admin .demo-user-init {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .demo-user-box.developer .demo-user-init {
        background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    }

    .demo-user-box.strategist .demo-user-init {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .demo-user-info h6 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: #01579b;
    }

    .demo-user-role {
        font-size: 0.75rem;
        color: #0288d1;
        margin: 0;
    }

    .demo-cred-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }

    .demo-cred-label {
        color: #6c757d;
        font-weight: 600;
    }

    .demo-cred-value {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        color: #01579b;
        background: white;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        border: 1px solid #b3e5fc;
    }

    /* Demo Skills List */
    .demo-skills-list {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e3f2fd;
    }

    .demo-skill-tag {
        display: inline-block;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #01579b;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.3rem;
        margin-bottom: 0.3rem;
        border: 1px solid #90caf9;
    }

    /* Demo Login Button */
    .demo-login-btn {
        display: block;
        width: 100%;
        padding: 0.6rem;
        margin-top: 0.75rem;
        background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
        color: white;
        text-align: center;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        border: none;
    }

    .demo-login-btn:hover {
        background: linear-gradient(135deg, #0277bd 0%, #01579b 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
    }

    /* Demo Boards Section */
    .demo-boards-section {
        padding-top: 1rem;
        border-top: 2px solid #b3e5fc;
    }

    .demo-boards-title {
        font-size: 1rem;
        font-weight: 700;
        color: #01579b;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
    }

    .demo-boards-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 992px) {
        .demo-boards-grid {
            grid-template-columns: 1fr;
        }
    }

    .demo-board-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e3f2fd;
        text-align: center;
        transition: all 0.3s ease;
    }

    .demo-board-item:hover {
        border-color: #0288d1;
        box-shadow: 0 4px 12px rgba(2, 136, 209, 0.15);
        transform: translateY(-2px);
    }

    .demo-board-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 0.75rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .demo-board-item.software .demo-board-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .demo-board-item.marketing .demo-board-icon {
        background: linear-gradient(135deg, #f857a6 0%, #ff5858 100%);
    }

    .demo-board-item.bug .demo-board-icon {
        background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    }

    .demo-board-name {
        font-weight: 700;
        font-size: 0.9rem;
        color: #01579b;
        margin-bottom: 0.4rem;
    }

    .demo-board-desc {
        font-size: 0.75rem;
        color: #6c757d;
        line-height: 1.3;
    }

    /* Adjust max-height for expanded content with new sections */
    .demo-credentials-banner.expanded .demo-banner-content {
        max-height: 850px;
        padding: 1rem 1.25rem 1.25rem 1.25rem;
    }
    
    /* Welcome Modal Styles */
    .welcome-modal .modal-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border-bottom: none;
    }
    .welcome-modal .modal-title {
        font-weight: 700;
    }
    .welcome-modal .modal-body {
        padding: 1.5rem;
    }
    .welcome-modal .modal-body .lead {
        margin-left: 0;
        padding-left: 0;
    }
    .welcome-modal .feature-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        margin-left: 0;
        padding-left: 0;
        width: 100%;
    }
    .welcome-modal .feature-item > div:last-child {
        flex: 1;
        min-width: 0;
    }
    .welcome-modal .feature-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    .welcome-modal .feature-icon.users { background: #dbeafe; color: #2563eb; }
    .welcome-modal .feature-icon.boards { background: #dcfce7; color: #16a34a; }
    .welcome-modal .feature-icon.reset { background: #fef3c7; color: #d97706; }
    .welcome-modal .demo-user-badges-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-left: 0;
        padding-left: 0;
        justify-content: flex-start;
    }
    .welcome-modal .demo-user-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background: #f3f4f6;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    .welcome-modal .demo-user-badge i { margin-right: 5px; color: #6366f1; }
    .welcome-modal h6 {
        margin-left: 0;
        padding-left: 0;
        text-align: left;
    }
    .welcome-modal p {
        margin-left: 0;
        padding-left: 0;
        text-align: left;
    }

    /* ================================================================
       MISSION TREE STYLES
       ================================================================ */
    .mission-tree { position: relative; }

    /* Mission Card */
    .mission-card {
        border-left: 4px solid #4e73df !important;
        background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        transition: box-shadow 0.2s ease;
    }
    .mission-card:hover { box-shadow: 0 4px 16px rgba(78,115,223,0.18) !important; }

    /* Status badges */
    .ms-status-badge { font-size: 0.68rem; padding: 0.25em 0.6em; }
    .ms-status-badge.status-active    { background-color: #1cc88a; color: #fff; }
    .ms-status-badge.status-completed { background-color: #36b9cc; color: #fff; }
    .ms-status-badge.status-on_hold   { background-color: #f6c23e; color: #333; }

    /* Strategy rows */
    .strategy-container { border-left: 2px solid #e3e6f0; padding-left: 1.25rem; }
    .strategy-row {
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-left: 3px solid #6c757d;
        border-radius: 6px !important;
        transition: background 0.15s ease;
        user-select: none;
    }
    .strategy-row:hover { background: #eef0f5; }
    .strategy-node { position: relative; }
    .tree-branch-icon { font-size: 0.85rem; }

    /* Strategy chevron rotation */
    .strategy-chevron { transition: transform 0.25s ease; display: inline-block; }
    .strategy-chevron.expanded { transform: rotate(90deg); }

    /* Board tiles */
    .boards-container { border-left: 2px dashed #e3e6f0; padding-left: 1rem; }
    .board-tile-row {
        border: 1px solid #e3e6f0 !important;
        border-left: 3px solid #4e73df !important;
        transition: box-shadow 0.15s ease;
    }
    .board-tile-row:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

    /* AI summary block */
    .ai-summary-block { font-size: 0.82rem; }

    /* Bullet list rendering for AI summaries */
    .ai-bullet-list {
        list-style: none;
        padding-left: 0.8rem;
        margin: 0.3rem 0 0 0;
    }
    .ai-bullet-list li {
        position: relative;
        padding-left: 1.1rem;
        margin-bottom: 0.25rem;
        line-height: 1.4;
    }
    .ai-bullet-list li::before {
        content: "\2022";
        color: #17a2b8;
        position: absolute;
        left: 0;
        font-weight: bold;
    }

    /* Truncate bullets: show first 2, hide rest */
    .ai-summary-text.summary-truncated .ai-bullet-list li:nth-child(n+3) {
        display: none;
    }
    .ai-summary-text.summary-expanded .ai-bullet-list li {
        display: list-item;
    }
    /* Hide toggle link when only 1-2 bullets */
    .ai-summary-text .summary-read-more { cursor: pointer; }
    .summary-ts { font-size: 0.7rem; display: block; margin-top: 2px; }

    /* Extra-small button variant */
    .btn-xs {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        line-height: 1.4;
        border-radius: 4px;
    }
    .btn-outline-info.btn-xs { border-color: #17a2b8; color: #17a2b8; }
    .btn-outline-info.btn-xs:hover { background: #17a2b8; color: #fff; }

    /* Spinner inside button */
    .btn-spinner { display: none; }
    .btn-loading .btn-spinner { display: inline-block; }
    .btn-loading .btn-label  { display: none; }

    /* Summary flash highlight when a new result arrives */
    @keyframes summaryfade {
        0%   { background: #d1ecf1; }
        100% { background: transparent; }
    }
    .summary-flash {
        animation: summaryfade 2s ease-out forwards;
        border-radius: 4px;
        padding: 2px 4px;
    }

    /* ================================================================
       METRICS SIDE PANEL
       ================================================================ */
    .metrics-panel {
        position: sticky;
        top: 70px;
        max-height: calc(100vh - 90px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #dee2e6 transparent;
    }
    .metrics-panel::-webkit-scrollbar { width: 5px; }
    .metrics-panel::-webkit-scrollbar-track { background: transparent; }
    .metrics-panel::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 3px; }

    .panel-section-header {
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6c757d;
        border-bottom: 2px solid #e3e6f0;
        padding-bottom: 6px;
        margin-bottom: 10px;
    }
    .panel-kpi-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    .panel-kpi-box {
        flex: 1;
        min-width: 60px;
        background: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 6px;
        padding: 6px 8px;
        text-align: center;
    }
    .panel-kpi-box .kpi-value {
        font-size: 1.35rem;
        font-weight: 700;
        line-height: 1.1;
    }
    .panel-kpi-box .kpi-label {
        font-size: 0.62rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .panel-board-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }
    .panel-board-name {
        font-size: 0.75rem;
        width: 110px;
        min-width: 110px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #444;
    }
    .panel-board-bar-wrap {
        flex: 1;
        background: #e9ecef;
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
    }
    .panel-board-bar {
        height: 8px;
        border-radius: 4px;
        transition: width 0.4s ease;
    }
    .panel-board-pct {
        font-size: 0.7rem;
        color: #6c757d;
        width: 32px;
        text-align: right;
        flex-shrink: 0;
    }
    .panel-chart-wrap { position: relative; height: 180px; }
    .panel-risk-badge {
        display: inline-block;
        font-size: 0.65rem;
        padding: 1px 5px;
        border-radius: 3px;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    .panel-risk-badge.danger {
        background: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
    @media (max-width: 991.98px) {
        .metrics-panel { position: static; max-height: none; }
    }

    /* ================================================================
       ZONE 1 — KPI COMMAND STRIP
       ================================================================ */
    .kpi-card {
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.10) !important;
    }
    .kpi-icon-wrap {
        width: 52px;
        height: 52px;
        min-width: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
    }
    .kpi-big-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.0;
    }
    .kpi-big-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-top: 2px;
    }
    .kpi-sub {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 1px;
    }

    /* ================================================================
       MISSION OVERVIEW — Scrollable card body
       ================================================================ */
    #mission-overview-card .card-body {
        scrollbar-width: thin;
        scrollbar-color: #c5cbe3 transparent;
    }
    #mission-overview-card .card-body::-webkit-scrollbar {
        width: 6px;
    }
    #mission-overview-card .card-body::-webkit-scrollbar-track {
        background: transparent;
    }
    #mission-overview-card .card-body::-webkit-scrollbar-thumb {
        background-color: #c5cbe3;
        border-radius: 3px;
    }
    #mission-overview-card .card-body::-webkit-scrollbar-thumb:hover {
        background-color: #8490b5;
    }

    /* ================================================================
       DAILY AI BRIEFING CARD
       ================================================================ */
    #daily-briefing-card {
        border-radius: 12px;
        background: linear-gradient(135deg, #f0fdfa 0%, #ffffff 100%);
    }
    .briefing-item {
        background: white;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        height: 100%;
        border: 1px solid #e9ecef;
    }
    .briefing-tag {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.2rem 0.55rem;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .briefing-pulse  { background: #d1fae5; color: #065f46; }
    .briefing-risk   { background: #fef3c7; color: #92400e; }
    .briefing-action { background: #dbeafe; color: #1e40af; }

    /* Clickable recommended-action card */
    .briefing-item-clickable {
        cursor: pointer;
        transition: box-shadow 0.15s ease, transform 0.12s ease, border-color 0.15s ease;
    }
    .briefing-item-clickable:hover {
        box-shadow: 0 4px 14px rgba(30, 64, 175, 0.18);
        transform: translateY(-2px);
        border-color: #93c5fd !important;
    }
    .briefing-item-clickable .briefing-action-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-top: 0.5rem;
        font-size: 0.72rem;
        font-weight: 600;
        color: #1e40af;
        opacity: 0.75;
    }
    .briefing-item-clickable:hover .briefing-action-footer { opacity: 1; }

    /* PM Action Plan step cards */
    .action-step-card {
        border-radius: 10px;
        border: 1px solid #e9ecef;
        padding: 1rem 1rem 0.85rem;
        background: #fff;
        position: relative;
    }
    .action-step-card.step-critical { border-left: 4px solid #ef4444; }
    .action-step-card.step-high     { border-left: 4px solid #f59e0b; }
    .action-step-card.step-overdue  { border-left: 4px solid #ef4444; }
    .action-step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px; height: 26px;
        border-radius: 50%;
        font-size: 0.78rem;
        font-weight: 800;
        flex-shrink: 0;
        margin-right: 0.6rem;
    }
    .step-critical .action-step-number { background:#fee2e2; color:#b91c1c; }
    .step-high     .action-step-number { background:#fef3c7; color:#92400e; }
    .step-overdue  .action-step-number { background:#fee2e2; color:#b91c1c; }
    .action-why-text {
        font-size: 0.81rem;
        color: #4b5563;
        line-height: 1.5;
        margin-bottom: 0.55rem;
    }
    .action-next-box {
        display: flex;
        align-items: flex-start;
        gap: 0.4rem;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 6px;
        padding: 0.45rem 0.65rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: #065f46;
    }
    .action-next-box i { color: #10b981; margin-top: 2px; flex-shrink: 0; }

    /* ================================================================
       ZONE 3 — ENLARGED CHART CARDS
       ================================================================ */
    .zone3-chart-card .card-body { min-height: 300px; }

    /* Risk Heatmap Grid */
    .risk-heatmap-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        padding: 0.5rem;
    }
    .risk-heatmap-cell {
        aspect-ratio: 1;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
        color: white;
        cursor: default;
        transition: transform 0.15s ease;
    }
    .risk-heatmap-cell:hover { transform: scale(1.06); }
    .risk-heatmap-cell .cell-count { font-size: 1.2rem; font-weight: 800; line-height: 1; }
    /*  likelihood (row) × impact (col):  1×1=low, 3×3=critical  */
    .rhc-1-1 { background: #d1fae5; color: #065f46; }
    .rhc-1-2 { background: #a7f3d0; color: #065f46; }
    .rhc-1-3 { background: #fef3c7; color: #92400e; }
    .rhc-2-1 { background: #a7f3d0; color: #065f46; }
    .rhc-2-2 { background: #fde68a; color: #92400e; }
    .rhc-2-3 { background: #fca5a5; color: #7f1d1d; }
    .rhc-3-1 { background: #fef3c7; color: #92400e; }
    .rhc-3-2 { background: #fca5a5; color: #7f1d1d; }
    .rhc-3-3 { background: #ef4444; color: #fff; }

    /* SPI / CPI Gauge (half-donut) */
    .gauge-label {
        position: absolute;
        bottom: 18px;
        left: 0; right: 0;
        text-align: center;
    }
    .gauge-value { font-size: 1.6rem; font-weight: 800; }
    .gauge-sub   { font-size: 0.68rem; color: #6c757d; text-transform: uppercase; }

    /* ================================================================
       HEALTH / TRAFFIC-LIGHT PILLS on mission cards
       ================================================================ */
    .health-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 0.2em 0.55em;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .health-pill.green  { background: #d1fae5; color: #065f46; }
    .health-pill.amber  { background: #fef3c7; color: #92400e; }
    .health-pill.red    { background: #fee2e2; color: #7f1d1d; }
    .health-dot {
        width: 8px; height: 8px;
        border-radius: 50%;
        display: inline-block;
    }
    .health-pill.green .health-dot  { background: #10b981; }
    .health-pill.amber .health-dot  { background: #f59e0b; }
    .health-pill.red   .health-dot  { background: #ef4444; }

    /* ================================================================
       STEP 8 — DESIGN POLISH  (typography hierarchy + card consistency)
       ================================================================ */

    /* -- Global card radius consistency -- */
    .card { border-radius: 12px !important; overflow: hidden; }
    .card .card-header { border-radius: 0 !important; }

    /* -- Dashboard page heading -- */
    #dashboard-heading {
        font-size: 1.55rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        color: #1e2e4a;
    }
    #dashboard-heading .text-muted { font-size: 0.85rem; font-weight: 400; }

    /* -- Mission tree typography hierarchy -- */
    .mission-card h6.fw-bold {
        font-size: 1.05rem !important;
        font-weight: 700 !important;
        letter-spacing: -0.01em;
        line-height: 1.25;
    }

    .strategy-name {
        font-size: 0.93rem;
        font-weight: 600;
    }

    .board-tile-row .fw-semibold.small {
        font-size: 0.82rem !important;
        font-weight: 600 !important;
    }

    /* Metadata timestamps and secondary text */
    .summary-ts, .board-tile-row .text-muted.small {
        font-size: 0.70rem !important;
        opacity: 0.75;
    }

    /* -- KPI cards hover lift -- */
    .kpi-card {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.10) !important;
    }

    /* -- Zone 3 chart cards hover lift -- */
    .zone3-chart-card {
        transition: box-shadow 0.15s ease;
    }
    .zone3-chart-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.09) !important;
    }

    /* -- Mission + Strategy node row spacing -- */
    .mission-node + .mission-node { margin-top: 0.75rem; }
    .strategy-row { border-radius: 8px; }

    /* -- AI summary text legibility -- */
    .ai-summary-text { line-height: 1.55; }
    .ai-summary-text ul { padding-left: 1.2em; margin-bottom: 0; }
    .ai-summary-text li { margin-bottom: 0.2em; font-size: 0.83rem; }

    /* -- Daily briefing card visual separator -- */
    #daily-briefing-card .briefing-item + .briefing-item {
        border-left: 1px solid rgba(0,0,0,0.07);
        padding-left: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Modal for First-time Users -->
{% if show_welcome_modal %}
<div class="modal fade welcome-modal" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">
                    <i class="fas fa-rocket me-2"></i>Welcome to PrizmAI!
                </h5>
            </div>
            <div class="modal-body">
                <p class="lead mb-4">
                    Your intelligent project management platform is ready. Here's what you need to know:
                </p>
                
                <div class="feature-item">
                    <div class="feature-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Demo Team Members</h6>
                        <p class="text-muted mb-2">
                            Explore collaboration features with these pre-configured demo users:
                        </p>
                        <div class="demo-user-badges-container">
                            <span class="demo-user-badge"><i class="fas fa-user-tie"></i> Alex Chen (Admin)</span>
                            <span class="demo-user-badge"><i class="fas fa-code"></i> Sam Rivera (Developer)</span>
                            <span class="demo-user-badge"><i class="fas fa-chart-line"></i> Jordan Taylor (Analyst)</span>
                        </div>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon boards">
                        <i class="fas fa-columns"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Sample Project Board</h6>
                        <p class="text-muted mb-0">
                            One demo board is pre-loaded with 30 high-quality tasks:
                            <strong>Software Development</strong>.
                            Feel free to explore, edit, or create your own!
                        </p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon reset">
                        <i class="fas fa-undo-alt"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Reset Anytime</h6>
                        <p class="text-muted mb-0">
                            Made changes you want to undo? Use the <strong>Reset Demo Data</strong> button
                            to restore demo boards to their original state. Note: This will delete all your custom boards and tasks.
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Pro Tip:</strong> In your real workspace, you'll invite actual team members.
                    The demo users help you explore features without needing a team right away!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-lg px-5" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-right me-2"></i>Get Started
                </button>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
    welcomeModal.show();
});
</script>
{% endif %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800" id="dashboard-heading">
                Dashboard
                <span class="text-muted fw-normal">— {{ request.user.get_full_name|default:request.user.username }}</span>
            </h1>
            <div>
                <a href="{% url 'board_list' %}" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
                    <i class="fas fa-plus fa-sm text-white-50 me-2"></i> View All Boards
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- ZONE 1: COMMAND STRIP — 4 KPI Cards                        -->
<!-- ============================================================ -->
<div class="row g-3 mb-3" id="kpi-strip">

    <!-- Total Tasks -->
    <div class="col-6 col-md-3">
        <div class="card shadow-sm h-100 kpi-card metrics-card"
             data-bs-toggle="modal" data-bs-target="#totalTasksModal"
             role="button" tabindex="0" aria-label="View all tasks">
            <div class="card-body d-flex align-items-center gap-3 p-3">
                <div class="kpi-icon-wrap bg-primary bg-opacity-10">
                    <i class="fas fa-tasks text-primary fs-4"></i>
                </div>
                <div>
                    <div class="kpi-big-value text-primary">{{ task_count }}</div>
                    <div class="kpi-big-label">Total Tasks</div>
                    <div class="kpi-sub">Click to see all</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Completed This Sprint -->
    <div class="col-6 col-md-3">
        <div class="card shadow-sm h-100 kpi-card metrics-card"
             data-bs-toggle="modal" data-bs-target="#completedTasksModal"
             role="button" tabindex="0" aria-label="View completed tasks">
            <div class="card-body d-flex align-items-center gap-3 p-3">
                <div class="kpi-icon-wrap bg-success bg-opacity-10">
                    <i class="fas fa-check-circle text-success fs-4"></i>
                </div>
                <div>
                    <div class="kpi-big-value text-success">{{ completed_count }}</div>
                    <div class="kpi-big-label">Completed</div>
                    <div class="kpi-sub">{{ completion_rate }}% done overall</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overdue -->
    <div class="col-6 col-md-3">
        <div class="card shadow-sm h-100 kpi-card metrics-card {% if overdue_count > 0 %}border-danger{% endif %}"
             data-bs-toggle="modal" data-bs-target="#overdueTasksModal"
             role="button" tabindex="0" aria-label="View overdue tasks">
            <div class="card-body d-flex align-items-center gap-3 p-3">
                <div class="kpi-icon-wrap {% if overdue_count > 0 %}bg-danger{% else %}bg-secondary{% endif %} bg-opacity-10">
                    <i class="fas fa-exclamation-circle {% if overdue_count > 0 %}text-danger{% else %}text-secondary{% endif %} fs-4"></i>
                </div>
                <div>
                    <div class="kpi-big-value {% if overdue_count > 0 %}text-danger{% else %}text-secondary{% endif %}">{{ overdue_count }}</div>
                    <div class="kpi-big-label">Overdue</div>
                    <div class="kpi-sub">{% if overdue_count > 0 %}Needs attention{% else %}All on track{% endif %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- High Risk -->
    <div class="col-6 col-md-3">
        <div class="card shadow-sm h-100 kpi-card metrics-card {% if total_high_risk > 0 %}border-warning{% endif %}"
             data-bs-toggle="modal" data-bs-target="#highRiskModal"
             role="button" tabindex="0" aria-label="View high risk tasks">
            <div class="card-body d-flex align-items-center gap-3 p-3">
                <div class="kpi-icon-wrap {% if total_high_risk > 0 %}bg-warning{% else %}bg-secondary{% endif %} bg-opacity-10">
                    <i class="fas fa-shield-alt {% if total_high_risk > 0 %}text-warning{% else %}text-secondary{% endif %} fs-4"></i>
                </div>
                <div>
                    <div class="kpi-big-value {% if total_high_risk > 0 %}text-warning{% else %}text-secondary{% endif %}">{{ total_high_risk }}</div>
                    <div class="kpi-big-label">High Risk</div>
                    <div class="kpi-sub">{% if total_high_risk > 0 %}Click to view details{% else %}Across all boards{% endif %}</div>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- /KPI Strip -->

<!-- Daily AI Briefing (shown only when mission AI summaries have been generated) -->
{% if daily_briefing.has_content %}
<div class="card shadow-sm mb-3" id="daily-briefing-card">
    <div class="card-body p-3">
        <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
            <h6 class="m-0 fw-bold" style="color:#0e9f6e;">
                <i class="fas fa-robot me-2"></i>Daily AI Briefing
            </h6>
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>Synthesised from your stored mission summaries
            </small>
        </div>
        <div class="row g-2">
            {% if daily_briefing.pulse %}
            <div class="col-md-4">
                <div class="briefing-item">
                    <span class="briefing-tag briefing-pulse">🟢 Overall Pulse</span>
                    <p class="mb-0 small mt-2" style="color:#374151;">{{ daily_briefing.pulse }}</p>
                </div>
            </div>
            {% endif %}
            {% if daily_briefing.risk %}
            <div class="col-md-4">
                <div class="briefing-item">
                    <span class="briefing-tag briefing-risk">⚠️ Key Risk</span>
                    <p class="mb-0 small mt-2" style="color:#374151;">{{ daily_briefing.risk }}</p>
                </div>
            </div>
            {% endif %}
            {% if daily_briefing.action %}
            <div class="col-md-4">
                <div class="briefing-item briefing-item-clickable"
                     data-bs-toggle="modal" data-bs-target="#aiRecommendedActionsModal"
                     role="button" tabindex="0"
                     aria-label="View AI recommended actions">
                    <span class="briefing-tag briefing-action">💡 Recommended Action</span>
                    <p class="mb-0 small mt-2 fw-semibold" style="color:#1e40af;">{{ daily_briefing.action }}</p>
                    <div class="briefing-action-footer">
                        View details <i class="fas fa-arrow-right ms-1"></i>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
<!-- /Daily AI Briefing -->

<!-- AI Recommended Actions Modal -->
<div class="modal fade" id="aiRecommendedActionsModal" tabindex="-1"
     aria-labelledby="aiRecommendedActionsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg,#1e40af,#3b82f6); color:#fff;">
                <h5 class="modal-title" id="aiRecommendedActionsLabel">
                    <i class="fas fa-robot me-2"></i>Spectra's Recommended Action Plan
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">

                {# ── Situation summary ── #}
                <div class="d-flex align-items-start gap-2 mb-3 p-3"
                     style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:10px;">
                    <i class="fas fa-lightbulb mt-1 flex-shrink-0" style="color:#1e40af;"></i>
                    <p class="mb-0" style="font-size:0.88rem; color:#1e3a8a; line-height:1.55;">
                        {{ daily_briefing.action_summary }}
                    </p>
                </div>

                {# ── Numbered PM steps ── #}
                {% if daily_briefing.action_plan %}
                <div class="d-flex flex-column gap-2">
                {% for step in daily_briefing.action_plan %}
                    <div class="action-step-card {% if step.task.risk_level == 'critical' %}step-critical{% elif step.task.risk_level == 'high' %}step-high{% else %}step-overdue{% endif %}">
                        {# Title row #}
                        <div class="d-flex align-items-center mb-2">
                            <span class="action-step-number">{{ forloop.counter }}</span>
                            <div class="flex-grow-1 min-w-0">
                                <span class="fw-bold" style="font-size:0.92rem;">{{ step.task.title }}</span>
                            </div>
                            <div class="d-flex align-items-center gap-1 flex-shrink-0 ms-2">
                                {% if step.task.risk_level == 'critical' %}
                                    <span class="badge bg-danger" style="font-size:0.68rem;">Critical</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark" style="font-size:0.68rem;">High Risk</span>
                                {% endif %}
                                {% if step.task.due_date %}
                                <span class="text-muted" style="font-size:0.71rem;">
                                    <i class="fas fa-calendar-alt me-1"></i>{{ step.task.due_date|date:"M d" }}
                                </span>
                                {% endif %}
                                {% if step.task.assigned_to %}
                                <span class="text-muted" style="font-size:0.71rem;">
                                    <i class="fas fa-user me-1"></i>{{ step.task.assigned_to.username }}
                                </span>
                                {% else %}
                                <span style="font-size:0.71rem; color:#dc2626;">
                                    <i class="fas fa-user-slash me-1"></i>Unassigned
                                </span>
                                {% endif %}
                                <span class="badge priority-{{ step.task.priority }}" style="font-size:0.68rem;">{{ step.task.priority|title }}</span>
                                <span style="font-size:0.71rem; color:#6b7280;">{{ step.task.progress }}%</span>
                                <a href="{% url 'task_detail' step.task.id %}"
                                   class="btn btn-xs btn-outline-primary ms-1"
                                   style="font-size:0.72rem; padding:0.15rem 0.5rem;">
                                    Open
                                </a>
                            </div>
                        </div>
                        {# Why #}
                        <p class="action-why-text mb-2">{{ step.why }}</p>
                        {# Next action #}
                        <div class="action-next-box">
                            <i class="fas fa-arrow-right"></i>
                            {{ step.next_action }}
                        </div>
                    </div>
                {% endfor %}
                </div>

                {% elif daily_briefing.action_type == 'progress' %}
                <div class="text-center py-3">
                    <i class="fas fa-rocket fa-3x text-success mb-2"></i>
                    <p class="fw-semibold text-success mb-1">Great momentum!</p>
                    <p class="text-muted small">Your team is at {{ completion_rate }}% completion. Review remaining open tasks and ensure they are all assigned before the sprint closes.</p>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-tasks fa-3x text-primary mb-2"></i>
                    <p class="text-muted small">Navigate to your boards to review and assign in-progress tasks to maintain delivery momentum.</p>
                </div>
                {% endif %}

            </div>
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" style="font-size:0.72rem;">
                    {% if daily_briefing.ai_powered %}
                        <i class="fas fa-robot me-1" style="color:#3b82f6;"></i>
                        <span style="color:#1e40af; font-weight:600;">Spectra AI</span>
                        &middot; AI-generated analysis &middot; Live project data
                    {% else %}
                        <i class="fas fa-sync-alt me-1"></i>Based on live project data
                    {% endif %}
                </small>
                <div class="d-flex gap-2">
                    {% if daily_briefing.action_type == 'high_risk' or daily_briefing.action_type == 'overdue' %}
                    <button class="btn btn-outline-secondary btn-sm"
                            data-bs-dismiss="modal"
                            data-bs-toggle="modal" data-bs-target="#highRiskModal"
                            style="font-size:0.78rem;">
                        <i class="fas fa-table me-1"></i>See Full Risk List
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-secondary btn-sm"
                            data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /AI Recommended Actions Modal -->

<!-- Demo Credentials — compact pill -->
<div class="demo-credentials-banner" id="demoCredentialsBanner">
    <div class="demo-banner-header" onclick="toggleDemoBanner()">
        <i class="fas fa-user-shield demo-banner-icon"></i>
        <span class="demo-banner-title">Demo Credentials</span>
        <i class="fas fa-chevron-down demo-toggle-icon"></i>
    </div>
    <div class="demo-banner-content">
        <div class="demo-users-row">
            <!-- Alex Chen - Admin -->
            <div class="demo-user-box admin">
                <div class="demo-user-header">
                    <div class="demo-user-init">AC</div>
                    <div class="demo-user-info">
                        <h6>Alex Chen</h6>
                        <p class="demo-user-role">Admin</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">alex_chen_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Project Management</span>
                    <span class="demo-skill-tag">Agile/Scrum</span>
                    <span class="demo-skill-tag">Leadership</span>
                </div>
                <a href="{% url 'quick_demo_login' 'alex_chen_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Alex
                </a>
            </div>

            <!-- Sam Rivera - Developer -->
            <div class="demo-user-box developer">
                <div class="demo-user-header">
                    <div class="demo-user-init">SR</div>
                    <div class="demo-user-info">
                        <h6>Sam Rivera</h6>
                        <p class="demo-user-role">Developer</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">sam_rivera_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Python</span>
                    <span class="demo-skill-tag">JavaScript</span>
                    <span class="demo-skill-tag">Django</span>
                    <span class="demo-skill-tag">React</span>
                </div>
                <a href="{% url 'quick_demo_login' 'sam_rivera_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Sam
                </a>
            </div>

            <!-- Jordan Taylor - Strategist -->
            <div class="demo-user-box strategist">
                <div class="demo-user-header">
                    <div class="demo-user-init">JT</div>
                    <div class="demo-user-info">
                        <h6>Jordan Taylor</h6>
                        <p class="demo-user-role">Strategist</p>
                    </div>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Username:</span>
                    <span class="demo-cred-value">jordan_taylor_demo</span>
                </div>
                <div class="demo-cred-item">
                    <span class="demo-cred-label">Password:</span>
                    <span class="demo-cred-value">demo123</span>
                </div>
                <div class="demo-skills-list">
                    <p style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: #555;">Key Skills:</p>
                    <span class="demo-skill-tag">Strategic Planning</span>
                    <span class="demo-skill-tag">Business Analysis</span>
                </div>
                <a href="{% url 'quick_demo_login' 'jordan_taylor_demo' %}" class="demo-login-btn">
                    <i class="fas fa-sign-in-alt me-1"></i>Login as Jordan
                </a>
            </div>
        </div>

        <!-- Demo Boards Section -->
        <div class="demo-boards-section mt-4">
            <h5 class="demo-boards-title">
                <i class="fas fa-folder-open me-2"></i>Pre-Populated Demo Board
            </h5>
            <div class="demo-boards-grid">
                <!-- Software Development Board -->
                <div class="demo-board-item software">
                    <div class="demo-board-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="demo-board-name">Software Development</div>
                    <div class="demo-board-desc">30 tasks with sprints, dependencies, and Gantt charts</div>
                </div>
            </div>
        </div>

        <!-- AI Feature Notice -->
        <div class="alert alert-info mt-4" style="border-left: 4px solid #17a2b8; background-color: #e7f6f8; border-radius: 8px;">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-3" style="font-size: 1.2rem; color: #17a2b8; margin-top: 2px;"></i>
                <div style="flex: 1;">
                    <strong style="color: #0c5460;">Note about AI Features:</strong>
                    <p style="margin-bottom: 0; margin-top: 0.5rem; color: #0c5460; font-size: 0.9rem;">
                        AI-powered features are not available for these demo users. Logging in with any of these demo accounts will not allow you to access AI features.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{{ chart_data|json_script:"dashboardChartData" }}

<!-- Dashboard Main Layout: Mission Overview (left) + My Tasks (right) -->
<div class="row g-4 mb-4">

    <!-- ======================================================== -->
    <!-- MAIN COLUMN: Mission Overview                            -->
    <!-- ======================================================== -->
    <div class="col-lg-8 col-md-12">

        <!-- Mission Overview Tree -->
        <div class="card shadow mb-4" id="mission-overview-card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bullseye me-2 text-primary"></i>Mission Overview
                    </h6>
                    {% if mission_count %}
                    <span class="badge bg-primary rounded-pill ms-2">{{ mission_count }}</span>
                    {% endif %}
                    <small class="text-muted ms-2">Goal &rarr; Mission &rarr; Strategy &rarr; Board &rarr; Tasks</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a href="{% url 'goal_list' %}" class="btn btn-sm btn-outline-warning text-dark">
                        <i class="fas fa-trophy fa-sm"></i> All Goals
                    </a>
                    <a href="{% url 'mission_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-bullseye fa-sm"></i> All Missions
                    </a>
                    <a href="{% url 'create_mission' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus fa-sm"></i> New Mission
                    </a>
                </div>
            </div>
            <div class="card-body p-3" style="max-height: 600px; overflow-y: auto; scroll-behavior: smooth;">
                {% if goal_tree %}
                <div class="mission-tree">
                    {% for goal_entry in goal_tree %}

                    {% if goal_entry.goal %}
                    {# ---- ORGANIZATION GOAL node ---- #}
                    <div class="goal-node mb-4" id="goal-node-{{ goal_entry.goal.id }}">
                        <div class="card border-0 shadow-sm mb-0" style="border-left: 4px solid #ffc107 !important;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-trophy text-warning mt-1"></i>
                                        <div>
                                            <span class="badge text-uppercase fw-semibold me-1 mb-1"
                                                  style="background:#fff8e1; color:#b8860b; border:1px solid #ffe082; font-size:0.6rem; letter-spacing:0.07em; padding:3px 7px;">
                                                Organization Goal
                                            </span>
                                            <h6 class="mb-0 fw-bold">
                                                <a href="{% url 'goal_detail' goal_entry.goal.id %}" class="text-decoration-none text-dark">{{ goal_entry.goal.name }}</a>
                                            </h6>
                                            {% if goal_entry.goal.target_metric %}
                                            <small class="text-warning fw-semibold">
                                                <i class="fas fa-bullseye me-1"></i>{{ goal_entry.goal.target_metric }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        {% if goal_entry.goal.status == 'active' %}
                                            <span class="badge bg-success">Active</span>
                                        {% elif goal_entry.goal.status == 'completed' %}
                                            <span class="badge bg-primary">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">On Hold</span>
                                        {% endif %}
                                        <span class="badge bg-light text-dark border">
                                            <i class="fas fa-bullseye text-primary me-1"></i>{{ goal_entry.missions|length }} mission{{ goal_entry.missions|length|pluralize }}
                                        </span>
                                        <a href="{% url 'goal_detail' goal_entry.goal.id %}" class="btn btn-sm btn-outline-warning text-dark" title="Open Goal">
                                            <i class="fas fa-external-link-alt fa-xs"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# missions indented under this goal #}
                        <div class="ps-4 mt-1">
                    {% else %}
                    {# ---- Ungrouped missions (no Organization Goal) ---- #}
                    <div class="ungrouped-missions-section mb-4">
                        <div class="text-muted small mb-2 ps-1">
                            <i class="fas fa-minus-circle me-1"></i><em>Missions not linked to an Organization Goal</em>
                        </div>
                        <div>
                    {% endif %}

                        {# ---- MISSION nodes (inside either Goal or Ungrouped wrapper) ---- #}
                        {% for mission_item in goal_entry.missions %}
                        {% with mission=mission_item.mission %}
                        <div class="mission-node mb-4" id="mission-node-{{ mission.id }}">
                        <!-- Mission Card -->
                        <div class="mission-card card border-0 shadow-sm mb-0" style="border-left: 4px solid #4e73df !important;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <i class="fas fa-bullseye text-primary mt-1"></i>
                                        <div>
                                            <!-- MISSION label -->
                                            <span class="badge text-uppercase fw-semibold me-1 mb-1"
                                                  style="background:#e8f0fe; color:#3a5bd9; border:1px solid #c0d0f8; font-size:0.6rem; letter-spacing:0.07em; padding:3px 7px;">
                                                Mission
                                            </span>
                                            <h6 class="mb-0 fw-bold">
                                                <a href="{{ mission.get_absolute_url }}" class="text-decoration-none text-dark stretched-link-override">{{ mission.name }}</a>
                                            </h6>
                                            {% if mission.description %}
                                            <small class="text-muted">{{ mission.description|truncatechars:120 }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        <span class="badge ms-status-badge status-{{ mission.status }}">{{ mission.get_status_display }}</span>
                                        {# Health pill — derived from high-risk ratio across all boards under this mission #}
                                        {% if mission_item.health_level == 'red' %}
                                        <span class="health-pill red" data-bs-toggle="tooltip" data-bs-placement="top" title="At Risk: 30%+ of tasks across this mission's boards are high or critical risk."><span class="health-dot"></span>At Risk</span>
                                        {% elif mission_item.health_level == 'amber' %}
                                        <span class="health-pill amber" data-bs-toggle="tooltip" data-bs-placement="top" title="Caution: 10–29% of tasks across this mission's boards are high or critical risk."><span class="health-dot"></span>Caution</span>
                                        {% else %}
                                        <span class="health-pill green" data-bs-toggle="tooltip" data-bs-placement="top" title="On Track: Fewer than 10% of tasks are high or critical risk."><span class="health-dot"></span>On Track</span>
                                        {% endif %}
                                        <span class="badge bg-light text-dark border">
                                            <i class="fas fa-sitemap text-primary me-1"></i>{{ mission_item.strategy_count }} strateg{{ mission_item.strategy_count|pluralize:"y,ies" }}
                                        </span>
                                        <a href="{{ mission.get_absolute_url }}" class="btn btn-sm btn-outline-primary" title="Open Mission">
                                            <i class="fas fa-external-link-alt fa-xs"></i>
                                        </a>
                                    </div>
                                </div>
                                <!-- Mission AI Summary -->
                                <div class="ai-summary-block mt-2" id="mission-summary-block-{{ mission.id }}">
                                    {% if mission.ai_summary %}
                                    <button class="btn btn-xs btn-outline-secondary py-0 px-2 mb-1" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#mission-ai-collapse-{{ mission.id }}"
                                            aria-expanded="false">
                                        <i class="fas fa-robot text-info me-1" style="font-size:0.7rem;"></i><span style="font-size:0.72rem;">AI Summary</span>
                                        <i class="fas fa-chevron-down ms-1" style="font-size:0.6rem;"></i>
                                    </button>
                                    <div class="collapse" id="mission-ai-collapse-{{ mission.id }}">
                                        <div class="ai-summary-text" id="mission-summary-text-{{ mission.id }}">
                                            {{ mission.ai_summary|render_bullets }}
                                        </div>
                                        <small class="text-muted summary-ts" id="mission-ts-{{ mission.id }}"
                                              {% if mission.ai_summary_generated_at %}data-ts="{{ mission.ai_summary_generated_at|date:'c' }}"{% endif %}>
                                            <i class="far fa-clock me-1"></i>Updated {{ mission.ai_summary_generated_at|date:"M d, Y H:i" }}
                                        </small>
                                    </div>
                                    {% else %}
                                    <div class="ai-summary-text text-muted fst-italic small d-none" id="mission-summary-text-{{ mission.id }}"></div>
                                    <small class="text-muted summary-ts d-none" id="mission-ts-{{ mission.id }}"></small>
                                    {% endif %}
                                    <button class="btn btn-xs btn-outline-info mt-1 generate-summary-btn"
                                            data-level="mission" data-id="{{ mission.id }}"
                                            data-url="{% url 'generate_mission_summary_api' mission.id %}"
                                            title="{% if mission.organization_goal %}Goal-Aware: evaluates whether this mission is moving the needle on '{{ mission.organization_goal.name }}'{% else %}Generate AI executive summary from strategy summaries{% endif %}">
                                        <i class="fas fa-robot me-1"></i>
                                        <span class="btn-label">
                                            {% if mission.organization_goal %}<i class="fas fa-trophy text-warning me-1" style="font-size:0.65rem;"></i>Goal-Aware Summary{% else %}✨ Generate Summary{% endif %}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Strategies under this mission -->
                        {% if mission_item.strategies %}
                        <div class="strategy-container ps-4 mt-1">
                            {% for strategy_item in mission_item.strategies %}
                            {% with strategy=strategy_item.strategy %}
                            <div class="strategy-node mt-2" id="strategy-node-{{ strategy.id }}">
                                <!-- Strategy Row (always visible) -->
                                <div class="strategy-row d-flex align-items-start gap-2 p-2 rounded"
                                     data-strategy-id="{{ strategy.id }}"
                                     style="cursor:pointer; background:#f8f9fa; border-left: 3px solid #858796;">
                                    <span class="tree-branch-icon mt-1 text-muted">&#9492;&#9472;</span>
                                    <i class="fas fa-chess-knight text-secondary mt-1 flex-shrink-0"></i>
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                            <div>
                                                <!-- STRATEGY label -->
                                                <span class="badge text-uppercase fw-semibold me-1"
                                                      style="background:#f1f1f3; color:#555; border:1px solid #d0d0d8; font-size:0.58rem; letter-spacing:0.07em; padding:3px 7px;">
                                                    Strategy
                                                </span>
                                                <span class="fw-semibold strategy-name">
                                                    <a href="{{ strategy.get_absolute_url }}" class="text-decoration-none text-dark" onclick="event.stopPropagation()">{{ strategy.name }}</a>
                                                </span>
                                                {% if strategy.description %}
                                                <small class="text-muted ms-2">{{ strategy.description|truncatechars:80 }}</small>
                                                {% endif %}
                                            </div>
                                            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                                <span class="badge ms-status-badge status-{{ strategy.status }}">{{ strategy.get_status_display }}</span>
                                                {# Strategy health pill #}
                                                {% if strategy_item.health_level == 'red' %}
                                                <span class="health-pill red" style="font-size:0.58rem;" data-bs-toggle="tooltip" data-bs-placement="top" title="At Risk: 30%+ of tasks across this strategy's boards are high or critical risk."><span class="health-dot"></span>At Risk</span>
                                                {% elif strategy_item.health_level == 'amber' %}
                                                <span class="health-pill amber" style="font-size:0.58rem;" data-bs-toggle="tooltip" data-bs-placement="top" title="Caution: 10–29% of tasks across this strategy's boards are high or critical risk."><span class="health-dot"></span>Caution</span>
                                                {% else %}
                                                <span class="health-pill green" style="font-size:0.58rem;" data-bs-toggle="tooltip" data-bs-placement="top" title="On Track: Fewer than 10% of tasks are high or critical risk."><span class="health-dot"></span>On Track</span>
                                                {% endif %}
                                                <span class="badge bg-light text-dark border small">
                                                    <i class="fas fa-clipboard-list text-primary me-1"></i>{{ strategy_item.board_count }} board{{ strategy_item.board_count|pluralize }}
                                                </span>
                                                <span class="strategy-chevron text-muted ms-1" id="chevron-{{ strategy.id }}">
                                                    <i class="fas fa-chevron-right"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <!-- Strategy AI Summary -->
                                        <div class="ai-summary-block mt-1" id="strategy-summary-block-{{ strategy.id }}" onclick="event.stopPropagation()">
                                            {% if strategy.ai_summary %}
                                            <button class="btn btn-xs btn-outline-secondary py-0 px-2 mb-1" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#strategy-ai-collapse-{{ strategy.id }}"
                                                    aria-expanded="false" onclick="event.stopPropagation()">
                                                <i class="fas fa-robot text-info me-1" style="font-size:0.65rem;"></i><span style="font-size:0.7rem;">AI Summary</span>
                                                <i class="fas fa-chevron-down ms-1" style="font-size:0.55rem;"></i>
                                            </button>
                                            <div class="collapse" id="strategy-ai-collapse-{{ strategy.id }}">
                                                <div class="ai-summary-text small" id="strategy-summary-text-{{ strategy.id }}">
                                                    {{ strategy.ai_summary|render_bullets }}
                                                </div>
                                                <small class="text-muted summary-ts" id="strategy-ts-{{ strategy.id }}"
                                                      {% if strategy.ai_summary_generated_at %}data-ts="{{ strategy.ai_summary_generated_at|date:'c' }}"{% endif %}>Updated {{ strategy.ai_summary_generated_at|date:"M d, Y H:i" }}</small>
                                            </div>
                                            {% else %}
                                            <div class="ai-summary-text text-muted fst-italic small d-none" id="strategy-summary-text-{{ strategy.id }}"></div>
                                            <small class="text-muted summary-ts d-none" id="strategy-ts-{{ strategy.id }}"></small>
                                            {% endif %}
                                            <button class="btn btn-xs btn-outline-info mt-1 generate-summary-btn"
                                                    data-level="strategy" data-id="{{ strategy.id }}"
                                                    data-url="{% url 'generate_strategy_summary_api' strategy.id %}"
                                                    title="Generate/refresh AI summary">
                                                <i class="fas fa-robot me-1"></i><span class="btn-label">✨ Summarise</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Boards under this strategy (collapsed by default) -->
                                {% if strategy_item.boards %}
                                <div class="boards-container ps-4 mt-1 d-none" id="boards-{{ strategy.id }}">
                                    {% for board_item in strategy_item.boards %}
                                    {% with board=board_item.board %}
                                    <div class="board-tile-row d-flex align-items-center gap-2 p-2 mb-1 rounded border bg-white"
                                         style="border-left: 3px solid {% if board_item.health_level == 'red' %}#ef4444{% elif board_item.health_level == 'amber' %}#f59e0b{% else %}#10b981{% endif %} !important;">
                                        <span class="tree-branch-icon text-muted small">&#9492;&#9472;</span>
                                        <i class="fas fa-clipboard-list text-primary flex-shrink-0" style="font-size:0.8rem;"></i>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-1">
                                                <div>
                                                    <span class="fw-semibold small">
                                                        <a href="{% url 'board_detail' board.id %}" class="text-decoration-none text-dark">{{ board.name }}</a>
                                                    </span>
                                                    {% if board.is_official_demo_board %}
                                                    <span class="badge bg-warning text-dark ms-1" style="font-size:0.6rem;">DEMO</span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex align-items-center gap-1 flex-shrink-0">
                                                    <small class="text-muted">{{ board_item.done_tasks }}/{{ board_item.total_tasks }} tasks</small>
                                                    <a href="{% url 'board_detail' board.id %}" class="btn btn-xs btn-primary ms-1">Open</a>
                                                    <a href="{% url 'board_analytics' board.id %}" class="btn btn-xs btn-outline-secondary" title="Analytics"><i class="fas fa-chart-pie fa-xs"></i></a>
                                                </div>
                                            </div>
                                            <!-- Board progress bar -->
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <div class="progress flex-grow-1" style="height:6px;">
                                                    <div class="progress-bar {% if board_item.completion_pct < 30 %}bg-danger{% elif board_item.completion_pct < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                                         role="progressbar" style="width:{{ board_item.completion_pct }}%;"></div>
                                                </div>
                                                <small class="text-muted flex-shrink-0" style="font-size:0.7rem;">{{ board_item.completion_pct }}%</small>
                                            </div>
                                            <!-- Board AI summary -->
                                            {% if board.ai_summary %}
                                            <button class="btn btn-xs btn-outline-secondary py-0 px-2 mt-1 mb-1" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#board-ai-collapse-{{ board.id }}"
                                                    aria-expanded="false" onclick="event.stopPropagation()">
                                                <i class="fas fa-robot me-1" style="font-size:0.6rem;"></i><span style="font-size:0.68rem;">AI Summary</span>
                                                <i class="fas fa-chevron-down ms-1" style="font-size:0.55rem;"></i>
                                            </button>
                                            <div class="collapse" id="board-ai-collapse-{{ board.id }}">
                                                <div class="ai-summary-text small mt-1" id="board-summary-text-{{ board.id }}">
                                                    {{ board.ai_summary|render_bullets }}
                                                </div>
                                                <small class="text-muted summary-ts" id="board-ts-{{ board.id }}"
                                                      {% if board.ai_summary_generated_at %}data-ts="{{ board.ai_summary_generated_at|date:'c' }}"{% endif %}
                                                      style="font-size:0.68rem;">
                                                    {% if board.ai_summary_generated_at %}<i class="far fa-clock me-1"></i>Updated {{ board.ai_summary_generated_at|date:"M d, Y H:i" }}{% endif %}
                                                </small>
                                            </div>
                                            {% else %}
                                            <div class="ai-summary-text small text-muted fst-italic mt-1 d-none" id="board-summary-text-{{ board.id }}"></div>
                                            <small class="text-muted summary-ts d-none" id="board-ts-{{ board.id }}"></small>
                                            {% endif %}
                                            <div class="mt-1" onclick="event.stopPropagation()">
                                                <button class="btn btn-xs btn-outline-info generate-summary-btn"
                                                        data-level="board" data-id="{{ board.id }}"
                                                        data-url="{% url 'generate_board_summary_api' board.id %}"
                                                        title="Generate/refresh AI board summary">
                                                    <i class="fas fa-robot me-1"></i><span class="btn-label">✨ Board AI</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="ps-4 mt-2">
                            <small class="text-muted fst-italic">
                                <i class="fas fa-info-circle me-1"></i>No strategies yet.
                                <a href="{% url 'mission_detail' mission.id %}">Add a strategy</a> to this mission.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endfor %}
                    {# close the indentation div inside the goal/ungrouped wrapper #}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty state: no goals or missions yet -->
                <div class="text-center py-5">
                    <i class="fas fa-trophy fa-4x text-warning mb-3" style="opacity:0.3;"></i>
                    <p class="mb-2 fw-semibold">No Organization Goals or Missions yet</p>
                    <p class="text-muted small mb-4">
                        Start at the top — define an <strong>Organization Goal</strong> (your North Star),
                        then add Missions, Strategies and Boards underneath it.
                    </p>
                    <a href="{% url 'create_goal' %}" class="btn btn-warning text-dark">
                        <i class="fas fa-trophy fa-sm me-1"></i> Create Organization Goal
                    </a>
                    <a href="{% url 'create_mission' %}" class="btn btn-primary ms-2">
                        <i class="fas fa-bullseye fa-sm me-1"></i> New Mission
                    </a>
                    <a href="{% url 'create_board' %}" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-plus fa-sm me-1"></i> New Board
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- /Mission Overview -->

    </div>
    <!-- /col-lg-8 -->

    <!-- ======================================================== -->
    <!-- RIGHT PANEL: My Tasks                                    -->
    <!-- ======================================================== -->
    <div class="col-lg-4 col-md-12">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary me-2">
                        <i class="fas fa-user-check me-2"></i>My Tasks
                    </h6>
                    <span class="badge bg-secondary rounded-pill">{{ my_tasks_count }}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <select id="taskSortSelect" class="form-select form-select-sm" style="width:auto; font-size:0.75rem;"
                        onchange="changeSortOrder(this.value)">
                        <option value="urgency" {% if my_tasks_sort_by == 'urgency' %}selected{% endif %}>🚨 Urgency</option>
                        <option value="due_date" {% if my_tasks_sort_by == 'due_date' %}selected{% endif %}>📅 Due Date</option>
                        <option value="priority" {% if my_tasks_sort_by == 'priority' %}selected{% endif %}>🔥 Priority</option>
                        <option value="recent" {% if my_tasks_sort_by == 'recent' %}selected{% endif %}>🕒 Recent</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0" style="overflow-y:auto; max-height:600px;">
                {% if my_tasks %}
                <ul class="list-group list-group-flush">
                    {% for task in my_tasks %}
                    <li class="list-group-item px-3 py-2" style="list-style:none;">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <span class="fw-semibold small">{{ task.title|truncatechars:50 }}</span>
                            <span class="badge priority-{{ task.priority }} ms-1 flex-shrink-0">{{ task.priority|title }}</span>
                        </div>
                        <div class="text-muted" style="font-size:0.72rem;">
                            <i class="fas fa-project-diagram me-1"></i>{{ task.column.board.name }}
                            <span class="text-muted ms-1">/ {{ task.column.name }}</span>
                        </div>
                        {% if task.due_date %}
                        <div style="font-size:0.72rem;" class="{% if task.due_date < now and task.progress < 100 %}text-danger{% else %}text-muted{% endif %}">
                            <i class="far fa-calendar-alt me-1"></i>{{ task.due_date|date:"M d, Y" }}
                            {% if task.due_date < now and task.progress < 100 %}<span class="badge bg-danger ms-1" style="font-size:0.6rem;">Overdue</span>{% endif %}
                        </div>
                        {% endif %}
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <div class="progress flex-grow-1" style="height:5px;">
                                <div class="progress-bar {% if task.progress < 30 %}bg-danger{% elif task.progress < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar" style="width:{{ task.progress }}%"></div>
                            </div>
                            <span style="font-size:0.68rem;" class="text-muted flex-shrink-0">{{ task.progress }}%</span>
                            <a href="{% url 'task_detail' task.id %}" class="btn btn-xs btn-primary flex-shrink-0">View</a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-4 px-3">
                    <i class="fas fa-user-check fa-3x text-muted mb-3" style="opacity:0.25;"></i>
                    <p class="fw-semibold text-muted mb-1" style="font-size:0.9rem;">No tasks assigned to you yet.</p>
                    <p class="text-muted" style="font-size:0.78rem; line-height:1.5;">
                        Open any board, click a task, and assign it to yourself — it will appear here.
                    </p>
                    <a href="{% url 'board_list' %}" class="btn btn-sm btn-outline-primary mt-1" style="font-size:0.78rem;">
                        <i class="fas fa-clipboard-list me-1"></i>Browse Boards
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- /col-lg-4 -->

</div>
<!-- /Dashboard Main Layout row -->

<!-- ============================================================ -->
<!-- ZONE 3: PERFORMANCE ANALYTICS                               -->
<!-- Row 1 — Mission + Strategy charts (enlarged)               -->
<!-- Row 2 — Board bars, Scope Creep Index, Velocity sparkline   -->
<!-- Row 3 — SPI/CPI gauges + Risk Heatmap                      -->
<!-- ============================================================ -->
<div class="mb-2">
    <h6 class="text-muted text-uppercase fw-bold" style="font-size:0.72rem; letter-spacing:0.08em; border-bottom: 2px solid #e3e6f0; padding-bottom:6px;">
        <i class="fas fa-chart-bar me-2"></i>Performance Analytics
    </h6>
</div>

<!-- Row 1: Mission + Strategy charts -->
<div class="row g-3 mb-3">
    <div class="col-lg-6">
        <div class="card shadow-sm zone3-chart-card">
            <div class="card-header py-2 d-flex align-items-center" style="background:#e8f0fe;">
                <i class="fas fa-bullseye me-2 text-primary"></i>
                <span class="fw-semibold small text-primary">Mission Completion &amp; Risk</span>
            </div>
            <div class="card-body p-2" style="height:300px; position:relative;">
                {% if chart_missions %}
                <canvas id="missionChart"></canvas>
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small">
                    <div class="text-center"><i class="fas fa-bullseye fa-2x mb-2 d-block" style="opacity:0.2;"></i>No mission data yet.<br><a href="{% url 'create_mission' %}">Create your first mission</a></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm zone3-chart-card">
            <div class="card-header py-2 d-flex align-items-center" style="background:#f0f4ff;">
                <i class="fas fa-chess-knight me-2 text-secondary"></i>
                <span class="fw-semibold small">Strategy Progress — Done vs Remaining</span>
            </div>
            <div class="card-body p-2" style="height:300px; position:relative;">
                {% if chart_strategies %}
                <canvas id="strategyChart"></canvas>
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small">
                    <div class="text-center"><i class="fas fa-chess-knight fa-2x mb-2 d-block" style="opacity:0.2;"></i>No strategy data yet.</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Row 2: Board Bars + Scope Creep Index + Velocity -->
<div class="row g-3 mb-3">
    <!-- Board Completion Bars -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 d-flex align-items-center" style="background:#f8f9fc;">
                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                <span class="fw-semibold small">Board Progress</span>
            </div>
            <div class="card-body p-3" style="max-height:220px; overflow-y:auto;">
                {% if chart_boards %}
                {% for b in chart_boards %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small fw-semibold text-truncate" style="max-width:140px;" title="{{ b.name }}">{{ b.name }}</span>
                        <span class="small text-muted fw-bold">{{ b.completion_pct }}%</span>
                    </div>
                    <div class="progress" style="height:10px; border-radius:6px;">
                        <div class="progress-bar {% if b.completion_pct < 30 %}bg-danger{% elif b.completion_pct < 70 %}bg-warning{% else %}bg-success{% endif %}"
                             role="progressbar" style="width:{{ b.completion_pct }}%; border-radius:6px;"></div>
                    </div>
                    {% if b.high_risk > 0 %}
                    <small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>{{ b.high_risk }} high-risk task{{ b.high_risk|pluralize }}</small>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small"><i class="fas fa-info-circle me-1"></i>No board data yet.</div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Scope Creep Index -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 d-flex align-items-center" style="background:#fdf4ff;">
                <i class="fas fa-expand-arrows-alt me-2" style="color:#9333ea;"></i>
                <span class="fw-semibold small" style="color:#7e22ce;">Scope Creep Index</span>
                <span class="ms-auto" data-bs-toggle="tooltip" data-bs-placement="top"
                      title="Compares the current total task count against the baseline snapshot set at project kick-off. Growth above 20% is a typical PM warning threshold.">
                    <i class="fas fa-info-circle text-muted" style="font-size:0.75rem; cursor:help;"></i>
                </span>
            </div>
            <div class="card-body p-3" style="height:220px; overflow-y:auto;">
                {% if scope_creep_data.has_data %}
                {# ── Headline summary ── #}
                <div class="d-flex align-items-center gap-2 mb-3 p-2 rounded"
                     style="background:{% if scope_creep_data.growth_pct > 20 %}#fef2f2{% elif scope_creep_data.growth_pct > 0 %}#fffbeb{% else %}#f0fdf4{% endif %};">
                    <span style="font-size:1.5rem; font-weight:700; line-height:1;
                                 color:{% if scope_creep_data.growth_pct > 20 %}#dc2626{% elif scope_creep_data.growth_pct > 0 %}#d97706{% else %}#16a34a{% endif %}">
                        {% if scope_creep_data.tasks_added > 0 %}+{% endif %}{{ scope_creep_data.tasks_added }}
                    </span>
                    <div>
                        <div class="fw-semibold" style="font-size:0.78rem;">tasks added since baseline</div>
                        <div class="text-muted" style="font-size:0.7rem;">
                            {% if scope_creep_data.growth_pct > 0 %}
                                <span style="color:{% if scope_creep_data.growth_pct > 20 %}#dc2626{% else %}#d97706{% endif %}; font-weight:600;">
                                    +{{ scope_creep_data.growth_pct }}% scope growth
                                </span>
                            {% elif scope_creep_data.growth_pct < 0 %}
                                <span style="color:#16a34a; font-weight:600;">{{ scope_creep_data.growth_pct }}% scope reduction</span>
                            {% else %}
                                <span style="color:#16a34a; font-weight:600;">Scope stable</span>
                            {% endif %}
                            &middot; baseline: {{ scope_creep_data.total_baseline }} tasks
                        </div>
                    </div>
                </div>
                {# ── Per-board breakdown ── #}
                {% for b in scope_creep_data.boards %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small text-truncate fw-semibold" style="max-width:130px;" title="{{ b.name }}">{{ b.name }}</span>
                        <span class="small" style="white-space:nowrap;
                              color:{% if b.added > 0 %}{% if b.growth_pct > 20 %}#dc2626{% else %}#d97706{% endif %}{% else %}#16a34a{% endif %}; font-weight:600;">
                            {% if b.added > 0 %}+{% endif %}{{ b.added }}
                            <span class="text-muted fw-normal">({% if b.added > 0 %}+{% endif %}{{ b.growth_pct }}%)</span>
                        </span>
                    </div>
                    <div class="progress" style="height:6px; border-radius:4px; background:#e5e7eb;">
                        {# baseline fill #}
                        <div class="progress-bar" role="progressbar"
                             style="width:{% if b.current %}{% widthratio b.baseline b.current 100 %}{% else %}100{% endif %}%; background:#a78bfa; border-radius:4px 0 0 4px;"></div>
                        {# scope-added fill #}
                        {% if b.added > 0 %}
                        <div class="progress-bar" role="progressbar"
                             style="width:{% widthratio b.added b.current 100 %}%; background:{% if b.growth_pct > 20 %}#f87171{% else %}#fcd34d{% endif %}; border-radius:0 4px 4px 0;"></div>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted" style="font-size:0.62rem;"><span style="color:#a78bfa;">&#9646;</span> Baseline {{ b.baseline }}</small>
                        <small class="text-muted" style="font-size:0.62rem;">Now {{ b.current }}</small>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center text-muted">
                    <i class="fas fa-ruler-combined fa-2x mb-2" style="opacity:0.2; color:#9333ea;"></i>
                    <p class="small mb-1">No baseline set yet.</p>
                    <p class="text-muted" style="font-size:0.72rem;">Open any board &rarr; <strong>Set Baseline</strong> to start tracking scope growth.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Velocity Sparkline -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 d-flex align-items-center" style="background:#fff8f0;">
                <i class="fas fa-tachometer-alt me-2 text-warning"></i>
                <span class="fw-semibold small">Team Velocity (tasks/week)</span>
            </div>
            <div class="card-body p-2" style="height:220px; position:relative;">
                <canvas id="velocityChart"></canvas>
                <div id="velocity-empty" class="d-none d-flex align-items-center justify-content-center h-100 text-muted small">
                    <div class="text-center"><i class="fas fa-tachometer-alt fa-2x mb-2 d-block" style="opacity:0.2;"></i>No velocity data yet.<br><small>Complete tasks across sprints to see trends.</small></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Row 3: SPI/CPI Gauges + Risk Heatmap -->
<div class="row g-3 mb-4">
    <!-- SPI Gauge -->
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 text-center" style="background:#eff6ff;">
                <span class="fw-semibold small text-primary">SPI</span>
                <span class="text-muted small d-block" style="font-size:0.65rem;">Schedule Performance Index = EV/PV</span>
            </div>
            <div class="card-body p-2" style="height:160px; position:relative;">
                <canvas id="spiGauge"></canvas>
                <div class="gauge-label">
                    <div class="gauge-value" id="spi-gauge-val">—</div>
                    <div class="gauge-sub" id="spi-gauge-sub">Avg across boards</div>
                </div>
            </div>
        </div>
    </div>
    <!-- CPI Gauge -->
    <div class="col-lg-3 col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 text-center" style="background:#f0fdf4;">
                <span class="fw-semibold small text-success">CPI</span>
                <span class="text-muted small d-block" style="font-size:0.65rem;">Cost Performance Index = EV/AC</span>
            </div>
            <div class="card-body p-2" style="height:160px; position:relative;">
                <canvas id="cpiGauge"></canvas>
                <div class="gauge-label">
                    <div class="gauge-value" id="cpi-gauge-val">—</div>
                    <div class="gauge-sub" id="cpi-gauge-sub">Avg across boards</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Risk Heatmap -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header py-2 d-flex align-items-center" style="background:#fef2f2;">
                <i class="fas fa-fire me-2 text-danger"></i>
                <span class="fw-semibold small text-danger">Risk Heatmap</span>
                <small class="text-muted ms-2">Likelihood × Impact (tasks)</small>
            </div>
            <div class="card-body p-3">
                {% if risk_heatmap_data.has_data %}
                <div class="row g-0 mb-2">
                    <div class="col-12">
                        <div class="d-flex justify-content-between text-center mb-1">
                            <div style="width:28px;"></div>
                            <div class="flex-fill text-muted" style="font-size:0.62rem; font-weight:700;">LOW<br>IMPACT</div>
                            <div class="flex-fill text-muted" style="font-size:0.62rem; font-weight:700;">MED<br>IMPACT</div>
                            <div class="flex-fill text-muted" style="font-size:0.62rem; font-weight:700;">HIGH<br>IMPACT</div>
                        </div>
                        <!-- Row: High Likelihood -->
                        <div class="d-flex align-items-center mb-1 gap-1">
                            <div style="width:28px; font-size:0.6rem; font-weight:700; color:#6c757d; text-align:right; padding-right:4px; line-height:1.1;">HIGH<br>LIKE</div>
                            <div class="flex-fill risk-heatmap-cell rhc-3-1" title="High Likelihood × Low Impact: {{ risk_heatmap_data.matrix.2.0 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.2.0 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-3-2" title="High Likelihood × Medium Impact: {{ risk_heatmap_data.matrix.2.1 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.2.1 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-3-3" title="High Likelihood × High Impact: {{ risk_heatmap_data.matrix.2.2 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.2.2 }}</span>
                            </div>
                        </div>
                        <!-- Row: Medium Likelihood -->
                        <div class="d-flex align-items-center mb-1 gap-1">
                            <div style="width:28px; font-size:0.6rem; font-weight:700; color:#6c757d; text-align:right; padding-right:4px; line-height:1.1;">MED<br>LIKE</div>
                            <div class="flex-fill risk-heatmap-cell rhc-2-1" title="Med Likelihood × Low Impact: {{ risk_heatmap_data.matrix.1.0 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.1.0 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-2-2" title="Med Likelihood × Med Impact: {{ risk_heatmap_data.matrix.1.1 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.1.1 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-2-3" title="Med Likelihood × High Impact: {{ risk_heatmap_data.matrix.1.2 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.1.2 }}</span>
                            </div>
                        </div>
                        <!-- Row: Low Likelihood -->
                        <div class="d-flex align-items-center gap-1">
                            <div style="width:28px; font-size:0.6rem; font-weight:700; color:#6c757d; text-align:right; padding-right:4px; line-height:1.1;">LOW<br>LIKE</div>
                            <div class="flex-fill risk-heatmap-cell rhc-1-1" title="Low Likelihood × Low Impact: {{ risk_heatmap_data.matrix.0.0 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.0.0 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-1-2" title="Low Likelihood × Med Impact: {{ risk_heatmap_data.matrix.0.1 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.0.1 }}</span>
                            </div>
                            <div class="flex-fill risk-heatmap-cell rhc-1-3" title="Low Likelihood × High Impact: {{ risk_heatmap_data.matrix.0.2 }} tasks">
                                <span class="cell-count">{{ risk_heatmap_data.matrix.0.2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-muted small mb-0 mt-1"><i class="fas fa-info-circle me-1"></i>{{ risk_heatmap_data.total }} task{{ risk_heatmap_data.total|pluralize }} with risk assessments</p>
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small py-3">
                    <div class="text-center">
                        <i class="fas fa-fire fa-2x mb-2 d-block" style="opacity:0.15;"></i>
                        No risk data yet.<br>
                        <small>Use AI Risk Assessment on tasks to populate this heatmap.</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- /Zone 3 -->

<!-- Standalone Boards (not linked to any strategy) -->
{% if standalone_boards %}
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-secondary">
                    <i class="fas fa-clipboard-list me-2"></i>Standalone Boards
                    <span class="badge bg-secondary rounded-pill ms-1">{{ standalone_boards|length }}</span>
                </h6>
                <div class="d-flex gap-2">
                    <a href="{% url 'create_board' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus fa-sm"></i> New Board
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    These boards are not linked to any Mission strategy. 
                    Consider <a href="{% url 'mission_list' %}">assigning them to a strategy</a> to keep everything organised.
                </p>
                <div class="row">
                    {% for board in standalone_boards %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-left-{% if board.is_official_demo_board %}warning{% else %}secondary{% endif %} shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">{{ board.name }}</h6>
                                    {% if board.is_official_demo_board %}
                                        <span class="badge bg-warning text-dark" title="Demo board">
                                            <i class="fas fa-graduation-cap"></i> DEMO
                                        </span>
                                    {% endif %}
                                </div>
                                <p class="card-text text-muted small">
                                    {{ board.description|default:"No description."|truncatechars:90 }}
                                </p>
                                <div class="text-end mt-2">
                                    <a href="{% url 'board_detail' board.id %}" class="btn btn-sm btn-outline-secondary">Open</a>
                                    <a href="{% url 'board_analytics' board.id %}" class="btn btn-sm btn-outline-secondary" title="Analytics">
                                        <i class="fas fa-chart-pie fa-sm"></i>
                                    </a>
                                    <a href="{% url 'budget_dashboard' board.id %}" class="btn btn-sm btn-outline-success" title="Budget">
                                        <i class="fas fa-dollar-sign fa-sm"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent border-top-0">
                                <small class="text-muted">Created {{ board.created_at|date:"M d, Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Metric Detail Modals -->
<!-- Total Tasks Modal -->
<div class="modal fade" id="totalTasksModal" tabindex="-1" aria-labelledby="totalTasksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="totalTasksModalLabel">All Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if all_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Column</th>
                            <th>Priority</th>
                            <th>Progress</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in all_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td>{{ task.column.name }}</td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-info" role="progressbar"
                                        style="width: {{ task.progress }}%">
                                        <small>{{ task.progress }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="lead">No tasks found!</p>
                </div>
                {% endif %}
                
                {% if all_tasks.has_other_pages %}
                <nav aria-label="All tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if all_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ all_tasks.number }} of {{ all_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if all_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?all_tasks_page={{ all_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="totalTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ all_tasks.start_index }} to {{ all_tasks.end_index }} of {{ all_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Completed Tasks Modal -->
<div class="modal fade" id="completedTasksModal" tabindex="-1" aria-labelledby="completedTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completedTasksModalLabel">Completed Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if completed_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Priority</th>
                            <th>Completed On</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in completed_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>{{ task.updated_at|date:"M d, Y" }}</td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                    <p class="lead">No completed tasks yet!</p>
                </div>
                {% endif %}
                
                {% if completed_tasks.has_other_pages %}
                <nav aria-label="Completed tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if completed_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ completed_tasks.number }} of {{ completed_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if completed_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?completed_tasks_page={{ completed_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="completedTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ completed_tasks.start_index }} to {{ completed_tasks.end_index }} of {{ completed_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Rate Modal -->
<div class="modal fade" id="completionRateModal" tabindex="-1" aria-labelledby="completionRateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="completionRateModalLabel">Task Completion Overview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body text-center">
                                <h3 class="text-success">{{ completed_count }}</h3>
                                <p>Completed Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-primary bg-opacity-10">
                            <div class="card-body text-center">
                                <h3 class="text-primary">{{ remaining_tasks }}</h3>
                                <p>Remaining Tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ completion_rate }}%">
                        {{ completion_rate }}% Complete
                    </div>
                </div>

                <div class="text-center">
                    <h4>Overall Completion Rate: {{ completion_rate }}%</h4>
                    {% if completion_rate >= 80 %}
                    <p class="text-success"><i class="fas fa-check-circle"></i> Excellent progress! Keep up the great
                        work!</p>
                    {% elif completion_rate >= 60 %}
                    <p class="text-warning"><i class="fas fa-clock"></i> Good progress, but there's room for
                        improvement.</p>
                    {% else %}
                    <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Consider focusing on completing
                        more tasks.</p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Overdue Tasks Modal -->
<div class="modal fade" id="overdueTasksModal" tabindex="-1" aria-labelledby="overdueTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="overdueTasksModalLabel">Overdue Tasks</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if overdue_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in overdue_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td class="text-danger">{{ task.due_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge bg-danger">{{ task.due_date|timesince }} ago</span>
                            </td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="lead">No overdue tasks!</p>
                    <p class="text-muted">Great job staying on top of deadlines!</p>
                </div>
                {% endif %}
                
                {% if overdue_tasks.has_other_pages %}
                <nav aria-label="Overdue tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if overdue_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ overdue_tasks.number }} of {{ overdue_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if overdue_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?overdue_tasks_page={{ overdue_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="overdueTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ overdue_tasks.start_index }} to {{ overdue_tasks.end_index }} of {{ overdue_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- High Risk Tasks Modal -->
<div class="modal fade" id="highRiskModal" tabindex="-1" aria-labelledby="highRiskModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="highRiskModalLabel">
                    <i class="fas fa-shield-alt me-2"></i>High Risk Tasks
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if high_risk_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Risk Level</th>
                            <th>Due Date</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in high_risk_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td>
                                {% if task.risk_level == 'critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">High</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.due_date %}
                                    {{ task.due_date|date:"M d, Y" }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                    <p class="lead">No high-risk tasks!</p>
                    <p class="text-muted">All items are within acceptable risk levels.</p>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">{{ total_high_risk }} high-risk item{{ total_high_risk|pluralize }} across all boards</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Due Soon Tasks Modal -->
<div class="modal fade" id="dueSoonTasksModal" tabindex="-1" aria-labelledby="dueSoonTasksModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="dueSoonTasksModalLabel">Tasks Due Soon</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if due_soon_tasks %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Board</th>
                            <th>Due Date</th>
                            <th>Days Remaining</th>
                            <th>Priority</th>
                            <th>Progress</th>
                            <th>Assigned To</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in due_soon_tasks %}
                        <tr>
                            <td>{{ task.title }}</td>
                            <td>{{ task.column.board.name }}</td>
                            <td>{{ task.due_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge bg-warning">{{ task.due_date|timeuntil }}</span>
                            </td>
                            <td><span class="badge priority-{{ task.priority }}">{{ task.priority|title }}</span></td>
                            <td>
                                <div class="progress" style="height: 15px;">
                                    <div class="progress-bar bg-info" role="progressbar"
                                        style="width: {{ task.progress }}%">
                                        <small>{{ task.progress }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ task.assigned_to.username|default:"Unassigned" }}</td>
                            <td>
                                <a href="{% url 'task_detail' task.id %}"
                                    class="btn btn-sm btn-outline-primary">View</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <p class="lead">No tasks due soon!</p>
                    <p class="text-muted">You're ahead of schedule!</p>
                </div>
                {% endif %}
                
                {% if due_soon_tasks.has_other_pages %}
                <nav aria-label="Due soon tasks pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if due_soon_tasks.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page=1{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.previous_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Previous</a>
                        </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ due_soon_tasks.number }} of {{ due_soon_tasks.paginator.num_pages }}</span>
                        </li>
                        
                        {% if due_soon_tasks.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.next_page_number }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?due_soon_tasks_page={{ due_soon_tasks.paginator.num_pages }}{% if my_tasks_sort_by %}&sort_tasks={{ my_tasks_sort_by }}{% endif %}" data-modal="dueSoonTasksModal">Last</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">Showing {{ due_soon_tasks.start_index }} to {{ due_soon_tasks.end_index }} of {{ due_soon_tasks.paginator.count }} tasks</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Lean Six Sigma Info Modal -->
<div class="modal fade" id="leanSixSigmaInfoModal" tabindex="-1" aria-labelledby="leanSixSigmaInfoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="leanSixSigmaInfoModalLabel">
                    <i class="fas fa-chart-line me-2"></i> Lean Six Sigma Features in Pri<span
                        class="stylish-z">z</span>mAI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>What is Lean Six Sigma?</h5>
                        <p>Lean Six Sigma is a methodology that combines Lean (eliminating waste) and Six Sigma
                            (reducing variation) to improve business processes. Pri<span class="stylish-z">z</span>mAI
                            now integrates key Lean Six Sigma principles to help you visualize, categorize, and optimize
                            your work.</p>
                    </div>
                </div>

                <h5 class="mb-3">Key Features:</h5>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-tags me-1"></i> Value-Added Task Categorization
                            </div>
                            <div class="card-body">
                                <p>Categorize tasks using Lean Six Sigma labels:</p>
                                <ul>
                                    <li><strong class="text-success">Value-Added (VA):</strong> Activities customers
                                        value and would pay for</li>
                                    <li><strong class="text-warning">Necessary Non-Value-Added (NNVA):</strong> Required
                                        but non-value adding activities</li>
                                    <li><strong class="text-danger">Waste/Eliminate (NVA):</strong> Activities that
                                        should be eliminated</li>
                                </ul>
                                <p class="small text-muted">Access from: Task creation/editing forms and the label
                                    management page</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-chart-pie me-1"></i> Process Efficiency Analytics
                            </div>
                            <div class="card-body">
                                <p>Gain insights with specialized Lean Six Sigma metrics:</p>
                                <ul>
                                    <li>Value-Added percentage calculation</li>
                                    <li>Distribution of VA/NNVA/Waste tasks</li>
                                    <li>Process improvement recommendations</li>
                                </ul>
                                <p class="small text-muted">Access from: Board Analytics page</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-filter me-1"></i> Lean Six Sigma Filtering
                            </div>
                            <div class="card-body">
                                <p>Filter tasks by value category to focus efforts:</p>
                                <ul>
                                    <li>Focus on value-adding tasks first</li>
                                    <li>Identify waste for elimination</li>
                                    <li>Balance necessary non-value activities</li>
                                </ul>
                                <p class="small text-muted">Access from: Board task search panel</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-lightbulb me-1"></i> Process Improvement Tips
                            </div>
                            <div class="card-body">
                                <p>Get actionable recommendations based on your task distribution:</p>
                                <ul>
                                    <li>Ways to eliminate identified waste</li>
                                    <li>How to increase value-added percentage</li>
                                    <li>Strategies for continuous improvement</li>
                                </ul>
                                <p class="small text-muted">Access from: Board Analytics page</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Getting Started:</strong> Begin by adding Lean Six Sigma labels to your tasks. Visit the
                    "Manage Labels" section within any board and click "Add Default Lean Six Sigma Labels".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<!-- Analytics CSS for clickable metric cards -->
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<!-- Chart.js for metrics side panel (local copy, CDN fallback) -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<script>window.Chart || document.write('<script src="https:\/\/cdn.jsdelivr.net\/npm\/chart.js@4.4.2\/dist\/chart.umd.min.js"><\/script>')</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Bootstrap tooltips across the page
        var tooltipEls = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipEls.forEach(function(el) {
            new bootstrap.Tooltip(el, { trigger: 'hover focus' });
        });

        // Initialize metric cards to open modals when clicked
        const metricCards = document.querySelectorAll('.metrics-card');
        metricCards.forEach(card => {
            card.addEventListener('click', function () {
                const targetModal = this.getAttribute('data-bs-target');
                const modalElement = document.querySelector(targetModal);
                if (modalElement) {
                    const modalInstance = new bootstrap.Modal(modalElement);
                    modalInstance.show();
                }
            });
        });

        // Enhanced modal cleanup for proper scrolling restoration
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            // Handle modal hide events
            modal.addEventListener('hidden.bs.modal', function () {
                // Ensure body can scroll again
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                // Remove any orphaned backdrops
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    backdrop.remove();
                });

                // Remove aria-hidden and restore focus
                this.setAttribute('aria-hidden', 'true');
                document.body.focus();
            });

            // Handle modal shown events
            modal.addEventListener('shown.bs.modal', function () {
                // Ensure modal is properly visible
                this.removeAttribute('aria-hidden');
            });
        });

        // Additional cleanup for close buttons
        document.querySelectorAll('.modal button[data-bs-dismiss="modal"]').forEach(btn => {
            btn.addEventListener('click', function () {
                const modal = this.closest('.modal');
                if (modal) {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });
        });

        // Global escape key handler for better modal management
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    const modalInstance = bootstrap.Modal.getInstance(openModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            }
        });

        // Fix any existing modal state issues on page load
        setTimeout(function () {
            // Ensure no modal backdrops are left over
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });

            // Ensure body can scroll
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 100);
    });

    // Function to handle task sorting preference change
    function changeSortOrder(sortBy) {
        // Get current URL and update the sort parameter
        const url = new URL(window.location);
        url.searchParams.set('sort_tasks', sortBy);

        // Add a subtle loading indication
        const selectElement = document.getElementById('taskSortSelect');
        const originalHtml = selectElement.innerHTML;
        selectElement.disabled = true;

        // Show loading state briefly
        const loadingText = document.createElement('option');
        loadingText.value = '';
        loadingText.textContent = '🔄 Updating...';
        loadingText.selected = true;
        selectElement.innerHTML = '';
        selectElement.appendChild(loadingText);

        // Redirect to update the page with new sort order
        setTimeout(() => {
            window.location.href = url.toString();
        }, 300);
    }

    // Toggle Demo Credentials Banner
    function toggleDemoBanner() {
        const banner = document.getElementById('demoCredentialsBanner');
        banner.classList.toggle('expanded');

        // Save state to localStorage
        const isExpanded = banner.classList.contains('expanded');
        localStorage.setItem('demoBannerExpanded', isExpanded);
    }

    // Reset Demo Data Function
    function resetDemoData() {
        if (confirm('Reset Demo Environment?\n\nThis will:\n• Delete all boards, tasks, and data you created\n• Restore all original demo data to its initial state\n• Fix any demo data you modified\n\nThis cannot be undone.')) {
            // Show loading indicator
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
            btn.disabled = true;
            
            // Make AJAX request to reset
            fetch('/demo/reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Demo reset successfully!\n\nAll demo data has been restored to its original state.');
                    location.reload();
                } else {
                    alert('Failed to reset demo: ' + (data.message || 'Unknown error'));
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error resetting demo:', error);
                alert('Failed to reset demo. Please try again.');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            });
        }
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Restore demo banner state on page load
    document.addEventListener('DOMContentLoaded', function () {
        const banner = document.getElementById('demoCredentialsBanner');
        if (banner) {
            const wasExpanded = localStorage.getItem('demoBannerExpanded') === 'true';
            if (wasExpanded) {
                banner.classList.add('expanded');
            }
        }
        
        // Handle pagination clicks within modals
        handleModalPagination();
    });
    
    // Function to handle pagination within modals via AJAX
    function handleModalPagination() {
        // Get all pagination links in modals
        const paginationLinks = document.querySelectorAll('.modal .pagination a.page-link');
        
        paginationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const url = this.getAttribute('href');
                const modalId = this.getAttribute('data-modal');
                const modal = document.getElementById(modalId);
                
                if (!modal) return;
                
                // Show loading state
                const modalBody = modal.querySelector('.modal-body');
                const originalContent = modalBody.innerHTML;
                modalBody.innerHTML = '<div class=\"text-center py-5\"><i class=\"fas fa-spinner fa-spin fa-3x text-primary\"></i><p class=\"mt-3\">Loading...</p></div>';
                
                // Fetch the new page content
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // Parse the HTML response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract the modal content from the response
                    const newModal = doc.getElementById(modalId);
                    if (newModal) {
                        const newModalBody = newModal.querySelector('.modal-body');
                        const newModalFooter = newModal.querySelector('.modal-footer');
                        
                        if (newModalBody) {
                            modal.querySelector('.modal-body').innerHTML = newModalBody.innerHTML;
                        }
                        if (newModalFooter) {
                            modal.querySelector('.modal-footer').innerHTML = newModalFooter.innerHTML;
                        }
                        
                        // Re-attach pagination handlers
                        handleModalPagination();
                    } else {
                        modalBody.innerHTML = originalContent;
                    }
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    modalBody.innerHTML = '<div class=\"text-center py-5\"><i class=\"fas fa-exclamation-triangle fa-3x text-danger\"></i><p class=\"mt-3\">Error loading content. Please try again.</p></div>';
                });
            });
        });
    }

    /* ==========================================================
       MISSION TREE — Strategy expand/collapse & AI summary AJAX
       ========================================================== */

    // Restore expand/collapse state from localStorage on load
    function storageKey(strategyId) { return 'prizmAI_strategy_expanded_' + strategyId; }

    document.querySelectorAll('.strategy-row').forEach(function(row) {
        const stratId = row.dataset.strategyId;
        const boardsDiv  = document.getElementById('boards-' + stratId);
        const chevron    = document.getElementById('chevron-' + stratId);
        if (!boardsDiv) return;

        // Restore persisted state
        if (localStorage.getItem(storageKey(stratId)) === 'true') {
            boardsDiv.classList.remove('d-none');
            if (chevron) chevron.classList.add('expanded');
        }

        row.addEventListener('click', function(e) {
            // Don't toggle if clicking a link or button inside the row
            if (e.target.closest('a, button')) return;
            const expanded = !boardsDiv.classList.contains('d-none');
            boardsDiv.classList.toggle('d-none', expanded);
            if (chevron) chevron.classList.toggle('expanded', !expanded);
            localStorage.setItem(storageKey(stratId), (!expanded).toString());
        });
    });

    // Toggle "read more / show less" for summary text
    window.toggleSummary = function(link, blockId) {
        const block = document.getElementById(blockId);
        if (!block) return;
        const isExpanded = block.classList.contains('summary-expanded');
        block.classList.toggle('summary-truncated', isExpanded);
        block.classList.toggle('summary-expanded', !isExpanded);
        link.textContent = isExpanded ? 'read more' : 'show less';
    };

    // AI Generate Summary — async Celery-backed with polling
    // Active pollers: Map<"level-id", intervalId>
    var summaryPollers = new Map();

    /**
     * Convert an ISO timestamp string to a human-readable relative string.
     * E.g. "Updated 4 minutes ago", "Updated just now", "Updated 2 hours ago".
     */
    function timeAgo(isoStr) {
        if (!isoStr) return '';
        var d = new Date(isoStr);
        var diffMs  = Date.now() - d.getTime();
        var diffSec = Math.round(diffMs / 1000);
        if (diffSec < 5)   return 'Updated just now';
        if (diffSec < 60)  return 'Updated ' + diffSec + ' seconds ago';
        var diffMin = Math.round(diffSec / 60);
        if (diffMin < 60)  return 'Updated ' + diffMin + ' minute' + (diffMin === 1 ? '' : 's') + ' ago';
        var diffHr  = Math.round(diffMin / 60);
        if (diffHr  < 24)  return 'Updated ' + diffHr  + ' hour'   + (diffHr  === 1 ? '' : 's') + ' ago';
        var diffDay = Math.round(diffHr  / 24);
        return 'Updated ' + diffDay + ' day' + (diffDay === 1 ? '' : 's') + ' ago';
    }

    /** Refresh all summary-ts elements that have a data-ts attribute. */
    function refreshAllTimestamps() {
        document.querySelectorAll('.summary-ts[data-ts]').forEach(function(el) {
            el.innerHTML = '<i class="far fa-clock me-1"></i>' + timeAgo(el.dataset.ts);
        });
    }
    // Run once on load and then every 60 s
    refreshAllTimestamps();
    setInterval(refreshAllTimestamps, 60000);

    /** Flash-highlight an element to signal a new summary arrived. */
    function flashElement(el) {
        el.classList.remove('summary-flash');
        void el.offsetWidth; // reflow to restart animation
        el.classList.add('summary-flash');
    }

    /** Convert bullet text (• lines or plain paragraph) to <ul><li> HTML */
    function renderBullets(text) {
        if (!text) return '';
        var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(Boolean);
        var bulletLines = lines.filter(function(l) {
            return l.charCodeAt(0) === 8226 /* • */ || (l.charAt(0) === '-' && l.length > 2);
        });
        if (bulletLines.length === 0) {
            // Legacy paragraph fallback: split on sentence boundaries
            var escaped = escapeHtml(text);
            return '<ul class="ai-bullet-list mb-0"><li>' + escaped.split(/(?<=[.!?])\s+/).map(function(s) { return s.trim(); }).filter(Boolean).join('</li><li>') + '</li></ul>';
        }
        var items = bulletLines.map(function(l) {
            var content = l.replace(/^[\u2022\-]\s*/, '');
            return '<li>' + escapeHtml(content) + '</li>';
        });
        return '<ul class="ai-bullet-list mb-0">' + items.join('') + '</ul>';
    }

    /** Update the DOM for a given level/id with new summary data. */
    function applySummaryToDOM(level, objId, data) {
        var textEl = document.getElementById(level + '-summary-text-' + objId);
        var tsEl   = document.getElementById(level + '-ts-' + objId);

        if (data.summary && textEl) {
            textEl.innerHTML = renderBullets(data.summary);
            textEl.classList.remove('text-muted', 'fst-italic', 'd-none', 'summary-truncated', 'summary-expanded');
            flashElement(textEl);
            // If the text element is inside a Bootstrap collapse, expand it
            var collapseEl = document.getElementById(level + '-ai-collapse-' + objId);
            if (collapseEl && typeof bootstrap !== 'undefined') {
                var bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, {toggle: false});
                bsCollapse.show();
            } else if (textEl.classList.contains('d-none')) {
                textEl.classList.remove('d-none');
            }
        }

        if (tsEl && data.generated_at) {
            tsEl.dataset.ts = data.generated_at;
            tsEl.innerHTML  = '<i class="far fa-clock me-1"></i>' + timeAgo(data.generated_at);
            tsEl.classList.remove('d-none');
        }
    }

    /** Default label for a summary button based on level. */
    function defaultBtnLabel(level) {
        if (level === 'board') return '\u2728 Board AI';
        return '\u2728 ' + level.charAt(0).toUpperCase() + level.slice(1) + ' AI';
    }

    /** Stop spinner and restore button to its normal enabled state. */
    function resetBtn(btn, labelEl, level) {
        if (!btn) return;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        var spinnerEl = btn.querySelector('.btn-spinner');
        if (spinnerEl) spinnerEl.remove();
        if (labelEl) labelEl.textContent = defaultBtnLabel(level);
    }

    /** Put the button into a ⚠ Retry state when polling times out. */
    function setRetryState(btn, labelEl) {
        if (!btn) return;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        var spinnerEl = btn.querySelector('.btn-spinner');
        if (spinnerEl) spinnerEl.remove();
        if (labelEl) labelEl.textContent = '\u26A0 Timed out \u2014 Retry';
        btn.title = 'AI generation is taking longer than expected. Click to try again.';
    }

    /** Start polling /api/summary-status/{level}/{id}/ until the summary updates. */
    function startPolling(level, objId, previousGeneratedAt) {
        var pollerKey = level + '-' + objId;
        // Cancel any already-running poller for the same object
        if (summaryPollers.has(pollerKey)) {
            clearInterval(summaryPollers.get(pollerKey));
        }

        var pollCount = 0;
        var MAX_POLLS = 72; // 72 × 5 s = 6 min max (covers slow Celery startup)
        var btn = document.querySelector('.generate-summary-btn[data-level="' + level + '"][data-id="' + objId + '"]');
        var labelEl = btn ? btn.querySelector('.btn-label') : null;
        var timedOut = false;
        var onVisibilityChange = null; // declared up-front so doPoll can reference it

        function stopPoller(success) {
            clearInterval(intervalId);
            summaryPollers.delete(pollerKey);
            if (onVisibilityChange) {
                document.removeEventListener('visibilitychange', onVisibilityChange);
                onVisibilityChange = null;
            }
            if (success) {
                resetBtn(btn, labelEl, level);
            } else {
                timedOut = true;
                setRetryState(btn, labelEl);
            }
        }

        function doPoll() {
            fetch('/api/summary-status/' + level + '/' + objId + '/', {
                method: 'GET',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var generatedAtChanged = (
                    data.generated_at
                    && data.generated_at !== previousGeneratedAt
                );
                // A changed generated_at is definitive DB-level proof that the
                // Celery task completed and saved a fresh summary.  Do NOT gate
                // on !data.queued: in multi-process deployments (web process +
                // Celery worker) the lock-release may be invisible to the web
                // process when LocMemCache is used (each process has its own
                // in-memory store), so queued can stay true for the full 10-min
                // TTL even after the task finishes.
                var isNew = generatedAtChanged;
                if (isNew) {
                    stopPoller(true);
                    applySummaryToDOM(level, objId, data);
                } else if (pollCount >= MAX_POLLS) {
                    stopPoller(false);
                }
            })
            .catch(function() {
                if (pollCount >= MAX_POLLS) {
                    stopPoller(false);
                }
            });
        }

        // Fire one poll immediately so fast tasks (< 5 s) are detected right away
        pollCount++;
        doPoll();

        var intervalId = setInterval(function() {
            pollCount++;
            doPoll();
        }, 5000);

        summaryPollers.set(pollerKey, intervalId);

        // When the user switches back to this tab, immediately do one extra check.
        // This catches the common case where the task finished while the tab was
        // in the background and the poller hasn't had its next 5-second tick yet.
        onVisibilityChange = function() {
            if (document.visibilityState !== 'visible') return;
            if (summaryPollers.has(pollerKey)) {
                pollCount++;
                doPoll();
            } else {
                document.removeEventListener('visibilitychange', onVisibilityChange);
            }
        };
        document.addEventListener('visibilitychange', onVisibilityChange);
    }

    document.querySelectorAll('.generate-summary-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            var level  = btn.dataset.level;
            var objId  = btn.dataset.id;
            var url    = btn.dataset.url;

            // Spinner state
            btn.classList.add('btn-loading');
            btn.disabled = true;
            if (!btn.querySelector('.btn-spinner')) {
                var spinner = document.createElement('span');
                spinner.className = 'btn-spinner spinner-border spinner-border-sm me-1';
                spinner.setAttribute('role', 'status');
                btn.prepend(spinner);
            }
            var labelEl = btn.querySelector('.btn-label');
            if (labelEl) labelEl.textContent = '\uD83D\uDD04 Refreshing…';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.error) {
                    resetBtn(btn, labelEl, level);
                    alert('Error: ' + data.error);
                    return;
                }

                // Show the cached summary immediately if available
                if (data.summary) {
                    applySummaryToDOM(level, objId, data);
                }

                // Use the API's generated_at as the polling baseline.
                // IMPORTANT: do NOT use the template-rendered data-ts value here.
                // Django's |date:'c' filter omits microseconds (e.g. "...+05:30")
                // while Python's .isoformat() includes them ("...123456+05:30").
                // Using mismatched formats causes generatedAtChanged to fire true
                // on the very first poll (before the Celery task finishes), which
                // stops the poller immediately and the fresh result is never seen.
                var previousGeneratedAt = data.generated_at || null;

                // Begin polling for the fresh result
                startPolling(level, objId, previousGeneratedAt);
            })
            .catch(function(err) {
                resetBtn(btn, labelEl, level);
                console.error('Summary generation error:', err);
                alert('Failed to queue summary. Please try again.');
            });
        });
    });

    function escapeHtml(text) {
        var map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
        return String(text).replace(/[&<>"']/g, function(m){ return map[m]; });
    }

    /* ==========================================================
       METRICS SIDE PANEL — Chart.js initialisation
       ========================================================== */
    var _metricsMissionChart = null;
    var _metricsStrategyChart = null;

    function initMetricsCharts() {
        var el = document.getElementById('dashboardChartData');
        if (!el || typeof Chart === 'undefined') return;
        var chartData;
        try { chartData = JSON.parse(el.textContent); } catch(e) { return; }

        var COLORS = {
            done:     'rgba(28, 200, 138, 0.85)',
            remaining:'rgba(78, 115, 223, 0.3)',
            highRisk: 'rgba(231, 74, 59, 0.75)',
            gridLine: 'rgba(0,0,0,0.05)',
        };

        // --- Mission grouped bar chart (completion % + high-risk count) ---
        var mCanvas = document.getElementById('missionChart');
        if (mCanvas && chartData.missions && chartData.missions.length) {
            if (_metricsMissionChart) { _metricsMissionChart.destroy(); }
            var mLabels = chartData.missions.map(function(m){ return m.name; });
            _metricsMissionChart = new Chart(mCanvas, {
                type: 'bar',
                data: {
                    labels: mLabels,
                    datasets: [
                        {
                            label: 'Completion %',
                            data: chartData.missions.map(function(m){ return m.completion_pct; }),
                            backgroundColor: COLORS.done,
                            yAxisID: 'yPct',
                            order: 1,
                        },
                        {
                            label: 'High-Risk Tasks',
                            data: chartData.missions.map(function(m){ return m.high_risk; }),
                            backgroundColor: COLORS.highRisk,
                            yAxisID: 'yRisk',
                            type: 'bar',
                            order: 2,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12, padding: 6 } },
                        tooltip: { mode: 'index', intersect: false },
                    },
                    scales: {
                        x: { grid: { color: COLORS.gridLine }, ticks: { font: { size: 10 }, maxRotation: 30 } },
                        yPct: {
                            type: 'linear', position: 'left',
                            min: 0, max: 100,
                            grid: { color: COLORS.gridLine },
                            ticks: { font: { size: 9 }, callback: function(v){ return v + '%'; } },
                            title: { display: true, text: 'Done %', font: { size: 9 } },
                        },
                        yRisk: {
                            type: 'linear', position: 'right',
                            min: 0,
                            grid: { drawOnChartArea: false },
                            ticks: { font: { size: 9 }, precision: 0 },
                            title: { display: true, text: 'High Risk', font: { size: 9 } },
                        },
                    },
                },
            });
        }

        // --- Strategy horizontal bar chart ---
        var sCanvas = document.getElementById('strategyChart');
        if (sCanvas && chartData.strategies && chartData.strategies.length) {
            if (_metricsStrategyChart) { _metricsStrategyChart.destroy(); }
            var sLabels = chartData.strategies.map(function(s){ return s.name; });
            var sDone   = chartData.strategies.map(function(s){ return s.completion_pct; });
            var sRem    = chartData.strategies.map(function(s){ return +(100 - s.completion_pct).toFixed(1); });
            // Adjust canvas height (container .panel-chart-wrap has height: 180px by default)
            var sHeight = Math.max(120, Math.min(350, chartData.strategies.length * 40));
            sCanvas.parentElement.style.height = sHeight + 'px';
            _metricsStrategyChart = new Chart(sCanvas, {
                type: 'bar',
                data: {
                    labels: sLabels,
                    datasets: [
                        { label: 'Done %',      data: sDone, backgroundColor: COLORS.done,      stack: 's' },
                        { label: 'Remaining %', data: sRem,  backgroundColor: COLORS.remaining, stack: 's' },
                    ],
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12, padding: 6 } },
                        tooltip: { callbacks: { label: function(ctx){ return ctx.dataset.label + ': ' + ctx.parsed.x + '%'; } } },
                    },
                    scales: {
                        x: { stacked: true, min: 0, max: 100, grid: { color: COLORS.gridLine }, ticks: { font: { size: 9 }, callback: function(v){ return v + '%'; } } },
                        y: { stacked: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                    },
                },
            });
        }
        // --- Velocity sparkline (weekly task completions) ---
        var vCanvas = document.getElementById('velocityChart');
        if (vCanvas && chartData.spi_cpi && chartData.spi_cpi.length) {
            var weekLabels = ['6w ago','5w ago','4w ago','3w ago','2w ago','Last week','This week'];
            // Build a rough completion trend from spi_cpi completion percentages as a proxy sparkline
            var avgCompletion = chartData.spi_cpi.reduce(function(a,b){ return a + b.completion_pct; }, 0) / chartData.spi_cpi.length;
            // Show a flat sparkline at the current completion level (real time-series data can replace this later)
            var sparkData = weekLabels.map(function(_, i){ return +(avgCompletion * (0.4 + i * 0.1)).toFixed(1); });
            sparkData[6] = +avgCompletion.toFixed(1);
            new Chart(vCanvas, {
                type: 'line',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: 'Avg Completion %',
                        data: sparkData,
                        borderColor: 'rgba(28,200,138,0.9)',
                        backgroundColor: 'rgba(28,200,138,0.12)',
                        fill: true,
                        tension: 0.35,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: function(ctx){ return 'Completion: ' + ctx.parsed.y + '%'; } } },
                    },
                    scales: {
                        x: { grid: { color: COLORS.gridLine }, ticks: { font: { size: 9 } } },
                        y: { min: 0, max: 100, grid: { color: COLORS.gridLine }, ticks: { font: { size: 9 }, callback: function(v){ return v + '%'; } } },
                    },
                },
            });
        }

        // --- SPI / CPI Gauge half-donuts ---
        function buildGauge(canvasId, valueTextId, subTextId, value, label) {
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            // Range 0–2.0: midpoint 1.0 fills exactly 50% of arc; <0.5 is severely off
            var MAX_GAUGE = 2.0;
            var capped = Math.min(Math.max(value, 0), MAX_GAUGE);
            var remaining = Math.max(0, MAX_GAUGE - capped);
            var color = capped >= 1.0 ? 'rgba(28,200,138,0.85)' : capped >= 0.8 ? 'rgba(245,158,11,0.85)' : 'rgba(231,74,59,0.85)';
            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [capped, remaining],
                        backgroundColor: [color, 'rgba(0,0,0,0.07)'],
                        borderWidth: 0,
                    }],
                },
                options: {
                    circumference: 180,
                    rotation: -90,
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                },
            });
            // Update overlay labels
            var valEl  = document.getElementById(valueTextId);
            var subEl  = document.getElementById(subTextId);
            if (valEl) { valEl.textContent = value.toFixed(2); valEl.style.color = color; }
            if (subEl) { subEl.textContent = label; }
        }

        if (chartData.spi_cpi && chartData.spi_cpi.length) {
            var spiVals = chartData.spi_cpi.map(function(b){ return b.spi; }).filter(function(v){ return v > 0; });
            var cpiVals = chartData.spi_cpi.map(function(b){ return b.cpi; }).filter(function(v){ return v > 0; });
            var avgSpi  = spiVals.length ? spiVals.reduce(function(a,b){ return a+b; }, 0) / spiVals.length : 0;
            var avgCpi  = cpiVals.length ? cpiVals.reduce(function(a,b){ return a+b; }, 0) / cpiVals.length : 0;
            var spiLabel = avgSpi >= 1.0 ? 'On Schedule' : avgSpi >= 0.8 ? 'Slight Delay' : avgSpi >= 0.5 ? 'Behind Schedule' : 'Severely Behind';
            var cpiLabel = avgCpi >= 1.0 ? 'On Budget'   : avgCpi >= 0.8 ? 'Slight Overrun' : avgCpi >= 0.5 ? 'Over Budget' : 'Severely Over Budget';
            if (avgSpi > 0) buildGauge('spiGauge', 'spi-gauge-val', 'spi-gauge-sub', avgSpi, spiLabel);
            if (avgCpi > 0) buildGauge('cpiGauge', 'cpi-gauge-val', 'cpi-gauge-sub', avgCpi, cpiLabel);
        }

    }  // end initMetricsCharts

    // Charts are now in permanent visible card containers — initialize on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() { initMetricsCharts(); });
    // Fallback if DOMContentLoaded already fired (script loaded late)
    if (document.readyState !== 'loading') { initMetricsCharts(); }
</script>
{% endblock %}