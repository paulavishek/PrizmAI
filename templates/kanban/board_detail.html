{% extends 'base.html' %}
{% load static %}
{% load kanban_filters %}

{% block title %}{{ board.name }} - PrizmAI{% endblock %}

{% block extra_css %}
<style>
    .kanban-column {
        cursor: grab;
        user-select: none; /* Prevent text selection during drag */
    }
    .kanban-column:active {
        cursor: grabbing;
    }
    .kanban-column.dragging {
        opacity: 0.6;
        z-index: 100;
    }
    .column-drag-placeholder {
        border: 2px dashed #6c757d;
        background-color: rgba(108, 117, 125, 0.1);
        margin: 0 10px;
        border-radius: 5px;
        flex: 0 0 300px;
    }
    .kanban-column-header {
        padding: 10px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #ddd;
        position: relative;
        cursor: grab;
    }
    .kanban-column-header:active {
        cursor: grabbing;
    }
    .column-task-count {
        display: inline;
        margin-left: 5px;
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
    .drag-handle {
        cursor: move;
        margin-right: 5px;
        opacity: 0.5;
    }
    .drag-handle:hover {
        opacity: 1;
    }
    .column-position-input {
        width: 50px;
        text-align: center;
        margin-right: 5px;
    }
    .column-ordering-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .column-ordering-panel:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .column-ordering-panel.collapsed {
        background: #f8f9fa;
    }
    .column-ordering-badge {
        display: inline-flex;
        align-items: center;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px 12px;
        margin-right: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    .column-ordering-badge:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }
    .column-ordering-badge input {
        width: 45px;
        margin-right: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: center;
        font-weight: 600;
    }
    .column-ordering-badge input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
    }
    .column-ordering-badge span {
        font-weight: 500;
        color: #495057;
    }
    kbd {
        background-color: #343a40;
        color: #fff;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.85em;
        font-family: monospace;
    }
    .column-position-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        margin-right: 8px;
    }
    /* Search panel styles */
    .search-panel {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .search-panel .form-group {
        margin-bottom: 10px;
    }
    .active-filters {
        background-color: #e9ecef;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }    .filter-badge {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    /* Quick Add Task Button Styling */
    .quick-add-task-btn {
        transition: all 0.2s ease;
        border-radius: 20px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .quick-add-task-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    .quick-add-task-btn i {
        font-size: 0.9rem;
    }
    
    /* Task highlight for search results */
    .task-highlighted {
        animation: pulse-highlight 1s ease-in-out;
    }
    
    @keyframes pulse-highlight {
        0%, 100% { box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4); }
        50% { box-shadow: 0 8px 24px rgba(13, 110, 253, 0.6); }
    }
    
    /* Live filter - hide non-matching tasks */
    .kanban-task.filtered-out {
        display: none !important;
    }
    
    /* Task Search Bar Styling */
    #taskSearchCard {
        border-left: 4px solid #0d6efd;
    }
    
    #liveSearchInput:focus {
        box-shadow: none;
        border-color: #0d6efd;
    }
    
    #taskSearchCard .btn-check:checked + .btn-outline-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }
    
</style>
{% endblock %}

{% block content %}
<!-- Demo Mode Banner - only show in legacy (non-simplified) mode -->
{% if is_demo_board and not simplified_mode %}
<div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-1"><i class="fas fa-hands-helping me-2"></i>Interactive Demo Mode</h5>
            <p class="mb-0 small">
                <strong>Go ahead - experiment!</strong> Create tasks, add comments, try all features. This is a shared playground for learning.
                <a href="{% url 'demo_dashboard' %}" class="text-white text-decoration-underline"><strong>Back to Demo Dashboard</strong></a> | 
                <a href="{% url 'dashboard' %}" class="text-white text-decoration-underline"><strong>Exit to My Dashboard</strong></a>
            </p>
        </div>
        <div>
            <span class="badge bg-light text-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                <i class="fas fa-graduation-cap me-1"></i>DEMO
            </span>
        </div>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">
            {{ board.name }}
            <span class="badge bg-info ms-2" title="Your role on this board">
                <i class="fas fa-user-shield"></i> {{ user_role_name }}
            </span>
        </h1>
        {% if board.description %}
            <p class="text-muted mb-0">{{ board.description }}</p>
        {% endif %}
    </div>    <div class="btn-group">
        <a href="{% if is_demo_board and not simplified_mode %}{% url 'demo_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
        <a href="{% url 'board_analytics' board.id %}" class="btn btn-outline-primary">
            <i class="fas fa-chart-pie me-1"></i> Analytics
        </a>
        <a href="{% url 'burndown_dashboard' board.id %}" class="btn btn-outline-success">
            <i class="fas fa-chart-line me-1"></i> Burndown
        </a>
        <a href="{% url 'coach_dashboard' board.id %}" class="btn btn-outline-purple" style="border-color: #667eea; color: #667eea;">
            <i class="fas fa-user-graduate me-1"></i> AI Coach
        </a>
        <a href="{% url 'skill_gap_dashboard' board.id %}" class="btn btn-outline-warning">
            <i class="fas fa-brain me-1"></i> Skill Gaps
        </a>
        <a href="{% url 'gantt_chart' board.id %}" class="btn btn-outline-info">
            <i class="fas fa-chart-gantt me-1"></i> Gantt Chart
        </a>
        <a href="{% url 'budget_dashboard' board.id %}" class="btn btn-outline-success">
            <i class="fas fa-dollar-sign me-1"></i> Budget & ROI
        </a>
        <a href="{% url 'retrospective_dashboard' board.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-history me-1"></i> Retrospectives
        </a>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-file-export me-1"></i> Export
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'export_board' board.id %}?format=json">Export as JSON</a></li>
                <li><a class="dropdown-item" href="{% url 'export_board' board.id %}?format=csv">Export as CSV</a></li>
            </ul>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'create_column' board.id %}">Add Column</a></li>
            <li><a class="dropdown-item" href="{% url 'create_label' board.id %}">Manage Labels</a></li>
            <li><a class="dropdown-item" href="{% url 'stakeholder:stakeholder_list' board.id %}">
                <i class="fas fa-users me-2 text-primary"></i>Manage Stakeholders
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'manage_board_members' board.id %}">
                <i class="fas fa-user-shield me-2 text-success"></i>Manage Members & Roles
            </a></li>
            <li><a class="dropdown-item" href="{% url 'view_permission_audit' board.id %}">
                <i class="fas fa-history me-2 text-info"></i>Permission Audit Log
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'edit_board' board.id %}">Edit Board</a></li>
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#boardSettingsModal">Board Settings</a></li>
            <li><a class="dropdown-item" href="{% url 'webhooks:webhook_list' board.id %}">
                <i class="fas fa-plug me-2 text-info"></i>Webhooks & Integrations
            </a></li>
            <li><hr class="dropdown-divider"></li>
            {% if board.created_by == request.user or request.user.profile.is_admin or request.user == board.organization.created_by %}
            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteBoardModal">Delete Board</a></li>
            {% endif %}
        </ul>
        </div>
    </div>
</div>

<!-- Permission banner removed - no restrictions in simplified mode -->

<!-- Scope Creep Alerts -->
{% if active_scope_alerts %}
<div class="alert alert-dismissible fade show mb-4" role="alert" 
     style="border-left: 4px solid 
     {% if active_scope_alerts.0.severity == 'critical' %}#dc3545{% elif active_scope_alerts.0.severity == 'warning' %}#ffc107{% else %}#17a2b8{% endif %};">
    <div class="d-flex align-items-start">
        <div class="me-3">
            {% if active_scope_alerts.0.severity == 'critical' %}
                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
            {% elif active_scope_alerts.0.severity == 'warning' %}
                <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
            {% else %}
                <i class="fas fa-info-circle fa-2x text-info"></i>
            {% endif %}
        </div>
        <div class="flex-grow-1">
            <h5 class="alert-heading mb-2">
                <i class="fas fa-chart-line me-2"></i>Scope Creep Detected
            </h5>
            <p class="mb-2">
                <strong>{{ active_scope_alerts.0.get_severity_display }}</strong>: 
                Scope has increased by <strong>{{ active_scope_alerts.0.scope_increase_percentage|floatformat:1 }}%</strong>
                {% if active_scope_alerts.0.tasks_added %}
                    ({{ active_scope_alerts.0.tasks_added }} tasks added)
                {% endif %}
            </p>
            {% if active_scope_alerts.0.predicted_delay_days %}
            <p class="mb-2">
                <i class="fas fa-clock me-2"></i>
                <strong>Predicted Impact:</strong> {{ active_scope_alerts.0.predicted_delay_days }} day{{ active_scope_alerts.0.predicted_delay_days|pluralize }} delay
            </p>
            {% endif %}
            {% if active_scope_alerts.0.ai_summary %}
            <p class="mb-2 text-muted small">{{ active_scope_alerts.0.ai_summary }}</p>
            {% endif %}
            {% if active_scope_alerts.0.recommendations %}
            <div class="mt-2">
                <strong>Recommendations:</strong>
                <ul class="mb-2 small">
                    {% for rec in active_scope_alerts.0.recommendations|slice:":3" %}
                    <li>{{ rec }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            <div class="mt-2">
                <a href="{% url 'scope_tracking_dashboard' board.id %}" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-chart-line me-1"></i>View Scope Dashboard
                </a>
                {% if active_scope_alerts|length > 1 %}
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#allScopeAlertsModal">
                    <i class="fas fa-list me-1"></i>View All Alerts ({{ active_scope_alerts|length }})
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<!-- Scope Status Widget (if baseline set) -->
{% if scope_status %}
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <i class="fas fa-chart-area fa-3x 
                   {% if scope_status.scope_change_percentage > 30 %}text-danger
                   {% elif scope_status.scope_change_percentage > 15 %}text-warning
                   {% elif scope_status.scope_change_percentage > 5 %}text-info
                   {% else %}text-success{% endif %}"></i>
            </div>
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-muted mb-1">Baseline</h6>
                        <h4 class="mb-0">{{ scope_status.baseline_tasks }} tasks</h4>
                        <small class="text-muted">{{ scope_status.baseline_complexity }} pts</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-1">Current</h6>
                        <h4 class="mb-0">{{ scope_status.current_tasks }} tasks</h4>
                        <small class="text-muted">{{ scope_status.current_complexity }} pts</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-1">Scope Change</h6>
                        <h4 class="mb-0 
                           {% if scope_status.scope_change_percentage > 30 %}text-danger
                           {% elif scope_status.scope_change_percentage > 15 %}text-warning
                           {% elif scope_status.scope_change_percentage > 5 %}text-info
                           {% else %}text-success{% endif %}">
                            {% if scope_status.scope_change_percentage > 0 %}+{% endif %}{{ scope_status.scope_change_percentage|floatformat:1 }}%
                        </h4>
                        <small class="text-muted">
                            {% if scope_status.tasks_added > 0 %}+{% endif %}{{ scope_status.tasks_added }} tasks
                        </small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-1">Since Baseline</h6>
                        <p class="mb-0 small">{{ scope_status.baseline_date|date:"M d, Y" }}</p>
                        <small class="text-muted">{{ scope_status.baseline_date|timesince }} ago</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- AI Resource Leveling Widget -->
{% include 'kanban/resource_leveling_widget.html' %}

<!-- Advanced Features Notification -->
<!-- Removed: Meeting Transcript Analysis has been consolidated to the dedicated Meeting Hub accessible from the main navigation -->

<!-- Search Panel -->
<div class="search-panel">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Search Tasks</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-search-panel">
            <i class="fas fa-chevron-up" id="toggle-search-icon"></i>
        </button>
    </div>
    
    <div id="search-form-container">
        <form method="get" class="row">            <div class="col-md-4 form-group">
                <label for="{{ search_form.search_term.id_for_label }}" class="form-label">Search Term</label>
                {{ search_form.search_term }}
            </div>
            <div class="col-md-2 form-group">
                <label for="{{ search_form.column.id_for_label }}" class="form-label">Column</label>
                {{ search_form.column }}
            </div>
            <div class="col-md-2 form-group">
                <label for="{{ search_form.priority.id_for_label }}" class="form-label">Priority</label>
                {{ search_form.priority }}
            </div>
            <div class="col-md-2 form-group">
                <label for="{{ search_form.label.id_for_label }}" class="form-label">Label</label>
                {{ search_form.label }}
            </div>            <div class="col-md-2 form-group">
                <label for="{{ search_form.label_category.id_for_label }}" class="form-label">
                    Label Type
                    <button type="button" class="btn btn-sm p-0" data-bs-toggle="modal" data-bs-target="#leanLabelsInfoModal">
                        <i class="fas fa-info-circle text-primary" title="Learn about Lean Six Sigma categories"></i>
                    </button>
                </label>
                {{ search_form.label_category }}
            </div>
            <div class="col-md-2 form-group mt-2">
                <label for="{{ search_form.assignee.id_for_label }}" class="form-label">Assignee</label>
                {{ search_form.assignee }}
            </div>
            <div class="col-12 mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-1"></i> Search
                </button>
                {% if any_filter_active %}
                <a href="{% url 'board_detail' board.id %}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-times me-1"></i> Clear Filters
                </a>
                {% endif %}
            </div>
        </form>
        
        {% if any_filter_active %}
        <div class="active-filters mt-3">
            <small class="text-muted mb-2 d-block">Active filters:</small>
            {% if search_form.cleaned_data.search_term %}
            <span class="filter-badge">
                <i class="fas fa-search me-1"></i> "{{ search_form.cleaned_data.search_term }}"
            </span>
            {% endif %}
            
            {% if search_form.cleaned_data.column %}
            <span class="filter-badge">
                <i class="fas fa-columns me-1"></i> Column: {{ search_form.cleaned_data.column.name }}
            </span>
            {% endif %}
            
            {% if search_form.cleaned_data.priority %}
            <span class="filter-badge">
                <i class="fas fa-flag me-1"></i> Priority: {{ search_form.cleaned_data.priority|title }}
            </span>
            {% endif %}
            
            {% if search_form.cleaned_data.label %}
            <span class="filter-badge" style="background-color: '{{ search_form.cleaned_data.label.color }}'">
                <i class="fas fa-tag me-1"></i> Label: {{ search_form.cleaned_data.label.name }}
            </span>
            {% endif %}
            
            {% if search_form.cleaned_data.assignee %}
            <span class="filter-badge">
                <i class="fas fa-user me-1"></i> Assignee: {{ search_form.cleaned_data.assignee.username }}
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Column Ordering Panel -->
<div class="column-ordering-panel" id="column-ordering-panel">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h5 class="mb-0">
                <i class="fas fa-sort me-2 text-primary"></i>Quick Column Reorder
                <small class="text-muted" style="font-size: 0.7em; font-weight: normal;">(for large boards)</small>
            </h5>
        </div>
        <div>
            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="toggle-column-panel">
                <i class="fas fa-chevron-up" id="toggle-column-icon"></i>
            </button>
        </div>
    </div>
    
    <div id="column-ordering-content">
        <div class="alert alert-info alert-dismissible fade show py-2 mb-3" role="alert" style="font-size: 0.9rem;">
            <i class="fas fa-lightbulb me-1"></i>
            <strong>Tip:</strong> You can drag column headers to reorder them, or use position numbers below for precise control across many columns.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="padding: 0.5rem;"></button>
        </div>
        
        <p class="text-muted small mb-2">
            <i class="fas fa-keyboard me-1"></i> <strong>Keyboard shortcut:</strong> Press <kbd>Alt</kbd> + <kbd>R</kbd> to quickly access this panel
        </p>
        
        <div id="column-ordering-badges" class="mb-3">
            {% for column in columns %}
            <div class="column-ordering-badge">
                <input type="number" min="1" max="{{ columns|length }}" value="{{ column.position|add:1 }}" 
                       class="form-control form-control-sm column-position-input" 
                       data-column-id="{{ column.id }}"
                       title="Position for {{ column.name }}">
                <span>{{ column.name }}</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="d-flex gap-2">
            <button id="refresh-columns-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt me-1"></i> Apply Reorder
            </button>
            <button id="reset-columns-btn" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-undo me-1"></i> Reset to Default
            </button>
        </div>
    </div>
</div>

<!-- Kanban Board -->
<div class="kanban-board" id="kanban-board">
    {% for column in columns %}
    <div class="kanban-column" id="column-{{ column.id }}" data-column-id="{{ column.id }}" draggable="true">
        <div class="kanban-column-header">            <div class="d-flex justify-content-between align-items-center w-100">
                <div class="d-flex align-items-center">
                    <span class="column-position-badge">{{ column.position|add:1 }}</span>
                    <span class="column-name-text">{{ column.name }}</span>
                    <span class="ms-2" style="font-size: 0.8rem; color: #6c757d; white-space: nowrap;">
                        <span style="font-weight: 500;">Tasks:</span> <span class="column-task-count"></span>
                    </span>
                </div>
                <div>
                    {% if column.id in column_permissions %}
                        {% if not column_permissions|get_item:column.id|get_item:'can_move_to' %}
                        <span class="badge bg-warning ms-2" title="You cannot move tasks into this column">
                            <i class="fas fa-lock"></i> Restricted
                        </span>
                        {% endif %}
                    {% endif %}
                </div>                <div class="column-actions">
                    {% if column.name|lower == 'to do' or column.name|lower == 'todo' %}
                        <!-- Edit button for To Do column -->
                        <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-column-btn" 
                                data-column-id="{{ column.id }}" data-column-name="{{ column.name }}"
                                data-bs-toggle="modal" data-bs-target="#editColumnModal"
                                title="Rename Column">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Lock icon for To Do column (cannot be deleted) -->
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                disabled title="The 'To Do' column cannot be deleted as it's required for creating new tasks">
                            <i class="fas fa-lock"></i>
                        </button>
                    {% else %}
                        <!-- Edit button for other columns -->
                        <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-column-btn" 
                                data-column-id="{{ column.id }}" data-column-name="{{ column.name }}"
                                data-bs-toggle="modal" data-bs-target="#editColumnModal"
                                title="Rename Column">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Delete button for other columns -->
                        <button type="button" class="btn btn-sm btn-outline-danger delete-column-btn" 
                                data-column-id="{{ column.id }}" data-column-name="{{ column.name }}"
                                data-bs-toggle="modal" data-bs-target="#deleteColumnModal"
                                title="Delete Column">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>        <div class="kanban-column-tasks" data-column-id="{{ column.id }}">
            {% for task in tasks %}
                {% if task.column.id == column.id %}
                <div class="kanban-task" id="task-{{ task.id }}">
                    <div class="task-title">{{ task.title }}</div>
                    
                    {% if task.description %}
                    <div class="task-description">{{ task.description|truncatechars:100 }}</div>
                    {% endif %}
                    
                    <!-- Task Progress Bar -->
                    <div class="task-progress-container mt-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-secondary progress-btn decrease-progress" 
                                    data-task-id="{{ task.id }}" title="Decrease progress by 10%">
                                <i class="fas fa-minus"></i>
                            </button>
                            
                            <div class="progress flex-grow-1 mx-1" style="height: 12px;">
                                <div class="progress-bar {% if task.progress == 100 %}bg-success{% elif task.progress < 30 %}bg-danger{% elif task.progress < 70 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ task.progress }}%;"
                                     data-progress="{{ task.progress }}"
                                     aria-valuenow="{{ task.progress }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-sm btn-outline-secondary progress-btn increase-progress" 
                                    data-task-id="{{ task.id }}" title="Increase progress by 10%">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">{{ task.progress }}% complete</small>
                        </div>
                    </div>
                      {% if task.labels.all %}
                    <div class="task-labels">
                        {% for label in task.labels.all %}
                            {% if label.category == 'lean' %}
                                <span class="task-label lean-label" data-color="{{ label.color|default:'#6c757d' }}" 
                                      title="Lean Six Sigma: {{ label.name }}">
                                    <i class="fas fa-chart-line"></i> {{ label.name }}
                                </span>
                            {% else %}
                                <span class="task-label" data-color="{{ label.color|default:'#6c757d' }}">{{ label.name }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- AI Risk Badge -->
                    {% if task.risk_level %}
                    <div class="mt-2">
                        <span class="badge {% if task.risk_level == 'critical' %}bg-danger{% elif task.risk_level == 'high' %}bg-warning text-dark{% elif task.risk_level == 'medium' %}bg-info{% else %}bg-success{% endif %}" 
                              style="cursor: pointer;" 
                              onclick="quickRiskView({{ task.id }}, '{{ task.title|escapejs }}')"
                              title="Click to see why - AI Risk Assessment">
                            🛡️ Risk: {{ task.risk_level|title }} ({{ task.risk_score }}/9)
                            <i class="bi bi-lightbulb ms-1" style="font-size: 0.8em;"></i>
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="task-footer">
                        <div>
                            <span class="task-priority priority-{{ task.priority }}">{{ task.priority|title }}</span>
                        </div>
                        <div>
                            {% if task.due_date %}
                            <span class="task-due-date {% if task.due_date < now and task.progress < 100 %}overdue{% endif %}">
                                <i class="far fa-calendar-alt me-1"></i> {{ task.due_date|date:"M d" }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if task.assigned_to %}
                    <div class="task-assignee mt-2">
                        {% if task.assigned_to.profile.profile_picture %}
                        <img src="{{ task.assigned_to.profile.profile_picture.url }}" alt="{{ task.assigned_to.username }}" class="task-assignee-avatar">
                        {% else %}
                        <span class="task-assignee-avatar bg-secondary text-white d-flex align-items-center justify-content-center">
                            {{ task.assigned_to.username|slice:":1" }}
                        </span>
                        {% endif %}
                        <small>{{ task.assigned_to.username }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="mt-2 text-end">
                        <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-task-btn" 
                                data-task-id="{{ task.id }}" data-task-title="{{ task.title }}"
                                data-bs-toggle="modal" data-bs-target="#deleteTaskModal">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if column.name|lower == 'to do' or column.name|lower == 'todo' %}
        <div class="p-2">
            <a href="{% url 'create_task_in_column' board.id column.id %}" class="btn btn-sm btn-primary add-task-btn">
                <i class="fas fa-plus me-1"></i> Add Task
            </a>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Add Column Button -->
    <div class="add-column-btn" style="flex: 0 0 auto; min-width: 100px; background: transparent; box-shadow: none;">
        <a href="{% url 'create_column' board.id %}" class="btn btn-outline-secondary h-100 d-flex align-items-center justify-content-center">
            <i class="fas fa-plus me-2"></i> Add Column
        </a>
    </div>
</div>

<!-- Wiki Links Section -->
<div class="card shadow mt-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-book me-2"></i> Linked Wiki Pages</h6>
        <a href="{% url 'wiki:quick_link' content_type='board' object_id=board.id %}" class="btn btn-sm btn-outline-primary" title="Link wiki pages to this board">
            <i class="fas fa-link"></i> Link Wiki
        </a>
    </div>
    <div class="card-body">
        {% if wiki_links %}
            <div class="list-group list-group-flush">
                {% for link in wiki_links %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="fas fa-book"></i> {{ link.wiki_page.title }}
                            </h6>
                            {% if link.description %}
                                <p class="mb-1 text-muted small">{{ link.description }}</p>
                            {% endif %}
                            <small class="text-muted">
                                Category: <strong>{{ link.wiki_page.category.name }}</strong> • 
                                Last updated: {{ link.wiki_page.updated_at|date:"M d, Y" }}
                            </small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <a href="{% url 'wiki:page_detail' link.wiki_page.slug %}" class="btn btn-sm btn-info" title="View wiki page">
                                <i class="fas fa-eye"></i> View Page
                            </a>
                            <form method="post" action="{% url 'wiki:delete_link' link.id %}" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this wiki link?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove link">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-book-open fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">No wiki pages linked to this board</p>
                <small class="text-muted">Click "Link Wiki" above to add relevant documentation</small>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Column Modal -->
<div class="modal fade" id="deleteColumnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Column</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the column "<span id="deleteColumnName"></span>"?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will also delete all tasks in this column!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteColumnForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Column</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the task "<span id="deleteTaskTitle"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteTaskForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Column Modal -->
<div class="modal fade" id="editColumnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Column</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editColumnForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editColumnName" class="form-label">Column Name</label>
                        <input type="text" class="form-control" id="editColumnName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Board Modal -->
<div class="modal fade" id="deleteBoardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Board</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the board <strong>{{ board.name }}</strong>?</p>
                <p class="text-danger">This action cannot be undone and all tasks associated with this board will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_board' board.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Board</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Board Settings Modal -->
<div class="modal fade" id="boardSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Board Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Board Members</h6>
                <ul class="list-group mb-3">
                    {% for member in board.members.all %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            {{ member.username }}
                            {% if member == board.created_by %}
                            <span class="badge bg-primary rounded-pill">Owner</span>
                            {% endif %}
                        </div>
                        {% if request.user == board.created_by or request.user.profile.is_admin or request.user == board.organization.created_by %}
                            {% if member != board.created_by %}
                            <a href="{% url 'remove_board_member' board.id member.id %}" class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Are you sure you want to remove {{ member.username }} from the board?')">
                                <i class="fas fa-trash me-1"></i> Remove
                            </a>
                            {% endif %}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                
                <form method="post" action="{% url 'add_board_member' board.id %}">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <select class="form-select" name="user_id">
                            <option selected disabled>Add a member...</option>
                            {% for user_profile in available_org_members %}
                                <option value="{{ user_profile.user.id }}">{{ user_profile.user.username }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-primary" type="submit">Add</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Lean Six Sigma Labels Info Modal -->
<div class="modal fade" id="leanLabelsInfoModal" tabindex="-1" aria-labelledby="leanLabelsInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leanLabelsInfoModalLabel">Understanding Lean Six Sigma Categories</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Pri<span class="stylish-z">z</span>mAI's Lean Six Sigma categories help you analyze tasks based on how they contribute value:</p>
                
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        Value-Added (VA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that transform inputs into outputs that customers value and are willing to pay for.</p>
                        <p class="card-text small">Example: Developing a feature that customers requested</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        Necessary Non-Value-Added (NNVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities required by current regulations, processes, or constraints, but don't directly add value for the customer.</p>
                        <p class="card-text small">Example: Compliance documentation, quality checks</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        Waste/Eliminate (NVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that consume resources without adding any value. These should be minimized or eliminated.</p>
                        <p class="card-text small">Example: Fixing defects, unnecessary meetings, waiting for approvals</p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-filter me-2"></i> 
                    <strong>Tip:</strong> Use the "Label Type" filter to focus on specific categories of tasks to help prioritize value-adding work and identify improvement opportunities.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- All Scope Alerts Modal -->
<div class="modal fade" id="allScopeAlertsModal" tabindex="-1" aria-labelledby="allScopeAlertsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allScopeAlertsModalLabel">
                    <i class="fas fa-chart-line me-2"></i>All Scope Creep Alerts
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for alert in active_scope_alerts %}
                <div class="card mb-3 border-start border-4 
                     {% if alert.severity == 'critical' %}border-danger
                     {% elif alert.severity == 'warning' %}border-warning
                     {% else %}border-info{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">
                                    {% if alert.severity == 'critical' %}
                                        <span class="badge bg-danger">Critical</span>
                                    {% elif alert.severity == 'warning' %}
                                        <span class="badge bg-warning text-dark">Warning</span>
                                    {% else %}
                                        <span class="badge bg-info">Info</span>
                                    {% endif %}
                                    Detected {{ alert.detected_at|timesince }} ago
                                </h6>
                            </div>
                            <span class="badge bg-{{ alert.status }} small">{{ alert.get_status_display }}</span>
                        </div>
                        
                        <div class="mt-3">
                            <p class="mb-2">
                                <strong>Scope Increase:</strong> {{ alert.scope_increase_percentage|floatformat:1 }}%
                                ({{ alert.tasks_added }} tasks added)
                            </p>
                            {% if alert.predicted_delay_days %}
                            <p class="mb-2">
                                <strong>Predicted Delay:</strong> {{ alert.predicted_delay_days }} day{{ alert.predicted_delay_days|pluralize }}
                            </p>
                            {% endif %}
                            {% if alert.ai_summary %}
                            <p class="text-muted small">{{ alert.ai_summary }}</p>
                            {% endif %}
                        </div>
                        
                        {% if alert.recommendations %}
                        <div class="mt-2">
                            <strong class="small">AI Recommendations:</strong>
                            <ul class="small mb-0">
                                {% for rec in alert.recommendations|slice:":3" %}
                                <li>{{ rec }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="modal-footer">
                <a href="{% url 'scope_tracking_dashboard' board.id %}" class="btn btn-primary">
                    View Full Dashboard
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'js/kanban.js' %}?v={{ board.id }}_{% now 'U' %}" id="kanban-script"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Apply label colors
        document.querySelectorAll('.task-label').forEach(label => {
            label.style.backgroundColor = label.dataset.color;
        });

        // Set progress bar widths after DOM is loaded
        document.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
            const progressValue = el.dataset.progress;
            el.style.width = progressValue + '%';
            el.setAttribute('aria-valuenow', progressValue);
            // Force a repaint to ensure the width is applied
            el.offsetHeight;
        });
        
        // Set up search panel toggle
        const toggleSearchBtn = document.getElementById('toggle-search-panel');
        const searchFormContainer = document.getElementById('search-form-container');
        const toggleSearchIcon = document.getElementById('toggle-search-icon');
        
        if (toggleSearchBtn && searchFormContainer) {
            console.log('Search panel toggle initialized successfully');
            toggleSearchBtn.addEventListener('click', function(e) {
                console.log('Toggle button clicked');
                e.preventDefault();
                e.stopPropagation();
                
                searchFormContainer.classList.toggle('d-none');
                
                // Update icon
                if (searchFormContainer.classList.contains('d-none')) {
                    toggleSearchIcon.classList.remove('fa-chevron-up');
                    toggleSearchIcon.classList.add('fa-chevron-down');
                } else {
                    toggleSearchIcon.classList.remove('fa-chevron-down');
                    toggleSearchIcon.classList.add('fa-chevron-up');
                }
            });
        } else {
            console.error('Search panel toggle elements not found:', {
                toggleSearchBtn: !!toggleSearchBtn,
                searchFormContainer: !!searchFormContainer,
                toggleSearchIcon: !!toggleSearchIcon
            });
        }
        
        // Set up column delete functionality
        const deleteColumnBtns = document.querySelectorAll('.delete-column-btn');
        deleteColumnBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const columnId = this.dataset.columnId;
                const columnName = this.dataset.columnName;
                const deleteForm = document.getElementById('deleteColumnForm');
                const deleteColumnNameSpan = document.getElementById('deleteColumnName');
                
                deleteForm.action = `/columns/${columnId}/delete/`;
                deleteColumnNameSpan.textContent = columnName;
            });
        });
        
        // Set up column edit functionality
        const editColumnBtns = document.querySelectorAll('.edit-column-btn');
        editColumnBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const columnId = this.dataset.columnId;
                const columnName = this.dataset.columnName;
                const editForm = document.getElementById('editColumnForm');
                const editColumnNameInput = document.getElementById('editColumnName');
                
                editForm.action = `/columns/${columnId}/update/`;
                editColumnNameInput.value = columnName;
            });
        });
          // Set up task delete functionality
        const deleteTaskBtns = document.querySelectorAll('.delete-task-btn');
        deleteTaskBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const taskId = this.dataset.taskId;
                const taskTitle = this.dataset.taskTitle;
                const deleteForm = document.getElementById('deleteTaskForm');
                const deleteTaskTitleSpan = document.getElementById('deleteTaskTitle');
                
                deleteForm.action = `/tasks/${taskId}/delete/`;
                deleteTaskTitleSpan.textContent = taskTitle;
            });
        });
          // Handle task deletion completion
        const deleteTaskForm = document.getElementById('deleteTaskForm');
        if (deleteTaskForm) {
            deleteTaskForm.addEventListener('submit', function() {
                // Update column scrolling after task deletion (page will refresh)
                // No need to dispatch event as page will reload
                setTimeout(() => {
                    if (typeof updateColumnScrolling === 'function') {
                        updateColumnScrolling();
                    }
                }, 100); // Shorter delay since page will refresh
            });
        }    });
    
    // Make updateColumnScrolling globally accessible
    window.updateColumnScrolling = function() {
        // Call the actual function from kanban.js if it exists
        if (typeof window.kanbanUpdateColumnScrolling === 'function') {
            window.kanbanUpdateColumnScrolling();
        }
    };
    
    // Quick risk view function for task cards
    window.quickRiskView = function(taskId, taskTitle) {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Quick Risk View</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6><strong>${taskTitle}</strong></h6>
                        <p class="text-muted mt-3">Click below to see the full AI risk analysis with detailed explanations:</p>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check2 text-success me-2"></i>Contributing factors breakdown</li>
                            <li><i class="bi bi-check2 text-success me-2"></i>AI confidence scores</li>
                            <li><i class="bi bi-check2 text-success me-2"></i>Impact analysis</li>
                            <li><i class="bi bi-check2 text-success me-2"></i>Model assumptions & limitations</li>
                        </ul>
                        <div class="alert alert-info mb-0">
                            <small><i class="bi bi-lightbulb me-2"></i><strong>Explainable AI:</strong> See exactly why this risk score was assigned.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <a href="/tasks/${taskId}/" class="btn btn-primary">
                            <i class="bi bi-eye me-2"></i>View Full Analysis
                        </a>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    };
    
    </script>

<script src="{% static 'js/command_palette.js' %}?v={{ STATIC_VERSION|default:'9' }}"></script>
{% endblock %}

{% endblock content %}