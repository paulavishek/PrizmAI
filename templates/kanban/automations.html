{% extends 'base.html' %}
{% load static %}

{% block title %}{{ board.name }} — Automations{% endblock %}

{% block extra_css %}
<style>
  .rule-card          { border-radius:10px; border:1px solid #dee2e6; padding:18px 20px;
                        background:#fff; transition:box-shadow .2s; }
  .rule-card:hover    { box-shadow:0 4px 16px rgba(0,0,0,.08); }
  .rule-card.inactive { opacity:.55; }
  .trigger-badge { background:#e0f0ff; color:#0d6efd; font-size:.78rem;
                   padding:3px 10px; border-radius:20px; white-space:nowrap; }
  .action-badge  { background:#e8f8e8; color:#198754; font-size:.78rem;
                   padding:3px 10px; border-radius:20px; white-space:nowrap; }
  .arrow-icon    { font-size:1.1rem; color:#adb5bd; }
  .create-card {
    background:linear-gradient(135deg,#f8f9fa,#fff);
    border-radius:12px; border:2px dashed #dee2e6; padding:26px;
  }
  .info-section {
    background:#fffbeb; border:1px solid #fde68a; border-radius:8px;
    padding:14px; margin-bottom:22px;
  }
  .tpl-card {
    border-radius:10px; border:1px solid #e9ecef; padding:14px 16px;
    background:#fff; transition:border-color .2s, box-shadow .2s;
  }
  .tpl-card:hover { border-color:#0d6efd33; box-shadow:0 2px 10px rgba(13,110,253,.07); }
  .tpl-card.activated { opacity:.6; }
  /* Scheduled Automations */
  .sched-badge   { background:#f0e8ff; color:#7c3aed; font-size:.78rem;
                   padding:3px 10px; border-radius:20px; white-space:nowrap; }
  .sched-info-section {
    background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px;
    padding:12px; margin-bottom:16px;
  }
  .sched-preview {
    background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px;
    padding:10px 14px; font-weight:600; color:#495057;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">

  <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-2">
    <div>
      <h1 class="h3 mb-0">
        <i class="fas fa-bolt me-2 text-warning"></i>Automations
      </h1>
      <p class="text-muted mb-0">{{ board.name }} — trigger-based rules that run automatically</p>
    </div>
    <a href="{% url 'board_detail' board.id %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-columns me-1"></i> Back to Board
    </a>
  </div>

  <div class="info-section">
    <strong><i class="fas fa-info-circle me-2 text-warning"></i>How Automations Work</strong>
    <p class="mb-0 small mt-1">
      Each rule has a <strong>trigger</strong> (something that happens) and an <strong>action</strong>
      (what PrizmAI does automatically).<br>
      Example: <em>"When a task is completed → notify the creator"</em> or
      <em>"When due date is 2 days away → notify the assignee"</em>.
    </p>
  </div>

  <div class="row g-4">

    <!-- LEFT: Templates + Rules -->
    <div class="col-lg-7">

      {% if templates %}
      <div class="mb-4">
        <h6 class="text-uppercase text-muted fw-semibold mb-3" style="letter-spacing:.06em;font-size:.78rem;">
          <i class="fas fa-magic me-1"></i> Quick-start templates — activate with one click
        </h6>
        <div class="row g-2">
          {% for tpl in templates %}
          <div class="col-md-4">
            <div class="tpl-card h-100 {% if tpl.already_active %}activated{% endif %}">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="text-{{ tpl.color }}"><i class="fas {{ tpl.icon }}"></i></span>
                <strong class="small">{{ tpl.name }}</strong>
              </div>
              <p class="text-muted mb-2" style="font-size:.78rem;line-height:1.4;">{{ tpl.description }}</p>
              {% if tpl.already_active %}
                <span class="badge bg-success-subtle text-success border border-success-subtle">
                  <i class="fas fa-check me-1"></i>Active
                </span>
              {% else %}
                <form method="post" action="{% url 'automation_activate_template' board.id tpl.id %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-primary w-100">
                    <i class="fas fa-bolt me-1"></i>Activate
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <h5 class="mb-3">
        <i class="fas fa-list me-2 text-secondary"></i>Rules ({{ automations.count }})
      </h5>

      {% if not automations %}
      <div class="text-center text-muted py-5 border rounded bg-white">
        <i class="fas fa-bolt fa-3x mb-3 text-light"></i>
        <p class="mb-1">No automation rules yet.</p>
        <p class="small">Activate a template above or build a custom rule on the right &rarr;</p>
      </div>
      {% endif %}

      {% for rule in automations %}
      <div class="rule-card mb-3 {% if not rule.is_active %}inactive{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center gap-2 mb-2">
              <strong>{{ rule.name }}</strong>
              {% if rule.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Paused</span>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="trigger-badge">
                <i class="fas fa-play-circle me-1"></i>
                {% if rule.trigger_type == 'task_overdue' %}Task becomes overdue
                {% elif rule.trigger_type == 'moved_to_column' %}Moved to column "{{ rule.trigger_value }}"
                {% elif rule.trigger_type == 'task_created' %}Task is created
                {% elif rule.trigger_type == 'task_completed' %}Task is completed (100%)
                {% elif rule.trigger_type == 'priority_changed' %}Priority changes to "{{ rule.trigger_value|title }}"
                {% elif rule.trigger_type == 'task_assigned' %}Task is assigned
                {% elif rule.trigger_type == 'due_date_approaching' %}Due date &le; {{ rule.trigger_value }} day{{ rule.trigger_value|pluralize }} away
                {% else %}{{ rule.get_trigger_type_display }}{% endif %}
              </span>
              <span class="arrow-icon">&rarr;</span>
              <span class="action-badge">
                <i class="fas fa-cogs me-1"></i>
                {% if rule.action_type == 'set_priority' %}Set priority &rarr; {{ rule.action_value|title }}
                {% elif rule.action_type == 'add_label' %}Add label "{{ rule.action_value }}"
                {% elif rule.action_type == 'send_notification' %}Notify {{ rule.action_value }}
                {% elif rule.action_type == 'move_to_column' %}Move to column "{{ rule.action_value }}"
                {% elif rule.action_type == 'assign_to_user' %}Assign to @{{ rule.action_value }}
                {% elif rule.action_type == 'set_due_date' %}Set due date &rarr; now + {{ rule.action_value }} day{{ rule.action_value|pluralize }}
                {% else %}{{ rule.get_action_type_display }}{% endif %}
              </span>
            </div>
            <div class="text-muted small mt-2">
              Fired {{ rule.run_count }} time{{ rule.run_count|pluralize }}
              {% if rule.last_run_at %}&middot; last run {{ rule.last_run_at|date:"M d, Y H:i" }}{% endif %}
              &middot; Created by {{ rule.created_by.username|default:"&mdash;" }}
            </div>
          </div>
          <div class="d-flex gap-2 ms-3 flex-shrink-0">
            <form method="post" action="{% url 'automation_toggle' board.id rule.id %}">
              {% csrf_token %}
              <button class="btn btn-sm {% if rule.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                      title="{% if rule.is_active %}Pause{% else %}Enable{% endif %}">
                <i class="fas {% if rule.is_active %}fa-pause{% else %}fa-play{% endif %}"></i>
              </button>
            </form>
            <form method="post" action="{% url 'automation_delete' board.id rule.id %}"
                  onsubmit="return confirm('Delete automation \'{{ rule.name|escapejs }}\'?');">
              {% csrf_token %}
              <button class="btn btn-sm btn-outline-danger" title="Delete">
                <i class="fas fa-trash-alt"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}

      <!-- ============================================================= -->
      <!-- SCHEDULED AUTOMATIONS LIST                                      -->
      <!-- ============================================================= -->
      <div class="mt-5">
        <h5 class="mb-3">
          <i class="fas fa-clock me-2 text-purple" style="color:#7c3aed;"></i>Scheduled Rules ({{ scheduled_automations.count }})
        </h5>

        <div class="sched-info-section">
          <i class="fas fa-info-circle me-1 text-primary"></i>
          <span class="small">
            Scheduled rules fire on a recurring clock-based schedule (daily, weekly, monthly)
            and are <strong>not</strong> triggered by task events.
            <br>
            <strong>Note:</strong> Scheduled automations require the Celery Beat worker to be running.
          </span>
        </div>

        {% if not scheduled_automations %}
        <div class="text-center text-muted py-4 border rounded bg-white">
          <i class="fas fa-clock fa-2x mb-2 text-light"></i>
          <p class="mb-0 small">No scheduled rules yet. Create one using the form on the right &rarr;</p>
        </div>
        {% endif %}

        {% for sa in scheduled_automations %}
        <div class="rule-card mb-3 {% if not sa.is_active %}inactive{% endif %}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <strong>{{ sa.name }}</strong>
                {% if sa.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Paused</span>
                {% endif %}
                {% if sa.failure_count >= 3 %}
                  <span class="badge bg-danger" title="Auto-disabled after 3 failures">
                    <i class="fas fa-exclamation-triangle me-1"></i>Failed
                  </span>
                {% elif sa.failure_count > 0 %}
                  <span class="badge bg-warning text-dark" title="{{ sa.failure_count }} failure(s)">
                    <i class="fas fa-exclamation-circle me-1"></i>{{ sa.failure_count }} fail{{ sa.failure_count|pluralize }}
                  </span>
                {% endif %}
              </div>

              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="sched-badge">
                  <i class="fas fa-clock me-1"></i>{{ sa.get_schedule_description }}
                </span>
                <span class="arrow-icon">&rarr;</span>
                <span class="action-badge">
                  <i class="fas fa-cogs me-1"></i>
                  {% if sa.action == 'send_notification' %}Notify {{ sa.get_notify_target_display|lower }}
                  {% elif sa.action == 'set_priority' %}Set priority &rarr; {{ sa.action_value|title }}
                  {% else %}{{ sa.get_action_display }}{% endif %}
                </span>
                <span class="trigger-badge" title="Task filter">
                  <i class="fas fa-filter me-1"></i>{{ sa.get_task_filter_display }}
                </span>
              </div>

              <div class="text-muted small mt-2">
                Fired {{ sa.run_count }} time{{ sa.run_count|pluralize }}
                {% if sa.last_run_at %}&middot; last run {{ sa.last_run_at|date:"M d, Y H:i" }}{% endif %}
                &middot; Created by {{ sa.created_by.username|default:"&mdash;" }}
              </div>
            </div>

            <div class="d-flex gap-2 ms-3 flex-shrink-0">
              <form method="post" action="{% url 'scheduled_automation_toggle' board.id sa.id %}">
                {% csrf_token %}
                <button class="btn btn-sm {% if sa.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                        title="{% if sa.is_active %}Pause{% else %}Enable{% endif %}">
                  <i class="fas {% if sa.is_active %}fa-pause{% else %}fa-play{% endif %}"></i>
                </button>
              </form>
              <form method="post" action="{% url 'scheduled_automation_delete' board.id sa.id %}"
                    onsubmit="return confirm('Delete scheduled rule \'{{ sa.name|escapejs }}\'?');">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

    </div>

    <!-- RIGHT: Create Rule Form -->
    <div class="col-lg-5">
      <div class="create-card">
        <h5 class="mb-3"><i class="fas fa-plus-circle me-2 text-primary"></i>Create New Rule</h5>

        {% if messages %}
          {% for msg in messages %}
          <div class="alert alert-{{ msg.tags|default:'info' }} alert-dismissible py-2 small" role="alert">
            {{ msg }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          {% endfor %}
        {% endif %}

        <form id="createRuleForm" method="post" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label fw-semibold">Rule Name <span class="text-danger">*</span></label>
            <input type="text" name="name" id="ruleName" class="form-control"
                   placeholder="e.g. Notify assignee before deadline" required maxlength="120">
            <div class="invalid-feedback">Please enter a rule name.</div>
          </div>

          <!-- TRIGGER -->
          <div class="mb-2">
            <label class="form-label fw-semibold">Trigger</label>
            <select name="trigger_type" id="triggerType" class="form-select" onchange="onTriggerChange()">
              {% for value, label in trigger_choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="tvColumnFragment" style="display:none;">
            <label class="form-label text-muted small">Column name fragment (e.g. "Review" matches "In Review")</label>
            <input type="text" id="tvColInput" class="form-control form-control-sm" placeholder="e.g. Review">
          </div>
          <div class="mb-3" id="tvPriority" style="display:none;">
            <label class="form-label text-muted small">When priority changes to</label>
            <select id="tvPrioritySelect" class="form-select form-select-sm">
              <option value="urgent">Urgent</option><option value="high">High</option>
              <option value="medium">Medium</option><option value="low">Low</option>
            </select>
          </div>
          <div class="mb-3" id="tvDays" style="display:none;">
            <label class="form-label text-muted small">Days before due date</label>
            <input type="number" id="tvDaysInput" class="form-control form-control-sm" value="2" min="1" max="365">
          </div>
          <!-- hidden field — populated by JS before submit -->
          <input type="hidden" name="trigger_value" id="triggerValueHidden">

          <!-- ACTION -->
          <div class="mb-2">
            <label class="form-label fw-semibold">Action</label>
            <select name="action_type" id="actionType" class="form-select" onchange="onActionChange()">
              {% for value, label in action_choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="avPriority" style="display:none;">
            <label class="form-label text-muted small">Priority</label>
            <select id="avPrioritySelect" class="form-select form-select-sm">
              <option value="urgent">Urgent</option><option value="high">High</option>
              <option value="medium">Medium</option><option value="low">Low</option>
            </select>
          </div>
          <div class="mb-3" id="avLabel" style="display:none;">
            <label class="form-label text-muted small">Label</label>
            <select id="avLabelSelect" class="form-select form-select-sm">
              {% for label in labels %}<option value="{{ label.name }}">{{ label.name }}</option>
              {% empty %}<option value="" disabled>No labels on this board yet</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3" id="avNotify" style="display:none;">
            <label class="form-label text-muted small">Notify</label>
            <select id="avNotifySelect" class="form-select form-select-sm">
              <option value="assignee">Task assignee</option>
              <option value="board_members">All board members</option>
              <option value="creator">Task creator</option>
            </select>
          </div>
          <div class="mb-3" id="avMoveCol" style="display:none;">
            <label class="form-label text-muted small">Destination column</label>
            <select id="avMoveColSelect" class="form-select form-select-sm">
              {% for col in columns %}<option value="{{ col.name }}">{{ col.name }}</option>
              {% empty %}<option value="" disabled>No columns available</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3" id="avAssign" style="display:none;">
            <label class="form-label text-muted small">Assign to</label>
            <select id="avAssignSelect" class="form-select form-select-sm">
              {% for member in members %}
              <option value="{{ member.username }}">{{ member.get_full_name|default:member.username }} (@{{ member.username }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="avDays" style="display:none;">
            <label class="form-label text-muted small">Days from now</label>
            <input type="number" id="avDaysInput" class="form-control form-control-sm" value="7" min="0" max="9999">
          </div>
          <!-- hidden field — populated by JS before submit -->
          <input type="hidden" name="action_value" id="actionValueHidden">

          <button type="button" class="btn btn-primary w-100 mt-1" onclick="openConfirmModal()">
            <i class="fas fa-eye me-2"></i>Review &amp; Create Rule
          </button>
        </form>
      </div>

      <!-- ============================================================= -->
      <!-- CREATE SCHEDULED RULE FORM                                      -->
      <!-- ============================================================= -->
      <div class="create-card mt-4">
        <h5 class="mb-3"><i class="fas fa-clock me-2" style="color:#7c3aed;"></i>Create Scheduled Rule</h5>

        <form id="createSchedForm" method="post" action="{% url 'scheduled_automation_create' board.id %}" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label fw-semibold">Rule Name <span class="text-danger">*</span></label>
            <input type="text" name="sched_name" id="schedName" class="form-control"
                   placeholder="e.g. Daily overdue summary" required maxlength="200">
          </div>

          <!-- SCHEDULE TYPE -->
          <div class="mb-2">
            <label class="form-label fw-semibold">Frequency</label>
            <select name="schedule_type" id="schedType" class="form-select" onchange="onSchedTypeChange()">
              {% for val, label in sched_schedule_types %}
              <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Time</label>
            <input type="time" name="scheduled_time" id="schedTime" class="form-control" value="09:00" required>
          </div>

          <div class="mb-3" id="schedDayWeekly" style="display:none;">
            <label class="form-label text-muted small">Day of week</label>
            <select name="scheduled_day" id="schedDayOfWeek" class="form-select form-select-sm">
              <option value="0">Monday</option>
              <option value="1">Tuesday</option>
              <option value="2">Wednesday</option>
              <option value="3">Thursday</option>
              <option value="4">Friday</option>
              <option value="5">Saturday</option>
              <option value="6">Sunday</option>
            </select>
          </div>

          <div class="mb-3" id="schedDayMonthly" style="display:none;">
            <label class="form-label text-muted small">Day of month (1–28)</label>
            <select name="scheduled_day" id="schedDayOfMonth" class="form-select form-select-sm">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option><option value="8">8</option><option value="9">9</option>
              <option value="10">10</option><option value="11">11</option><option value="12">12</option>
              <option value="13">13</option><option value="14">14</option><option value="15">15</option>
              <option value="16">16</option><option value="17">17</option><option value="18">18</option>
              <option value="19">19</option><option value="20">20</option><option value="21">21</option>
              <option value="22">22</option><option value="23">23</option><option value="24">24</option>
              <option value="25">25</option><option value="26">26</option><option value="27">27</option>
              <option value="28">28</option>
            </select>
          </div>

          <!-- ACTION -->
          <div class="mb-2">
            <label class="form-label fw-semibold">Action</label>
            <select name="sched_action" id="schedAction" class="form-select" onchange="onSchedActionChange()">
              {% for val, label in sched_action_choices %}
              <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- send_notification sub-fields -->
          <div id="schedNotifyFields">
            <div class="mb-3">
              <label class="form-label text-muted small">Notify</label>
              <select name="notify_target" id="schedNotifyTarget" class="form-select form-select-sm">
                {% for val, label in sched_notify_targets %}
                <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label text-muted small">Custom message (optional)</label>
              <input type="text" name="sched_action_value" id="schedNotifyMessage"
                     class="form-control form-control-sm" placeholder="Leave blank for auto-generated">
            </div>
          </div>

          <!-- set_priority sub-field -->
          <div id="schedPriorityField" style="display:none;">
            <div class="mb-3">
              <label class="form-label text-muted small">Priority</label>
              <select name="sched_action_value" id="schedPrioritySelect" class="form-select form-select-sm">
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>

          <!-- Task filter -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Apply to tasks</label>
            <select name="task_filter" id="schedTaskFilter" class="form-select">
              {% for val, label in sched_task_filters %}
              <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Live preview -->
          <div class="sched-preview mb-3" id="schedPreview">
            <i class="fas fa-clock me-1" style="color:#7c3aed;"></i>
            This rule will run: <span id="schedPreviewText">Every day at 9:00 AM</span>
          </div>

          <button type="button" class="btn w-100 mt-1 text-white" style="background:#7c3aed;"
                  onclick="openSchedConfirmModal()">
            <i class="fas fa-eye me-2"></i>Review &amp; Create Scheduled Rule
          </button>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- CONFIRMATION MODAL (trigger-based rules) -->
<div class="modal fade" id="confirmRuleModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-bolt text-warning me-2"></i>Confirm New Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">
          Review the rule below. Once saved it will start running automatically on
          <strong>{{ board.name }}</strong>.
        </p>
        <div class="bg-light rounded p-3 border" id="confirmRuleSummary"></div>
        <p class="text-muted small mt-3 mb-0">
          <i class="fas fa-info-circle me-1"></i>
          This rule will affect <strong>all current and future tasks</strong> on this board that
          match the trigger. You can pause or delete it at any time.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitRuleForm()">
          <i class="fas fa-plus me-1"></i>Create Rule
        </button>
      </div>
    </div>
  </div>
</div>

<!-- SCHEDULED AUTOMATION CONFIRMATION MODAL -->
<div class="modal fade" id="confirmSchedModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clock me-2" style="color:#7c3aed;"></i>Confirm Scheduled Rule</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">
          Review the scheduled rule below. Once saved it will start running on
          <strong>{{ board.name }}</strong> according to the schedule.
        </p>
        <div class="bg-light rounded p-3 border" id="confirmSchedSummary"></div>
        <p class="text-muted small mt-3 mb-0">
          <i class="fas fa-info-circle me-1"></i>
          This rule fires on a recurring schedule and applies to tasks matching the filter.
          You can pause or delete it at any time.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn text-white" style="background:#7c3aed;" onclick="submitSchedForm()">
          <i class="fas fa-plus me-1"></i>Create Scheduled Rule
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const TRIGGER_LABELS = {
  task_overdue:'Task becomes overdue (due date passed, not done)',
  moved_to_column:'Task moved to a column containing\u2026',
  task_created:'Task is created',
  task_completed:'Task is marked as complete / done (100%)',
  priority_changed:'Task priority changes to\u2026',
  task_assigned:'Task is assigned to a team member',
  due_date_approaching:'Task due date is approaching (X days before)',
};
const ACTION_LABELS = {
  set_priority:'Set priority', add_label:'Add label',
  send_notification:'Send notification', move_to_column:'Move task to column',
  assign_to_user:'Assign to a specific person', set_due_date:'Set due date (now + N days)',
};

function onTriggerChange() {
  const t = document.getElementById('triggerType').value;
  ['tvColumnFragment','tvPriority','tvDays'].forEach(id =>
    document.getElementById(id).style.display = 'none');
  if      (t === 'moved_to_column')       document.getElementById('tvColumnFragment').style.display = 'block';
  else if (t === 'priority_changed')      document.getElementById('tvPriority').style.display = 'block';
  else if (t === 'due_date_approaching')  document.getElementById('tvDays').style.display = 'block';
}

function onActionChange() {
  const a = document.getElementById('actionType').value;
  ['avPriority','avLabel','avNotify','avMoveCol','avAssign','avDays'].forEach(id =>
    document.getElementById(id).style.display = 'none');
  const map = {set_priority:'avPriority',add_label:'avLabel',send_notification:'avNotify',
               move_to_column:'avMoveCol',assign_to_user:'avAssign',set_due_date:'avDays'};
  if (map[a]) document.getElementById(map[a]).style.display = 'block';
}

function getValues() {
  const triggerType = document.getElementById('triggerType').value;
  const actionType  = document.getElementById('actionType').value;
  let triggerValue = '';
  if (triggerType === 'moved_to_column')        triggerValue = document.getElementById('tvColInput').value.trim();
  else if (triggerType === 'priority_changed')  triggerValue = document.getElementById('tvPrioritySelect').value;
  else if (triggerType === 'due_date_approaching') triggerValue = document.getElementById('tvDaysInput').value;
  let actionValue = '';
  const avMap = {set_priority:'avPrioritySelect',add_label:'avLabelSelect',
                 send_notification:'avNotifySelect',move_to_column:'avMoveColSelect',
                 assign_to_user:'avAssignSelect',set_due_date:'avDaysInput'};
  if (avMap[actionType]) actionValue = document.getElementById(avMap[actionType]).value;
  return {name:document.getElementById('ruleName').value.trim(), triggerType, triggerValue, actionType, actionValue};
}

function openConfirmModal() {
  const form = document.getElementById('createRuleForm');
  if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
  const v = getValues();
  if (!v.name) { alert('Please enter a rule name.'); return; }

  document.getElementById('triggerValueHidden').value = v.triggerValue;
  document.getElementById('actionValueHidden').value  = v.actionValue;

  let triggerText = TRIGGER_LABELS[v.triggerType] || v.triggerType;
  if      (v.triggerType === 'moved_to_column')        triggerText = 'Moved to column containing "' + v.triggerValue + '"';
  else if (v.triggerType === 'priority_changed')       triggerText = 'Priority changes to "' + v.triggerValue + '"';
  else if (v.triggerType === 'due_date_approaching')   triggerText = 'Due date \u2264 ' + v.triggerValue + ' day(s) away';

  let actionText = ACTION_LABELS[v.actionType] || v.actionType;
  if      (v.actionType === 'set_priority')     actionText = 'Set priority to "' + v.actionValue + '"';
  else if (v.actionType === 'add_label')         actionText = 'Add label "' + v.actionValue + '"';
  else if (v.actionType === 'send_notification') {
    const t={assignee:'task assignee',board_members:'all board members',creator:'task creator'};
    actionText = 'Send notification to ' + (t[v.actionValue] || v.actionValue);
  }
  else if (v.actionType === 'move_to_column')   actionText = 'Move task to column "' + v.actionValue + '"';
  else if (v.actionType === 'assign_to_user')    actionText = 'Assign to @' + v.actionValue;
  else if (v.actionType === 'set_due_date')      actionText = 'Set due date to now + ' + v.actionValue + ' day(s)';

  document.getElementById('confirmRuleSummary').innerHTML =
    '<div class="fw-semibold mb-2">' + esc(v.name) + '</div>' +
    '<div class="d-flex align-items-center gap-2 flex-wrap">' +
    '<span class="trigger-badge"><i class="fas fa-play-circle me-1"></i>' + esc(triggerText) + '</span>' +
    '<span class="arrow-icon">\u2192</span>' +
    '<span class="action-badge"><i class="fas fa-cogs me-1"></i>' + esc(actionText) + '</span></div>';

  new bootstrap.Modal(document.getElementById('confirmRuleModal')).show();
}

function submitRuleForm() {
  bootstrap.Modal.getInstance(document.getElementById('confirmRuleModal')).hide();
  document.getElementById('createRuleForm').submit();
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                  .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

document.addEventListener('DOMContentLoaded', function() { onTriggerChange(); onActionChange(); onSchedTypeChange(); onSchedActionChange(); updateSchedPreview(); });

/* ------------------------------------------------------------------ */
/* SCHEDULED AUTOMATION JS                                             */
/* ------------------------------------------------------------------ */
const DAY_NAMES = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

function onSchedTypeChange() {
  const st = document.getElementById('schedType').value;
  document.getElementById('schedDayWeekly').style.display  = st === 'weekly'  ? 'block' : 'none';
  document.getElementById('schedDayMonthly').style.display = st === 'monthly' ? 'block' : 'none';
  // Disable the unused select so its name='scheduled_day' isn't submitted
  document.getElementById('schedDayOfWeek').disabled  = st !== 'weekly';
  document.getElementById('schedDayOfMonth').disabled = st !== 'monthly';
  updateSchedPreview();
}

function onSchedActionChange() {
  const a = document.getElementById('schedAction').value;
  document.getElementById('schedNotifyFields').style.display  = a === 'send_notification' ? 'block' : 'none';
  document.getElementById('schedPriorityField').style.display = a === 'set_priority'       ? 'block' : 'none';
  // Disable hidden fields so they aren't submitted
  document.getElementById('schedNotifyMessage').disabled  = a !== 'send_notification';
  document.getElementById('schedNotifyTarget').disabled   = a !== 'send_notification';
  document.getElementById('schedPrioritySelect').disabled = a !== 'set_priority';
}

function getSchedPreviewText() {
  const st   = document.getElementById('schedType').value;
  const time = document.getElementById('schedTime').value || '09:00';

  // Format time to 12-hour
  const [hh, mm] = time.split(':').map(Number);
  const ampm = hh >= 12 ? 'PM' : 'AM';
  const h12  = hh % 12 || 12;
  const nice = h12 + ':' + String(mm).padStart(2,'0') + ' ' + ampm;

  if (st === 'daily')  return 'Every day at ' + nice;
  if (st === 'weekly') {
    const day = DAY_NAMES[document.getElementById('schedDayOfWeek').value] || '?';
    return 'Every ' + day + ' at ' + nice;
  }
  if (st === 'monthly') {
    const d = document.getElementById('schedDayOfMonth').value || '?';
    const suffix = (d==1||d==21)?'st':(d==2||d==22)?'nd':(d==3||d==23)?'rd':'th';
    return 'Every month on the ' + d + suffix + ' at ' + nice;
  }
  return st;
}

function updateSchedPreview() {
  document.getElementById('schedPreviewText').textContent = getSchedPreviewText();
}

// Attach listeners for live preview
['schedType','schedTime','schedDayOfWeek','schedDayOfMonth'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.addEventListener('change', updateSchedPreview);
});

function openSchedConfirmModal() {
  const form = document.getElementById('createSchedForm');
  if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
  const name = document.getElementById('schedName').value.trim();
  if (!name) { alert('Please enter a rule name.'); return; }

  const schedText = getSchedPreviewText();
  const action    = document.getElementById('schedAction').value;
  let actionText = '';
  if (action === 'send_notification') {
    const t = {assignee:'task assignee', board_members:'all board members', creator:'task creator'};
    actionText = 'Notify ' + (t[document.getElementById('schedNotifyTarget').value] || 'recipients');
  } else if (action === 'set_priority') {
    actionText = 'Set priority to "' + document.getElementById('schedPrioritySelect').value + '"';
  }

  const filterLabel = document.getElementById('schedTaskFilter').selectedOptions[0].text;

  document.getElementById('confirmSchedSummary').innerHTML =
    '<div class="fw-semibold mb-2">' + esc(name) + '</div>' +
    '<div class="d-flex align-items-center gap-2 flex-wrap mb-2">' +
    '<span class="sched-badge"><i class="fas fa-clock me-1"></i>' + esc(schedText) + '</span>' +
    '<span class="arrow-icon">\u2192</span>' +
    '<span class="action-badge"><i class="fas fa-cogs me-1"></i>' + esc(actionText) + '</span></div>' +
    '<div class="small text-muted"><i class="fas fa-filter me-1"></i>Applies to: ' + esc(filterLabel) + '</div>';

  new bootstrap.Modal(document.getElementById('confirmSchedModal')).show();
}

function submitSchedForm() {
  bootstrap.Modal.getInstance(document.getElementById('confirmSchedModal')).hide();
  document.getElementById('createSchedForm').submit();
}
</script>
{% endblock %}