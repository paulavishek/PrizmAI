{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Create Task - PrizmAI{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        {% if column %}
                            Add Task to {{ column.name }}
                        {% else %}
                            Create New Task
                        {% endif %}
                    </h6>
                    <button onclick="goBack()" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </button>
                </div>
                <div class="card-body">
                    <form method="post" class="task-form" id="task-create-form">
                        {% csrf_token %}
                        <input type="hidden" name="confirm_duplicate" id="confirm_duplicate" value="false">
                        
                        <!-- Duplicate Task Warning -->
                        {% if duplicate_tasks %}
                        <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> Duplicate Task Detected
                            </h5>
                            <p class="mb-2">
                                <strong>{{ duplicate_tasks|length }} task(s) with this title already exist in this board:</strong>
                            </p>
                            <ul class="mb-3">
                                {% for dup_task in duplicate_tasks %}
                                <li>
                                    <a href="{% url 'task_detail' dup_task.id %}" target="_blank" class="alert-link">
                                        {{ dup_task.title }}
                                    </a>
                                    <small class="text-muted">
                                        - {{ dup_task.column.name }}
                                        {% if dup_task.assigned_to %}
                                            | Assigned to: {{ dup_task.assigned_to.username }}
                                        {% endif %}
                                        {% if dup_task.due_date %}
                                            | Due: {{ dup_task.due_date|date:"M d, Y" }}
                                        {% endif %}
                                    </small>
                                </li>
                                {% endfor %}
                            </ul>
                            <hr>
                            <p class="mb-3">
                                <i class="fas fa-info-circle"></i> 
                                <strong>What would you like to do?</strong>
                            </p>
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-sm btn-info" onclick="viewExistingTask()">
                                    <i class="fas fa-eye me-1"></i> View Existing Task
                                </button>
                                <button type="button" class="btn btn-sm btn-success" onclick="confirmCreateDuplicate()">
                                    <i class="fas fa-check me-1"></i> Create Anyway
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="goBack()">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endif %}
                        
                        <!-- Display form-level errors -->
                        {% if form.errors %}
                        <div class="alert alert-danger mb-3" role="alert">
                            <h6 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Please fix the following errors:</h6>
                            {% if form.non_field_errors %}
                                <ul class="mb-0">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                            {% for field in form %}
                                {% if field.errors %}
                                    <p class="mb-1"><strong>{{ field.label }}:</strong> {{ field.errors|join:", " }}</p>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <!-- SECTION 1: THE BASICS (Required)                                    -->
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <div class="mb-4" id="section-basics">
                            <h5 class="border-bottom pb-2 mb-3">
                                <span class="badge bg-primary me-2">1</span>
                                <i class="fas fa-edit text-primary me-1"></i> The Basics
                            </h5>

                            <!-- Phase Selection (only visible if board has phases) -->
                            {% if board.num_phases > 0 %}
                            <div class="mb-3" id="phase-field-container">
                                <label for="{{ form.phase.id_for_label }}" class="form-label">
                                    <i class="fas fa-layer-group me-1"></i> Phase <span class="text-danger">*</span>
                                </label>
                                {{ form.phase }}
                                <small class="form-text text-muted">
                                    Select which phase this task belongs to (this board has {{ board.num_phases }} phase(s)).
                                </small>
                                {% if form.phase.errors %}
                                    <div class="invalid-feedback d-block">{{ form.phase.errors }}</div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Title -->
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Title <span class="text-danger">*</span></label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Description with AI Generation -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="{{ form.description.id_for_label }}" class="form-label mb-0">Description</label>
                                    <button type="button" id="generate-ai-description" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-robot me-1"></i> Generate with AI
                                    </button>
                                </div>
                                {{ form.description }}
                                <div id="ai-spinner" class="d-none text-center mt-2">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2 text-muted">Generating description with AI...</span>
                                </div>
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <!-- SECTION 2: CONSTRAINTS & CONTEXT (The "Game Changers")              -->
                        <!-- These fields affect AI predictions - must come BEFORE AI Analysis   -->
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <span class="badge bg-secondary me-2">2</span>
                                <i class="fas fa-sliders-h text-secondary me-1"></i> Constraints & Context
                            </h5>
                            
                            <!-- Assignee Selection - Required for AI Predictions -->
                            <div class="mb-3">
                                <label for="{{ form.assigned_to.id_for_label }}" class="form-label">
                                    <i class="fas fa-user-check me-1"></i> Assigned To
                                </label>
                                {{ form.assigned_to }}
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>Select an assignee to enable AI deadline prediction.
                                </small>
                                {% if form.assigned_to.errors %}
                                    <div class="invalid-feedback d-block">{{ form.assigned_to.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Regular Labels (for other tags) - Only show if non-LSS labels exist -->
                            {% if form.labels.field.queryset.exists %}
                            <div class="mb-3">
                                <label for="{{ form.labels.id_for_label }}" class="form-label">
                                    <i class="fas fa-tags me-1"></i> Tags/Labels <small class="text-muted">(Optional)</small>
                                </label>
                                {{ form.labels }}
                                {% if form.labels.errors %}
                                    <div class="invalid-feedback d-block">{{ form.labels.errors }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- Collapsible Advanced Constraints & Context -->
                            <div class="card border-secondary">
                                <div class="card-header bg-light cursor-pointer d-flex justify-content-between align-items-center" 
                                     data-bs-toggle="collapse" data-bs-target="#advancedConstraintsSection" 
                                     aria-expanded="false" aria-controls="advancedConstraintsSection">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chevron-down me-2 collapse-icon"></i>
                                        <i class="fas fa-cog text-secondary"></i> Add Constraints & Context 
                                        <small class="text-muted">(Optional)</small>
                                    </h6>
                                    <span class="badge bg-info" id="constraints-hint">
                                        <i class="fas fa-lightbulb me-1"></i>Affects AI predictions
                                    </span>
                                </div>
                                <div id="advancedConstraintsSection" class="collapse">
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3 py-2">
                                            <small>
                                                <i class="fas fa-brain me-1"></i>
                                                <strong>Pro Tip:</strong> Fill out these fields <em>before</em> running AI analysis. 
                                                The AI considers risk, complexity, and workload when suggesting deadlines and priorities.
                                            </small>
                                        </div>
                                        
                                        <!-- ðŸ›¡ï¸ Risk Assessment Section -->
                                        <div class="mb-4">
                                            <h6><i class="fas fa-shield-alt text-warning"></i> Risk Assessment</h6>
                                            <p class="small text-muted mb-3">Assess potential risks for this task. Risk score will be automatically calculated from likelihood Ã— impact.</p>
                                            
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.risk_likelihood.id_for_label }}" class="form-label">Risk Likelihood</label>
                                                    {{ form.risk_likelihood }}
                                                    <small class="form-text text-muted">How likely is the risk to occur?</small>
                                                    {% if form.risk_likelihood.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.risk_likelihood.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.risk_impact.id_for_label }}" class="form-label">Risk Impact</label>
                                                    {{ form.risk_impact }}
                                                    <small class="form-text text-muted">What's the severity if it occurs?</small>
                                                    {% if form.risk_impact.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.risk_impact.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.risk_level.id_for_label }}" class="form-label">Risk Level</label>
                                                    {{ form.risk_level }}
                                                    <small class="form-text text-muted">Overall risk classification</small>
                                                    {% if form.risk_level.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.risk_level.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="{{ form.risk_indicators_text.id_for_label }}" class="form-label">{{ form.risk_indicators_text.label }}</label>
                                                {{ form.risk_indicators_text }}
                                                <small class="form-text text-muted">{{ form.risk_indicators_text.help_text }}</small>
                                                {% if form.risk_indicators_text.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.risk_indicators_text.errors }}</div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="{{ form.mitigation_strategies_text.id_for_label }}" class="form-label">{{ form.mitigation_strategies_text.label }}</label>
                                                {{ form.mitigation_strategies_text }}
                                                <small class="form-text text-muted">{{ form.mitigation_strategies_text.help_text }}</small>
                                                {% if form.mitigation_strategies_text.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.mitigation_strategies_text.errors }}</div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="alert alert-secondary mb-0 py-2">
                                                <small>
                                                    <i class="fas fa-info-circle"></i> 
                                                    <strong>Tip:</strong> If you set Likelihood and Impact, the Risk Score (1-9) will be automatically calculated.
                                                </small>
                                            </div>
                                        </div>

                                        <hr>
                                        
                                        <!-- ðŸ“Š Manual Complexity Score -->
                                        <div class="mb-4">
                                            <h6><i class="fas fa-chart-line text-warning"></i> Task Complexity (Manual Estimate)</h6>
                                            <div class="mb-3">
                                                <label for="{{ form.complexity_score.id_for_label }}" class="form-label d-flex justify-content-between align-items-center">
                                                    <span>Complexity Score</span>
                                                    <output id="complexity-output" class="badge bg-secondary">5</output>
                                                </label>
                                                <div class="d-flex align-items-center gap-3">
                                                    <small class="text-muted">Simple (1)</small>
                                                    {{ form.complexity_score }}
                                                    <small class="text-muted">Complex (10)</small>
                                                </div>
                                                <small class="form-text text-muted">{{ form.complexity_score.help_text }}</small>
                                                {% if form.complexity_score.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.complexity_score.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <hr>

                                        <!-- ðŸ“¦ Resource Information -->
                                        <div class="mb-4">
                                            <h6><i class="fas fa-box text-info"></i> Resource & Workload</h6>
                                            <div class="mb-3">
                                                <label for="{{ form.workload_impact.id_for_label }}" class="form-label">Workload Impact</label>
                                                {{ form.workload_impact }}
                                                <small class="form-text text-muted">{{ form.workload_impact.help_text }}</small>
                                                {% if form.workload_impact.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.workload_impact.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.skill_match_score.id_for_label }}" class="form-label">Skill Match Score</label>
                                                {{ form.skill_match_score }}
                                                <small class="form-text text-muted">How well the assignee's skills match this task (0-100%)</small>
                                                {% if form.skill_match_score.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.skill_match_score.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3 form-check">
                                                {{ form.collaboration_required }}
                                                <label class="form-check-label" for="{{ form.collaboration_required.id_for_label }}">
                                                    <i class="fas fa-users me-1"></i> Collaboration Required
                                                </label>
                                                <small class="form-text text-muted d-block">Check if this task requires collaboration with other team members</small>
                                                {% if form.collaboration_required.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.collaboration_required.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <hr>

                                        <!-- ï¿½ Budget & Cost Estimation -->
                                        <div class="mb-4">
                                            <h6><i class="fas fa-dollar-sign text-success"></i> Budget & Cost Estimation</h6>
                                            <div class="alert alert-info py-2 mb-3">
                                                <small><i class="fas fa-info-circle me-1"></i> Cost estimates help track project budget and enable AI-powered budget recommendations.</small>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.estimated_cost.id_for_label }}" class="form-label">
                                                        <i class="fas fa-money-bill-wave me-1 text-success"></i> Estimated Cost
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        {{ form.estimated_cost }}
                                                    </div>
                                                    <small class="form-text text-muted">{{ form.estimated_cost.help_text }}</small>
                                                    {% if form.estimated_cost.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.estimated_cost.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.estimated_hours.id_for_label }}" class="form-label">
                                                        <i class="fas fa-clock me-1 text-primary"></i> Estimated Hours
                                                    </label>
                                                    <div class="input-group">
                                                        {{ form.estimated_hours }}
                                                        <span class="input-group-text">hrs</span>
                                                    </div>
                                                    <small class="form-text text-muted">{{ form.estimated_hours.help_text }}</small>
                                                    {% if form.estimated_hours.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.estimated_hours.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="{{ form.hourly_rate.id_for_label }}" class="form-label">
                                                        <i class="fas fa-user-clock me-1 text-info"></i> Hourly Rate
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$/hr</span>
                                                        {{ form.hourly_rate }}
                                                    </div>
                                                    <small class="form-text text-muted">{{ form.hourly_rate.help_text }}</small>
                                                    {% if form.hourly_rate.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.hourly_rate.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12">
                                                    <div class="card bg-light">
                                                        <div class="card-body py-2">
                                                            <small class="text-muted">
                                                                <i class="fas fa-calculator me-1"></i>
                                                                <strong>Estimated Labor Cost:</strong>
                                                                <span id="laborCostPreview">$0.00</span>
                                                                <span class="ms-2 text-secondary">(Hours Ã— Hourly Rate)</span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <hr>

                                        <!-- ï¿½ðŸ”— Task Relationships & Timeline -->
                                        <div class="mb-4">
                                            <h6><i class="fas fa-project-diagram text-info"></i> Task Relationships & Timeline</h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                                                    {{ form.start_date }}
                                                    <small class="form-text text-muted">When this task should start</small>
                                                    {% if form.start_date.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.start_date.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.parent_task.id_for_label }}" class="form-label">
                                                        Parent Task
                                                        <i class="fas fa-question-circle text-muted" title="Select a parent task to create a subtask hierarchy"></i>
                                                    </label>
                                                    {{ form.parent_task }}
                                                    <small class="form-text text-muted">Make this a subtask of another task (optional)</small>
                                                    {% if form.parent_task.errors %}
                                                        <div class="invalid-feedback d-block">{{ form.parent_task.errors }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.dependencies.id_for_label }}" class="form-label">
                                                    Timeline Dependencies (Gantt Chart)
                                                    <i class="fas fa-question-circle text-muted" title="Tasks that must be completed before this task can start"></i>
                                                </label>
                                                {{ form.dependencies }}
                                                <small class="form-text text-muted">{{ form.dependencies.help_text }}</small>
                                                {% if form.dependencies.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.dependencies.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.related_tasks.id_for_label }}" class="form-label">
                                                    Related Tasks
                                                    <i class="fas fa-question-circle text-muted" title="Tasks that are related but not dependencies"></i>
                                                </label>
                                                {{ form.related_tasks }}
                                                <small class="form-text text-muted">Tasks that are related but not dependencies (optional)</small>
                                                {% if form.related_tasks.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.related_tasks.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="alert alert-secondary mb-0 py-2">
                                                <small>
                                                    <i class="fas fa-info-circle"></i> 
                                                    <strong>Timeline vs Hierarchy:</strong> Dependencies block timeline progress (Gantt chart), while Parent Task creates an organizational hierarchy (subtasks).
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        
                                        <!-- Required Skills (JSON) -->
                                        <div class="mb-3">
                                            <label for="{{ form.required_skills.id_for_label }}" class="form-label">
                                                <i class="fas fa-tools me-1"></i> Required Skills (Advanced)
                                            </label>
                                            {{ form.required_skills }}
                                            <small class="form-text text-muted">{{ form.required_skills.help_text }}</small>
                                            {% if form.required_skills.errors %}
                                                <div class="invalid-feedback d-block">{{ form.required_skills.errors }}</div>
                                            {% endif %}
                                        </div>

                                        <hr>

                                        <!-- ðŸ‘¥ Stakeholder & Additional Info -->
                                        <div class="alert alert-secondary mb-0 py-2">
                                            <small>
                                                <i class="fas fa-users me-1"></i> 
                                                <strong>Stakeholders & Attachments:</strong> You can add stakeholders, and files after creating the task.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <!-- SECTION 3: AI ANALYSIS (The "Intelligence" Layer)                   -->
                        <!-- Runs AFTER user has provided context for accurate predictions       -->
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <span class="badge bg-info me-2">3</span>
                                <i class="fas fa-brain text-info me-1"></i> AI Analysis
                                <small class="text-muted fw-normal ms-2">(Uses all context above)</small>
                            </h5>
                            
                            <!-- Task Complexity Analysis - AI-powered -->
                            <div class="card mb-3 border-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><i class="fas fa-sitemap text-success me-1"></i> Task Complexity Analysis</h6>
                                            <small class="text-muted">Get AI suggestions for breaking complex tasks into manageable subtasks</small>
                                        </div>
                                        <button type="button" id="suggest-breakdown-btn" class="btn btn-sm btn-outline-success" 
                                                title="AI-powered task breakdown suggestion">
                                            <i class="fas fa-sitemap me-1"></i> Analyze & Break Down
                                        </button>
                                    </div>
                                    <div id="breakdown-ai-spinner" class="d-none text-center mt-2">
                                        <div class="spinner-border spinner-border-sm text-success" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2 text-muted">Analyzing task complexity...</span>
                                    </div>
                                    <div id="task-breakdown-result" class="d-none mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Due Date & Priority Row -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card border-info h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="{{ form.due_date.id_for_label }}" class="form-label mb-0">
                                                    <i class="fas fa-calendar-alt text-info me-1"></i> Due Date
                                                </label>
                                                <button type="button" id="predict-deadline-btn" class="btn btn-sm btn-outline-info" 
                                                        data-board-id="{{ board.id }}" title="AI-powered deadline prediction">
                                                    <i class="fas fa-brain me-1"></i> Predict
                                                </button>
                                            </div>
                                            {{ form.due_date }}
                                            <!-- Helper text for prediction requirements -->
                                            <small id="predict-assignee-hint" class="form-text text-warning d-none">
                                                <i class="fas fa-exclamation-circle me-1"></i>Please select an assignee above to enable AI prediction.
                                            </small>
                                            <div id="deadline-ai-spinner" class="d-none text-center mt-1">
                                                <div class="spinner-border spinner-border-sm text-info" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2 text-muted small">Predicting optimal deadline...</span>
                                            </div>
                                            <div id="deadline-prediction-result" class="d-none mt-2"></div>
                                            {% if form.due_date.errors %}
                                                <div class="invalid-feedback d-block">{{ form.due_date.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="{{ form.priority.id_for_label }}" class="form-label mb-0">
                                                    <i class="fas fa-flag text-warning me-1"></i> Priority
                                                </label>
                                                <button type="button" id="suggest-priority-btn" class="btn btn-sm btn-outline-warning" 
                                                        data-board-id="{{ board.id }}" title="AI-powered priority suggestion">
                                                    <i class="fas fa-magic me-1"></i> Suggest
                                                </button>
                                            </div>
                                            <div id="priority-suggestion-container" class="mb-2"></div>
                                            {{ form.priority }}
                                            <div id="priority-ai-spinner" class="d-none text-center mt-1">
                                                <div class="spinner-border spinner-border-sm text-warning" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2 text-muted small">Analyzing optimal priority...</span>
                                            </div>
                                            {% if form.priority.errors %}
                                                <div class="invalid-feedback d-block">{{ form.priority.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lean Six Sigma Classification -->
                            <div class="card mb-3 border-primary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">
                                            <i class="fas fa-chart-line text-primary me-1"></i> Lean Six Sigma Classification
                                            <button type="button" class="btn btn-sm p-0 ms-1" data-bs-toggle="modal" data-bs-target="#leanLabelsInfoModal">
                                                <i class="fas fa-info-circle text-primary" title="Learn about Lean Six Sigma categories"></i>
                                            </button>
                                        </label>
                                        <button type="button" id="suggest-lss-classification" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-robot me-1"></i> Suggest LSS
                                        </button>
                                    </div>
                                    
                                    <div class="lss-radio-group">
                                        {% for value, label in form.lss_classification.field.choices %}
                                        {% if value %}  {# Skip empty choice #}
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="lss_classification" 
                                                   id="lss_{{ value }}" value="{{ value }}"
                                                   {% if form.lss_classification.value == value %}checked{% endif %}>
                                            <label class="form-check-label" for="lss_{{ value }}">
                                                {% if value == 'value_added' %}
                                                    <span class="badge bg-success">{{ label }}</span>
                                                    <small class="text-muted">- Directly adds customer value</small>
                                                {% elif value == 'necessary_nva' %}
                                                    <span class="badge bg-warning text-dark">{{ label }}</span>
                                                    <small class="text-muted">- Required but doesn't add direct value</small>
                                                {% elif value == 'waste' %}
                                                    <span class="badge bg-danger">{{ label }}</span>
                                                    <small class="text-muted">- Should be eliminated or minimized</small>
                                                {% endif %}
                                            </label>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    
                                    <div id="classify-spinner" class="d-none text-center mt-2">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2 text-muted">Analyzing with AI...</span>
                                    </div>
                                    {% if form.lss_classification.errors %}
                                        <div class="invalid-feedback d-block">{{ form.lss_classification.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- AI LSS Classification Suggestion -->
                            <div id="lss-suggestion-container" class="alert alert-info mb-3 d-none">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-robot mt-1 me-2"></i>
                                    <div class="flex-grow-1" id="lss-suggestion-text">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <!-- SECTION 4: FINAL REVIEW & CREATE                                    -->
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <button onclick="goBack()" type="button" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus-circle me-1"></i> Create Task
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lean Six Sigma Labels Info Modal -->
<div class="modal fade" id="leanLabelsInfoModal" tabindex="-1" aria-labelledby="leanLabelsInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leanLabelsInfoModalLabel">Understanding Lean Six Sigma Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Pri<span class="stylish-z">z</span>mAI includes Lean Six Sigma labels to help categorize your tasks based on their value contribution:</p>
                
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        Value-Added (VA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that transform inputs into outputs that customers value and are willing to pay for.</p>
                        <p class="card-text small">Example: Developing a feature that customers requested</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        Necessary Non-Value-Added (NNVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities required by current regulations, processes, or constraints, but don't directly add value for the customer.</p>
                        <p class="card-text small">Example: Compliance documentation, quality checks</p>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        Waste/Eliminate (NVA)
                    </div>
                    <div class="card-body">
                        <p class="card-text">Activities that consume resources without adding any value. These should be minimized or eliminated.</p>
                        <p class="card-text small">Example: Fixing defects, unnecessary meetings, waiting for approvals</p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i> 
                    <strong>Tip:</strong> Tagging your tasks this way helps identify process improvement opportunities and focus on value-adding activities.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Collapse icon rotation */
    .collapse-icon {
        transition: transform 0.3s ease;
    }
    [aria-expanded="true"] .collapse-icon {
        transform: rotate(180deg);
    }
    
    /* Card hover effects for AI sections */
    .card.border-info:hover,
    .card.border-warning:hover,
    .card.border-success:hover,
    .card.border-primary:hover {
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    /* Cursor pointer for collapsible headers */
    .cursor-pointer {
        cursor: pointer;
    }
    .cursor-pointer:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
</style>

<script>
    // Duplicate task handling functions
    function viewExistingTask() {
        // Open the first duplicate task in a new tab
        {% if duplicate_tasks %}
        const firstTaskUrl = "{% url 'task_detail' duplicate_tasks.0.id %}";
        window.open(firstTaskUrl, '_blank');
        {% endif %}
    }
    
    function confirmCreateDuplicate() {
        // Set the hidden input to confirm duplicate creation
        document.getElementById('confirm_duplicate').value = 'true';
        // Submit the form
        document.getElementById('task-create-form').submit();
    }

    // Handle complexity score slider display
    document.addEventListener('DOMContentLoaded', function() {
        const complexitySlider = document.getElementById('id_complexity_score');
        const complexityOutput = document.getElementById('complexity-output');
        
        if (complexitySlider && complexityOutput) {
            // Set initial value from the input
            const initialValue = complexitySlider.value || 5;
            complexityOutput.value = initialValue;
            complexityOutput.textContent = initialValue;
            
            // Update on change
            complexitySlider.addEventListener('input', function() {
                const value = this.value;
                complexityOutput.value = value;
                complexityOutput.textContent = value;
                
                // Update badge color based on complexity
                complexityOutput.className = 'badge ';
                if (value >= 8) {
                    complexityOutput.className += 'bg-danger';
                } else if (value >= 5) {
                    complexityOutput.className += 'bg-warning';
                } else {
                    complexityOutput.className += 'bg-success';
                }
            });
            
            // Trigger initial update
            complexitySlider.dispatchEvent(new Event('input'));
        }
        
        // Update collapse icon aria-expanded attribute
        const advancedSection = document.getElementById('advancedConstraintsSection');
        const advancedHeader = document.querySelector('[data-bs-target="#advancedConstraintsSection"]');
        if (advancedSection && advancedHeader) {
            advancedSection.addEventListener('shown.bs.collapse', function() {
                advancedHeader.setAttribute('aria-expanded', 'true');
            });
            advancedSection.addEventListener('hidden.bs.collapse', function() {
                advancedHeader.setAttribute('aria-expanded', 'false');
            });
        }
        
        // Debug: Log form submission
        const taskForm = document.querySelector('.task-form');
        if (taskForm) {
            taskForm.addEventListener('submit', function(e) {
                const complexityValue = document.querySelector('input[name="complexity_score"]')?.value;
                console.log('Submitting complexity score:', complexityValue);
            });
        }
    });
</script>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/ai_features.js' %}?v={{ STATIC_VERSION|default:'2' }}"></script>
<script src="{% static 'js/priority_suggestion.js' %}?v={{ STATIC_VERSION|default:'6' }}"></script>
<script>
    // Initialize Priority Suggestion Widget and assign to global variable
    document.addEventListener('DOMContentLoaded', function() {
        const boardId = {{ board.id }};
        prioritySuggestion = new PrioritySuggestionWidget({ boardId: boardId });
        prioritySuggestion.init();
        
        // Budget/Cost calculation preview
        function updateLaborCostPreview() {
            const hoursInput = document.getElementById('id_estimated_hours');
            const rateInput = document.getElementById('id_hourly_rate');
            const preview = document.getElementById('laborCostPreview');
            
            if (hoursInput && rateInput && preview) {
                const hours = parseFloat(hoursInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const laborCost = hours * rate;
                preview.textContent = '$' + laborCost.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }
        
        // Add event listeners for budget fields
        const hoursInput = document.getElementById('id_estimated_hours');
        const rateInput = document.getElementById('id_hourly_rate');
        
        if (hoursInput) {
            hoursInput.addEventListener('input', updateLaborCostPreview);
        }
        if (rateInput) {
            rateInput.addEventListener('input', updateLaborCostPreview);
        }
        
        // Initial calculation
        updateLaborCostPreview();
    });
</script>
{% endblock %}
