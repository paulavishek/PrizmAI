{% extends 'base.html' %}
{% load static %}

{% block title %}Time Tracking Dashboard{% if board %} - {{ board.name }}{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-line"></i> Time Tracking Dashboard
            {% if board %}
            <small class="text-muted">- {{ board.name }}</small>
            {% endif %}
        </h1>
        <div>
            <a href="{% url 'my_timesheet' %}" class="btn btn-primary">
                <i class="fas fa-calendar-week"></i> My Timesheet
            </a>
            <button onclick="goBack()" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>

    {% if showing_demo_data %}
    <!-- Demo Data Notice -->
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-lightbulb fa-lg me-3"></i>
            <div>
                <strong>Exploring Time Tracking!</strong>
                You're viewing sample data from <strong>{{ demo_user.get_full_name|default:demo_user.username }}</strong> to see how time tracking works.
                Start logging your own time on tasks to see your personal stats here!
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Stats Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 metric-card" data-period="today" style="cursor: pointer;" title="Click to see breakdown">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Today <i class="fas fa-search-plus small ms-1"></i>
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ today_hours }}h</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 metric-card" data-period="week" style="cursor: pointer;" title="Click to see breakdown">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                This Week <i class="fas fa-search-plus small ms-1"></i>
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ week_hours }}h</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 metric-card" data-period="month" style="cursor: pointer;" title="Click to see breakdown">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                This Month <i class="fas fa-search-plus small ms-1"></i>
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ month_hours }}h</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 metric-card" data-period="all" style="cursor: pointer;" title="Click to see breakdown">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Hours <i class="fas fa-search-plus small ms-1"></i>
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_hours }}h</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-hourglass-half fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI-Powered Alerts Section -->
    {% if time_alerts or missing_time_alert %}
    <div class="row mb-4">
        <div class="col-12">
            {% if missing_time_alert %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <span class="badge bg-primary me-2"><i class="fas fa-robot"></i> AI</span>
                <strong>Reminder:</strong> {{ missing_time_alert.message }}
                <span class="ms-2 text-muted">{{ missing_time_alert.suggestion }}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% for alert in time_alerts %}
            {% if alert.severity == 'critical' %}
            <div class="alert alert-danger fade show" role="alert" id="alert-{{ alert.date_str }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-danger me-2"><i class="fas fa-robot"></i> AI</span>
                        <strong>High Hours Alert:</strong> {{ alert.message }}
                        <br><small class="text-muted">{{ alert.suggestion }}</small>
                    </div>
                    <div class="btn-group-vertical btn-group-sm ms-3">
                        <button type="button" class="btn btn-outline-light btn-sm text-danger" onclick="showSplitEntryModal('{{ alert.date_str }}', {{ alert.hours }})" title="Split these hours across multiple days">
                            <i class="fas fa-code-branch"></i> Split Entry
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm text-danger" onclick="acknowledgeAlert('{{ alert.date_str }}')" title="Confirm this was intentional">
                            <i class="fas fa-check"></i> Was Correct
                        </button>
                    </div>
                </div>
            </div>
            {% elif alert.severity == 'warning' %}
            <div class="alert alert-warning fade show" role="alert" id="alert-{{ alert.date_str }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-warning text-dark me-2"><i class="fas fa-robot"></i> AI</span>
                        <strong>Notice:</strong> {{ alert.message }}
                        <br><small class="text-muted">{{ alert.suggestion }}</small>
                    </div>
                    <div class="btn-group-vertical btn-group-sm ms-3">
                        <button type="button" class="btn btn-outline-dark btn-sm" onclick="showSplitEntryModal('{{ alert.date_str }}', {{ alert.hours }})" title="Split these hours across multiple days">
                            <i class="fas fa-code-branch"></i> Split Entry
                        </button>
                        <button type="button" class="btn btn-outline-dark btn-sm" onclick="acknowledgeAlert('{{ alert.date_str }}')" title="Confirm this was intentional">
                            <i class="fas fa-check"></i> Was Correct
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Daily Hours Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Daily Hours (Last 14 Days)</h6>
                    <small class="text-muted"><i class="fas fa-mouse-pointer"></i> Click any bar to see breakdown</small>
                </div>
                <div class="card-body">
                    <canvas id="dailyHoursChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Time Entry -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt text-warning me-1"></i> Quick Log Time
                    </h6>
                </div>
                <div class="card-body">
                    <form id="quickLogForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Task <span class="text-danger">*</span></label>
                            <select class="form-select" id="quick-task-select" required>
                                <option value="">Select a task...</option>
                                {% if smart_suggestions %}
                                <optgroup label="AI Suggested Tasks">
                                    {% for suggestion in smart_suggestions %}
                                    <option value="{{ suggestion.task.id }}" {% if forloop.first %}selected{% endif %}>
                                        {{ suggestion.task.title|truncatechars:40 }} ({{ suggestion.reason_text }})
                                    </option>
                                    {% endfor %}
                                </optgroup>
                                {% endif %}
                                {% if my_tasks %}
                                <optgroup label="My Assigned Tasks">
                                {% for task in my_tasks %}
                                {% if task.id not in suggested_task_ids %}
                                <option value="{{ task.id }}">{{ task.title|truncatechars:50 }}</option>
                                {% endif %}
                                {% endfor %}
                                </optgroup>
                                {% endif %}
                            </select>
                            <div class="mt-2">
                                <label class="form-label small text-muted">Or search for a task from your boards:</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="task-search-input" 
                                           placeholder="Type to search tasks..." autocomplete="off">
                                    <div id="task-search-results" class="list-group position-absolute w-100" 
                                         style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                            <div class="mt-2 p-2 bg-light rounded small">
                                {% if smart_suggestions %}
                                <i class="fas fa-robot text-primary me-1"></i>
                                <strong>AI Suggestions</strong> - Based on your recent activity and deadlines<br>
                                {% endif %}
                                <i class="fas fa-user text-success me-1"></i>
                                <strong>My Assigned Tasks</strong> - Tasks assigned to you (incomplete)<br>
                                <i class="fas fa-search text-info me-1"></i>
                                <strong>Search Tasks</strong> - Find any task from your boards by typing its name
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hours <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quick-hours" 
                                   step="0.25" min="0.25" max="16" required>
                            <small class="text-muted">Increments of 0.25 (max 16h per entry)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="quick-date" 
                                   value="{{ "now"|date:"Y-m-d" }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="quick-description" 
                                      rows="2" placeholder="What did you work on?"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Log Time
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Time Entries -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Entries</h6>
                </div>
                <div class="card-body">
                    {% if recent_entries %}
                    <div class="list-group list-group-flush">
                        {% for entry in recent_entries %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="{% url 'task_detail' entry.task.id %}" class="text-decoration-none" title="{{ entry.task.title }}">
                                            {{ entry.task.title|truncatechars:40 }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        {{ entry.task.column.board.name }} • {{ entry.work_date|date:"M d, Y" }}
                                    </small>
                                    {% if entry.description %}
                                    <p class="mb-0 mt-1"><small title="{{ entry.description }}" style="cursor: help;">{{ entry.description|truncatechars:60 }}</small></p>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">{{ entry.hours_spent }}h</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No time entries yet</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tasks by Time Logged -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Tasks by Time</h6>
                </div>
                <div class="card-body">
                    {% if tasks_with_time %}
                    <div class="list-group list-group-flush">
                        {% for task in tasks_with_time %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <a href="{% url 'task_detail' task.id %}" class="text-decoration-none" title="{{ task.title }}">
                                        {{ task.title|truncatechars:50 }}
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ task.column.board.name }}</small>
                                </div>
                                <span class="badge bg-info">{{ task.total_hours }}h</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No tasks with time logged yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Daily Hours Chart
    const chartData = {{ chart_data|safe }};
    const ctx = document.getElementById('dailyHoursChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.day + ' ' + d.date.substring(5)),
            datasets: [{
                label: 'Hours',
                data: chartData.map(d => d.hours),
                backgroundColor: 'rgba(13, 110, 253, 0.5)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const clickedDate = chartData[index].date;
                    showDayBreakdown(clickedDate);
                }
            },
            onHover: function(event, elements) {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + 'h';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' hours';
                        }
                    }
                }
            }
        }
    });

    // Show day breakdown modal
    function showDayBreakdown(dateStr) {
        const modal = new bootstrap.Modal(document.getElementById('dayBreakdownModal'));
        const modalBody = document.getElementById('dayBreakdownContent');
        const modalTitle = document.getElementById('dayBreakdownTitle');
        
        modalBody.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading...</p></div>';
        modal.show();
        
        {% if board %}
        const url = `/api/time-entries-by-date/?date=${dateStr}&board_id={{ board.id }}`;
        {% else %}
        const url = `/api/time-entries-by-date/?date=${dateStr}`;
        {% endif %}
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalTitle.textContent = `Time Breakdown - ${data.date_display}`;
                    
                    if (data.entries.length === 0) {
                        modalBody.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-clock fa-2x mb-2"></i><p>No time logged on this day</p></div>';
                        return;
                    }
                    
                    let html = `
                        <div class="alert alert-light mb-3">
                            <strong>Total: ${data.total_hours}h</strong> across ${data.entry_count} ${data.entry_count === 1 ? 'entry' : 'entries'}
                        </div>
                        <div class="list-group">
                    `;
                    
                    data.entries.forEach(entry => {
                        const truncatedTitle = entry.task_title.length > 50 ? entry.task_title.substring(0, 50) + '...' : entry.task_title;
                        const truncatedDesc = entry.description && entry.description.length > 80 ? entry.description.substring(0, 80) + '...' : entry.description;
                        html += `
                            <a href="/tasks/${entry.task_id}/" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" ${entry.task_title.length > 50 ? `title="${entry.task_title}" style="cursor: help;"` : ''}>${truncatedTitle}</h6>
                                        <small class="text-muted">${entry.board_name}</small>
                                        ${entry.description ? `<p class="mb-0 mt-1 small text-secondary" ${entry.description.length > 80 ? `title="${entry.description}" style="cursor: help;"` : ''}>${truncatedDesc}</p>` : ''}
                                    </div>
                                    <span class="badge bg-primary rounded-pill">${entry.hours}h</span>
                                </div>
                            </a>
                        `;
                    });
                    
                    html += '</div>';
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                modalBody.innerHTML = '<div class="alert alert-danger">Failed to load time entries. Please try again.</div>';
            });
    }

    // Quick log form - with AI validation
    document.getElementById('quickLogForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const taskId = document.getElementById('quick-task-select').value;
        const hours = parseFloat(document.getElementById('quick-hours').value);
        const date = document.getElementById('quick-date').value;
        const description = document.getElementById('quick-description').value;
        
        if (!taskId || !hours) {
            alert('Please fill in all required fields');
            return;
        }
        
        // First, validate with AI
        validateTimeEntryWithAI(taskId, hours, date, description);
    });
    
    // AI-powered time entry validation
    function validateTimeEntryWithAI(taskId, hours, date, description) {
        const submitBtn = document.querySelector('#quickLogForm button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-robot fa-spin"></i> AI Checking...';
        submitBtn.disabled = true;
        
        fetch('/api/time-entry/validate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                task_id: taskId,
                hours: hours,
                work_date: date,
            }),
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            
            if (data.success && data.needs_attention) {
                // Show AI suggestion modal
                showAISplitSuggestionModal(data, taskId, hours, date, description);
            } else {
                // No concerns, proceed with normal submission
                submitTimeEntry(taskId, hours, date, description);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            // On error, fallback to normal submission
            submitTimeEntry(taskId, hours, date, description);
        });
    }
    
    // Submit time entry directly
    function submitTimeEntry(taskId, hours, date, description) {
        const formData = new FormData();
        formData.append('hours', hours);
        formData.append('description', description);
        formData.append('work_date', date);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/task/${taskId}/time/quick-log/`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast(data.message || 'Time logged successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to log time'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to log time. Please try again.');
        });
    }
    
    // Show AI split suggestion modal
    let aiSplitData = null;
    function showAISplitSuggestionModal(validationData, taskId, hours, date, description) {
        aiSplitData = { validationData, taskId, hours, date, description };
        
        const modal = document.getElementById('aiSplitSuggestionModal');
        const modalBody = document.getElementById('aiSplitSuggestionContent');
        
        const severityClass = validationData.severity === 'critical' ? 'danger' : 'warning';
        const severityIcon = validationData.severity === 'critical' ? 'exclamation-triangle' : 'lightbulb';
        
        let html = `
            <div class="alert alert-${severityClass} mb-4">
                <div class="d-flex align-items-start">
                    <i class="fas fa-robot fa-2x me-3"></i>
                    <div>
                        <strong><i class="fas fa-${severityIcon} me-1"></i> AI Notice</strong>
                        <p class="mb-0 mt-1">${validationData.message}</p>
                    </div>
                </div>
            </div>
        `;
        
        if (validationData.suggestion) {
            const suggestion = validationData.suggestion;
            html += `
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-magic me-2"></i>AI Recommendation: Split Your Time
                    </div>
                    <div class="card-body">
                        <p class="text-muted">${suggestion.rationale}</p>
                        <p><strong>${suggestion.summary}</strong></p>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Hours</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            suggestion.entries.forEach((entry, idx) => {
                const isOriginal = entry.is_original_day ? '<span class="badge bg-info ms-1">Original</span>' : '';
                html += `
                    <tr>
                        <td>${entry.date_display} ${isOriginal}</td>
                        <td><strong>${entry.hours}h</strong></td>
                        <td>
                            <input type="text" class="form-control form-control-sm ai-split-desc" 
                                   data-idx="${idx}" value="${entry.description}" 
                                   placeholder="Description...">
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Related task suggestions
        if (validationData.task_suggestions && validationData.task_suggestions.length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-tasks me-2"></i>Related Tasks (if you want to split across different tasks)
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
            `;
            
            validationData.task_suggestions.forEach(task => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${task.task_title}</strong>
                            <br><small class="text-muted">${task.reason} • ${task.progress}% complete</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="addTaskToSplit(${task.task_id}, '${task.task_title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </li>
                `;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
        }
        
        modalBody.innerHTML = html;
        
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    // Accept AI split suggestion
    function acceptAISplit() {
        if (!aiSplitData || !aiSplitData.validationData.suggestion) return;
        
        const entries = aiSplitData.validationData.suggestion.entries.map((entry, idx) => {
            const descInput = document.querySelector(`.ai-split-desc[data-idx="${idx}"]`);
            return {
                task_id: entry.task_id,
                hours: entry.hours,
                date: entry.date,
                description: descInput ? descInput.value : entry.description,
            };
        });
        
        const btn = document.getElementById('acceptAISplitBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        btn.disabled = true;
        
        fetch('/api/time-entry/create-split/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ entries: entries }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast(`${data.message}`);
                bootstrap.Modal.getInstance(document.getElementById('aiSplitSuggestionModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + (data.error || data.errors?.join(', ') || 'Failed to create entries'));
                btn.innerHTML = '<i class="fas fa-check"></i> Accept AI Suggestion';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create split entries. Please try again.');
            btn.innerHTML = '<i class="fas fa-check"></i> Accept AI Suggestion';
            btn.disabled = false;
        });
    }
    
    // Proceed with original entry despite AI warning
    function proceedWithOriginalEntry() {
        if (!aiSplitData) return;
        
        bootstrap.Modal.getInstance(document.getElementById('aiSplitSuggestionModal')).hide();
        submitTimeEntry(aiSplitData.taskId, aiSplitData.hours, aiSplitData.date, aiSplitData.description);
    }
    
    // Show success toast
    function showSuccessToast(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Metric card click handlers
    document.querySelectorAll('.metric-card').forEach(card => {
        card.addEventListener('click', function() {
            const period = this.dataset.period;
            showPeriodBreakdown(period);
        });
    });

    // Show period breakdown modal with pagination
    let currentPeriodData = null;
    let currentPage = 1;
    const itemsPerPage = 10;
    
    function showPeriodBreakdown(period) {
        const modal = new bootstrap.Modal(document.getElementById('periodBreakdownModal'));
        const modalBody = document.getElementById('periodBreakdownContent');
        const modalTitle = document.getElementById('periodBreakdownTitle');
        
        modalBody.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading...</p></div>';
        modal.show();
        
        {% if board %}
        const url = `/api/time-entries-by-period/?period=${period}&board_id={{ board.id }}`;
        {% else %}
        const url = `/api/time-entries-by-period/?period=${period}`;
        {% endif %}
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modalTitle.textContent = `Time Breakdown - ${data.period_display}`;
                    
                    if (data.tasks.length === 0) {
                        modalBody.innerHTML = '<div class=\"text-center py-4 text-muted\"><i class=\"fas fa-clock fa-2x mb-2\"></i><p>No time logged for this period</p></div>';
                        return;
                    }
                    
                    currentPeriodData = data;
                    currentPage = 1;
                    renderPeriodBreakdownPage();
                } else {
                    modalBody.innerHTML = `<div class=\"alert alert-danger\">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                modalBody.innerHTML = '<div class=\"alert alert-danger\">Failed to load time entries. Please try again.</div>';
            });
    }
    
    function renderPeriodBreakdownPage() {
        if (!currentPeriodData) return;
        
        const modalBody = document.getElementById('periodBreakdownContent');
        const tasks = currentPeriodData.tasks;
        const totalPages = Math.ceil(tasks.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, tasks.length);
        const pageTasks = tasks.slice(startIndex, endIndex);
        
        let html = `
            <div class=\"alert alert-light mb-3\">
                <strong>Total: ${currentPeriodData.total_hours}h</strong> across ${currentPeriodData.task_count} ${currentPeriodData.task_count === 1 ? 'task' : 'tasks'}
                <span class=\"float-end text-muted\">Showing ${startIndex + 1}-${endIndex} of ${tasks.length}</span>
            </div>
            <div class=\"list-group mb-3\">
        `;
        
        pageTasks.forEach(task => {
            const truncatedTitle = task.task_title.length > 50 ? task.task_title.substring(0, 50) + '...' : task.task_title;
            const entriesHtml = task.entries.slice(0, 3).map(e => {
                const fullDesc = e.description || '';
                const truncatedDesc = fullDesc.length > 40 ? fullDesc.substring(0, 40) + '...' : fullDesc;
                return `<small class=\"d-block text-muted\" ${fullDesc.length > 40 ? `title=\"${fullDesc}\" style=\"cursor: help;\"` : ''}>${e.date}: ${e.hours}h${truncatedDesc ? ' - ' + truncatedDesc : ''}</small>`;
            }).join('');
            
            html += `
                <a href=\"/tasks/${task.task_id}/\" class=\"list-group-item list-group-item-action\">
                    <div class=\"d-flex justify-content-between align-items-start\">
                        <div class=\"flex-grow-1\">
                            <h6 class=\"mb-1\" ${task.task_title.length > 50 ? `title=\"${task.task_title}\" style=\"cursor: help;\"` : ''}>${truncatedTitle}</h6>
                            <small class=\"text-muted\">${task.board_name} • ${task.entry_count} ${task.entry_count === 1 ? 'entry' : 'entries'}</small>
                            ${entriesHtml}
                        </div>
                        <span class=\"badge bg-primary rounded-pill\">${task.hours}h</span>
                    </div>
                </a>
            `;
        });
        
        html += '</div>';
        
        // Add pagination controls if needed
        if (totalPages > 1) {
            html += '<nav aria-label=\"Task pagination\"><ul class=\"pagination justify-content-center\">';
            
            // Previous button
            html += `<li class=\"page-item ${currentPage === 1 ? 'disabled' : ''}\">
                <a class=\"page-link\" href=\"#\" onclick=\"changePeriodPage(${currentPage - 1}); return false;\">Previous</a>
            </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<li class=\"page-item ${i === currentPage ? 'active' : ''}\">
                        <a class=\"page-link\" href=\"#\" onclick=\"changePeriodPage(${i}); return false;\">${i}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<li class=\"page-item disabled\"><span class=\"page-link\">...</span></li>';
                }
            }
            
            // Next button
            html += `<li class=\"page-item ${currentPage === totalPages ? 'disabled' : ''}\">
                <a class=\"page-link\" href=\"#\" onclick=\"changePeriodPage(${currentPage + 1}); return false;\">Next</a>
            </li>`;
            
            html += '</ul></nav>';
        }
        
        modalBody.innerHTML = html;
    }
    
    window.changePeriodPage = function(page) {
        if (!currentPeriodData) return;
        const totalPages = Math.ceil(currentPeriodData.tasks.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderPeriodBreakdownPage();
    };
    
    // Task search functionality
    let searchTimeout;
    const taskSearchInput = document.getElementById('task-search-input');
    const taskSearchResults = document.getElementById('task-search-results');
    const taskSelect = document.getElementById('quick-task-select');
    
    taskSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            taskSearchResults.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            {% if board %}
            const url = `/api/search-tasks/?q=${encodeURIComponent(query)}&board_id={{ board.id }}`;
            {% else %}
            const url = `/api/search-tasks/?q=${encodeURIComponent(query)}`;
            {% endif %}
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.tasks.length === 0) {
                            taskSearchResults.innerHTML = '<div class=\"list-group-item text-muted\">No tasks found</div>';
                            taskSearchResults.style.display = 'block';
                        } else {
                            let html = '';
                            data.tasks.forEach(task => {
                                html += `
                                    <a href=\"#\" class=\"list-group-item list-group-item-action task-search-result\" 
                                       data-task-id=\"${task.id}\" data-task-title=\"${task.title}\">
                                        <strong>${task.title}</strong>
                                        <br><small class=\"text-muted\">${task.board_name} • ${task.column_name}</small>
                                    </a>
                                `;
                            });
                            taskSearchResults.innerHTML = html;
                            taskSearchResults.style.display = 'block';
                            
                            // Add click handlers
                            document.querySelectorAll('.task-search-result').forEach(item => {
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    const taskId = this.dataset.taskId;
                                    const taskTitle = this.dataset.taskTitle;
                                    
                                    // Clear existing selection
                                    taskSelect.value = '';
                                    
                                    // Add temporary option to select
                                    const option = new Option(taskTitle, taskId, true, true);
                                    taskSelect.add(option, 0);
                                    
                                    // Clear search
                                    taskSearchInput.value = '';
                                    taskSearchResults.style.display = 'none';
                                });
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    taskSearchResults.innerHTML = '<div class=\"list-group-item text-danger\">Search failed</div>';
                    taskSearchResults.style.display = 'block';
                });
        }, 300);
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!taskSearchInput.contains(e.target) && !taskSearchResults.contains(e.target)) {
            taskSearchResults.style.display = 'none';
        }
    });
});
</script>

<!-- Day Breakdown Modal -->
<div class="modal fade" id="dayBreakdownModal" tabindex="-1" aria-labelledby="dayBreakdownTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayBreakdownTitle">
                    <i class="fas fa-chart-pie me-2"></i>Time Breakdown
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="dayBreakdownContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Period Breakdown Modal -->
<div class="modal fade" id="periodBreakdownModal" tabindex="-1" aria-labelledby="periodBreakdownTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="periodBreakdownTitle">
                    <i class="fas fa-chart-pie me-2"></i>Time Breakdown
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="periodBreakdownContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Split Entry Modal -->
<div class="modal fade" id="splitEntryModal" tabindex="-1" aria-labelledby="splitEntryTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="splitEntryTitle">
                    <i class="fas fa-code-branch me-2"></i>Split Time Entries
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    Split <strong id="splitTotalHours">0</strong>h from <strong id="splitOriginalDate"></strong> across multiple days.
                </p>
                <div id="splitEntriesContainer">
                    <!-- Split entries will be added here dynamically -->
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addSplitRow()">
                    <i class="fas fa-plus"></i> Add Another Day
                </button>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Remaining to allocate:</span>
                    <strong id="splitRemainingHours">0h</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSplitEntries()" id="submitSplitBtn" disabled>
                    <i class="fas fa-check"></i> Apply Split
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Split Suggestion Modal -->
<div class="modal fade" id="aiSplitSuggestionModal" tabindex="-1" aria-labelledby="aiSplitSuggestionTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="aiSplitSuggestionTitle">
                    <i class="fas fa-robot me-2"></i>AI Time Entry Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="aiSplitSuggestionContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="proceedWithOriginalEntry()">
                    <i class="fas fa-arrow-right"></i> Log Anyway
                </button>
                <button type="button" class="btn btn-success" id="acceptAISplitBtn" onclick="acceptAISplit()">
                    <i class="fas fa-check"></i> Accept AI Suggestion
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Alert action functions
let splitModalData = { date: null, totalHours: 0, entries: [], originalEntries: [] };

function acknowledgeAlert(dateStr) {
    // Store acknowledgment in localStorage
    const acknowledged = JSON.parse(localStorage.getItem('acknowledgedTimeAlerts') || '[]');
    if (!acknowledged.includes(dateStr)) {
        acknowledged.push(dateStr);
        localStorage.setItem('acknowledgedTimeAlerts', JSON.stringify(acknowledged));
    }
    
    // Hide the alert with animation
    const alertEl = document.getElementById('alert-' + dateStr);
    if (alertEl) {
        alertEl.classList.remove('show');
        setTimeout(() => alertEl.remove(), 150);
    }
    
    // Show confirmation
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">Acknowledged</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                This entry has been marked as correct. The alert won't appear again for this date.
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showSplitEntryModal(dateStr, totalHours) {
    splitModalData = { date: dateStr, totalHours: totalHours, entries: [], originalEntries: [] };
    
    document.getElementById('splitTotalHours').textContent = totalHours;
    document.getElementById('splitOriginalDate').textContent = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    
    // Initialize with two split rows
    const container = document.getElementById('splitEntriesContainer');
    container.innerHTML = '';
    addSplitRow();
    addSplitRow();
    
    updateSplitRemaining();
    
    // Pre-fetch original entries for this date so we have task_ids for submission
    fetch(`/api/time-entries-by-date/?date=${dateStr}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.entries.length > 0) {
                splitModalData.originalEntries = data.entries;
            }
        })
        .catch(() => {});  // graceful fallback – user can still submit

    const modal = new bootstrap.Modal(document.getElementById('splitEntryModal'));
    modal.show();
}

function addSplitRow() {
    const container = document.getElementById('splitEntriesContainer');
    const rowIndex = container.children.length;
    
    const row = document.createElement('div');
    row.className = 'row mb-2 split-row';
    row.innerHTML = `
        <div class="col-6">
            <input type="date" class="form-control form-control-sm split-date" 
                   value="${splitModalData.date}" onchange="updateSplitRemaining()">
        </div>
        <div class="col-4">
            <div class="input-group input-group-sm">
                <input type="number" class="form-control split-hours" step="0.25" min="0.25" 
                       placeholder="Hours" onchange="updateSplitRemaining()" oninput="updateSplitRemaining()">
                <span class="input-group-text">h</span>
            </div>
        </div>
        <div class="col-2">
            ${rowIndex > 1 ? `<button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSplitRow(this)"><i class="fas fa-times"></i></button>` : ''}
        </div>
    `;
    container.appendChild(row);
}

function removeSplitRow(btn) {
    btn.closest('.split-row').remove();
    updateSplitRemaining();
}

function updateSplitRemaining() {
    const hoursInputs = document.querySelectorAll('.split-hours');
    let allocated = 0;
    hoursInputs.forEach(input => {
        allocated += parseFloat(input.value) || 0;
    });
    
    const remaining = splitModalData.totalHours - allocated;
    const remainingEl = document.getElementById('splitRemainingHours');
    remainingEl.textContent = remaining.toFixed(2) + 'h';
    remainingEl.className = remaining < 0 ? 'text-danger' : (remaining === 0 ? 'text-success' : '');
    
    // Enable/disable submit button
    document.getElementById('submitSplitBtn').disabled = remaining !== 0 || allocated === 0;
}

function submitSplitEntries() {
    const rows = document.querySelectorAll('.split-row');
    const splits = [];
    
    rows.forEach(row => {
        const date = row.querySelector('.split-date').value;
        const hours = parseFloat(row.querySelector('.split-hours').value);
        if (date && hours > 0) {
            splits.push({ date, hours });
        }
    });
    
    if (splits.length === 0) {
        alert('Please enter at least one valid split entry');
        return;
    }

    // Derive task_id from the original entries fetched for this date.
    // Distribute hours proportionally if multiple original tasks; otherwise use first task.
    const originalEntries = splitModalData.originalEntries;
    const defaultTaskId = originalEntries.length > 0 ? originalEntries[0].task_id : null;

    if (!defaultTaskId) {
        alert('Unable to determine the original task for these entries. Please log entries manually.');
        return;
    }

    // Build entries payload — each split row inherits the task description from the original entry
    const defaultDescription = originalEntries.length > 0 ? (originalEntries[0].description || '') : '';
    const entriesPayload = splits.map(s => ({
        task_id: defaultTaskId,
        hours: s.hours,
        date: s.date,
        description: defaultDescription ? `[Split] ${defaultDescription}` : '[Split entry]'
    }));

    // Disable the submit button during processing
    const submitBtn = document.getElementById('submitSplitBtn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                      window.CSRF_TOKEN || '{{ csrf_token }}';

    fetch('/api/time-entry/create-split/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ entries: entriesPayload })
    })
    .then(r => r.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('splitEntryModal')).hide();
            // Show success toast
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong class="me-auto">Time Entry Split</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        Successfully created ${data.created_count} split ${data.created_count === 1 ? 'entry' : 'entries'}.
                        Refresh the page to see updated totals.
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); location.reload(); }, 3000);
        } else {
            const errMsg = data.errors ? data.errors.join('\n') : (data.error || 'An error occurred');
            alert('Failed to create split entries:\n' + errMsg);
        }
    })
    .catch(err => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        alert('Network error — please try again.');
        console.error('Split entries error:', err);
    });
}

// Check for acknowledged alerts on page load
document.addEventListener('DOMContentLoaded', function() {
    const acknowledged = JSON.parse(localStorage.getItem('acknowledgedTimeAlerts') || '[]');
    acknowledged.forEach(dateStr => {
        const alertEl = document.getElementById('alert-' + dateStr);
        if (alertEl) {
            alertEl.remove();
        }
    });
});
</script>
{% endblock %}
